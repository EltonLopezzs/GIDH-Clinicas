<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Pacientes - {{ session.clinica_nome_display or 'Cl√≠nica On' }}</title>

    <link rel="icon" type="image/png" href="https://placehold.co/40x40/0d9488/ffffff?text=C">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        /* Estilos principais */
        :root {
            --bg: #f1f5f9;                  /* Gray-100 */
            --card: #ffffff;                /* White */
            --text: #0f172a;                /* Gray-900 */
            --muted: #64748b;               /* Gray-500 */
            --accent: #9b53b8;              /* Purple-500 */
            --primary-dark: #115e59;        
            --primary: #5587c2;             /* Blue-500 */
            --primary-light: #c8dcf3;       /* Blue-100 */
            --secondary: #f59e0b;           /* Yellow-500 */
            --danger: #dc2626;              /* Red-600 */
            --success: #16a34a;             /* Green-600 */
            --warning: #f59e0b;             /* Yellow-500 */
            --info: #0ea5e9;                /* Sky-500 */
            --border-color: #e2e8f0;        /* Gray-200 */

            --dark-bg: #0f172a;             /* Gray-900 */
            --dark-card: #1e293b;           /* Gray-800 */
            --dark-text: #f1f5f9;           /* Gray-100 */
            --dark-muted: #94a3b8;          /* Gray-400 */
            --dark-border-color: #334155;   /* Gray-600 */

            color-scheme: light;
        }
        [data-theme="dark"] {
            --bg: var(--dark-bg);
            --text: var(--dark-text);
            --card: var(--dark-card);
            --muted: var(--dark-muted);
            --border-color: var(--dark-border-color);
            color-scheme: dark;
        }
        ::-webkit-scrollbar {
            background-color: var(--bg);
            width: 0.5625rem;
            height: 0.5625rem;
            border-top-right-radius: 0.3125rem;
            border-bottom-right-radius: 0.3125rem;
            transition: background-color 0.8s ease;
        }
        ::-webkit-scrollbar-thumb {
            background-color: var(--muted);
            border-radius: .3125rem;
            transition: background-color 0.8s ease;
        }
        ::-webkit-scrollbar-thumb:hover {
            transition: background-color 0.8s ease;
            background-color: var(--primary);
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        html, body {
            height: 100%;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .layout {
            display: flex;
            min-height: 100vh;
            width: 100%;
        }
        /* --- Main Content & Topbar --- */
        .main-content {
            flex: 1; margin-left: 260px;
            transition: margin-left 0.3s ease;
            display: flex; flex-direction: column; width: calc(100% - 260px);
            max-width: calc(100% - 260px);
            box-sizing: border-box;
        }
        .main-content.collapsed { 
            margin-left: 88px;
            width: calc(100% - 88px);
            max-width: calc(100% - 88px);
        }
        .topbar {
            background-color: var(--card);
            color: var(--text);
            padding: 0 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border-color);
            height: 70px;
            flex-shrink: 0;
            position: sticky;
            top: 0;
            z-index: 900;
        }
        .topbar-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .topbar .page-title {
            font-weight: 600;
            font-size: 1.25rem;
            color: var(--text);
        }
        .toggle-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--muted);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: grid;
            place-items: center;
            transition: background 0.2s ease, color 0.2s ease;
        }
        .toggle-btn:hover {
            background-color: var(--bg);
            color: var(--primary);
        }
        .topbar-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }
        .search-form {
            display: flex;
            align-items: center;
        }
        .search-input {
            padding: 0.5rem 0.8rem;
            border: 1px solid var(--border-color);
            border-radius: 8px 0 0 8px;
            font-size: 0.9rem;
            background-color: var(--bg);
            color: var(--text);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .search-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary) 20%, transparent);
            outline: none;
            z-index: 1;
        }
        .search-button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0 8px 8px 0;
            margin-left: -1px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .search-button:hover {
            background-color: var(--accent);
        }
        main { 
            flex-grow: 1; 
            padding: 1.5rem; 
            overflow-y: auto; 
            width: 100%;
            max-width: 100%;
        }
        .btn {
            padding: 0.6rem 1.2rem;
            font-size: 0.9rem;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
        }
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        .btn-primary:hover {
            background-color: var(--accent);
        }
        .btn-info {
            background-color: var(--info);
            color: white;
        }
        .btn-info:hover {
            background-color: #0369a1;
        }
        .btn-warning {
            background-color: var(--warning);
            color: #854d0e;
        }
        [data-theme="dark"] .btn-warning {
            color: var(--dark-bg);
        }
        .btn-warning:hover {
            background-color: #fcd34d;
        }
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        .btn-danger:hover {
            background-color: #b91c1c;
        }
        .card-list-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(520px, 1fr));
            gap: 1.5rem;
            width: 100%;
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .patient-card-modern {
            background: var(--card);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            width: 100%;
            min-height: 280px;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .paciente-card.modern-card {
            transform: translateY(var(--animation-delay, 0));
            opacity: 0;
            animation: slideInUp 0.6s ease forwards;
            animation-delay: var(--animation-delay, 0s);
            width: 100%;
            box-sizing: border-box;
            border-radius: 16px !important;
            height: 100%;
        }
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .patient-card-modern:hover {
            scale: 1.01;
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        }
        .patient-header {
            display: flex;
            align-items: center;
            padding: 1.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: white;
            position: relative;
        }
        .patient-avatar {
            position: relative;
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            margin-right: 1rem;
            flex-shrink: 0;
        }
        .patient-status-indicator {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid white;
        }
        .status-active {
            background: #10b981;
        }
        .status-inactive {
            background: #ef4444;
        }
        .status-pending {
            background: #f59e0b;
        }
        .patient-info {
            flex: 1;
            min-width: 0;
        }
        .patient-name {
            font-size: 1.25rem;
            font-weight: 700;
            margin: 0 0 0.5rem 0;
            color: white;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
        }
        .patient-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.85rem;
            opacity: 0.9;
        }
        .patient-meta span {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        .patient-meta i {
            font-size: 0.75rem;
        }
        .patient-actions-dropdown {
            position: relative;
        }
        .dropdown-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        .dropdown-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        .dropdown-menu {
            position: absolute;
            top: -32px;
            right: 58px;
            background: var(--card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            min-width: 180px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
            z-index: 999;
            margin-top: 0.5rem;
            overflow-y: auto;
            overflow-x: hidden;
            max-height: 350px;
        }
        .dropdown-menu::after {
            content: '';
            position: absolute;
            top: 36px;
            right: -22px;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid var(--card);
            transform: rotate(270deg);
            z-index: 99999;
        }
        .dropdown-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            color: var(--text);
            text-decoration: none;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        .dropdown-item:hover {
            background: var(--bg);
        }
        .dropdown-item-danger {
            color: var(--danger);
        }
        .dropdown-item-danger:hover {
            background: rgba(220, 38, 38, 0.1);
            color: var(--danger);
        }
        .dropdown-item i {
            width: 16px;
            text-align: center;
        }
        .dropdown-divider {
            height: 1px;
            background: var(--border-color);
            margin: 0.5rem 0;
        }
        .dropdown-section-label {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.25rem 1rem;
            font-size: 0.6rem;
            font-weight: 500;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.2px;
            opacity: 0.7;
            margin: 0.25rem 0 0.1rem 0;
        }
        [data-theme="dark"] .dropdown-section-label {
            color: var(--dark-muted);
            opacity: 0.6;
        }
        .dropdown-section-label i {
            font-size: 0.55rem;
            opacity: 0.5;
        }
        .dropdown-section-label + .dropdown-item {
            margin-top: 0.1rem;
        }
        .dropdown-section-label + .dropdown-divider {
            margin-top: 0.5rem;
        }
        /* Detalhes do paciente */
        .patient-details {
            padding: 1.5rem;
            flex: 1;
        }
        .detail-grid {
            display: grid;
            gap: 1rem;
            grid-template-columns: 2fr 1fr;
        }
        .detail-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            border-radius: 8px;
            transition: all 0.2s ease;
            width: 100%;
        }
        .detail-item.clickable {
            cursor: pointer;
        }
        .detail-item.clickable:hover {
            background: var(--bg);
            transform: translateX(4px);
        }
        .detail-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--muted);
            flex-shrink: 0;
        }
        .detail-content {
            flex: 1;
            min-width: 0;
        }
        .detail-label {
            display: block;
            font-size: 0.75rem;
            color: var(--muted);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.25rem;
        }
        .detail-value {
            display: block;
            font-size: 0.95rem;
            color: var(--text);
            font-weight: 500;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
        }
        /* Para o campo de endere√ßo, permitir quebra de linha */
        .detail-value.address-value {
            white-space: normal;
            overflow: visible;
            text-overflow: unset;
        }
        .detail-empty {
            color: var(--muted);
            font-style: italic;
            opacity: 0.7;
            position: relative;
        }
        .detail-empty::before {
            content: "‚ö™";
            margin-right: 0.5rem;
            font-style: normal;
            opacity: 0.6;
        }
        .detail-item:has(.detail-empty) .detail-icon {
            opacity: 0.5;
        }
        .detail-item:has(.detail-empty) .detail-icon i {
            color: var(--muted);
        }
        .convenio-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        /* Footer do card */
        .patient-footer {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            background: var(--bg);
            border-top: 1px solid var(--border-color);
            margin-top: auto;
            width: 100%;
        }
        .patient-stats {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex: 1;
        }
        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: var(--muted);
        }
        .stat-item i {
            font-size: 0.75rem;
        }
        .quick-actions {
            display: flex;
            gap: 0.5rem;
        }
        .quick-action-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }
        .quick-action-btn.primary {
            background: var(--primary);
            color: white;
        }
        .quick-action-btn.info {
            background: var(--info);
            color: white;
        }
        .quick-action-btn.success {
            background: var(--success);
            color: white;
        }
        .quick-action-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        /* Estado vazio */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4rem 2rem;
            text-align: center;
            background: var(--card);
            border-radius: 16px;
            border: 2px dashed var(--border-color);
        }
        .empty-state-animation {
            position: relative;
            margin-bottom: 2rem;
        }
        .empty-state-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            animation: floatIcon 3s ease-in-out infinite;
            box-shadow: 0 10px 30px rgba(13, 148, 136, 0.3);
        }
        @keyframes floatIcon {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(5deg); }
        }
        .empty-state-particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: var(--primary);
            border-radius: 50%;
            animation: floatParticle 4s ease-in-out infinite;
        }
        .particle:nth-child(1) {
            top: 20%;
            left: 20%;
            animation-delay: 0s;
        }
        .particle:nth-child(2) {
            top: 60%;
            right: 30%;
            animation-delay: 1.5s;
        }
        .particle:nth-child(3) {
            bottom: 30%;
            left: 60%;
            animation-delay: 3s;
        }
        @keyframes floatParticle {
            0%, 100% {
                transform: translateY(0px) scale(1);
                opacity: 0.7;
            }
            50% {
                transform: translateY(-20px) scale(1.2);
                opacity: 1;
            }
        }
        .empty-state-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.5rem;
        }
        .empty-state-description {
            font-size: 1rem;
            color: var(--muted);
            margin-bottom: 2rem;
            line-height: 1.5;
            max-width: 500px;
        }
        .empty-state-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
        }
        .empty-state-btn {
            padding: 1rem 2rem;
            font-size: 1rem;
            border-radius: 12px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .empty-state-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }
        .empty-state-btn:hover::before {
            left: 100%;
        }
        .btn-secondary {
            background: var(--muted);
            color: white;
        }
        .btn-secondary:hover {
            background: var(--text);
            transform: translateY(-2px);
        }
        /* Skeleton loading */
        .patient-card-skeleton {
            background: var(--card);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            animation: pulse 1.5s ease-in-out infinite;
        }
        .skeleton-header {
            display: flex;
            align-items: center;
            padding: 1.5rem;
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
        }
        .skeleton-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.6);
            margin-right: 1rem;
            flex-shrink: 0;
        }
        .skeleton-info {
            flex: 1;
        }
        .skeleton-line {
            height: 12px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 6px;
            margin-bottom: 8px;
        }
        .skeleton-name {
            width: 70%;
            height: 16px;
        }
        .skeleton-meta {
            width: 50%;
        }
        .skeleton-body {
            padding: 1.5rem;
        }
        .skeleton-short {
            width: 60%;
        }
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.6;
            }
        }
        [data-theme="dark"] .skeleton-header {
            background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
        }
        [data-theme="dark"] .skeleton-line,
        [data-theme="dark"] .skeleton-avatar {
            background: rgba(55, 65, 81, 0.6);
        }
        /* Responsividade */
        @media (max-width: 767px) {
            .card-list-container {
                grid-template-columns: 1fr;
                gap: 1rem;
                padding: 0 0.5rem;
            }
            .patient-header {
                padding: 1rem;
            }
            .patient-avatar {
                width: 50px;
                height: 50px;
                font-size: 1.5rem;
                margin-right: 0.75rem;
            }
            .patient-name {
                font-size: 1.1rem;
            }
            .patient-meta {
                flex-direction: column;
                gap: 0.5rem;
            }
            .patient-details {
                padding: 1rem;
            }
            .patient-footer {
                padding: 0.75rem 1rem;
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }
            .patient-card-modern {
                width: 100%;
                max-width: 100%;
            }
            .detail-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
            }
            .detail-item {
                padding: 0.5rem;
            }
        }
        @media (min-width: 768px) and (max-width: 999px) {
            .card-list-container {
                padding: 0;
            }
            .patient-card-modern {
                width: 100%;
                max-width: 100%;
            }
            .detail-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
        }
        @media (min-width: 1000px) {
            .card-list-container {
                padding: 0;
            }
            .patient-card-modern {
                width: 100%;
                max-width: 100%;
                min-height: 300px;
            }
            .detail-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
        }
        .paciente-card:not(.modern-card) {
            background-color: var(--card);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 1rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: default;
            position: relative;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .paciente-card:not(.modern-card):hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .paciente-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .paciente-card-header h4 {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text);
            margin: 0;
            flex-grow: 1;
        }
        [data-theme="dark"] .paciente-card-header h4 {
            color: var(--dark-text);
        }
        .paciente-card-header .actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        .paciente-card-body {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            font-size: 0.95rem;
            align-items: center;
        }
        .paciente-card-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text);
            flex: 1;
        }
        .paciente-card-item i {
            color: var(--muted);
            font-size: 1rem;
            width: 20px;
            text-align: center;
            flex-shrink: 0;
        }
        .paciente-card-item .value {
            font-weight: 500;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-grow: 1;
        }
        [data-theme="dark"] .paciente-card-item .value {
            color: var(--dark-text);
        }
        /* --- Pagination Controls --- */
        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: var(--card);
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .pagination-button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            font-weight: 600;
        }
        .pagination-button:hover:not(:disabled) {
            background-color: var(--accent);
        }
        .pagination-button:disabled {
            background-color: var(--muted);
            cursor: not-allowed;
            opacity: 0.6;
        }
        .pagination-info {
            font-size: 1rem;
            color: var(--text);
            font-weight: 500;
        }
        .toast-container {
            position: fixed;
            top: 85px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 360px;
        }
        .toast {
            background-color: var(--card);
            color: var(--text);
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1), 0 5px 5px rgba(0,0,0,0.05);
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            border: 1px solid var(--border-color);
            animation: toast-slide-in 0.5s cubic-bezier(0.215, 0.610, 0.355, 1.000);
            position: relative;
            overflow: hidden;
        }
        .toast.success {
            border-left: 5px solid var(--success);
        }
        .toast.danger {
            border-left: 5px solid var(--danger);
        }
        .toast.warning {
            border-left: 5px solid var(--warning);
        }
        .toast.info {
            border-left: 5px solid var(--info);
        }
        .toast-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
            margin-top: 2px;
        }
        .toast.success .toast-icon {
            color: var(--success);
        }
        .toast.danger .toast-icon {
            color: var(--danger);
        }
        .toast.warning .toast-icon {
            color: var(--warning);
        }
        .toast.info .toast-icon {
            color: var(--info);
        }
        .toast-content {
            flex-grow: 1;
        }
        .toast-title {
            font-weight: 700;
            font-size: 1rem;
            color: var(--text);
            display: block;
            margin-bottom: 0.25rem;
        }
        .toast-message {
            font-size: 0.9rem;
            color: var(--muted);
            line-height: 1.4;
        }
        .toast-close {
            background: none;
            border: none;
            color: var(--muted);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            opacity: 0.7;
            transition: opacity 0.2s ease, color 0.2s ease;
            flex-shrink: 0;
        }
        .toast-close:hover {
            opacity: 1;
            color: var(--text);
        }
        .toast-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 4px;
            width: 100%;
            animation: toast-progress-bar 5s linear forwards;
        }
        .toast.success .toast-progress {
            background-color: var(--success);
        }
        .toast.danger .toast-progress {
            background-color: var(--danger);
        }
        .toast.warning .toast-progress {
            background-color: var(--warning);
        }
        .toast.info .toast-progress {
            background-color: var(--info);
        }
        @keyframes toast-slide-in {
            from {
                opacity: 0;
                transform: translateX(110%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        @keyframes toast-fade-out {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-20px);
            }
        }
        .toast.fade-out {
            animation: toast-fade-out 0.4s ease-in forwards;
        }
        @keyframes toast-progress-bar {
            from { width: 100%; }
            to { width: 0%; }
        }
        .toggle-btn-desktop { display: none; }
        .menu-btn-mobile { display: block; }
        span.btn-text-desktop { display: none; }

        @media(min-width: 769px) {
            .toggle-btn-desktop { display: grid; }
            .menu-btn-mobile { display: none; }
            span.btn-text-desktop { display: inline; }
        }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); box-shadow: 4px 0 15px rgba(0,0,0,0.1); }
            .sidebar.collapsed { transform: translateX(-100%); width: 280px; } /* Ajustado para 280px */
            .sidebar.collapsed nav ul li a, .sidebar.collapsed .sidebar-footer button, .sidebar.collapsed .sidebar-footer a { justify-content: flex-start; }
            .sidebar.collapsed nav ul li a span, .sidebar.collapsed .sidebar-footer span { display: inline; }
            .sidebar.collapsed .sidebar-header .logo span { display: inline; }
            .main-content, .main-content.collapsed { margin-left: 0; width: 100%; }
            main { padding: 1rem; }
            .topbar { flex-wrap: wrap; height: auto; row-gap: 1rem; padding-top: 1rem; padding-bottom: 1rem;}
            .topbar-left, .topbar-actions { width: 100%; justify-content: space-between; }
            .search-form { flex-grow: 1; }
            
            .paciente-card-header .actions {
                flex-direction: column;
                align-items: flex-end;
            }
            .paciente-card-header .actions .btn {
                width: auto;
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
            }
        }

        /* =================================
           MODAL MODERNA DE PACIENTE
        ================================= */
        #patient-steps-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            /* backdrop-filter: blur(12px); */
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3500;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #patient-steps-modal-overlay.visible {
            display: flex;
            opacity: 1;
        }

        #patient-steps-modal {
            background: var(--card);
            border-radius: 24px;
            width: 80vw; /* 80% da largura da viewport */
            height: 80vh; /* 80% da altura da viewport */
            max-width: 1400px; /* Largura m√°xima para telas muito grandes */
            max-height: 900px; /* Altura m√°xima para telas muito altas */
            min-width: 800px; /* Largura m√≠nima para telas pequenas */
            min-height: 600px; /* Altura m√≠nima para telas pequenas */
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            transform: scale(0.9) translateY(30px);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        #patient-steps-modal-overlay.visible #patient-steps-modal {
            transform: scale(1) translateY(0);
            position: relative;
            overflow: hidden;
        }

        /* Header moderno da modal */
        .modern-modal-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: white;
            padding: 1.5rem 2rem;
            height: 110px;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }

        .modern-modal-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
            opacity: 0.3;
        }

        .modal-header-content {
            position: relative;
            z-index: 2;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .modal-avatar {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
        }

        .modal-title-text h2 {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 0 0 0.25rem 0;
        }

        .modal-subtitle {
            font-size: 1rem;
            opacity: 0.9;
            margin: 0;
        }

        .modal-close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 2;
        }

        .modal-close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        /* Conte√∫do da modal */
        .modern-modal-body {
            flex: 1;
            height: 540px; /* Altura aumentada para evitar scroll */
            overflow: hidden;
            background: var(--card);
        }

        .modern-section {
            display: none;
        }

        .modern-section.active {
            display: block;
            animation: fadeInScale 0.4s ease;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: translateY(15px) scale(0.98);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .section-card {
            background: var(--card);
            padding: 2rem;
            padding-top: 0rem;
            height: 100%;
            overflow: hidden;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .section-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.3rem;
        }

        .section-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text);
            margin: 0;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem; /* Gap aumentado */
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem; /* Gap aumentado */
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        /* Layout espec√≠fico para dados pessoais */
        .personal-data-grid {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* Primeira linha: Nome 80% + G√™nero 20% */
        .personal-row-1 {
            display: grid;
            grid-template-columns: 4fr 1fr; /* 80% + 20% */
            gap: 1.5rem;
        }

        /* Segunda linha: 3 campos iguais */
        .personal-row-2 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr; /* 33.33% cada */
            gap: 1.5rem;
        }

        .form-label {
            font-weight: 600;
            color: var(--text);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .form-label .required {
            color: #ef4444;
            font-size: 1rem;
        }

        .form-input {
            padding: 1rem;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.2s ease;
            background: var(--card);
            color: var(--text);
            font-family: inherit;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(var(--primary-rgb, 85, 135, 194), 0.1);
            transform: translateY(-1px);
        }

        .form-input.error {
            border-color: #ef4444;
            box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.1);
            background: rgba(239, 68, 68, 0.05);
        }

        .form-input.success {
            border-color: #10b981;
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
            background: rgba(16, 185, 129, 0.05);
        }

        .form-input::placeholder {
            color: var(--muted);
        }

        /* Footer da modal */
        .modern-modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            padding: 0.75rem;
            background: var(--bg);
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
            width: 100%;
            position: absolute;
            bottom: 0px;
            right: 0px;
        }

        .progress-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            color: var(--muted);
            font-size: 0.9rem;
            padding: 1rem;
            padding-bottom: 0.5rem;
        }

        .progress-dots {
            display: flex;
            gap: 0.5rem;
        }

        .progress-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--border-color);
            transition: all 0.3s ease;
        }

        .progress-dot.active {
            background: var(--primary);
            transform: scale(1.2);
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
        }
        
        .patient-form {
            overflow-y: auto;
        }

        .modern-btn {
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-width: 120px;
            justify-content: center;
        }

        .modern-btn-secondary {
            background: var(--muted);
            color: white;
        }

        .modern-btn-secondary:hover {
            background: var(--text);
            transform: translateY(-1px);
        }

        .modern-btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 15px rgba(var(--primary-rgb, 85, 135, 194), 0.3);
        }

        .modern-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(var(--primary-rgb, 85, 135, 194), 0.4);
        }

        /* Responsividade */
        @media (max-width: 1200px) {
            #patient-steps-modal {
                width: 95vw;
                height: 85vh;
            }
            
            .modern-modal-body {
                height: calc(85vh - 200px); /* Ajustar conforme altura do header + footer */
            }
        }
        
        @media (max-width: 768px) {
            #patient-steps-modal {
                width: 100vw;
                height: 100vh;
                border-radius: 0;
            }
            
            .modern-modal-body {
                height: calc(100vh - 200px); /* Ajustar conforme altura do header + footer */
            }

            .modern-modal-header {
                padding: 1.5rem;
                height: 100px;
            }

            .modal-title-text h2 {
                font-size: 1.5rem;
            }

            .modern-tabs-container {
                padding: 0 1rem;
            }

            .modern-tab {
                padding: 0.75rem 1rem;
                font-size: 0.85rem;
            }

            .modern-modal-body {
                padding: 1.5rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            /* Layout responsivo para dados pessoais em tablets */
            .personal-row-1 {
                grid-template-columns: 3fr 1fr; /* Nome um pouco menor, g√™nero maior */
            }

            .personal-row-2 {
                grid-template-columns: 1fr 1fr; /* Apenas 2 colunas em tablets */
                grid-template-rows: auto auto; /* CPF e RG na primeira linha, Data na segunda */
            }

            .personal-row-2 .form-group:nth-child(3) {
                grid-column: 1 / -1; /* Data de nascimento ocupa toda a largura */
            }

            .section-card {
                padding: 1.5rem;
                padding-top: 0rem;
            }

            .modern-modal-footer {
                padding: 1rem;
                flex-direction: column;
                gap: 1rem;
            }

            .modal-actions {
                width: 100%;
                justify-content: space-between;
            }

            .modern-btn {
                flex: 1;
            }
        }

        /* Anima√ß√µes adicionais */
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(50px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-entering {
            animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* --- Modal de Confirma√ß√£o de Exclus√£o --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(15,23,42,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 4000;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        
        .modal-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }
        
        .delete-modal {
            background: var(--card);
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            max-width: 480px;
            width: 90vw;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        
        .modal-overlay.show .delete-modal {
            transform: scale(1);
        }
        
        .delete-modal .modal-header {
            padding: 2rem 2rem 1rem 2rem;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
        }
        
        .modal-icon-danger {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: rgba(220, 38, 38, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem auto;
            color: var(--danger);
            font-size: 2rem;
        }
        
        .delete-modal .modal-header h3 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text);
        }
        
        .delete-modal .modal-body {
            padding: 2rem;
        }
        
        .delete-modal .modal-body p {
            margin-bottom: 1rem;
            color: var(--text);
            line-height: 1.6;
        }
        
        .warning-text {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.2);
            border-radius: 8px;
            padding: 1rem;
            color: #d97706;
            font-size: 0.9rem;
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
        }
        
        .warning-text i {
            margin-top: 0.1rem;
            flex-shrink: 0;
        }
        
        .delete-modal .modal-footer {
            padding: 1rem 2rem 2rem 2rem;
            display: flex;
            gap: 1rem;
            justify-content: space-between;
        }
        
        .delete-modal .modal-footer .btn {
            min-width: 120px;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .delete-modal .modal-footer .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .delete-modal .modal-footer .btn-secondary {
            background: var(--muted);
            color: white;
        }
        
        .delete-modal .modal-footer .btn-secondary:hover:not(:disabled) {
            background: var(--text);
        }
        
        .delete-modal .modal-footer .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .delete-modal .modal-footer .btn-danger:hover:not(:disabled) {
            background: #b91c1c;
        }
        
        #patient-steps-modal {
            background: var(--card);
            border-radius: 18px;
            box-shadow: 0 10px 32px rgba(0,0,0,0.18);
            /* max-width: 700px;
            width: 95vw;
            max-height: 95vh; */
            overflow: auto;
            position: relative;
            padding: 0;
            display: flex;
            flex-direction: column;
        }
        .form-card {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            align-items: stretch;
        }
        .paciente-steps {
            display: flex;
            flex-direction: row;
            width: 100%;
            background: none;
            border-radius: 18px 18px 0 0;
            overflow: hidden;
        }
        .paciente-step {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 18px 0 14px 0;
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--muted);
            opacity: 0.7;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            background: none;
            transition: color 0.2s, opacity 0.2s, border-color 0.2s, background 0.2s;
        }
        .paciente-step.active {
            color: var(--primary);
            opacity: 1;
            border-bottom: 3px solid var(--primary);
            background: var(--primary-light);
        }
        .paciente-step i {
            font-size: 1.2rem;
            margin-right: 0.5rem;
        }
        @media (max-width: 600px) {
            #patient-steps-modal { max-width: 100vw; border-radius: 0; }
            .paciente-steps { flex-direction: column; border-radius: 0; }
            .paciente-step { border-bottom: none; border-left: 4px solid transparent; justify-content: flex-start; padding: 14px 0 14px 18px; }
            .paciente-step.active { border-left: 4px solid var(--primary); background: var(--primary-light); }
        }

        .paciente-card-section {
            background: var(--card);
            border-radius: 0px 0px 18px 18px;
            box-shadow: 0 4px 24px 0 rgb(0 0 0 / 0.07);
            padding: 2.5rem 2rem 2rem 2rem;
            /* min-height: 100%; */
            border: 1.5px solid var(--border-color);
            position: relative;
        }

        .paciente-card-container-modal {
            min-height: 80vh;
            min-width: 80vw;            

            display: flex;
            flex-direction: column;
            /* align-items: center; */
            justify-content: space-between;
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 1.5rem;
        }
        .section-title i {
            font-size: 1.2rem;
        }
        .paciente-card-fields {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.2rem 2rem;
        }
        .paciente-field {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .paciente-field label {
            font-size: 1.05rem;
            color: var(--muted);
            font-weight: 600;
            margin-bottom: 0.1rem;
        }
        .paciente-field input,
        .paciente-field select,
        .paciente-field textarea {
            background: transparent;
            border: none;
            border-bottom: 2px solid var(--border-color);
            font-size: 1.1rem;
            padding: 0.5rem 0.2rem 0.3rem 0.2rem;
            color: var(--text);
            transition: border-color 0.2s;
            border-radius: 0;
            outline: none;
        }
        .paciente-field input:focus,
        .paciente-field select:focus,
        .paciente-field textarea:focus {
            border-color: var(--primary);
            background: #f7fafc;
        }
        .paciente-field textarea {
            min-height: 60px;
            resize: vertical;
        }
        .paciente-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 2rem;
            /* position: absolute;
            bottom: 2rem; */
        }
        .paciente-btn {
            padding: 8px 16px;
            font-size: 1rem;
            border-radius: 8px;
            border: none;
            font-weight: 700;
            background: var(--primary);
            color: #fff;
            box-shadow: 0 2px 12px 0 rgb(13 148 136 / 0.10);
            cursor: pointer;
            transition: background 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .paciente-btn.cancel {
            background: transparent;
            color: var(--muted);
            box-shadow: none;
        }
        .paciente-btn:not(.cancel):hover {
            background: var(--accent);
        }
        @media (max-width: 600px) {
            #patient-drawer { width: 100vw; min-width: 0; }
            .form-card { flex-direction: column; }
            .paciente-steps { flex-direction: row; width: 100%; min-width: 0; height: auto; }
            .paciente-step { border-bottom: none; border-left: 4px solid transparent; justify-content: flex-start; padding: 14px 0 14px 18px; }
            .paciente-step.active { border-top: 4px solid var(--primary); border-left: none; }
            .paciente-card-section { border-radius: 0 0 18px 18px; }
        }

        /* --- Estilos para o input de data customizado --- */
        .date-input-display {
            position: relative;
            background: var(--card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 14px 16px;
            font-size: 1rem;
            font-weight: 500;
            color: var(--text);
            transition: all 0.3s ease;
            width: 100%;
            box-sizing: border-box;
        }

        .date-input-display:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.1);
        }

        .date-input-display::placeholder {
            color: var(--muted);
            font-weight: 400;
        }

        .date-input-display.error {
            border-color: var(--danger);
            background-color: rgba(220, 38, 38, 0.05);
        }

        .date-input-display.error:focus {
            border-color: var(--danger);
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }

        .date-input-display.valid {
            border-color: var(--success);
            background-color: rgba(22, 163, 74, 0.05);
        }

        /* --- Estilos para campos obrigat√≥rios --- */
        .paciente-field.required label::after {
            content: ' *';
            color: var(--danger);
            font-weight: 700;
            margin-left: 2px;
        }

        .paciente-field.required input,
        .paciente-field.required select,
        .paciente-field.required textarea {
            border-left: 3px solid var(--danger);
            padding-left: 8px;
        }

        .paciente-field.required input:focus,
        .paciente-field.required select:focus,
        .paciente-field.required textarea:focus {
            border-left-color: var(--primary);
            box-shadow: -3px 0 0 var(--primary);
        }

        .paciente-field.required input:valid,
        .paciente-field.required select.valid,
        .paciente-field.required textarea.valid {
            border-left-color: var(--success);
        }

        .paciente-field.required input:invalid,
        .paciente-field.required select.invalid,
        .paciente-field.required textarea.invalid {
            border-left-color: var(--danger);
        }

        /* Estilo espec√≠fico para o campo de data obrigat√≥rio */
        .paciente-field.required .date-input-display {
            border-left: 3px solid var(--danger);
            padding-left: 13px;
        }

        .paciente-field.required .date-input-display:focus {
            border-left-color: var(--primary);
            box-shadow: -3px 0 0 var(--primary), 0 0 0 3px rgba(13, 148, 136, 0.1);
        }

        .paciente-field.required .date-input-display.valid {
            border-left-color: var(--success);
        }

        .paciente-field.required .date-input-display.error {
            border-left-color: var(--danger);
        }

        /* Estados de valida√ß√£o para campos obrigat√≥rios */
        .paciente-field.required input.valid,
        .paciente-field.required select.valid,
        .paciente-field.required textarea.valid {
            border-bottom-color: var(--success);
            background-color: rgba(22, 163, 74, 0.05);
        }

        .paciente-field.required input.invalid,
        .paciente-field.required select.invalid,
        .paciente-field.required textarea.invalid {
            border-bottom-color: var(--danger);
            background-color: rgba(220, 38, 38, 0.05);
        }

        /* Anima√ß√£o sutil para transi√ß√£o de estados */
        .paciente-field input,
        .paciente-field select,
        .paciente-field textarea,
        .paciente-field .date-input-display {
            transition: all 0.3s ease;
        }

        /* Tooltip para campos obrigat√≥rios */
        .paciente-field.required {
            position: relative;
        }

        .paciente-field.required:hover::before {
            content: 'Campo obrigat√≥rio';
            position: absolute;
            top: -30px;
            left: 0;
            background: var(--text);
            color: var(--card);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: nowrap;
            z-index: 1000;
            opacity: 0.9;
        }

        /* Tooltip espec√≠fico para CPF */
        .paciente-field.required input[name="cpf"]:hover::after {
            content: 'Digite um CPF v√°lido';
            position: absolute;
            top: -30px;
            right: 0;
            background: var(--info);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: nowrap;
            z-index: 1001;
            opacity: 0.9;
        }

        /* Feedback visual para CPF inv√°lido */
        .paciente-field.required input[name="cpf"].invalid {
            border-bottom-color: var(--danger);
            background-color: rgba(220, 38, 38, 0.05);
            position: relative;
        }

        .paciente-field.required input[name="cpf"].invalid::placeholder {
            color: var(--danger);
        }

        /* Anima√ß√£o de shake para campos inv√°lidos no submit */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .paciente-field.required input.invalid.shake,
        .paciente-field.required select.invalid.shake,
        .paciente-field.required textarea.invalid.shake,
        .paciente-field.required .date-input-display.error.shake {
            animation: shake 0.5s ease-in-out;
            border-color: var(--danger) !important;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.2) !important;
        }

        /* Destaque mais forte para campos inv√°lidos */
        .paciente-field.required input.invalid,
        .paciente-field.required select.invalid,
        .paciente-field.required textarea.invalid {
            border-bottom-color: var(--danger) !important;
            border-left-color: var(--danger) !important;
            background-color: rgba(220, 38, 38, 0.1) !important;
        }

        .paciente-field.required .date-input-display.error {
            border-color: var(--danger) !important;
            border-left-color: var(--danger) !important;
            background-color: rgba(220, 38, 38, 0.1) !important;
        }

        /* Indicador visual para step com erro */
        .paciente-step.has-error {
            color: var(--danger) !important;
            border-bottom-color: var(--danger) !important;
            background: rgba(220, 38, 38, 0.1) !important;
        }

        .paciente-step.has-error::after {
            content: '‚ö†Ô∏è';
            margin-left: 5px;
            font-size: 0.9rem;
        }

        /* Nova modal para alertas gerais */
        .alert-modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(15,23,42,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 4500; /* Maior que outras modals */
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        .alert-modal-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }
        .alert-modal {
            background: var(--card);
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            max-width: 400px; /* Tamanho consistente */
            width: 90vw;
            transform: scale(0.95);
            transition: transform 0.3s ease;
            padding: 2rem;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }
        .alert-modal-overlay.show .alert-modal {
            transform: scale(1);
        }
        .alert-modal-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
        }
        .alert-modal-icon.info { background: var(--info); }
        .alert-modal-icon.success { background: var(--success); }
        .alert-modal-icon.warning { background: var(--warning); }
        .alert-modal-icon.danger { background: var(--danger); }

        .alert-modal-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--text);
            margin: 0;
        }
        .alert-modal-message {
            font-size: 1rem;
            color: var(--muted);
            line-height: 1.6;
        }
        .alert-modal-actions {
            display: flex;
            justify-content: center;
            width: 100%;
        }
        .alert-modal-actions .btn {
            min-width: 100px;
        }

        /* Sistema de Navega√ß√£o Moderna - Estilos Extras */
        .form-input.error {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Anima√ß√µes suaves para as se√ß√µes */
        .modern-section {
            opacity: 0;
            transform: translateX(20px);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
        }

        .modern-section.active {
            opacity: 1;
            transform: translateX(0);
            pointer-events: all;
        }

        /* Estados de hover mais refinados */
        .modern-tab:hover:not(.active) {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(168, 85, 247, 0.05));
            transform: translateY(-2px);
        }

        .modern-btn:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 8px 25px rgba(0, 0, 0, 0.12),
                0 0 0 1px rgba(255, 255, 255, 0.1) inset;
        }

        .progress-steps {
            display: flex;
            align-items: center;
            gap: 3rem;
            position: relative;
            padding: 0 1rem;
        }

        .progress-steps::before {
            content: '';
            position: absolute;
            top: 20px;
            left: calc(50px + 1rem);
            right: calc(50px + 1rem);
            height: 3px;
            background: linear-gradient(90deg, 
                rgba(99, 102, 241, 0.2) 0%, 
                rgba(168, 85, 247, 0.2) 100%);
            border-radius: 2px;
            z-index: 1;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            z-index: 2;
            min-width: 100px;
            flex: 1;
        }

        .progress-step:hover {
            transform: translateY(-2px);
        }

        .progress-step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--card);
            border: 3px solid rgba(99, 102, 241, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            color: var(--muted);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .progress-step-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--muted);
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
        }

        /* Estados ativos do indicador de progresso */
        .progress-step.active .progress-step-circle {
            background: linear-gradient(135deg, #6366f1, #a855f7);
            /* border-color: #6366f1; */
            color: white;
            box-shadow: 
                0 4px 20px rgba(99, 102, 241, 0.4),
                0 0 0 4px rgba(99, 102, 241, 0.1);
            transform: scale(1.1);
        }

        .progress-step.active .progress-step-label {
            color: var(--primary);
            font-weight: 600;
        }

        /* Estados de hover para steps n√£o ativos */
        .progress-step:not(.active):hover .progress-step-circle {
            border-color: rgba(99, 102, 241, 0.6);
            background: #FFFFFF;
            transform: scale(1.05);
        }

        .progress-step:not(.active):hover .progress-step-label {
            color: var(--text);
        }

        /* Linha de progresso din√¢mica */
        .progress-steps::after {
            content: '';
            position: absolute;
            top: 20px;
            /* left: 40px; */
            left: calc(50px + 1rem);
            right: calc(50px + 1rem);
            height: 3px;
            background: linear-gradient(90deg, #6366f1, #a855f7);
            border-radius: 2px;
            z-index: 1;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            width: 0%;
        }

        /* Responsividade do indicador de progresso */
        @media (max-width: 768px) {
            .progress-steps {
                gap: 2rem;
                padding: 0 0.5rem;
            }

            .progress-steps::before,
            .progress-steps::after {
                left: calc(35px + 0.5rem);
                right: calc(35px + 0.5rem);
            }

            .progress-step {
                min-width: 70px;
            }

            .progress-step-circle {
                width: 35px;
                height: 35px;
                font-size: 0.875rem;
            }

            .progress-step-label {
                font-size: 0.75rem;
                max-width: 70px;
                overflow: hidden;
                text-overflow: ellipsis;
            }
        }

        @media (max-width: 480px) {
            .progress-steps {
                gap: 1.5rem;
                padding: 0 0.25rem;
            }

            .progress-step {
                min-width: 60px;
            }

            .progress-step-circle {
                width: 30px;
                height: 30px;
                font-size: 0.75rem;
            }

            .progress-step-label {
                font-size: 0.65rem;
                max-width: 60px;
            }

            .progress-steps::before,
            .progress-steps::after {
                left: calc(30px + 0.25rem);
                right: calc(30px + 0.25rem);
            }
        }

        /* Melhorias nos inputs */
        .form-input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 
                0 0 0 3px rgba(99, 102, 241, 0.1),
                0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        .form-input::placeholder {
            color: var(--muted);
            opacity: 0.7;
        }

        /* Estilo para campos obrigat√≥rios */
        .required {
            color: #ef4444;
            font-weight: 600;
        }

        /* Transi√ß√µes suaves para o overlay */
        #patient-steps-modal-overlay {
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #patient-steps-modal-overlay.visible {
            opacity: 1;
        }

        #patient-steps-modal-overlay.visible #patient-steps-modal {
            transform: scale(1);
            opacity: 1;
        }

        #patient-steps-modal {
            transform: scale(0.95);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Efeitos de foco aprimorados */
        .modern-tab:focus,
        .modern-btn:focus,
        .form-input:focus {
            outline: 2px solid #6366f1;
            outline-offset: 2px;
        }

        /* Loading state para o bot√£o de salvar */
        .modern-btn.loading {
            position: relative;
            color: transparent;
        }

        .modern-btn.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* === DROPDOWN CUSTOMIZADO MODERNO === */
        .custom-select-wrapper {
            position: relative;
            width: 100%;
        }

        .custom-select {
            position: relative;
            width: 100%;
            user-select: none;
        }

        .custom-select-trigger {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            background: var(--card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-height: 50px;
            box-sizing: border-box;
        }

        .custom-select-trigger:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(85, 135, 194, 0.15);
        }

        .custom-select.open .custom-select-trigger {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary) 20%, transparent);
            border-bottom-left-radius: 4px;
            border-bottom-right-radius: 4px;
        }

        .custom-select-value {
            font-size: 0.95rem;
            color: var(--text);
            flex: 1;
            text-align: left;
        }

        .custom-select-value.placeholder {
            color: var(--muted);
        }

        .custom-select-arrow {
            font-size: 0.8rem;
            color: var(--muted);
            transition: transform 0.3s ease;
            margin-left: 0.5rem;
        }

        .custom-select.open .custom-select-arrow {
            transform: rotate(180deg);
            color: var(--primary);
        }

        .custom-select-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--card);
            border: 2px solid var(--primary);
            border-top: none;
            border-radius: 0 0 12px 12px;
            z-index: 1000;
            max-height: 140px;
            overflow-y: auto;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .custom-select.open .custom-select-options {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .custom-select-option {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid var(--border-color);
        }

        .custom-select-option:last-child {
            border-bottom: none;
        }

        .custom-select-option:hover {
            background: linear-gradient(135deg, var(--primary-light) 0%, color-mix(in srgb, var(--primary) 10%, transparent) 100%);
            color: var(--primary);
        }

        .custom-select-option.selected {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: white;
        }

        .custom-select-option.selected:hover {
            background: linear-gradient(135deg, var(--accent) 0%, var(--primary) 100%);
        }

        .option-icon {
            margin-right: 0.75rem;
            font-size: 0.9rem;
            width: 16px;
            text-align: center;
            opacity: 0.7;
        }

        .custom-select-option.selected .option-icon {
            opacity: 1;
        }

        .custom-select-option span {
            font-size: 0.95rem;
            font-weight: 500;
        }

        /* Scrollbar para as op√ß√µes */
        .custom-select-options::-webkit-scrollbar {
            width: 6px;
        }

        .custom-select-options::-webkit-scrollbar-track {
            background: var(--bg);
            border-radius: 3px;
        }

        .custom-select-options::-webkit-scrollbar-thumb {
            background: var(--muted);
            border-radius: 3px;
        }

        .custom-select-options::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        /* Estado de foco para acessibilidade */
        .custom-select-trigger:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary) 20%, transparent);
        }

        .custom-select-option:focus {
            outline: none;
            background: linear-gradient(135deg, var(--primary-light) 0%, color-mix(in srgb, var(--primary) 10%, transparent) 100%);
            color: var(--primary);
        }

        /* Anima√ß√£o suave para aparecer */
        @keyframes dropdownSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .custom-select.open .custom-select-options {
            animation: dropdownSlideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .custom-select-trigger {
                padding: 0.65rem 0.85rem;
                min-height: 46px;
            }
            
            .custom-select-option {
                padding: 0.65rem 0.85rem;
            }
            
            .option-icon {
                margin-right: 0.6rem;
            }
        }

        /* Dark mode */
        [data-theme="dark"] .custom-select-options {
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>
    <div id="toast-container"></div>
    <!-- Nova Modal para Alertas Gerais -->
    <div id="general-alert-modal-overlay" class="alert-modal-overlay">
        <div class="alert-modal">
            <div id="alert-modal-icon" class="alert-modal-icon"></div>
            <h3 id="alert-modal-title" class="alert-modal-title"></h3>
            <p id="alert-modal-message" class="alert-modal-message"></p>
            <div class="alert-modal-actions">
                <button id="alert-modal-close-btn" class="btn btn-primary">OK</button>
            </div>
        </div>
    </div>

    <div class="layout">
        {% include 'Nav.html' %}

        <div class="main-content">
            <header class="topbar">
                <div class="topbar-left">
                    <button class="toggle-btn menu-btn-mobile"><i class="fa-solid fa-bars"></i></button>
                    <button class="toggle-btn toggle-btn-desktop"><i class="fa-solid fa-bars-staggered"></i></button>
                    <h1 class="page-title">Gerenciar Pacientes</h1>
                </div>
                <div class="topbar-actions">
                    <form id="searchForm" class="search-form"> {# Adicionado ID para o formul√°rio #}
                        <input type="text" id="searchInput" name="search" placeholder="Buscar paciente..." class="search-input" value="{{ search_query or '' }}">
                        <button type="submit" class="search-button"><i class="fas fa-search"></i></button>
                    </form>
                    <button id="add-patient-btn" class="btn btn-primary" type="button" onclick="openPatientModal()">
                        <i class="fas fa-plus"></i> <span class="btn-text-desktop">Adicionar Paciente</span>
                    </button>
                </div>
            </header>

            <main>
                {# O bloco de flash messages ser√° tratado via JS/Toast #}

                <div class="card-list-container">
                    {# Os cards de paciente ser√£o renderizados aqui via JavaScript #}
                </div>
                <p id="no-results-message" style="text-align: center; color: var(--muted); padding: 2rem; width: 100%; display: none;">Nenhum paciente encontrado.</p>

                <div class="pagination-controls">
                    <button id="prevPageBtn" class="pagination-button"><i class="fas fa-chevron-left"></i> Anterior</button>
                    <span id="pageInfo" class="pagination-info"></span>
                    <button id="nextPageBtn" class="pagination-button">Pr√≥ximo <i class="fas fa-chevron-right"></i></button>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal Moderna de Paciente -->
    <div id="patient-steps-modal-overlay" style="display:none; z-index:3500; align-items:center; justify-content:center;">
        <div id="patient-steps-modal">
            <!-- Header Moderno -->
            <div class="modern-modal-header">
                <div class="modal-header-content">
                    <div class="modal-title-section">
                        <div class="modal-avatar">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <div class="modal-title-text">
                            <h2 id="modal-dynamic-title">Novo Paciente</h2>
                            <p class="modal-subtitle">Preencha as informa√ß√µes do paciente</p>
                        </div>
                    </div>
                    <button type="button" class="modal-close-btn steps-modal-close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="progress-indicator">
                <div class="progress-steps">
                    <div class="progress-step active" data-section="personal">
                        <div class="progress-step-circle">
                            <i class="fas fa-user"></i>
                        </div>
                        <span class="progress-step-label">Dados Pessoais</span>
                    </div>
                    <div class="progress-step" data-section="contact">
                        <div class="progress-step-circle">
                            <i class="fas fa-phone"></i>
                        </div>
                        <span class="progress-step-label">Contato</span>
                    </div>
                    <div class="progress-step" data-section="address">
                        <div class="progress-step-circle">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <span class="progress-step-label">Endere√ßo</span>
                    </div>
                    <div class="progress-step" data-section="medical">
                        <div class="progress-step-circle">
                            <i class="fas fa-heartbeat"></i>
                        </div>
                        <span class="progress-step-label">M√©dico</span>
                    </div>
                </div>
            </div>
            
            <!-- Formul√°rio -->
            <form id="steps-patient-form" class="patient-form" action="{{ url_for('adicionar_paciente') }}" method="post">
                <div class="modern-modal-body">
                    
                    <!-- Se√ß√£o: Dados Pessoais -->
                    <div class="modern-section active" data-section="personal">
                        <div class="section-card">
                            
                            <div class="section-header"></div>

                            <div class="personal-data-grid">
                                <div class="personal-row-1">
                                    <div class="form-group">
                                        <label class="form-label">
                                            Nome Completo <span class="required">*</span>
                                        </label>
                                        <input type="text" id="steps-nome" name="nome" class="form-input" placeholder="Digite o nome completo" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">G√™nero</label>
                                        <div class="custom-select-wrapper">
                                            <div class="custom-select" id="steps-genero-dropdown">
                                                <div class="custom-select-trigger">
                                                    <span class="custom-select-value" data-default="Selecionar">Selecionar</span>
                                                    <i class="fas fa-chevron-down custom-select-arrow"></i>
                                                </div>
                                                <div class="custom-select-options">
                                                    <div class="custom-select-option" data-value="">
                                                        <i class="fas fa-user-question option-icon"></i>
                                                        <span>Selecionar</span>
                                                    </div>
                                                    <div class="custom-select-option" data-value="Masculino">
                                                        <i class="fas fa-mars option-icon"></i>
                                                        <span>Masculino</span>
                                                    </div>
                                                    <div class="custom-select-option" data-value="Feminino">
                                                        <i class="fas fa-venus option-icon"></i>
                                                        <span>Feminino</span>
                                                    </div>
                                                    <div class="custom-select-option" data-value="Outro">
                                                        <i class="fas fa-genderless option-icon"></i>
                                                        <span>Outro</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <input type="hidden" id="steps-genero" name="genero" value="">
                                        </div>
                                    </div>
                                </div>

                                <div class="personal-row-2">
                                    <div class="form-group">
                                        <label class="form-label">
                                            CPF <span class="required">*</span>
                                        </label>
                                        <input type="text" id="steps-cpf" name="cpf" class="form-input" placeholder="000.000.000-00" required>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">RG</label>
                                        <input type="text" id="steps-rg" name="rg" class="form-input" placeholder="00.000.000-0">
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">
                                            Data de Nascimento <span class="required">*</span>
                                        </label>
                                        <input type="text" 
                                                id="steps-data_nascimento_display" 
                                                placeholder="DD/MM/AAAA" 
                                                maxlength="10" 
                                                class="form-input date-input-display"
                                                required>
                                        <input type="hidden" id="steps-data_nascimento" name="data_nascimento" required>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Se√ß√£o: Contato -->
                    <div class="modern-section" data-section="contact">
                        <div class="section-card">

                            <div class="section-header"></div>

                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Telefone Principal</label>
                                    <input type="tel" id="steps-telefone" name="telefone" class="form-input" placeholder="(00) 00000-0000">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">E-mail</label>
                                    <input type="email" id="steps-email" name="email" class="form-input" placeholder="email@exemplo.com">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Se√ß√£o: Endere√ßo -->
                    <div class="modern-section" data-section="address">
                        <div class="section-card">

                            <div class="section-header"></div>

                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">CEP</label>
                                    <input type="text" id="steps-cep" name="cep" class="form-input" placeholder="00000-000">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">
                                        Cidade <span class="required">*</span>
                                    </label>
                                    <input type="text" id="steps-cidade" name="cidade" class="form-input" placeholder="Digite a cidade" required>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">
                                        Estado <span class="required">*</span>
                                    </label>
                                    <input type="text" id="steps-estado" name="estado" class="form-input" placeholder="SP" maxlength="2" required>
                                </div>

                                <div class="form-group full-width">
                                    <label class="form-label">Logradouro</label>
                                    <input type="text" id="steps-logradouro" name="logradouro" class="form-input" placeholder="Rua, Avenida, etc.">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">N√∫mero</label>
                                    <input type="text" id="steps-numero" name="numero" class="form-input" placeholder="123">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Bairro</label>
                                    <input type="text" id="steps-bairro" name="bairro" class="form-input" placeholder="Nome do bairro">
                                </div>

                                <div class="form-group full-width">
                                    <label class="form-label">Complemento</label>
                                    <input type="text" id="steps-complemento" name="complemento" class="form-input" placeholder="Apartamento, sala, etc.">
                                </div>

                            </div>
                        </div>
                    </div>

                    <!-- Se√ß√£o: Informa√ß√µes M√©dicas -->
                    <div class="modern-section" data-section="medical">
                        <div class="section-card">

                            <div class="section-header"></div>

                            <div class="form-grid">

                                <div class="form-group full-width">
                                    <label class="form-label">Conv√™nio</label>
                                    <div class="custom-select-wrapper">
                                        <div class="custom-select" id="steps-convenio-dropdown">
                                            <div class="custom-select-trigger">
                                                <span class="custom-select-value" data-default="Particular">Particular</span>
                                                <i class="fas fa-chevron-down custom-select-arrow"></i>
                                                </div>
                                            <div class="custom-select-options">
                                                <div class="custom-select-option" data-value="">
                                                    <i class="fas fa-user option-icon"></i>
                                                    <span>Particular</span>
                                                </div>
                                                {% for convenio in convenios %}
                                                <div class="custom-select-option" data-value="{{ convenio.id }}">
                                                    <i class="fas fa-hospital option-icon"></i>
                                                    <span>{{ convenio.nome }}</span>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <input type="hidden" id="steps-convenio_id" name="convenio_id" value="">
                                    </div>
                                </div>

                                <div class="form-group full-width">
                                    <label class="form-label">Observa√ß√µes M√©dicas</label>
                                    <textarea id="steps-observacoes" name="observacoes" class="form-input" rows="3" placeholder="Alergias, medicamentos, observa√ß√µes importantes..."></textarea>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Nome do Respons√°vel 1</label>
                                    <input type="text" id="steps-responsavel1_nome" name="responsavel1_nome" class="form-input" placeholder="Nome completo">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Telefone do Respons√°vel 1</label>
                                    <input type="tel" id="steps-responsavel1_telefone" name="responsavel1_telefone" class="form-input" placeholder="(00) 00000-0000">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Nome do Respons√°vel 2</label>
                                    <input type="text" id="steps-responsavel2_nome" name="responsavel2_nome" class="form-input" placeholder="Nome completo">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Telefone do Respons√°vel 2</label>
                                    <input type="tel" id="steps-responsavel2_telefone" name="responsavel2_telefone" class="form-input" placeholder="(00) 00000-0000">
                                </div>

                            </div>
                        </div>
                    </div>

                </div>

                <!-- Footer Moderno -->
                <div class="modern-modal-footer">
                    <div class="modal-actions">
                        <button id="dynamic-patient-btn" type="submit" class="modern-btn modern-btn-primary">
                            <!-- T√≠tulo din√¢mico -->
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentSection = 'personal';
        let modal = null;
        let form = null;
        let sections = null;
        let progressSteps = null;

        function initializePatientModal() {
            modal = document.getElementById('patient-steps-modal-overlay');
            form = document.getElementById('steps-patient-form');
            sections = document.querySelectorAll('.modern-section');
            progressSteps = document.querySelectorAll('.progress-step');
            
            if (!modal || !form) return;

            document.querySelectorAll('.steps-modal-close').forEach(btn => {
                btn.addEventListener('click', () => closePatientModal());
            });

            progressSteps.forEach(step => {
                step.addEventListener('click', (e) => {
                    e.preventDefault();
                    const section = step.getAttribute('data-section');
                    navigateToSection(section);
                });
            });

            form.addEventListener('submit', (e) => {
                handleFormSubmit(e);
            });

            initializeInputMasks();
            initializeCustomDropdowns();
        }

        function initializeCustomDropdowns() {
            const customSelects = document.querySelectorAll('.custom-select');
            
            customSelects.forEach(customSelect => {
                // Remover event listeners existentes para evitar duplicatas
                const existingTrigger = customSelect.querySelector('.custom-select-trigger');
                if (existingTrigger._initialized) return;
                
                const trigger = customSelect.querySelector('.custom-select-trigger');
                const options = customSelect.querySelector('.custom-select-options');
                const valueSpan = customSelect.querySelector('.custom-select-value');
                const hiddenInput = customSelect.parentElement.querySelector('input[type="hidden"]');
                const defaultText = valueSpan.getAttribute('data-default');
                
                // Abrir/fechar dropdown
                trigger.addEventListener('click', (e) => {
                    e.stopPropagation();
                    
                    // Fechar outros dropdowns
                    customSelects.forEach(otherSelect => {
                        if (otherSelect !== customSelect) {
                            otherSelect.classList.remove('open');
                        }
                    });
                    
                    customSelect.classList.toggle('open');
                });
                
                trigger._initialized = true;
                
                // Selecionar op√ß√£o
                options.addEventListener('click', (e) => {
                    const option = e.target.closest('.custom-select-option');
                    if (!option) return;
                    
                    const value = option.getAttribute('data-value');
                    
                    // Atualizar valor
                    hiddenInput.value = value;
                    // Usar innerHTML para preservar √≠cones
                    valueSpan.innerHTML = option.innerHTML;
                    
                    // Atualizar classes visuais
                    if (value === '') {
                        valueSpan.classList.add('placeholder');
                    } else {
                        valueSpan.classList.remove('placeholder');
                    }
                    
                    // Atualizar op√ß√µes selecionadas
                    options.querySelectorAll('.custom-select-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    option.classList.add('selected');
                    
                    // Fechar dropdown
                    customSelect.classList.remove('open');
                    
                    e.stopPropagation();
                });
                
                // Suporte a teclado
                trigger.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        trigger.click();
                    } else if (e.key === 'Escape') {
                        customSelect.classList.remove('open');
                    }
                });
                
                // Navega√ß√£o por teclado nas op√ß√µes
                options.addEventListener('keydown', (e) => {
                    const optionsList = options.querySelectorAll('.custom-select-option');
                    const currentIndex = Array.from(optionsList).findIndex(opt => opt.classList.contains('focused'));
                    
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        const nextIndex = currentIndex < optionsList.length - 1 ? currentIndex + 1 : 0;
                        optionsList.forEach(opt => opt.classList.remove('focused'));
                        optionsList[nextIndex].classList.add('focused');
                        optionsList[nextIndex].focus();
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        const prevIndex = currentIndex > 0 ? currentIndex - 1 : optionsList.length - 1;
                        optionsList.forEach(opt => opt.classList.remove('focused'));
                        optionsList[prevIndex].classList.add('focused');
                        optionsList[prevIndex].focus();
                    } else if (e.key === 'Enter') {
                        e.preventDefault();
                        if (currentIndex >= 0) {
                            optionsList[currentIndex].click();
                        }
                    }
                });
            });
            
            // Fechar dropdown ao clicar fora (adicionar apenas uma vez)
            if (!document._dropdownClickListenerAdded) {
                document.addEventListener('click', () => {
                    customSelects.forEach(customSelect => {
                        customSelect.classList.remove('open');
                    });
                });
                document._dropdownClickListenerAdded = true;
            }
        }

        function initializeInputMasks() {
            const cpfInput = document.getElementById('steps-cpf');
            if (cpfInput) {
                cpfInput.addEventListener('input', (e) => {
                    let value = e.target.value.replace(/\D/g, '');
                    value = value.replace(/(\d{3})(\d)/, '$1.$2');
                    value = value.replace(/(\d{3})(\d)/, '$1.$2');
                    value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
                    e.target.value = value;
                });
            }

            // M√°scara para telefone
            const phoneInputs = document.querySelectorAll('input[type="tel"]');
            phoneInputs.forEach(input => {
                input.addEventListener('input', (e) => {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length <= 10) {
                        value = value.replace(/(\d{2})(\d)/, '($1) $2');
                        value = value.replace(/(\d{4})(\d)/, '$1-$2');
                    } else {
                        value = value.replace(/(\d{2})(\d)/, '($1) $2');
                        value = value.replace(/(\d{5})(\d)/, '$1-$2');
                    }
                    e.target.value = value;
                });
            });

            // M√°scara para data
            const dateDisplay = document.getElementById('steps-data_nascimento_display');
            const dateHidden = document.getElementById('steps-data_nascimento');
            if (dateDisplay && dateHidden) {
                dateDisplay.addEventListener('input', (e) => {
                    let value = e.target.value.replace(/\D/g, '');
                    value = value.replace(/(\d{2})(\d)/, '$1/$2');
                    value = value.replace(/(\d{2})(\d)/, '$1/$2');
                    e.target.value = value;

                    // Converter para formato ISO para o input hidden
                    if (value.length === 10) {
                        const [day, month, year] = value.split('/');
                        if (day && month && year && year.length === 4) {
                            // Validar se √© uma data v√°lida
                            const dayNum = parseInt(day);
                            const monthNum = parseInt(month);
                            const yearNum = parseInt(year);
                            
                            if (dayNum >= 1 && dayNum <= 31 && monthNum >= 1 && monthNum <= 12 && yearNum >= 1900) {
                                const testDate = new Date(yearNum, monthNum - 1, dayNum);
                                // Verificar se a data √© v√°lida (ex: 31/02 n√£o √© v√°lido)
                                if (testDate.getDate() === dayNum && testDate.getMonth() === monthNum - 1) {
                                    dateHidden.value = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                                    e.target.classList.remove('error');
                                    e.target.classList.add('success');
                                } else {
                                    e.target.classList.add('error');
                                    e.target.classList.remove('success');
                                }
                            } else {
                                e.target.classList.add('error');
                                e.target.classList.remove('success');
                            }
                        }
                    } else {
                        e.target.classList.remove('error', 'success');
                        dateHidden.value = '';
                    }
                });
            }

            // M√°scara para CEP
            const cepInput = document.getElementById('steps-cep');
            if (cepInput) {
                cepInput.addEventListener('input', (e) => {
                    let value = e.target.value.replace(/\D/g, '');
                    value = value.replace(/(\d{5})(\d)/, '$1-$2');
                    e.target.value = value;
                });
            }
        }

        function navigateToSection(sectionName) {
            currentSection = sectionName;

            sections.forEach(section => {
                section.classList.toggle('active', section.getAttribute('data-section') === sectionName);
            });

            progressSteps.forEach(step => {
                step.classList.toggle('active', step.getAttribute('data-section') === sectionName);
            });

            updateProgressLine(sectionName);
        }

        function updateProgressLine(currentSection) {
            const progressLine = document.querySelector('.progress-steps::after');
            const sectionOrder = ['personal', 'contact', 'address', 'medical'];
            const currentIndex = sectionOrder.indexOf(currentSection);
            let progressPercentage = 0;
            if (currentIndex === 0) {
                progressPercentage = 0;
            } else if (currentIndex === 1) {
                progressPercentage = 25;
            } else if (currentIndex === 2) {
                progressPercentage = 50; // 25% a mais na terceira
            } else if (currentIndex === 3) {
                progressPercentage = 80; // 30% a mais na √∫ltima
            }
            
            const style = document.getElementById('progress-line-style') || document.createElement('style');
            style.id = 'progress-line-style';
            style.textContent = `
                .progress-steps::after {
                    width: ${progressPercentage}% !important;
                }
            `;
            
            if (!document.getElementById('progress-line-style')) {
                document.head.appendChild(style);
            }
        }

        function openPatientModal(patientData = null) {
            initializeCustomDropdowns();
            
            if (patientData) {
                // Preenche o formul√°rio com os dados do paciente
                setTimeout(() => {
                    populateForm(patientData);
                }, 50);
                
                document.getElementById('modal-dynamic-title').textContent = 'Editar Paciente';
                document.querySelector('.modal-subtitle').textContent = 'Atualize as informa√ß√µes do paciente';

                // Atualiza o bot√£o din√¢mico
                document.getElementById('dynamic-patient-btn').textContent = 'Salvar paciente';
            } else {
                // Limpa o formul√°rio e prepara para novo paciente
                clearForm();
                
                document.getElementById('modal-dynamic-title').textContent = 'Novo Paciente';
                document.querySelector('.modal-subtitle').textContent = 'Preencha as informa√ß√µes do paciente';

                // Atualiza o bot√£o din√¢mico
                document.getElementById('dynamic-patient-btn').textContent = 'Cadastrar paciente';
            }

            navigateToSection('personal');
            
            openModal({
                modalSelector: '#patient-steps-modal-overlay',
                backdropId: 'patient-modal-backdrop',
                onOpen: () => {
                    setTimeout(() => {
                        const firstInput = document.getElementById('steps-nome');
                        if (firstInput) firstInput.focus();
                    }, 100);
                },
                onBackdropClick: (e) => {
                    if (e.target.id === 'patient-modal-backdrop') {
                        closePatientModal();
                    }
                }
            });
        }

        function closePatientModal() {
            closeModal({
                modalSelector: '#patient-steps-modal-overlay',
                backdropId: 'patient-modal-backdrop',
                onClose: () => {
                    clearForm();
                }
            });
        }

        function populateForm(patientData) {
                const fieldMappings = {
                    'telefone': 'contato_telefone',
                    'email': 'contato_email',
                    'cep': ['endereco', 'cep'],
                    'cidade': ['endereco', 'cidade'],
                    'estado': ['endereco', 'estado'],
                    'logradouro': ['endereco', 'logradouro'],
                    'numero': ['endereco', 'numero'],
                    'bairro': ['endereco', 'bairro'],
                    'complemento': ['endereco', 'complemento']
                };
                
                const fields = [
                    'nome', 'cpf', 'rg', 'genero', 'telefone', 'email',
                    'cep', 'cidade', 'estado', 'logradouro', 'numero', 'bairro', 
                    'complemento', 'convenio_id', 'observacoes',
                    'responsavel1_nome', 'responsavel1_telefone',
                    'responsavel2_nome', 'responsavel2_telefone'
                ];

                fields.forEach(field => {
                    if (field === 'genero') {
                        if (patientData[field]) {
                            const customSelect = document.getElementById('steps-genero-dropdown');
                            const valueSpan = customSelect.querySelector('.custom-select-value');
                            const hiddenInput = document.getElementById('steps-genero');
                            const option = customSelect.querySelector(`.custom-select-option[data-value="${patientData[field]}"]`);
                            
                            if (option) {
                                hiddenInput.value = patientData[field];
                                // Usar innerHTML para preservar os √≠cones
                                valueSpan.innerHTML = option.innerHTML;
                                valueSpan.classList.remove('placeholder');
                                
                                // Atualizar visual das op√ß√µes
                                customSelect.querySelectorAll('.custom-select-option').forEach(opt => {
                                    opt.classList.remove('selected');
                                });
                                option.classList.add('selected');
                            }
                        }
                    } else if (field === 'convenio_id') {
                        // Tratar dropdown customizado de conv√™nio
                        const customSelect = document.getElementById('steps-convenio-dropdown');
                        const valueSpan = customSelect.querySelector('.custom-select-value');
                        const hiddenInput = document.getElementById('steps-convenio_id');
                        const targetValue = patientData[field] || '';
                        const option = customSelect.querySelector(`.custom-select-option[data-value="${targetValue}"]`);
                        
                        if (option) {
                            hiddenInput.value = targetValue;
                            // Usar innerHTML para preservar os √≠cones
                            valueSpan.innerHTML = option.innerHTML;
                            
                            if (targetValue === '') {
                                valueSpan.classList.add('placeholder');
                            } else {
                                valueSpan.classList.remove('placeholder');
                            }
                            
                            // Atualizar visual das op√ß√µes
                            customSelect.querySelectorAll('.custom-select-option').forEach(opt => {
                                opt.classList.remove('selected');
                            });
                            option.classList.add('selected');
                        }
                    } else {
                        const input = document.getElementById(`steps-${field}`);
                        
                        let fieldValue = null;
                        if (fieldMappings[field]) {
                            const mapping = fieldMappings[field];
                            if (Array.isArray(mapping)) {
                                fieldValue = patientData[mapping[0]] ? patientData[mapping[0]][mapping[1]] : null;
                            } else {
                                fieldValue = patientData[mapping];
                            }
                        } else {
                            fieldValue = patientData[field];
                        }
                        
                        if (input && fieldValue) {
                            input.value = fieldValue;
                        }
                    }
                });

                if (patientData.data_nascimento) {
                    const dateHidden = document.getElementById('steps-data_nascimento');
                    const dateDisplay = document.getElementById('steps-data_nascimento_display');
                    if (dateHidden && dateDisplay) {
                        dateHidden.value = patientData.data_nascimento;
                        
                        // Converter data para formato brasileiro (DD/MM/AAAA)
                        let displayValue = '';
                        try {
                            // Se a data est√° em formato ISO (YYYY-MM-DD)
                            if (patientData.data_nascimento.includes('-') && patientData.data_nascimento.length === 10) {
                                const [year, month, day] = patientData.data_nascimento.split('-');
                                displayValue = `${day.padStart(2, '0')}/${month.padStart(2, '0')}/${year}`;
                            } 
                            // Se a data √© um objeto Date ou string que precisa ser convertida
                            else {
                                const date = new Date(patientData.data_nascimento);
                                if (!isNaN(date.getTime())) {
                                    const day = String(date.getDate()).padStart(2, '0');
                                    const month = String(date.getMonth() + 1).padStart(2, '0');
                                    const year = date.getFullYear();
                                    displayValue = `${day}/${month}/${year}`;
                                    // Tamb√©m atualize o campo hidden com formato correto
                                    dateHidden.value = `${year}-${month}-${day}`;
                                }
                            }
                        } catch (error) {
                            console.error('Erro ao formatar data:', error);
                            displayValue = patientData.data_nascimento;
                        }
                        
                        dateDisplay.value = displayValue;
                    }
                }

            form.action = `/pacientes/editar/${patientData.id}`;
        }

        function clearForm() {
            form.reset();
            form.action = '{{ url_for("adicionar_paciente") }}';
            
            // Limpar campos espec√≠ficos dessa desgra√ßa
            const dateHidden = document.getElementById('steps-data_nascimento');
            const dateDisplay = document.getElementById('steps-data_nascimento_display');
            if (dateHidden) dateHidden.value = '';
            if (dateDisplay) dateDisplay.value = '';
            
            // Resetar dropdown customizado de g√™nero
            const generoDropdown = document.getElementById('steps-genero-dropdown');
            const generoValueSpan = generoDropdown.querySelector('.custom-select-value');
            const generoHiddenInput = document.getElementById('steps-genero');
            const generoDefaultText = generoValueSpan.getAttribute('data-default');
            
            generoHiddenInput.value = '';
            generoValueSpan.textContent = generoDefaultText;
            generoValueSpan.classList.add('placeholder');
            
            // Remover sele√ß√£o visual
            generoDropdown.querySelectorAll('.custom-select-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // Resetar dropdown customizado de conv√™nio
            const convenioDropdown = document.getElementById('steps-convenio-dropdown');
            const convenioValueSpan = convenioDropdown.querySelector('.custom-select-value');
            const convenioHiddenInput = document.getElementById('steps-convenio_id');
            
            // Resetar para "Particular" (valor padr√£o)
            convenioHiddenInput.value = '';
            convenioValueSpan.innerHTML = '<i class="fas fa-hospital"></i> Particular';
            convenioValueSpan.classList.remove('placeholder');
            
            // Remover sele√ß√£o visual e marcar "Particular" como selecionado
            convenioDropdown.querySelectorAll('.custom-select-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            const particularOption = convenioDropdown.querySelector('.custom-select-option[data-value=""]');
            if (particularOption) {
                particularOption.classList.add('selected');
            }
        }

        function handleFormSubmit(e) {
                // Valida√ß√£o b√°sica aprende caf√©
                const requiredFields = ['steps-nome', 'steps-cpf', 'steps-data_nascimento', 'steps-cidade', 'steps-estado'];
                let isValid = true;

                requiredFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field && !field.value.trim()) {
                        isValid = false;
                        field.classList.add('error');
                        
                        // Remover classe de erro ap√≥s um tempo pra n encher o saco
                        setTimeout(() => {
                            field.classList.remove('error');
                        }, 3000);
                    }
                });

                if (!isValid) {
                    e.preventDefault();
                    showToast('Por favor, preencha todos os campos obrigat√≥rios', 'error');
                    return;
                }

            // Se chegou at√© aqui, o formul√°rio pode ser enviado
            showToast('Salvando dados...', 'info');
        }

        document.addEventListener('DOMContentLoaded', function() {
            initializePatientModal();
        });

        // === SISTEMA CENTRALIZADO DE GERENCIAMENTO DE BACKDROP (se algu√©m quebrar come√ßa a rezar) ===
        
        /**
         * Fun√ß√£o gen√©rica para criar backdrop de modal
         * @param {Object} options - Configura√ß√µes do backdrop
         * @param {string} options.id - ID √∫nico do backdrop (default: 'modal-backdrop')
         * @param {number} options.zIndex - Z-index do backdrop (default: 3400)
         * @param {string} options.opacity - Opacidade do backdrop (default: '0.5')
         * @param {Function} options.onClick - Fun√ß√£o a ser executada no clique do backdrop
         * @param {boolean} options.closeOnClick - Se deve fechar ao clicar no backdrop (default: true)
         */

        function createModalBackdrop(options = {}) {
            const config = {
                id: options.id || 'modal-backdrop',
                zIndex: options.zIndex || 3400,
                opacity: options.opacity || '0.5',
                onClick: options.onClick || null,
                closeOnClick: options.closeOnClick !== false,
                ...options
            };

            // Remove backdrop existente com mesmo ID se houver
            const existingBackdrop = document.getElementById(config.id);
            if (existingBackdrop) {
                existingBackdrop.remove();
            }

            const backdrop = document.createElement('div');
            backdrop.id = config.id;
            backdrop.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, ${config.opacity});
                z-index: ${config.zIndex};
                pointer-events: auto;
                transition: opacity 0.3s ease;
                opacity: 0;
            `;

            // Adicionar event listener se especificado
            if (config.onClick) {
                backdrop.addEventListener('click', config.onClick);
            }

            document.body.appendChild(backdrop);
            
            // Bloquear scroll do body
            document.body.style.overflow = 'hidden';

            // Anima√ß√£o de fade in
            requestAnimationFrame(() => {
                backdrop.style.opacity = config.opacity;
            });

            return backdrop;
        }

        /**
         * Fun√ß√£o gen√©rica para remover backdrop de modal
         * @param {string} backdropId - ID do backdrop a ser removido (default: 'modal-backdrop')
         * @param {Function} onComplete - Callback executado ap√≥s remo√ß√£o
         */

        function removeModalBackdrop(backdropId = 'modal-backdrop', onComplete = null) {
            const backdrop = document.getElementById(backdropId);
            if (backdrop) {
                // Anima√ß√£o de fade out
                backdrop.style.opacity = '0';
                
                setTimeout(() => {
                    if (backdrop.parentNode) {
                        backdrop.remove();
                    }
                    
                    // Restaurar scroll do body apenas se n√£o h√° outros backdrops
                    const allBackdrops = document.querySelectorAll('[id$="-backdrop"], #modal-backdrop');
                    if (allBackdrops.length === 0) {
                        document.body.style.overflow = 'auto';
                    }
                    
                    if (onComplete) {
                        onComplete();
                    }
                }, 300);
            } else if (onComplete) {
                onComplete();
            }
        }

        /**
         * FUN√á√ÉO CENTRAL PARA FECHAR QUALQUER MODAL
         * @param {Object} options - Op√ß√µes de fechamento
         * @param {string} options.modalSelector - Seletor CSS da modal
         * @param {string} options.backdropId - ID do backdrop associado
         * @param {Function} options.onClose - Callback executado ap√≥s fechamento
         * @param {boolean} options.force - Se deve fechar for√ßadamente (default: false)
         */

        function closeModal(options = {}) {
            const {
                modalSelector,
                backdropId = 'modal-backdrop',
                onClose = null,
                force = false
            } = options;

            const modal = document.querySelector(modalSelector);
            if (!modal) {
                console.warn(`Modal n√£o encontrada: ${modalSelector}`);
                return;
            }

            if (force) {
                // Fechamento for√ßado - imediato
                modal.classList.remove('visible', 'show', 'active');
                modal.style.cssText = 'display: none !important; opacity: 0 !important; visibility: hidden !important;';
                removeModalBackdrop(backdropId, onClose);
                document.body.style.overflow = 'auto';
            } else {
                // Fechamento com anima√ß√£o
                modal.classList.remove('visible', 'show', 'active');
                modal.style.opacity = '0';
                
                setTimeout(() => {
                    modal.style.display = 'none';
                    if (onClose) onClose();
                }, 300);
                
                removeModalBackdrop(backdropId);
            }
        }

        /**
         * FUN√á√ÉO CENTRAL PARA ABRIR QUALQUER MODAL
         * @param {Object} options - Op√ß√µes de abertura
         * @param {string} options.modalSelector - Seletor CSS da modal
         * @param {string} options.backdropId - ID do backdrop
         * @param {Function} options.onOpen - Callback executado ap√≥s abertura
         * @param {Function} options.onBackdropClick - Callback para clique no backdrop
         */

        function openModal(options = {}) {
            const {
                modalSelector,
                backdropId = 'modal-backdrop',
                onOpen = null,
                onBackdropClick = null
            } = options;

            const modal = document.querySelector(modalSelector);
            if (!modal) {
                console.warn(`Modal n√£o encontrada: ${modalSelector}`);
                return;
            }

            // Limpar estado anterior
            modal.style.display = 'none';
            modal.style.opacity = '0';
            modal.classList.remove('visible', 'show', 'active');

            createModalBackdrop({
                id: backdropId,
                onClick: onBackdropClick || ((e) => {
                    if (e.target.id === backdropId) {
                        closeModal({ modalSelector, backdropId });
                    }
                })
            });

            // Aguardar frame para garantir limpeza
            requestAnimationFrame(() => {
                modal.style.display = 'flex';
                
                requestAnimationFrame(() => {
                    modal.style.opacity = '1';
                    modal.classList.add('visible');
                    
                    if (onOpen) onOpen();
                });
            });
        }

        // Fun√ß√µes globais para intera√ß√µes dos cards
        function togglePatientActions(patientId) {
            const dropdown = document.getElementById(`actions-${patientId}`);
            const allDropdowns = document.querySelectorAll('.dropdown-menu');
            
            // Fechar outros dropdowns
            allDropdowns.forEach(menu => {
                if (menu !== dropdown) {
                    menu.classList.remove('show');
                }
            });
            
            dropdown.classList.toggle('show');
        }

        function editPatient(patientId) {
            const patientData = allPatientsGlobal.find(p => p.id === patientId);
            if (patientData) {
                openPatientModal(patientData);
            }
        }

        function deletePatient(patientId) {
            if (confirm('Tem certeza que deseja excluir este paciente?')) {
                window.location.href = `/deletar_paciente/${patientId}`;
            }
        }

        function toggleStepperModal() {
            openPatientModal();
        }

        function callPatient(phone) {
            if (phone) {
                // Remove todos os caracteres n√£o num√©ricos
                const cleanPhone = phone.replace(/\D/g, '');
                // Mensagem personalizada para WhatsApp
                const message = "Ol√°! Entrando em contato da cl√≠nica. Como posso ajud√°-lo?";
                const encodedMessage = encodeURIComponent(message);
                // Abre o WhatsApp Web com o n√∫mero e mensagem
                window.open(`https://wa.me/55${cleanPhone}?text=${encodedMessage}`, '_blank');
            }
        }

        function makePhoneCall(phone) {
            if (phone) {
                window.open(`tel:${phone.replace(/\D/g, '')}`);
            }
        }

        function emailPatient(email) {
            if (email) {
                window.open(`mailto:${email}`);
            }
        }

        // Vari√°veis globais para as fun√ß√µes de exclus√£o
        let allPatientsGlobal = [];
        let showToastGlobal = null;
        let currentPageGlobal = 1;
        let renderPatientCardsGlobal = null;
        let showGeneralAlertModalGlobal = null;

        function deletePatient(patientId, patientName) {
            // Fechar o dropdown
            document.querySelectorAll('.dropdown-menu').forEach(menu => {
                menu.classList.remove('show');
            });

            // Criar modal de confirma√ß√£o personalizado
            const modal = document.createElement('div');
            modal.className = 'modal-overlay delete-modal-overlay';
            modal.innerHTML = `
                <div class="modal-content delete-modal">
                    <div class="modal-header">
                        <div class="modal-icon-danger">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <h3>Confirmar Exclus√£o</h3>
                    </div>
                    <div class="modal-body">
                        <p>Tem certeza que deseja excluir o paciente <strong>${patientName}</strong>?</p>
                        <p class="warning-text">
                            <i class="fas fa-warning"></i>
                            Esta a√ß√£o n√£o pode ser desfeita. Todos os dados do paciente, incluindo prontu√°rios e hist√≥rico m√©dico, ser√£o permanentemente removidos.
                        </p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">
                            <i class="fas fa-times"></i>
                            Cancelar
                        </button>
                        <button type="button" class="btn btn-danger" onclick="confirmDelete('${patientId}')">
                            <i class="fas fa-trash"></i>
                            Sim, Excluir
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Usar fun√ß√£o centralizada para criar modal
            openModal({
                modalSelector: '.delete-modal-overlay',
                backdropId: 'delete-modal-backdrop',
                onOpen: () => {
                    modal.classList.add('show');
                },
                onBackdropClick: (e) => {
                    if (e.target.id === 'delete-modal-backdrop') {
                        closeDeleteModal();
                    }
                }
            });
        }

        function closeDeleteModal() {
            // Usar fun√ß√£o centralizada
            closeModal({
                modalSelector: '.delete-modal-overlay',
                backdropId: 'delete-modal-backdrop',
                onClose: () => {
                    const modal = document.querySelector('.delete-modal-overlay');
                    if (modal && modal.parentNode) {
                        modal.parentNode.removeChild(modal);
                    }
                }
            });
        }

        // Fun√ß√£o para fechar o modal instantaneamente (para usar ap√≥s exclus√£o)
        function forceCloseDeleteModal() {
            // Usar fun√ß√£o centralizada com for√ßa
            closeModal({
                modalSelector: '.delete-modal-overlay',
                backdropId: 'delete-modal-backdrop',
                force: true,
                onClose: () => {
                    const modal = document.querySelector('.delete-modal-overlay');
                    if (modal && modal.parentNode) {
                        modal.parentNode.removeChild(modal);
                    }
                }
            });
        }

        function confirmDelete(patientId) {
            // Mostrar loading
            const confirmBtn = document.querySelector('.modal-footer .btn-danger');
            const originalText = confirmBtn.innerHTML;
            confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Excluindo...';
            confirmBtn.disabled = true;

            // Fazer requisi√ß√£o para excluir o paciente
            fetch(`/pacientes/${patientId}/excluir`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
                }
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('Erro ao excluir paciente');
                }
            })
            .then(data => {
                forceCloseDeleteModal();
                
                // Remover o paciente da lista local
                if (allPatientsGlobal && allPatientsGlobal.length > 0) {
                    const index = allPatientsGlobal.findIndex(p => p.id === patientId);
                    if (index > -1) {
                        allPatientsGlobal.splice(index, 1);
                    }
                }
                
                // Recarregar a lista
                if (renderPatientCardsGlobal) {
                    // Usar a fun√ß√£o global que atualizar√° a vari√°vel currentPage no escopo local
                    renderPatientCardsGlobal();
                }
                
                // Mostrar mensagem de sucesso
                if (showToastGlobal) {
                    showToastGlobal('Paciente exclu√≠do com sucesso!', 'success');
                }
            })
            .catch(error => {
                console.error('Erro ao excluir paciente:', error);
                confirmBtn.innerHTML = originalText;
                confirmBtn.disabled = false;
                if (showToastGlobal) {
                    showToastGlobal('Erro ao excluir paciente. Tente novamente.', 'danger');
                }
            });
        }

        // Fechar dropdowns ao clicar fora
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.patient-actions-dropdown')) {
                document.querySelectorAll('.dropdown-menu').forEach(menu => {
                    menu.classList.remove('show');
                });
            }
        });
    </script>

    <script type="module">
        // Define os modelos de URL usando Jinja2 para serem avaliados no servidor
        const prontuarioUrlTemplate = "{{ url_for('ver_prontuario', paciente_doc_id='__ID__') }}";
        const peiUrlTemplate = "{{ url_for('peis.ver_peis_paciente', paciente_doc_id='__ID__') }}";
        const planejamentoSemanalUrlTemplate = "/pacientes/__ID__/planejamento_semanal"; // Nova URL
        const editUrlTemplate = "{{ url_for('editar_paciente', paciente_doc_id='__ID__') }}";

        document.addEventListener('DOMContentLoaded', () => {
            const htmlEl = document.documentElement;
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            const menuBtnMobile = document.querySelector('.menu-btn-mobile');
            const toggleBtnDesktop = document.querySelector('.toggle-btn-desktop');
            const themeToggle = document.querySelector('#theme-toggle');
            const logoutButton = document.getElementById('logoutButton');
            const cardListContainer = document.querySelector('.card-list-container');
            const noResultsMessage = document.getElementById('no-results-message');

            const searchForm = document.getElementById('searchForm');
            const searchInput = document.getElementById('searchInput');
            const prevPageBtn = document.getElementById('prevPageBtn');
            const nextPageBtn = document.getElementById('nextPageBtn');
            const pageInfo = document.getElementById('pageInfo');

            // Dados de pacientes passados pelo Jinja2
            const allPatients = {{ pacientes | tojson | safe }};
            const allConvenios = {{ convenios | tojson | safe }};
            let filteredPatients = [];

            let currentPage = 1;
            let itemsPerPage = calculateItemsPerPage();

            // Fun√ß√£o para calcular items por p√°gina dinamicamente
            function calculateItemsPerPage() {
                const containerWidth = document.querySelector('.main-content')?.offsetWidth || window.innerWidth - 250; // Largura dispon√≠vel
                const cardMinWidth = 520; // minmax(520px, 1fr) do CSS
                const gap = 24; // 1.5rem = 24px pego la CSS
                
                // Ajustar para mobile/tablet
                let actualCardMinWidth = cardMinWidth;
                if (window.innerWidth <= 768) {
                    actualCardMinWidth = Math.min(cardMinWidth, containerWidth - 40); // 20px padding cada lado
                }
                
                // Calcular quantos cards cabem por linha
                let cardsPerRow = Math.floor((containerWidth + gap) / (actualCardMinWidth + gap));
                if (cardsPerRow < 1) cardsPerRow = 1;
                
                // Calcular altura dispon√≠vel da viewport
                const viewportHeight = window.innerHeight;
                const headerHeight = 60;
                const searchHeight = 80;
                const paginationHeight = 60;
                const cardHeight = 280;
                const cardGap = 24;
                
                const availableHeight = viewportHeight - headerHeight - searchHeight - paginationHeight - 40;
                const rowsVisible = Math.floor((availableHeight + cardGap) / (cardHeight + cardGap));
                const minRowsVisible = Math.max(rowsVisible, 2); // M√≠nimo 2 linhas
                
                // Total de items = cards por linha √ó linhas vis√≠veis
                const calculatedItems = cardsPerRow * minRowsVisible;
                
                // Definir limites m√≠nimo e m√°ximo
                const minItems = cardsPerRow * 2;
                const maxItems = cardsPerRow * 8;
                
                const result = Math.min(Math.max(calculatedItems, minItems), maxItems);
                
                return result;
            }

            // Recalcular itemsPerPage quando a janela for redimensionada
            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    const newItemsPerPage = calculateItemsPerPage();
                    if (newItemsPerPage !== itemsPerPage) {
                        itemsPerPage = newItemsPerPage;
                        renderPatientCards();
                        renderPaginationControls();
                    }
                }, 250);
            });

            allPatientsGlobal = allPatients;
            currentPageGlobal = currentPage;

            const toastContainer = document.getElementById('toast-container');
            function showToast(message, category = 'info') {
                if (!toastContainer) return;

                const toast = document.createElement('div');
                toast.className = `toast ${category}`;
                
                let iconClass = 'fa-solid fa-circle-info';
                let title = 'Informa√ß√£o';
                if (category === 'success') {
                    iconClass = 'fa-solid fa-check-circle';
                    title = 'Sucesso';
                }
                if (category === 'danger') {
                    iconClass = 'fa-solid fa-times-circle';
                    title = 'Erro';
                }
                if (category === 'warning') {
                    iconClass = 'fa-solid fa-exclamation-triangle';
                    title = 'Aten√ß√£o';
                }

                toast.innerHTML = `
                    <div class="toast-icon">
                        <i class="${iconClass}"></i>
                    </div>
                    <div class="toast-content">
                        <strong class="toast-title">${title}</strong>
                        <span class="toast-message">${message}</span>
                    </div>
                    <button class="toast-close">&times;</button>
                    <div class="toast-progress"></div>
                `;
                
                toastContainer.appendChild(toast);

                const closeButton = toast.querySelector('.toast-close');
                closeButton.addEventListener('click', () => {
                    toast.classList.add('fade-out');
                    toast.addEventListener('animationend', () => toast.remove());
                });

                setTimeout(() => {
                    toast.classList.add('fade-out');
                    toast.addEventListener('animationend', () => toast.remove());
                }, 5000);
            }

            showToastGlobal = showToast;

            // --- L√≥gica para Modal de Alerta Geral ---
            const generalAlertOverlay = document.getElementById('general-alert-modal-overlay');
            const alertModalIcon = document.getElementById('alert-modal-icon');
            const alertModalTitle = document.getElementById('alert-modal-title');
            const alertModalMessage = document.getElementById('alert-modal-message');
            const alertModalCloseBtn = document.getElementById('alert-modal-close-btn');

            function showGeneralAlertModal(title, message, category = 'info') {
                alertModalTitle.textContent = title;
                alertModalMessage.textContent = message;
                
                alertModalIcon.className = 'alert-modal-icon'; // Reset class
                let iconClass = '';
                switch (category) {
                    case 'info': iconClass = 'fas fa-info-circle'; break;
                    case 'success': iconClass = 'fas fa-check-circle'; break;
                    case 'warning': iconClass = 'fas fa-exclamation-triangle'; break;
                    case 'danger': iconClass = 'fas fa-times-circle'; break;
                }
                alertModalIcon.classList.add(category);
                alertModalIcon.innerHTML = `<i class="${iconClass}"></i>`;

                // Usar fun√ß√£o centralizada para abrir modal
                openModal({
                    modalSelector: '#general-alert-modal-overlay',
                    backdropId: 'alert-modal-backdrop',
                    onOpen: () => {
                        generalAlertOverlay.classList.add('show');
                    },
                    onBackdropClick: (e) => {
                        if (e.target.id === 'alert-modal-backdrop') {
                            closeGeneralAlertModal();
                        }
                    }
                });
            }

            function closeGeneralAlertModal() {
                // Usar fun√ß√£o centralizada
                closeModal({
                    modalSelector: '#general-alert-modal-overlay',
                    backdropId: 'alert-modal-backdrop'
                });
            }
            // Conectar a fun√ß√£o showGeneralAlertModal com a global
            showGeneralAlertModalGlobal = showGeneralAlertModal;

            alertModalCloseBtn.addEventListener('click', closeGeneralAlertModal);
            generalAlertOverlay.addEventListener('click', (e) => {
                if (e.target === generalAlertOverlay) {
                    closeGeneralAlertModal();
                }
            });


            // --- Processa mensagens flash do backend e as exibe como toasts ---
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% for category, message in messages %}
                    showToast({{ message|tojson|safe }}, "{{ category }}");
                {% endfor %}
            {% endwith %}

            // --- L√≥gica da Sidebar (removida daqui para ser gerenciada por Nav.html) ---
            // A l√≥gica da sidebar, tema e logout foi movida para Nav.html
            // e ser√° inclu√≠da automaticamente.

            // --- Fun√ß√£o para filtrar pacientes ---
            function filterPatients(query) {
                if (!query) {
                    return allPatients;
                }
                const lowerCaseQuery = query.toLowerCase();
                return allPatients.filter(paciente => {
                    const matchesName = paciente.nome && paciente.nome.toLowerCase().includes(lowerCaseQuery);
                    const matchesPhone = paciente.contato_telefone && paciente.contato_telefone.toLowerCase().includes(lowerCaseQuery);
                    const matchesCpf = paciente.cpf && paciente.cpf.toLowerCase().includes(lowerCaseQuery);
                    // Adicionado busca por respons√°veis
                    const matchesResponsavel1Name = paciente.responsavel1_nome && paciente.responsavel1_nome.toLowerCase().includes(lowerCaseQuery);
                    const matchesResponsavel1Phone = paciente.responsavel1_telefone && paciente.responsavel1_telefone.toLowerCase().includes(lowerCaseQuery);
                    const matchesResponsavel2Name = paciente.responsavel2_nome && paciente.responsavel2_nome.toLowerCase().includes(lowerCaseQuery);
                    const matchesResponsavel2Phone = paciente.responsavel2_telefone && paciente.responsavel2_telefone.toLowerCase().includes(lowerCaseQuery);

                    return matchesName || matchesPhone || matchesCpf || matchesResponsavel1Name || matchesResponsavel1Phone || matchesResponsavel2Name || matchesResponsavel2Phone;
                });
            }

            // --- Renderiza√ß√£o dos Cart√µes de Paciente (Moderna e Org√¢nica) ---
            function renderPatientCards() {
                cardListContainer.innerHTML = ''; // Limpa os cart√µes existentes
                
                const currentSearchQuery = searchInput.value;
                filteredPatients = filterPatients(currentSearchQuery);

                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                const patientsToRender = filteredPatients.slice(startIndex, endIndex);

                if (patientsToRender.length === 0) {
                    renderEmptyState();
                } else {
                    noResultsMessage.style.display = 'none';
                    
                    // Adicionar skeleton loading para feedback visual
                    showSkeletonLoading();
                    
                    setTimeout(() => {
                        cardListContainer.innerHTML = ''; // Remove skeleton
                        patientsToRender.forEach((paciente, index) => {
                            const card = createModernPatientCard(paciente, index);
                            cardListContainer.appendChild(card);
                        });
                        // Adicionar anima√ß√£o escalonada aos cards
                        animateCardsEntrance();
                    }, 150); // Pequeno delay para mostrar o skeleton
                }
                renderPaginationControls(); // Atualiza os controles de pagina√ß√£o
            }

            // Skeleton loading para melhor UX
            function showSkeletonLoading() {
                const skeletonCount = Math.min(itemsPerPage, 3);
                cardListContainer.innerHTML = '';
                
                for (let i = 0; i < skeletonCount; i++) {
                    const skeleton = document.createElement('div');
                    skeleton.className = 'patient-card-skeleton';
                    skeleton.innerHTML = `
                        <div class="skeleton-header">
                            <div class="skeleton-avatar"></div>
                            <div class="skeleton-info">
                                <div class="skeleton-line skeleton-name"></div>
                                <div class="skeleton-line skeleton-meta"></div>
                            </div>
                        </div>
                        <div class="skeleton-body">
                            <div class="skeleton-line"></div>
                            <div class="skeleton-line"></div>
                            <div class="skeleton-line skeleton-short"></div>
                        </div>
                    `;
                    cardListContainer.appendChild(skeleton);
                }
            }

            // Criar card moderno para paciente
            function createModernPatientCard(paciente, index) {
                const card = document.createElement('div');
                card.className = 'paciente-card modern-card';
                card.style.setProperty('--animation-delay', `${index * 0.1}s`);
                
                // Calcular idade se houver data de nascimento
                const idade = calculateAge(paciente.data_nascimento);
                const idadeText = formatAge(idade);
                
                // Determinar avatar baseado no g√™nero
                const avatarIcon = getAvatarIcon(paciente.genero);
                
                // Determinar cor do conv√™nio
                const convenioColor = getConvenioColor(paciente.convenio_nome);
                
                // Adicionar gradiente din√¢mico baseado no nome
                const gradientColor = getPatientGradient(paciente.nome);

                // Formatar endere√ßo completo
                const fullAddress = formatAddress(paciente);
                
                card.innerHTML = `
                    <div class="patient-card-modern">
                        <div class="patient-header" style="background: ${gradientColor};">
                            <div class="patient-avatar">
                                <i class="${avatarIcon}"></i>
                                <div class="patient-status-indicator status-active"></div>
                            </div>
                            <div class="patient-info">
                                <h3 class="patient-name">${paciente.nome}</h3>
                                <div class="patient-meta">
                                    <span class="patient-age">
                                        <i class="fas fa-birthday-cake"></i>
                                        ${idadeText}
                                    </span>
                                   
                                </div>
                            </div>
                            <div class="patient-actions-dropdown">
                                <button class="dropdown-toggle" onclick="togglePatientActions('${paciente.id}')">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <div class="dropdown-menu" id="actions-${paciente.id}">
                                    <div class="dropdown-section-label">
                                        <i class="fas fa-cog"></i> A√ß√µes
                                    </div>
                                    <button type="button" class="dropdown-item" onclick="editPatient('${paciente.id}')">
                                        <i class="fas fa-edit"></i>
                                        Editar Dados
                                    </button>
                                    <button type="button" class="dropdown-item dropdown-item-danger" onclick="deletePatient('${paciente.id}', '${paciente.nome}')">
                                        <i class="fas fa-trash"></i>
                                        Excluir Paciente
                                    </button>
                                    
                                    <div class="dropdown-divider"></div>
                                    <div class="dropdown-section-label">
                                        <i class="fas fa-file-medical"></i> Dados M√©dicos
                                    </div>
                                    <a href="${prontuarioUrlTemplate.replace('__ID__', paciente.id)}" class="dropdown-item">
                                        <i class="fas fa-notes-medical"></i>
                                        Ver Prontu√°rio
                                    </a>
                                    <a href="${peiUrlTemplate.replace('__ID__', paciente.id)}" class="dropdown-item">
                                        <i class="fas fa-child-reaching"></i>
                                        Ver PEI
                                    </a>
                                    <a href="${planejamentoSemanalUrlTemplate.replace('__ID__', paciente.id)}" class="dropdown-item">
                                        <i class="fas fa-calendar-week"></i>
                                        Planejamento Semanal
                                    </a>
                                    ${paciente.contato_telefone || paciente.contato_email || paciente.responsavel1_telefone || paciente.responsavel2_telefone ? `
                                        <div class="dropdown-divider"></div>
                                        <div class="dropdown-section-label">
                                            <i class="fas fa-address-book"></i> Contatos
                                        </div>
                                    ` : ''}
                                    ${paciente.contato_telefone ? `
                                        <button type="button" class="dropdown-item" onclick="callPatient('${paciente.contato_telefone}')">
                                            <i class="fab fa-whatsapp"></i>
                                            ${formatPhone(paciente.contato_telefone)}
                                        </button>
                                        <button type="button" class="dropdown-item" onclick="makePhoneCall('${paciente.contato_telefone}')">
                                            <i class="fas fa-phone"></i>
                                            ${formatPhone(paciente.contato_telefone)}
                                        </button>
                                    ` : ''}
                                    ${paciente.responsavel1_nome && paciente.responsavel1_telefone ? `
                                        <button type="button" class="dropdown-item" onclick="callPatient('${paciente.responsavel1_telefone}')">
                                            <i class="fas fa-user-shield"></i> Resp. 1: ${paciente.responsavel1_nome} (${formatPhone(paciente.responsavel1_telefone)})
                                        </button>
                                    ` : ''}
                                    ${paciente.responsavel2_nome && paciente.responsavel2_telefone ? `
                                        <button type="button" class="dropdown-item" onclick="callPatient('${paciente.responsavel2_telefone}')">
                                            <i class="fas fa-user-shield"></i> Resp. 2: ${paciente.responsavel2_nome} (${formatPhone(paciente.responsavel2_telefone)})
                                        </button>
                                    ` : ''}
                                    ${paciente.contato_email ? `
                                        <button type="button" class="dropdown-item" onclick="emailPatient('${paciente.contato_email}')">
                                            <i class="fas fa-envelope"></i>
                                            ${paciente.contato_email}
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                        
                        <div class="patient-details">
                            <div class="detail-grid">
                                <!-- CPF - sempre exibido -->
                                <div class="detail-item">
                                    <div class="detail-icon">
                                        <i class="fas fa-id-card"></i>
                                    </div>
                                    <div class="detail-content">
                                        <span class="detail-label">CPF</span>
                                        <span class="detail-value ${!paciente.cpf ? 'detail-empty' : ''}">${paciente.cpf ? formatCPF(paciente.cpf) : 'N√£o informado'}</span>
                                    </div>
                                </div>
                                
                                <!-- Telefone - sempre exibido -->
                                <div class="detail-item ${paciente.contato_telefone ? 'clickable' : ''}" ${paciente.contato_telefone ? `onclick="callPatient('${paciente.contato_telefone}')"` : ''}>
                                    <div class="detail-icon">
                                        <i class="fas fa-phone"></i>
                                    </div>
                                    <div class="detail-content">
                                        <span class="detail-label">Telefone</span>
                                        <span class="detail-value ${!paciente.contato_telefone ? 'detail-empty' : ''}">${paciente.contato_telefone ? formatPhone(paciente.contato_telefone) : 'N√£o informado'}</span>
                                    </div>
                                </div>
                                
                                <!-- Conv√™nio - sempre exibido -->
                                <div class="detail-item">
                                    <div class="detail-icon">
                                        <i class="fas fa-handshake"></i>
                                    </div>
                                    <div class="detail-content">
                                        <span class="detail-label">Conv√™nio</span>
                                        <span class="detail-value ${!paciente.convenio_nome ? 'detail-empty' : ''}">
                                            ${paciente.convenio_nome ? `<span class="convenio-badge" style="background-color: ${convenioColor};">${paciente.convenio_nome}</span>` : 'N√£o informado'}
                                        </span>
                                    </div>
                                </div>
                                
                                <!-- Data de Nascimento - sempre exibido -->
                                <div class="detail-item">
                                    <div class="detail-icon">
                                        <i class="fas fa-calendar-alt"></i>
                                    </div>
                                    <div class="detail-content">
                                        <span class="detail-label">Nascimento</span>
                                        <span class="detail-value ${!paciente.data_nascimento ? 'detail-empty' : ''}">${paciente.data_nascimento ? formatDate(paciente.data_nascimento) : 'N√£o informado'}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="patient-footer">
                            <div class="patient-stats">
                                <div class="stat-item">
                                    <i class="fas fa-calendar-plus"></i>
                                    <span>Cadastrado em ${formatDate(paciente.data_cadastro)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                return card;
            }

            // Estado vazio moderno e interativo
            function renderEmptyState() {
                noResultsMessage.style.display = 'none';
                const isSearching = searchInput.value.length > 0;
                
                cardListContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-animation">
                            <div class="empty-state-icon">
                                <i class="fas fa-${isSearching ? 'search' : 'user-friends'}"></i>
                            </div>
                            <div class="empty-state-particles">
                                <div class="particle"></div>
                                <div class="particle"></div>
                                <div class="particle"></div>
                            </div>
                        </div>
                        <h3 class="empty-state-title">
                            ${isSearching ? 
                                'Nenhum paciente encontrado' : 
                                'Nenhum paciente cadastrado'
                            }
                        </h3>
                        <p class="empty-state-description">
                            ${isSearching ? 
                                'Tente ajustar os filtros de busca ou verifique se o nome, telefone ou CPF est√£o corretos.' : 
                                'Comece criando seu primeiro paciente para come√ßar a gerenciar os dados cl√≠nicos.'
                            }
                        </p>
                        <div class="empty-state-actions">
                            <button class="btn btn-primary empty-state-btn" onclick="openPatientModal()">
                                <i class="fas fa-plus"></i>
                                Adicionar Paciente
                            </button>
                            ${isSearching ? `
                                <button class="btn btn-secondary empty-state-btn" onclick="clearSearch()">
                                    <i class="fas fa-times"></i>
                                    Limpar Busca
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                // Animar entrada do estado vazio
                setTimeout(() => {
                    const emptyState = cardListContainer.querySelector('.empty-state');
                    if (emptyState) {
                        emptyState.style.opacity = '0';
                        emptyState.style.transform = 'translateY(20px)';
                        emptyState.style.transition = 'all 0.6s ease';
                        
                        setTimeout(() => {
                            emptyState.style.opacity = '1';
                            emptyState.style.transform = 'translateY(0)';
                        }, 100);
                    }
                }, 50);
            }
            
            // Fun√ß√£o para limpar a busca
            function clearSearch() {
                searchInput.value = '';
                currentPage = 1;
                renderPatientCards();
            }

            // Fun√ß√µes auxiliares para formata√ß√£o e intera√ß√£o
            function calculateAge(birthDate) {
                if (!birthDate) return null;
                
                const today = new Date();
                const birth = new Date(birthDate);
                
                // Evitar problemas de timezone
                today.setHours(0, 0, 0, 0);
                birth.setHours(0, 0, 0, 0);
                
                // Calcular anos
                let years = today.getFullYear() - birth.getFullYear();
                let months = today.getMonth() - birth.getMonth();
                
                // Ajustar se ainda n√£o fez anivers√°rio este ano
                if (months < 0 || (months === 0 && today.getDate() < birth.getDate())) {
                    years--;
                    months += 12;
                }
                
                // Ajustar meses se ainda n√£o completou o m√™s
                if (today.getDate() < birth.getDate()) {
                    months--;
                    if (months < 0) {
                        months = 11;
                        years--;
                    }
                }
                
                return {
                    years: Math.max(0, years),
                    months: Math.max(0, months),
                    totalMonths: Math.max(0, years * 12 + months)
                };
            }

            function formatAge(ageData) {
                if (!ageData) return 'N/A';
                
                const { years, months, totalMonths } = ageData;
                
                // Para beb√™s menores de 2 anos, mostrar em meses
                if (years < 2) {
                    if (totalMonths === 0) {
                        return 'Rec√©m-nascido';
                    } else if (totalMonths === 1) {
                        return '1 m√™s';
                    } else if (totalMonths < 12) {
                        return `${totalMonths} meses`;
                    } else if (totalMonths < 24) {
                        const remainingMonths = totalMonths - 12;
                        if (remainingMonths === 0) {
                            return '1 ano';
                        } else if (remainingMonths === 1) {
                            return '1 ano e 1 m√™s';
                        } else {
                            return `1 ano e ${remainingMonths} meses`;
                        }
                    }
                }
                
                // Para crian√ßas e adultos, mostrar em anos
                if (years === 1) {
                    return '1 ano';
                } else {
                    return `${years} anos`;
                }
            }

            function getAvatarIcon(genero) {
                switch(genero?.toLowerCase()) {
                    case 'masculino': return 'fa-solid fa-mars';
                    case 'feminino': return 'fa-solid fa-venus';
                    case 'masculino': return 'fa-solid fa-user-tie';
                    default: return 'fa-solid fa-child-reaching';
                }
            }

            function getConvenioColor(convenio) {
                if (!convenio || convenio === 'Particular') return '#6b7280';
                const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#f97316', '#84cc16'];
                const hash = convenio.split('').reduce((a, b) => {
                    a = ((a << 5) - a) + b.charCodeAt(0);
                    return a & a;
                }, 0);
                return colors[Math.abs(hash) % colors.length];
            }

            // Gerar gradiente din√¢mico baseado no nome do paciente
            function getPatientGradient(nome) {
                // Cor s√≥lida √∫nica para todos os cards
                return 'linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%)';
            }

            function formatCPF(cpf) {
                if (!cpf) return '';
                return cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
            }

            function formatPhone(phone) {
                if (!phone) return '';
                const cleaned = phone.replace(/\D/g, '');
                if (cleaned.length === 11) {
                    return cleaned.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
                }
                return phone;
            }

            function formatDate(dateStr) {
                if (!dateStr) return 'N/A';
                try {
                    const date = new Date(dateStr);
                    return date.toLocaleDateString('pt-BR');
                } catch {
                    return 'N/A';
                }
            }

            function formatAddress(paciente) {
                // Access the nested 'endereco' object
                const endereco = paciente.endereco || {}; 

                const parts = [];
                if (endereco.logradouro) parts.push(endereco.logradouro);
                if (endereco.numero) parts.push(`, ${endereco.numero}`);
                if (endereco.complemento) parts.push(` (${endereco.complemento})`);
                if (endereco.bairro) parts.push(` - ${endereco.bairro}`);
                if (endereco.cidade) parts.push(`, ${endereco.cidade}`);
                if (endereco.estado) parts.push(`/${endereco.estado}`);
                if (endereco.cep) parts.push(` - ${formatCEP(endereco.cep)}`);
                
                return parts.join('');
            }

            function formatCEP(cep) {
                if (!cep) return '';
                return cep.replace(/(\d{5})(\d{3})/, '$1-$2');
            }

            function animateCardsEntrance() {
                const cards = cardListContainer.querySelectorAll('.paciente-card');
                
                // Intersection Observer para anima√ß√£o quando entra na viewport
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach((entry) => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('animate-in');
                            observer.unobserve(entry.target);
                        }
                    });
                }, {
                    threshold: 0.1,
                    rootMargin: '50px'
                });
                
                cards.forEach((card, index) => {
                    card.style.opacity = '0';
                    card.style.transform = 'translateY(30px) scale(0.95)';
                    
                    // Animar com delay escalonado
                    setTimeout(() => {
                        card.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
                        card.style.opacity = '1';
                        card.style.transform = 'translateY(0) scale(1)';
                        
                        // Adicionar efeito de destaque sutil
                        setTimeout(() => {
                            card.style.boxShadow = '0 4px 20px rgba(0, 0, 0, 0.1)';
                        }, 300);
                    }, index * 150);
                    
                    observer.observe(card);
                });
            }

            // --- L√≥gica dos Controles de Pagina√ß√£o ---
            function renderPaginationControls() {
                const totalPages = Math.ceil(filteredPatients.length / itemsPerPage);
                pageInfo.textContent = `P√°gina ${currentPage} de ${totalPages}`;

                prevPageBtn.disabled = currentPage === 1;
                nextPageBtn.disabled = currentPage === totalPages;
            }

            // --- Event Listener para o Formul√°rio de Busca ---
            searchForm.addEventListener('submit', (event) => {
                event.preventDefault(); // Impede o envio padr√£o do formul√°rio
                currentPage = 1; // Reseta a p√°gina para 1 ao realizar uma nova busca
                renderPatientCards(); // Renderiza os cards com o filtro aplicado
            });

            prevPageBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderPatientCards();
                }
            });

            nextPageBtn.addEventListener('click', () => {
                const totalPages = Math.ceil(filteredPatients.length / itemsPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    renderPatientCards();
                }
            });

            // --- Redirecionamento para sistema centralizado ---
            window.openPatientStepsModal = function(patientId) {
                // Fun√ß√£o redirecionada para sistema centralizado
                if (patientId) {
                    editPatient(patientId);
                } else {
                    openPatientModal();
                }
            };

            function clearValidationClasses() {
                const requiredFields = document.querySelectorAll('.paciente-field.required input, .paciente-field.required select, .paciente-field.required textarea');
                requiredFields.forEach(field => {
                    field.classList.remove('valid', 'invalid');
                    if (field.classList.contains('date-input-display')) {
                        field.classList.remove('valid', 'error');
                    }
                    // Remover anima√ß√£o de shake
                    field.classList.remove('shake');
                    // Remover has-error dos steps
                    const stepParent = field.closest('[data-step-content]');
                    if (stepParent) {
                        const stepIndex = Array.from(stepParent.parentNode.children).indexOf(stepParent);
                        const stepElement = document.querySelector(`.paciente-step[data-step="${stepIndex + 1}"]`);
                        if (stepElement) {
                            stepElement.classList.remove('has-error');
                        }
                    }
                });
            }

            function setupRequiredFieldValidation() {
                const requiredFields = document.querySelectorAll('.paciente-field.required input, .paciente-field.required select, .paciente-field.required textarea');
                requiredFields.forEach(field => {
                    if (field.type === 'hidden') return;
                    
                    if (field.name === 'cpf') {
                        applyCPFMask(field);
                    }
                    
                    field.addEventListener('blur', function() {
                        validateRequiredField(this);
                    });
                    
                    field.addEventListener('input', function() {
                        if (this.classList.contains('invalid')) {
                            this.classList.remove('invalid');
                        }
                        
                        if (this.name === 'cpf' && this.value.replace(/\D/g, '').length === 11) {
                            validateRequiredField(this);
                        }
                    });
                });
            }

            function validateRequiredField(field) {
                let isValid = false;
                
                if (field.name === 'cpf') {
                    isValid = validateCPF(field.value);
                } else if (field.classList.contains('date-input-display')) {
                    const hiddenInput = document.getElementById('steps-data_nascimento');
                    isValid = hiddenInput && hiddenInput.value.trim() !== '' && isValidDate(hiddenInput.value);
                } else {
                    isValid = field.value.trim() !== '';
                }
                
                if (isValid) {
                    field.classList.remove('invalid');
                    field.classList.add('valid');
                    if (field.classList.contains('date-input-display')) {
                        field.classList.remove('error');
                        field.classList.add('valid');
                    }
                } else {
                    field.classList.remove('valid');
                    field.classList.add('invalid');
                    if (field.classList.contains('date-input-display')) {
                        field.classList.remove('valid');
                        field.classList.add('error');
                    }
                }
                
                return isValid;
            }

            function validateCPF(cpf) {
                cpf = cpf.replace(/\D/g, '');
                
                if (cpf.length !== 11) return false;
                
                if (/^(\d)\1+$/.test(cpf)) return false;
                
                let sum = 0;
                for (let i = 0; i < 9; i++) {
                    sum += parseInt(cpf[i]) * (10 - i);
                }
                let remainder = sum % 11;
                let digit1 = remainder < 2 ? 0 : 11 - remainder;
                
                if (parseInt(cpf[9]) !== digit1) return false;
                
                sum = 0;
                for (let i = 0; i < 10; i++) {
                    sum += parseInt(cpf[i]) * (11 - i);
                }
                remainder = sum % 11;
                let digit2 = remainder < 2 ? 0 : 11 - remainder;
                
                return parseInt(cpf[10]) === digit2;
            }

            function applyCPFMask(input) {
                input.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    
                    if (value.length > 11) {
                        value = value.slice(0, 11);
                    }
                    
                    if (value.length > 9) {
                        value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{0,2})/, '$1.$2.$3-$4');
                    } else if (value.length > 6) {
                        value = value.replace(/(\d{3})(\d{3})(\d{0,3})/, '$1.$2.$3');
                    } else if (value.length > 3) {
                        value = value.replace(/(\d{3})(\d{0,3})/, '$1.$2');
                    }
                    
                    e.target.value = value;
                });
                
                input.addEventListener('keypress', function(e) {
                    if (!/[0-9]/.test(e.key) && 
                        !['Backspace', 'Delete', 'Tab', 'Enter', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                        e.preventDefault();
                    }
                });
            }

            setupRequiredFieldValidation();
            
            // Garantir que itemsPerPage seja calculado corretamente no carregamento
            setTimeout(() => {
                itemsPerPage = calculateItemsPerPage();
                renderPatientCards();
            }, 100);
            
            renderPatientCardsGlobal = renderPatientCards;
        });

        function formatDateToYMD(dateStr) {
            if (!dateStr) return '';
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return dateStr;
            const d = new Date(dateStr);
            if (!isNaN(d.getTime())) {
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${y}-${m}-${day}`;
            }
            return '';
        }

        function formatDateToDMY(dateStr) {
            if (!dateStr) return '';
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                const [year, month, day] = dateStr.split('-');
                return `${day}/${month}/${year}`;
            }
            return '';
        }

        function parseDateFromDMY(dateStr) {
            if (!dateStr) return '';
            const cleanStr = dateStr.replace(/[^\d\/]/g, '');
            const match = cleanStr.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
            if (match) {
                const [, day, month, year] = match;
                return `${year}-${month}-${day}`;
            }
            return '';
        }

        function isValidDate(dateStr) {
            if (!dateStr) return false;
            const d = new Date(dateStr);
            return !isNaN(d.getTime()) && d.getFullYear() > 1900 && d.getTime() <= Date.now();
        }

        document.addEventListener('DOMContentLoaded', function() {
            const displayInput = document.getElementById('steps-data_nascimento_display');
            const hiddenInput = document.getElementById('steps-data_nascimento');
            const cepInput = document.getElementById('steps-cep');
            const logradouroInput = document.getElementById('steps-logradouro');
            const bairroInput = document.getElementById('steps-bairro');
            const cidadeInput = document.getElementById('steps-cidade');
            const estadoInput = document.getElementById('steps-estado');

            // M√°scara e valida√ß√£o para Data de Nascimento
            if (displayInput && hiddenInput) {
                displayInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    
                    if (value.length > 8) {
                        value = value.slice(0, 8);
                    }
                    
                    if (value.length >= 5) {
                        value = value.replace(/(\d{2})(\d{2})(\d{0,4})/, '$1/$2/$3');
                    } else if (value.length >= 3) {
                        value = value.replace(/(\d{2})(\d{0,2})/, '$1/$2');
                    }
                    
                    e.target.value = value;
                    
                    const parsedDate = parseDateFromDMY(value);
                    hiddenInput.value = parsedDate;
                    
                    if (value.length === 10) {
                        if (isValidDate(parsedDate)) {
                            e.target.classList.remove('error');
                            e.target.classList.add('valid');
                        } else {
                            e.target.classList.remove('valid');
                            e.target.classList.add('error');
                        }
                    } else {
                        e.target.classList.remove('valid', 'error');
                    }
                });
                
                displayInput.addEventListener('keypress', function(e) {
                    if (!/[0-9]/.test(e.key) && 
                        !['Backspace', 'Delete', 'Tab', 'Enter', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                        e.preventDefault();
                    }
                });
                
                displayInput.addEventListener('paste', function(e) {
                    e.preventDefault();
                    const pastedText = (e.clipboardData || window.clipboardData).getData('text');
                    const digitsOnly = pastedText.replace(/\D/g, '').slice(0, 8);
                    
                    if (digitsOnly.length >= 6) {
                        let formatted = digitsOnly;
                        if (formatted.length >= 5) {
                            formatted = formatted.replace(/(\d{2})(\d{2})(\d{0,4})/, '$1/$2/$3');
                        } else if (formatted.length >= 3) {
                            formatted = formatted.replace(/(\d{2})(\d{0,2})/, '$1/$2');
                        }
                        
                        displayInput.value = formatted;
                        hiddenInput.value = parseDateFromDMY(formatted);
                        
                        displayInput.dispatchEvent(new Event('input'));
                    }
                });
            }

            // M√°scara para telefone dos respons√°veis
            const responsavel1TelefoneInput = document.getElementById('steps-responsavel1_telefone');
            const responsavel2TelefoneInput = document.getElementById('steps-responsavel2_telefone');

            function applyPhoneMask(input) {
                if (!input) return;
                input.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length > 11) {
                        value = value.slice(0, 11);
                    }
                    if (value.length === 11) {
                        value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
                    } else if (value.length === 10) {
                        value = value.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
                    } else if (value.length > 5) {
                        value = value.replace(/(\d{2})(\d{4})(\d{0,4})/, '($1) $2-$3');
                    } else if (value.length > 2) {
                        value = value.replace(/(\d{2})(\d{0,5})/, '($1) $2');
                    }
                    e.target.value = value;
                });
                input.addEventListener('keypress', function(e) {
                    if (!/[0-9]/.test(e.key) && 
                        !['Backspace', 'Delete', 'Tab', 'Enter', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                        e.preventDefault();
                    }
                });
            }

            applyPhoneMask(responsavel1TelefoneInput);
            applyPhoneMask(responsavel2TelefoneInput);


            // Busca CEP
            if (cepInput) {
                cepInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length > 8) {
                        value = value.slice(0, 8);
                    }
                    if (value.length > 5) {
                        value = value.replace(/(\d{5})(\d{0,3})/, '$1-$2');
                    }
                    e.target.value = value;
                });

                cepInput.addEventListener('blur', async function() {
                    const cep = this.value.replace(/\D/g, '');
                    if (cep.length === 8) {
                        try {
                            // Adicionar um indicador de carregamento
                            this.style.background = `url('https://cdnjs.cloudflare.com/ajax/libs/galleriffic/2.0.1/css/loader.gif') no-repeat right 10px center / 20px 20px`;
                            this.style.backgroundSize = '20px 20px';
                            this.style.paddingRight = '40px';

                            const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                            const data = await response.json();

                            if (data.erro) {
                                showGeneralAlertModal('CEP Inv√°lido', 'O CEP informado n√£o foi encontrado.', 'warning');
                                // Limpar campos de endere√ßo se o CEP for inv√°lido
                                logradouroInput.value = '';
                                bairroInput.value = '';
                                cidadeInput.value = '';
                                estadoInput.value = '';
                            } else {
                                logradouroInput.value = data.logradouro || '';
                                bairroInput.value = data.bairro || '';
                                cidadeInput.value = data.localidade || '';
                                estadoInput.value = data.uf || '';
                            }
                        } catch (error) {
                            console.error('Erro ao buscar CEP:', error);
                            showGeneralAlertModal('Erro na Busca de CEP', 'N√£o foi poss√≠vel buscar o CEP. Verifique sua conex√£o ou tente novamente.', 'danger');
                            // Limpar campos de endere√ßo em caso de erro
                            logradouroInput.value = '';
                            bairroInput.value = '';
                            cidadeInput.value = '';
                            estadoInput.value = '';
                        } finally {
                            // Remover indicador de carregamento
                            this.style.background = '';
                            this.style.paddingRight = '';
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>
