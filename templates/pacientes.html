<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Pacientes - {{ session.clinica_nome_display or 'Clínica On' }}</title>

    <link rel="icon" type="image/png" href="https://placehold.co/40x40/0d9488/ffffff?text=C">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        /* Estilos principais */
        :root {
            --bg: #f1f5f9;                  /* Gray-100 */
            --card: #ffffff;                /* White */
            --text: #0f172a;                /* Gray-900 */
            --muted: #64748b;               /* Gray-500 */
            --accent: #9b53b8;              /* Purple-500 */
            --primary: #5587c2;             /* Blue-500 */
            --primary-light: #c8dcf3;       /* Blue-100 */
            --secondary: #f59e0b;           /* Yellow-500 */
            --danger: #dc2626;              /* Red-600 */
            --success: #16a34a;             /* Green-600 */
            --warning: #f59e0b;             /* Yellow-500 */
            --info: #0ea5e9;                /* Sky-500 */
            --border-color: #e2e8f0;        /* Gray-200 */

            --dark-bg: #0f172a;             /* Gray-900 */
            --dark-card: #1e293b;           /* Gray-800 */
            --dark-text: #f1f5f9;           /* Gray-100 */
            --dark-muted: #94a3b8;          /* Gray-400 */
            --dark-border-color: #334155;   /* Gray-600 */

            color-scheme: light;
        }

        [data-theme="dark"] {
            --bg: var(--dark-bg);
            --text: var(--dark-text);
            --card: var(--dark-card);
            --muted: var(--dark-muted);
            --border-color: var(--dark-border-color);
            color-scheme: dark;
        }

        /* Reset básico e box-sizing */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
            /* Removido overflow-x: hidden; para permitir que os toasts apareçam */
        }
        .layout { display: flex; min-height: 100vh; width: 100%; }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: linear-gradient(180deg, var(--primary), var(--accent));
            color: white;
            position: fixed;
            top: 0; left: 0;
            height: 100vh;
            transition: width 0.3s ease, transform 0.3s ease;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }
        .sidebar-inner-content { padding: 0; height: 100%; overflow-y: auto; display: flex; flex-direction: column; }
        .sidebar-header {
            padding: 0 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sidebar-header .logo {
            font-size: 1.4rem; font-weight: 700; color: white; text-decoration: none;
            display: flex; align-items: center; gap: 0.75rem;
            white-space: nowrap; overflow: hidden;
        }
        .sidebar-header .logo i { font-size: 1.8rem; }
        .sidebar.collapsed { width: 78px; }
        .sidebar.collapsed .sidebar-header .logo span { display: none; }
        .sidebar.collapsed .sidebar-header .logo i { margin-right: 0; }
        .sidebar nav { flex-grow: 1; margin-top: 1rem; padding: 0 0.75rem; }
        .sidebar nav ul { list-style: none; padding: 0; }
        .sidebar nav ul li { margin-bottom: 0.5rem; }
        .sidebar nav ul li a {
            color: #e2e8f0; text-decoration: none; display: flex; align-items: center;
            padding: 0.75rem 1rem; gap: 1rem; border-radius: 8px; font-size: 0.95rem;
            font-weight: 500; white-space: nowrap; overflow: hidden; transition: background 0.2s ease, color 0.2s ease;
        }
        .sidebar nav ul li a i { width: 24px; text-align: center; font-size: 1.2rem; flex-shrink: 0; }
        .sidebar.collapsed nav ul li a span { display: none; }
        .sidebar.collapsed nav ul li a { justify-content: center; padding: 0.75rem; }
        .sidebar nav ul li a:hover { background: rgba(255, 255, 255, 0.1); color: white; }
        .sidebar nav ul li.active a { background: white; color: var(--primary); font-weight: 600; }
        .sidebar-footer { padding: 1rem 0.75rem; margin-top: auto; flex-shrink: 0; }
        .sidebar.collapsed .sidebar-footer { padding: 1rem 0.5rem; }
        .sidebar-footer button, .sidebar-footer a {
            background: none; border: none; cursor: pointer; color: #e2e8f0; padding: 0.75rem 1rem;
            border-radius: 8px; width: 100%; display: flex; align-items: center; gap: 1rem;
            transition: background 0.2s ease, color 0.2s ease; font-family: 'Inter', sans-serif;
            font-size: 0.95rem; text-decoration: none;
        }
        .sidebar-footer button:hover, .sidebar-footer a:hover { background: rgba(255, 255, 255, 0.1); color: white; }
        .sidebar.collapsed .sidebar-footer span { display: none; }
        .sidebar.collapsed .sidebar-footer button, .sidebar.collapsed .sidebar-footer a { justify-content: center; padding: 0.75rem; }

        /* --- Main Content & Topbar --- */
        .main-content {
            flex: 1; margin-left: 260px; transition: margin-left 0.3s ease;
            display: flex; flex-direction: column; width: calc(100% - 260px);
            max-width: calc(100% - 260px);
            box-sizing: border-box;
            /* Removido overflow-x: hidden; para permitir que os toasts apareçam */
        }
        .main-content.collapsed { 
            margin-left: 78px; 
            width: calc(100% - 78px); 
            max-width: calc(100% - 78px);
        }
        .topbar {
            background-color: var(--card); color: var(--text); padding: 0 1.5rem;
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid var(--border-color); height: 70px; flex-shrink: 0;
            position: sticky; top: 0; z-index: 900;
        }
        .topbar-left { display: flex; align-items: center; gap: 1rem; }
        .topbar .page-title { font-weight: 600; font-size: 1.25rem; color: var(--text); }
        .toggle-btn {
            background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--muted);
            width: 40px; height: 40px; border-radius: 50%; display: grid; place-items: center;
            transition: background 0.2s ease, color 0.2s ease;
        }
        .toggle-btn:hover { background-color: var(--bg); color: var(--primary); }
        .topbar-actions { display: flex; gap: 0.75rem; align-items: center; }
        .search-form { display: flex; align-items: center; }
        .search-input {
            padding: 0.5rem 0.8rem; border: 1px solid var(--border-color); border-radius: 8px 0 0 8px;
            font-size: 0.9rem; background-color: var(--bg); color: var(--text);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .search-input:focus {
            border-color: var(--primary); box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary) 20%, transparent);
            outline: none; z-index: 1;
        }
        .search-button {
            background-color: var(--primary); color: white; border: none;
            padding: 0.5rem 1rem; border-radius: 0 8px 8px 0; margin-left: -1px;
            cursor: pointer; transition: background-color 0.2s ease;
        }
        .search-button:hover { background-color: var(--accent); }

        main { 
            flex-grow: 1; 
            padding: 1.5rem; 
            overflow-y: auto; 
            width: 100%;
            max-width: 100%;
        }

        /* --- Buttons --- */
        .btn {
            padding: 0.6rem 1.2rem; font-size: 0.9rem; border-radius: 8px; text-decoration: none;
            font-weight: 600; display: inline-flex; align-items: center; justify-content: center;
            gap: 0.5rem; border: 1px solid transparent; cursor: pointer; transition: all 0.2s ease-in-out;
        }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.85rem; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: var(--accent); }
        .btn-info { background-color: var(--info); color: white; }
        .btn-info:hover { background-color: #0369a1; }
        .btn-warning { background-color: var(--warning); color: #854d0e; }
        [data-theme="dark"] .btn-warning { color: var(--dark-bg); }
        .btn-warning:hover { background-color: #fcd34d; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-danger:hover { background-color: #b91c1c; }

        /* --- Card Layout for Patients --- */
        .card-list-container {
            display: grid;
            /* Ajustado para 3 cards em telas maiores, 2 em médias, 1 em pequenas */
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Ajustado minmax para 4 cards */
            gap: 1.5rem;
            width: 100%;
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Melhorias para desktop - 4 cards por linha */
        @media (min-width: 1400px) { /* Mantém 1400px como ponto de quebra para 4 colunas */
            .card-list-container {
                grid-template-columns: repeat(4, 1fr);
                gap: 1.5rem; /* Ajustado para um gap menor para 4 colunas */
            }
        }

        /* Melhorias para desktop médio - 3 cards por linha */
        @media (min-width: 1000px) and (max-width: 1399px) { 
            .card-list-container {
                grid-template-columns: repeat(3, 1fr);
                gap: 1.5rem;
            }
        }

        /* Melhorias para tablet - 2 cards por linha */
        @media (min-width: 768px) and (max-width: 999px) {
            .card-list-container {
                grid-template-columns: repeat(2, 1fr); /* Alterado para 2 colunas em tablet */
                gap: 1.5rem;
            }
        }

        /* Melhorias para mobile - 1 card por linha */
        @media (max-width: 767px) {
            .card-list-container {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }

        /* Card moderno para pacientes */
        .patient-card-modern {
            background: var(--card);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            width: 100%;
            min-height: 280px; /* Pode ser ajustado para ser mais flexível */
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .paciente-card.modern-card {
            transform: translateY(var(--animation-delay, 0));
            opacity: 0;
            animation: slideInUp 0.6s ease forwards;
            animation-delay: var(--animation-delay, 0s);
            width: 100%;
            box-sizing: border-box;
            border-radius: 16px !important;
            height: 100%;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .patient-card-modern:hover {
            scale: 1.01;
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        }

        /* Header do card */
        .patient-header {
            display: flex;
            align-items: center;
            padding: 1.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: white;
            position: relative;
        }

        .patient-avatar {
            position: relative;
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            margin-right: 1rem;
            flex-shrink: 0;
        }

        .patient-status-indicator {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid white;
        }

        .status-active { background: #10b981; }
        .status-inactive { background: #ef4444; }
        .status-pending { background: #f59e0b; }

        .patient-info {
            flex: 1;
            min-width: 0;
        }

        .patient-name {
            font-size: 1.25rem;
            font-weight: 700;
            margin: 0 0 0.5rem 0;
            color: white;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
        }

        .patient-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .patient-meta span {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .patient-meta i {
            font-size: 0.75rem;
        }

        .patient-id, .patient-age {
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
        }

        /* Dropdown de ações */
        .patient-actions-dropdown {
            position: relative;
        }

        .dropdown-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .dropdown-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            min-width: 180px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
            z-index: 1000;
            margin-top: 0.5rem;
        }

        .dropdown-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            color: var(--text);
            text-decoration: none;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .dropdown-item:hover {
            background: var(--bg);
        }

        .dropdown-item-danger {
            color: var(--danger);
        }

        .dropdown-item-danger:hover {
            background: rgba(220, 38, 38, 0.1);
            color: var(--danger);
        }

        .dropdown-item i {
            width: 16px;
            text-align: center;
        }

        .dropdown-divider {
            height: 1px;
            background: var(--border-color);
            margin: 0.5rem 0;
        }

        .dropdown-section-label {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.25rem 1rem;
            font-size: 0.6rem;
            font-weight: 500;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.2px;
            opacity: 0.7;
            margin: 0.25rem 0 0.1rem 0;
        }

        [data-theme="dark"] .dropdown-section-label {
            color: var(--dark-muted);
            opacity: 0.6;
        }

        .dropdown-section-label i {
            font-size: 0.55rem;
            opacity: 0.5;
        }

        .dropdown-section-label + .dropdown-item {
            margin-top: 0.1rem;
        }

        .dropdown-section-label + .dropdown-divider {
            margin-top: 0.5rem;
        }

        /* Detalhes do paciente */
        .patient-details {
            padding: 1.5rem;
            flex: 1;
        }

        .detail-grid {
            display: grid;
            gap: 1rem;
            grid-template-columns: 1fr;
        }

        .detail-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            border-radius: 8px;
            transition: all 0.2s ease;
            width: 100%;
        }

        .detail-item.clickable {
            cursor: pointer;
        }

        .detail-item.clickable:hover {
            background: var(--bg);
            transform: translateX(4px);
        }

        .detail-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--muted);
            flex-shrink: 0;
        }

        .detail-content {
            flex: 1;
            min-width: 0;
        }

        .detail-label {
            display: block;
            font-size: 0.75rem;
            color: var(--muted);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.25rem;
        }

        .detail-value {
            display: block;
            font-size: 0.95rem;
            color: var(--text);
            font-weight: 500;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
        }
        /* Para o campo de endereço, permitir quebra de linha */
        .detail-value.address-value {
            white-space: normal;
            overflow: visible;
            text-overflow: unset;
        }


        .detail-empty {
            color: var(--muted);
            font-style: italic;
            opacity: 0.7;
            position: relative;
        }

        .detail-empty::before {
            content: "⚪";
            margin-right: 0.5rem;
            font-style: normal;
            opacity: 0.6;
        }

        /* Styling para ícones de campos vazios */
        .detail-item:has(.detail-empty) .detail-icon {
            opacity: 0.5;
        }

        .detail-item:has(.detail-empty) .detail-icon i {
            color: var(--muted);
        }

        .convenio-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Footer do card */
        .patient-footer {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            background: var(--bg);
            border-top: 1px solid var(--border-color);
            margin-top: auto;
            width: 100%;
        }

        .patient-stats {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex: 1;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: var(--muted);
        }

        .stat-item i {
            font-size: 0.75rem;
        }

        .quick-actions {
            display: flex;
            gap: 0.5rem;
        }

        .quick-action-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }

        .quick-action-btn.primary {
            background: var(--primary);
            color: white;
        }

        .quick-action-btn.info {
            background: var(--info);
            color: white;
        }

        .quick-action-btn.success {
            background: var(--success);
            color: white;
        }

        .quick-action-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Estado vazio */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4rem 2rem;
            text-align: center;
            background: var(--card);
            border-radius: 16px;
            border: 2px dashed var(--border-color);
        }

        .empty-state-animation {
            position: relative;
            margin-bottom: 2rem;
        }

        .empty-state-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            animation: floatIcon 3s ease-in-out infinite;
            box-shadow: 0 10px 30px rgba(13, 148, 136, 0.3);
        }

        @keyframes floatIcon {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(5deg); }
        }

        .empty-state-particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: var(--primary);
            border-radius: 50%;
            animation: floatParticle 4s ease-in-out infinite;
        }

        .particle:nth-child(1) {
            top: 20%;
            left: 20%;
            animation-delay: 0s;
        }

        .particle:nth-child(2) {
            top: 60%;
            right: 30%;
            animation-delay: 1.5s;
        }

        .particle:nth-child(3) {
            bottom: 30%;
            left: 60%;
            animation-delay: 3s;
        }

        @keyframes floatParticle {
            0%, 100% {
                transform: translateY(0px) scale(1);
                opacity: 0.7;
            }
            50% {
                transform: translateY(-20px) scale(1.2);
                opacity: 1;
            }
        }

        .empty-state-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.5rem;
        }

        .empty-state-description {
            font-size: 1rem;
            color: var(--muted);
            margin-bottom: 2rem;
            line-height: 1.5;
            max-width: 500px;
        }

        .empty-state-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .empty-state-btn {
            padding: 1rem 2rem;
            font-size: 1rem;
            border-radius: 12px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .empty-state-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .empty-state-btn:hover::before {
            left: 100%;
        }

        .btn-secondary {
            background: var(--muted);
            color: white;
        }

        .btn-secondary:hover {
            background: var(--text);
            transform: translateY(-2px);
        }

        /* Skeleton loading */
        .patient-card-skeleton {
            background: var(--card);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .skeleton-header {
            display: flex;
            align-items: center;
            padding: 1.5rem;
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
        }

        .skeleton-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.6);
            margin-right: 1rem;
            flex-shrink: 0;
        }

        .skeleton-info {
            flex: 1;
        }

        .skeleton-line {
            height: 12px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .skeleton-name {
            width: 70%;
            height: 16px;
        }

        .skeleton-meta {
            width: 50%;
        }

        .skeleton-body {
            padding: 1.5rem;
        }

        .skeleton-short {
            width: 60%;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.6;
            }
        }

        [data-theme="dark"] .skeleton-header {
            background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
        }

        [data-theme="dark"] .skeleton-line,
        [data-theme="dark"] .skeleton-avatar {
            background: rgba(55, 65, 81, 0.6);
        }

        /* Responsividade */
        @media (max-width: 767px) {
            .card-list-container {
                grid-template-columns: 1fr;
                gap: 1rem;
                padding: 0 0.5rem;
            }
            
            .patient-header {
                padding: 1rem;
            }
            
            .patient-avatar {
                width: 50px;
                height: 50px;
                font-size: 1.5rem;
                margin-right: 0.75rem;
            }
            
            .patient-name {
                font-size: 1.1rem;
            }
            
            .patient-meta {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .patient-details {
                padding: 1rem;
            }
            
            .patient-footer {
                padding: 0.75rem 1rem;
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }
            
            .patient-card-modern {
                width: 100%;
                max-width: 100%;
            }
            
            .detail-grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
            
            .detail-item {
                padding: 0.5rem;
            }
        }

        /* Melhorias para tablet */
        @media (min-width: 768px) and (max-width: 999px) {
            .card-list-container {
                padding: 0;
            }
            
            .patient-card-modern {
                width: 100%;
                max-width: 100%;
            }
            
            .detail-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }

        /* Melhorias para desktop */
        @media (min-width: 1000px) {
            .card-list-container {
                padding: 0;
            }
            
            .patient-card-modern {
                width: 100%;
                max-width: 100%;
                min-height: 300px;
            }
            
            .detail-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }

        /* Card original (manter para compatibilidade) */
        .paciente-card:not(.modern-card) {
            background-color: var(--card);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 1rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: default;
            position: relative;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .paciente-card:not(.modern-card):hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .paciente-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .paciente-card-header h4 {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text);
            margin: 0;
            flex-grow: 1;
        }
        [data-theme="dark"] .paciente-card-header h4 {
            color: var(--dark-text);
        }

        .paciente-card-header .actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .paciente-card-body {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            font-size: 0.95rem;
            align-items: center;
        }

        .paciente-card-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text);
            flex: 1;
        }
        .paciente-card-item i {
            color: var(--muted);
            font-size: 1rem;
            width: 20px;
            text-align: center;
            flex-shrink: 0;
        }
        .paciente-card-item .value {
            font-weight: 500;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-grow: 1;
        }
        [data-theme="dark"] .paciente-card-item .value {
            color: var(--dark-text);
        }

        /* --- Pagination Controls --- */
        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: var(--card);
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .pagination-button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            font-weight: 600;
        }
        .pagination-button:hover:not(:disabled) {
            background-color: var(--accent);
        }
        .pagination-button:disabled {
            background-color: var(--muted);
            cursor: not-allowed;
            opacity: 0.6;
        }
        .pagination-info {
            font-size: 1rem;
            color: var(--text);
            font-weight: 500;
        }

        /* --- Flash Messages (Toast-like) --- */
        .toast-container {
            position: fixed;
            top: 85px; /* Abaixo do topbar */
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 360px;
        }

        .toast {
            background-color: var(--card);
            color: var(--text);
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1), 0 5px 5px rgba(0,0,0,0.05);
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            border: 1px solid var(--border-color);
            animation: toast-slide-in 0.5s cubic-bezier(0.215, 0.610, 0.355, 1.000);
            position: relative;
            overflow: hidden;
        }

        .toast.success { border-left: 5px solid var(--success); }
        .toast.danger { border-left: 5px solid var(--danger); }
        .toast.warning { border-left: 5px solid var(--warning); }
        .toast.info { border-left: 5px solid var(--info); }

        .toast-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
            margin-top: 2px;
        }
        .toast.success .toast-icon { color: var(--success); }
        .toast.danger .toast-icon { color: var(--danger); }
        .toast.warning .toast-icon { color: var(--warning); }
        .toast.info .toast-icon { color: var(--info); }

        .toast-content {
            flex-grow: 1;
        }
        .toast-title {
            font-weight: 700;
            font-size: 1rem;
            color: var(--text);
            display: block;
            margin-bottom: 0.25rem;
        }
        .toast-message {
            font-size: 0.9rem;
            color: var(--muted);
            line-height: 1.4;
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--muted);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            opacity: 0.7;
            transition: opacity 0.2s ease, color 0.2s ease;
            flex-shrink: 0;
        }
        .toast-close:hover {
            opacity: 1;
            color: var(--text);
        }

        .toast-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 4px;
            width: 100%;
            animation: toast-progress-bar 5s linear forwards;
        }
        .toast.success .toast-progress { background-color: var(--success); }
        .toast.danger .toast-progress { background-color: var(--danger); }
        .toast.warning .toast-progress { background-color: var(--warning); }
        .toast.info .toast-progress { background-color: var(--info); }

        @keyframes toast-slide-in {
            from {
                opacity: 0;
                transform: translateX(110%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes toast-fade-out {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-20px);
            }
        }
        .toast.fade-out {
            animation: toast-fade-out 0.4s ease-in forwards;
        }

        @keyframes toast-progress-bar {
            from { width: 100%; }
            to { width: 0%; }
        }

        /* --- Responsive --- */
        .toggle-btn-desktop { display: none; }
        .menu-btn-mobile { display: block; }
        span.btn-text-desktop { display: none; }

        @media(min-width: 769px) {
            .toggle-btn-desktop { display: grid; }
            .menu-btn-mobile { display: none; }
            span.btn-text-desktop { display: inline; }
        }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); box-shadow: 4px 0 15px rgba(0,0,0,0.1); }
            .sidebar.collapsed { transform: translateX(-100%); width: 260px; }
            .sidebar.collapsed nav ul li a, .sidebar.collapsed .sidebar-footer button, .sidebar.collapsed .sidebar-footer a { justify-content: flex-start; }
            .sidebar.collapsed nav ul li a span, .sidebar.collapsed .sidebar-footer span { display: inline; }
            .sidebar.collapsed .sidebar-header .logo span { display: inline; }
            .main-content, .main-content.collapsed { margin-left: 0; width: 100%; }
            main { padding: 1rem; }
            .topbar { flex-wrap: wrap; height: auto; row-gap: 1rem; padding-top: 1rem; padding-bottom: 1rem;}
            .topbar-left, .topbar-actions { width: 100%; justify-content: space-between; }
            .search-form { flex-grow: 1; }
            
            .paciente-card-header .actions {
                flex-direction: column;
                align-items: flex-end;
            }
            .paciente-card-header .actions .btn {
                width: auto;
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
            }
        }

        /* --- Modal de Steps para Adicionar/Editar Paciente (visual igual ao paciente_form) --- */
        /* --- Steps no Modal Centralizado --- */
        #patient-steps-modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(15,23,42,0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3500;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        #patient-steps-modal-overlay.visible { 
            opacity: 1; 
            pointer-events: auto;
        }
        
        /* --- Modal de Confirmação de Exclusão --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(15,23,42,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 4000;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        
        .modal-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }
        
        .delete-modal {
            background: var(--card);
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            max-width: 480px;
            width: 90vw;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        
        .modal-overlay.show .delete-modal {
            transform: scale(1);
        }
        
        .delete-modal .modal-header {
            padding: 2rem 2rem 1rem 2rem;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
        }
        
        .modal-icon-danger {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: rgba(220, 38, 38, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem auto;
            color: var(--danger);
            font-size: 2rem;
        }
        
        .delete-modal .modal-header h3 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text);
        }
        
        .delete-modal .modal-body {
            padding: 2rem;
        }
        
        .delete-modal .modal-body p {
            margin-bottom: 1rem;
            color: var(--text);
            line-height: 1.6;
        }
        
        .warning-text {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.2);
            border-radius: 8px;
            padding: 1rem;
            color: #d97706;
            font-size: 0.9rem;
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
        }
        
        .warning-text i {
            margin-top: 0.1rem;
            flex-shrink: 0;
        }
        
        .delete-modal .modal-footer {
            padding: 1rem 2rem 2rem 2rem;
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }
        
        .delete-modal .modal-footer .btn {
            min-width: 120px;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .delete-modal .modal-footer .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .delete-modal .modal-footer .btn-secondary {
            background: var(--muted);
            color: white;
        }
        
        .delete-modal .modal-footer .btn-secondary:hover:not(:disabled) {
            background: var(--text);
        }
        
        .delete-modal .modal-footer .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .delete-modal .modal-footer .btn-danger:hover:not(:disabled) {
            background: #b91c1c;
        }
        
        #patient-steps-modal {
            background: var(--card);
            border-radius: 18px;
            box-shadow: 0 10px 32px rgba(0,0,0,0.18);
            /* max-width: 700px;
            width: 95vw;
            max-height: 95vh; */
            overflow: auto;
            position: relative;
            padding: 0;
            display: flex;
            flex-direction: column;
        }
        .form-card {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            align-items: stretch;
        }
        .paciente-steps {
            display: flex;
            flex-direction: row;
            width: 100%;
            background: none;
            border-radius: 18px 18px 0 0;
            overflow: hidden;
        }
        .paciente-step {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 18px 0 14px 0;
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--muted);
            opacity: 0.7;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            background: none;
            transition: color 0.2s, opacity 0.2s, border-color 0.2s, background 0.2s;
        }
        .paciente-step.active {
            color: var(--primary);
            opacity: 1;
            border-bottom: 3px solid var(--primary);
            background: var(--primary-light);
        }
        .paciente-step i {
            font-size: 1.2rem;
            margin-right: 0.5rem;
        }
        @media (max-width: 600px) {
            #patient-steps-modal { max-width: 100vw; border-radius: 0; }
            .paciente-steps { flex-direction: column; border-radius: 0; }
            .paciente-step { border-bottom: none; border-left: 4px solid transparent; justify-content: flex-start; padding: 14px 0 14px 18px; }
            .paciente-step.active { border-left: 4px solid var(--primary); background: var(--primary-light); }
        }

        .paciente-card-section {
            background: var(--card);
            border-radius: 0px 0px 18px 18px;
            box-shadow: 0 4px 24px 0 rgb(0 0 0 / 0.07);
            padding: 2.5rem 2rem 2rem 2rem;
            /* min-height: 100%; */
            border: 1.5px solid var(--border-color);
            position: relative;
        }

        .paciente-card-container-modal {
            min-height: 80vh;
            min-width: 80vw;            

            display: flex;
            flex-direction: column;
            /* align-items: center; */
            justify-content: space-between;
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 1.5rem;
        }
        .section-title i {
            font-size: 1.2rem;
        }
        .paciente-card-fields {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.2rem 2rem;
        }
        .paciente-field {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .paciente-field label {
            font-size: 1.05rem;
            color: var(--muted);
            font-weight: 600;
            margin-bottom: 0.1rem;
        }
        .paciente-field input,
        .paciente-field select,
        .paciente-field textarea {
            background: transparent;
            border: none;
            border-bottom: 2px solid var(--border-color);
            font-size: 1.1rem;
            padding: 0.5rem 0.2rem 0.3rem 0.2rem;
            color: var(--text);
            transition: border-color 0.2s;
            border-radius: 0;
            outline: none;
        }
        .paciente-field input:focus,
        .paciente-field select:focus,
        .paciente-field textarea:focus {
            border-color: var(--primary);
            background: #f7fafc;
        }
        .paciente-field textarea {
            min-height: 60px;
            resize: vertical;
        }
        .paciente-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 2rem;
            /* position: absolute;
            bottom: 2rem; */
        }
        .paciente-btn {
            padding: 8px 16px;
            font-size: 1rem;
            border-radius: 8px;
            border: none;
            font-weight: 700;
            background: var(--primary);
            color: #fff;
            box-shadow: 0 2px 12px 0 rgb(13 148 136 / 0.10);
            cursor: pointer;
            transition: background 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .paciente-btn.cancel {
            background: transparent;
            color: var(--muted);
            box-shadow: none;
        }
        .paciente-btn:not(.cancel):hover {
            background: var(--accent);
        }
        @media (max-width: 600px) {
            #patient-drawer { width: 100vw; min-width: 0; }
            .form-card { flex-direction: column; }
            .paciente-steps { flex-direction: row; width: 100%; min-width: 0; height: auto; }
            .paciente-step { flex-direction: row; align-items: center; justify-content: center; width: 100%; border-left: none; border-top: 4px solid transparent; }
            .paciente-step.active { border-top: 4px solid var(--primary); border-left: none; }
            .paciente-card-section { border-radius: 0 0 18px 18px; }
        }

        /* --- Estilos para o input de data customizado --- */
        .date-input-display {
            position: relative;
            background: var(--card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 14px 16px;
            font-size: 1rem;
            font-weight: 500;
            color: var(--text);
            transition: all 0.3s ease;
            width: 100%;
            box-sizing: border-box;
        }

        .date-input-display:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.1);
        }

        .date-input-display::placeholder {
            color: var(--muted);
            font-weight: 400;
        }

        .date-input-display.error {
            border-color: var(--danger);
            background-color: rgba(220, 38, 38, 0.05);
        }

        .date-input-display.error:focus {
            border-color: var(--danger);
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }

        .date-input-display.valid {
            border-color: var(--success);
            background-color: rgba(22, 163, 74, 0.05);
        }

        /* --- Estilos para campos obrigatórios --- */
        .paciente-field.required label::after {
            content: ' *';
            color: var(--danger);
            font-weight: 700;
            margin-left: 2px;
        }

        .paciente-field.required input,
        .paciente-field.required select,
        .paciente-field.required textarea {
            border-left: 3px solid var(--danger);
            padding-left: 8px;
        }

        .paciente-field.required input:focus,
        .paciente-field.required select:focus,
        .paciente-field.required textarea:focus {
            border-left-color: var(--primary);
            box-shadow: -3px 0 0 var(--primary);
        }

        .paciente-field.required input:valid,
        .paciente-field.required select:valid,
        .paciente-field.required textarea:valid {
            border-left-color: var(--success);
        }

        .paciente-field.required input:invalid,
        .paciente-field.required select:invalid,
        .paciente-field.required textarea:invalid {
            border-left-color: var(--danger);
        }

        /* Estilo específico para o campo de data obrigatório */
        .paciente-field.required .date-input-display {
            border-left: 3px solid var(--danger);
            padding-left: 13px;
        }

        .paciente-field.required .date-input-display:focus {
            border-left-color: var(--primary);
            box-shadow: -3px 0 0 var(--primary), 0 0 0 3px rgba(13, 148, 136, 0.1);
        }

        .paciente-field.required .date-input-display.valid {
            border-left-color: var(--success);
        }

        .paciente-field.required .date-input-display.error {
            border-left-color: var(--danger);
        }

        /* Estados de validação para campos obrigatórios */
        .paciente-field.required input.valid,
        .paciente-field.required select.valid,
        .paciente-field.required textarea.valid {
            border-bottom-color: var(--success);
            background-color: rgba(22, 163, 74, 0.05);
        }

        .paciente-field.required input.invalid,
        .paciente-field.required select.invalid,
        .paciente-field.required textarea.invalid {
            border-bottom-color: var(--danger);
            background-color: rgba(220, 38, 38, 0.05);
        }

        /* Animação sutil para transição de estados */
        .paciente-field input,
        .paciente-field select,
        .paciente-field textarea,
        .paciente-field .date-input-display {
            transition: all 0.3s ease;
        }

        /* Tooltip para campos obrigatórios */
        .paciente-field.required {
            position: relative;
        }

        .paciente-field.required:hover::before {
            content: 'Campo obrigatório';
            position: absolute;
            top: -30px;
            left: 0;
            background: var(--text);
            color: var(--card);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: nowrap;
            z-index: 1000;
            opacity: 0.9;
        }

        /* Tooltip específico para CPF */
        .paciente-field.required input[name="cpf"]:hover::after {
            content: 'Digite um CPF válido';
            position: absolute;
            top: -30px;
            right: 0;
            background: var(--info);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: nowrap;
            z-index: 1001;
            opacity: 0.9;
        }

        /* Feedback visual para CPF inválido */
        .paciente-field.required input[name="cpf"].invalid {
            border-bottom-color: var(--danger);
            background-color: rgba(220, 38, 38, 0.05);
            position: relative;
        }

        .paciente-field.required input[name="cpf"].invalid::placeholder {
            color: var(--danger);
        }

        /* Animação de shake para campos inválidos no submit */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .paciente-field.required input.invalid.shake,
        .paciente-field.required select.invalid.shake,
        .paciente-field.required textarea.invalid.shake,
        .paciente-field.required .date-input-display.error.shake {
            animation: shake 0.5s ease-in-out;
            border-color: var(--danger) !important;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.2) !important;
        }

        /* Destaque mais forte para campos inválidos */
        .paciente-field.required input.invalid,
        .paciente-field.required select.invalid,
        .paciente-field.required textarea.invalid {
            border-bottom-color: var(--danger) !important;
            border-left-color: var(--danger) !important;
            background-color: rgba(220, 38, 38, 0.1) !important;
        }

        .paciente-field.required .date-input-display.error {
            border-color: var(--danger) !important;
            border-left-color: var(--danger) !important;
            background-color: rgba(220, 38, 38, 0.1) !important;
        }

        /* Indicador visual para step com erro */
        .paciente-step.has-error {
            color: var(--danger) !important;
            border-bottom-color: var(--danger) !important;
            background: rgba(220, 38, 38, 0.1) !important;
        }

        .paciente-step.has-error::after {
            content: '⚠️';
            margin-left: 5px;
            font-size: 0.9rem;
        }

        /* Nova modal para alertas gerais */
        .alert-modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(15,23,42,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 4500; /* Maior que outras modals */
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        .alert-modal-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }
        .alert-modal {
            background: var(--card);
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            max-width: 400px; /* Tamanho consistente */
            width: 90vw;
            transform: scale(0.95);
            transition: transform 0.3s ease;
            padding: 2rem;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }
        .alert-modal-overlay.show .alert-modal {
            transform: scale(1);
        }
        .alert-modal-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
        }
        .alert-modal-icon.info { background: var(--info); }
        .alert-modal-icon.success { background: var(--success); }
        .alert-modal-icon.warning { background: var(--warning); }
        .alert-modal-icon.danger { background: var(--danger); }

        .alert-modal-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--text);
            margin: 0;
        }
        .alert-modal-message {
            font-size: 1rem;
            color: var(--muted);
            line-height: 1.6;
        }
        .alert-modal-actions {
            display: flex;
            justify-content: center;
            width: 100%;
        }
        .alert-modal-actions .btn {
            min-width: 100px;
        }
    </style>
</head>
<body>
    <div id="toast-container"></div>
    <!-- Nova Modal para Alertas Gerais -->
    <div id="general-alert-modal-overlay" class="alert-modal-overlay">
        <div class="alert-modal">
            <div id="alert-modal-icon" class="alert-modal-icon"></div>
            <h3 id="alert-modal-title" class="alert-modal-title"></h3>
            <p id="alert-modal-message" class="alert-modal-message"></p>
            <div class="alert-modal-actions">
                <button id="alert-modal-close-btn" class="btn btn-primary">OK</button>
            </div>
        </div>
    </div>

    <div class="layout">
        <aside class="sidebar">
            <div class="sidebar-inner-content">
                <div class="sidebar-header">
                    <a href="{{ url_for('index') }}" class="logo">
                        <i class="fa-solid fa-staff-snake"></i> <span>{{ session.clinica_nome_display or 'ClínicaOn' }}</span>
                    </a>
                </div>
                <nav>
                    <ul>
                        <li><a href="{{ url_for('index') }}"><i class="fa-solid fa-house-chimney"></i> <span>Dashboard</span></a></li>
                        <li class="active"><a href="{{ url_for('listar_pacientes') }}"><i class="fa-solid fa-hospital-user"></i> <span>Pacientes</span></a></li>
                        <li><a href="{{ url_for('buscar_prontuario') }}"><i class="fa-solid fa-notes-medical"></i> <span>Prontuários</span></a></li>
                        <li><a href="{{ url_for('listar_profissionais') }}"><i class="fa-solid fa-user-doctor"></i> <span>Profissionais</span></a></li>
                        <li><a href="{{ url_for('listar_servicos_procedimentos') }}"><i class="fa-solid fa-syringe"></i> <span>Serviços/Proc.</span></a></li>
                        <li><a href="{{ url_for('listar_convenios') }}"><i class="fa-solid fa-handshake"></i> <span>Convênios</span></a></li>
                        <li><a href="{{ url_for('listar_horarios') }}"><i class="fa-regular fa-clock"></i> <span>Horários</span></a></li>
                        <li><a href="{{ url_for('listar_agendamentos') }}"><i class="fa-regular fa-calendar-check"></i> <span>Agendamentos</span></a></li>
                        {% if session.user_role == 'admin' %}
                        <li><a href="{{ url_for('listar_usuarios') }}"><i class="fa-solid fa-users-gear"></i> <span>Utilizadores</span></a></li>
                        <li><a href="{{ url_for('listar_modelos_anamnese') }}"><i class="fa-regular fa-file-lines"></i> <span>Modelos Anamnese</span></a></li>
                        <li><a href="{{ url_for('listar_estoque') }}"><i class="fa-solid fa-boxes-stacked"></i> <span>Estoque</span></a></li>
                        <li><a href="{{ url_for('listar_contas_a_pagar') }}"><i class="fa-solid fa-money-bill-wave"></i> <span>Contas a Pagar</span></a></li>
                        <li><a href="{{ url_for('patrimonio.listar_patrimonio') }}"><i class="fa-solid fa-building-columns"></i> <span>Patrimônio</span></a></li>
                        {% endif %}
                    </ul>
                </nav>
                <div class="sidebar-footer">
                    <button id="theme-toggle" aria-label="Alternar tema">
                        <i class="fa-solid fa-sun"></i> <span>Alternar Tema</span>
                    </button>
                    <a href="#" id="logoutButton"><i class="fa-solid fa-arrow-right-from-bracket"></i> <span>Sair</span></a>
                </div>
            </div>
        </aside>

        <div class="main-content">
            <header class="topbar">
                <div class="topbar-left">
                    <button class="toggle-btn menu-btn-mobile"><i class="fa-solid fa-bars"></i></button>
                    <button class="toggle-btn toggle-btn-desktop"><i class="fa-solid fa-bars-staggered"></i></button>
                    <h1 class="page-title">Gerenciar Pacientes</h1>
                </div>
                <div class="topbar-actions">
                    <form id="searchForm" class="search-form"> {# Adicionado ID para o formulário #}
                        <input type="text" id="searchInput" name="search" placeholder="Buscar paciente..." class="search-input" value="{{ search_query or '' }}">
                        <button type="submit" class="search-button"><i class="fas fa-search"></i></button>
                    </form>
                    <button id="add-patient-btn" class="btn btn-primary" type="button" onclick="openPatientStepsModal()">
                        <i class="fas fa-plus"></i> <span class="btn-text-desktop">Adicionar Paciente</span>
                    </button>
                </div>
            </header>

            <main>
                {# O bloco de flash messages será tratado via JS/Toast #}

                <div class="card-list-container">
                    {# Os cards de paciente serão renderizados aqui via JavaScript #}
                </div>
                <p id="no-results-message" style="text-align: center; color: var(--muted); padding: 2rem; width: 100%; display: none;">Nenhum paciente encontrado.</p>

                <div class="pagination-controls">
                    <button id="prevPageBtn" class="pagination-button"><i class="fas fa-chevron-left"></i> Anterior</button>
                    <span id="pageInfo" class="pagination-info"></span>
                    <button id="nextPageBtn" class="pagination-button">Próximo <i class="fas fa-chevron-right"></i></button>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal de Steps para Adicionar/Editar Paciente (visual igual ao paciente_form) -->
    <div id="patient-steps-modal-overlay" style="display:none; z-index:3500; align-items:center; justify-content:center;">
        <div id="patient-steps-modal" style="background:var(--card); border-radius:18px; box-shadow:0 10px 32px rgba(0,0,0,0.18); overflow:auto; position:relative; padding:0; display:flex; flex-direction:column;">
            <form id="steps-patient-form" class="patient-form" action="{{ url_for('adicionar_paciente') }}" method="post" style="width:100%;">
                <div class="form-card" style="align-items:stretch;">
                    <div class="paciente-steps" style="min-width:120px;">
                        <div class="paciente-step active" data-step="1"><i class="fa-solid fa-user"></i> Dados Pessoais</div>
                        <div class="paciente-step" data-step="2"><i class="fa-solid fa-phone"></i> Contato</div>
                        <div class="paciente-step" data-step="3"><i class="fa-solid fa-location-dot"></i> Endereço</div>
                        <div class="paciente-step" data-step="4"><i class="fa-solid fa-circle-info"></i> Outras Informações</div>
                    </div>
                    <div class="paciente-step-content" style="flex:1; position:relative;">
                        <button type="button" class="paciente-btn cancel steps-modal-close" style="position:absolute; top:12px; right:12px; z-index:10; background:transparent; color:var(--muted); font-size:1.5rem;">&times;</button>
                        <div class="paciente-card-section" data-step-content="1" style="display:block;">
                            <div class="paciente-card-container-modal">
                                <div class="paciente-card-header-modal">
                                    <!-- <div class="section-title"><i class="fa-solid fa-user"></i> Dados Pessoais</div> -->
                                    <div class="paciente-card-fields single">
                                        <div class="paciente-field required"><label for="steps-nome">Nome Completo</label><input type="text" id="steps-nome" name="nome" required></div>
                                        <div class="paciente-field required">
                                            <label for="steps-data_nascimento">Data de Nascimento</label>
                                            <input type="text" 
                                                   id="steps-data_nascimento_display" 
                                                   placeholder="DD/MM/AAAA" 
                                                   maxlength="10" 
                                                   class="date-input-display"
                                                   required>
                                            <input type="hidden" id="steps-data_nascimento" name="data_nascimento" required>
                                        </div>
                                        <div class="paciente-field"><label for="steps-genero">Gênero</label><select id="steps-genero" name="genero"><option value="">Selecione</option><option value="Masculino">Masculino</option><option value="Feminino">Feminino</option><option value="Outro">Outro</option></select></div>
                                        <div class="paciente-field required"><label for="steps-cpf">CPF</label><input type="text" id="steps-cpf" name="cpf" placeholder="XXX.XXX.XXX-XX" required></div>
                                        <div class="paciente-field"><label for="steps-rg">RG</label><input type="text" id="steps-rg" name="rg" placeholder="XX.XXX.XXX-X"></div>
                                    </div>
                                </div>
    
                                <div class="paciente-actions paciente-actions-sticky" style="justify-content:flex-end; gap:1rem; margin-top:2rem;">
                                    <button type="button" class="paciente-btn btn-primary steps-next">Próximo <i class="fa fa-chevron-right"></i></button>
                                </div>
                            </div>
                        </div>
                        <div class="paciente-card-section" data-step-content="2" style="display:none;">
                            <div class="paciente-card-container-modal">
                                <div class="paciente-card-header-modal">
                                    <!-- <div class="section-title"><i class="fa-solid fa-phone"></i> Contato</div> -->
                                    <div class="paciente-card-fields single">
                                        <div class="paciente-field"><label for="steps-telefone">Telefone</label><input type="tel" id="steps-telefone" name="telefone" placeholder="(XX) XXXXX-XXXX"></div>
                                        <div class="paciente-field"><label for="steps-email">E-mail</label><input type="email" id="steps-email" name="email" placeholder="seu.email@example.com"></div>
                                    </div>
                                </div>
    
                                <div class="paciente-actions paciente-actions-sticky" style="justify-content:space-between; gap:1rem; margin-top:2rem;">
                                    <button type="button" class="paciente-btn btn-primary steps-prev"><i class="fa fa-chevron-left"></i> Voltar</button>
                                    <button type="button" class="paciente-btn btn-primary steps-next">Próximo <i class="fa fa-chevron-right"></i></button>
                                </div>
                            </div>
                        </div>
                        <div class="paciente-card-section" data-step-content="3" style="display:none;">
                            <div class="paciente-card-container-modal">
                                <div class="paciente-card-header-modal">
                                    <!-- <div class="section-title"><i class="fa-solid fa-location-dot"></i> Endereço</div> -->
                                    <div class="paciente-card-fields single">
                                        <div class="paciente-field"><label for="steps-cep">CEP</label><input type="text" id="steps-cep" name="cep" placeholder="XXXXX-XXX"></div>
                                        <div class="paciente-field required"><label for="steps-cidade">Cidade</label><input type="text" id="steps-cidade" name="cidade" required></div>
                                        <div class="paciente-field required"><label for="steps-estado">Estado (UF)</label><input type="text" id="steps-estado" name="estado" placeholder="SP" required></div>
                                        <div class="paciente-field"><label for="steps-logradouro">Logradouro</label><input type="text" id="steps-logradouro" name="logradouro" placeholder="Rua Exemplo"></div>
                                        <div class="paciente-field"><label for="steps-numero">Número</label><input type="text" id="steps-numero" name="numero" placeholder="123"></div>
                                        <div class="paciente-field"><label for="steps-bairro">Bairro</label><input type="text" id="steps-bairro" name="bairro" placeholder="Centro"></div>
                                        <div class="paciente-field"><label for="steps-complemento">Complemento</label><input type="text" id="steps-complemento" name="complemento" placeholder="Apto 401"></div>
                                    </div>
                                </div>
    
                                <div class="paciente-actions paciente-actions-sticky" style="justify-content:space-between; gap:1rem; margin-top:2rem;">
                                    <button type="button" class="paciente-btn btn-primary steps-prev"><i class="fa fa-chevron-left"></i> Voltar</button>
                                    <button type="button" class="paciente-btn btn-primary steps-next">Próximo <i class="fa fa-chevron-right"></i></button>
                                </div>
                            </div>
                        </div>
                        <div class="paciente-card-section" data-step-content="4" style="display:none;">
                            <div class="paciente-card-container-modal">
                                <div class="paciente-card-header-modal">
                                    <!-- <div class="section-title"><i class="fa-solid fa-circle-info"></i> Outras Informações</div> -->
                                    <div class="paciente-card-fields single">
                                        <div class="paciente-field"><label for="steps-convenio_id">Convênio</label><select id="steps-convenio_id" name="convenio_id"><option value="">Nenhum / Particular</option></select></div>
                                        <div class="paciente-field"><label for="steps-observacoes">Observações Gerais</label><textarea id="steps-observacoes" name="observacoes" rows="3" placeholder="Informações relevantes sobre o paciente, alergias, etc."></textarea></div>
                                    </div>
                                </div>
                                <div class="paciente-actions paciente-actions-sticky" style="justify-content:space-between; gap:1rem; margin-top:2rem;">
                                    <button type="button" class="paciente-btn btn-primary steps-prev"><i class="fa fa-chevron-left"></i> Voltar</button>
                                    <button type="submit" class="paciente-btn btn-primary"><i class="fas fa-save"></i> Salvar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Funções globais para interações dos cards
        function togglePatientActions(patientId) {
            const dropdown = document.getElementById(`actions-${patientId}`);
            const allDropdowns = document.querySelectorAll('.dropdown-menu');
            
            // Fechar outros dropdowns
            allDropdowns.forEach(menu => {
                if (menu !== dropdown) {
                    menu.classList.remove('show');
                }
            });
            
            dropdown.classList.toggle('show');
        }

        function callPatient(phone) {
            if (phone) {
                // Remove todos os caracteres não numéricos
                const cleanPhone = phone.replace(/\D/g, '');
                // Mensagem personalizada para WhatsApp
                const message = "Olá! Entrando em contato da clínica. Como posso ajudá-lo?";
                const encodedMessage = encodeURIComponent(message);
                // Abre o WhatsApp Web com o número e mensagem
                window.open(`https://wa.me/55${cleanPhone}?text=${encodedMessage}`, '_blank');
            }
        }

        function makePhoneCall(phone) {
            if (phone) {
                window.open(`tel:${phone.replace(/\D/g, '')}`);
            }
        }

        function emailPatient(email) {
            if (email) {
                window.open(`mailto:${email}`);
            }
        }

        // Variáveis globais para as funções de exclusão
        let allPatientsGlobal = [];
        let showToastGlobal = null;
        let currentPageGlobal = 1;
        let renderPatientCardsGlobal = null;
        let showGeneralAlertModalGlobal = null; // Nova variável global para a modal de alerta

        function deletePatient(patientId, patientName) {
            // Fechar o dropdown
            document.querySelectorAll('.dropdown-menu').forEach(menu => {
                menu.classList.remove('show');
            });

            // Criar modal de confirmação personalizado
            const modal = document.createElement('div');
            modal.className = 'modal-overlay delete-modal-overlay';
            modal.innerHTML = `
                <div class="modal-content delete-modal">
                    <div class="modal-header">
                        <div class="modal-icon-danger">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <h3>Confirmar Exclusão</h3>
                    </div>
                    <div class="modal-body">
                        <p>Tem certeza que deseja excluir o paciente <strong>${patientName}</strong>?</p>
                        <p class="warning-text">
                            <i class="fas fa-warning"></i>
                            Esta ação não pode ser desfeita. Todos os dados do paciente, incluindo prontuários e histórico médico, serão permanentemente removidos.
                        </p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">
                            <i class="fas fa-times"></i>
                            Cancelar
                        </button>
                        <button type="button" class="btn btn-danger" onclick="confirmDelete('${patientId}')">
                            <i class="fas fa-trash"></i>
                            Sim, Excluir
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Animação de entrada
            requestAnimationFrame(() => {
                modal.classList.add('show');
            });
        }

        function closeDeleteModal() {
            // Buscar especificamente pela modal de exclusão
            const modal = document.querySelector('.delete-modal-overlay');
            if (modal) {
                modal.classList.remove('show');
                
                // Aguardar a transição antes de remover o modal
                const handleTransitionEnd = () => {
                    if (modal.parentNode) {
                        modal.parentNode.removeChild(modal);
                    }
                    modal.removeEventListener('transitionend', handleTransitionEnd);
                };
                
                modal.addEventListener('transitionend', handleTransitionEnd);
                
                // Fallback: remover após timeout se a transição não funcionar
                setTimeout(() => {
                    if (modal.parentNode) {
                        modal.parentNode.removeChild(modal);
                    }
                    modal.removeEventListener('transitionend', handleTransitionEnd);
                }, 350);
            }
        }

        // Função para fechar o modal instantaneamente (para usar após exclusão)
        function forceCloseDeleteModal() {
            const modal = document.querySelector('.delete-modal-overlay');
            if (modal) {
                modal.remove();
            }
        }

        function confirmDelete(patientId) {
            // Mostrar loading
            const confirmBtn = document.querySelector('.modal-footer .btn-danger');
            const originalText = confirmBtn.innerHTML;
            confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Excluindo...';
            confirmBtn.disabled = true;

            // Fazer requisição para excluir o paciente
            fetch(`/pacientes/${patientId}/excluir`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
                }
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('Erro ao excluir paciente');
                }
            })
            .then(data => {
                forceCloseDeleteModal();
                
                // Remover o paciente da lista local
                if (allPatientsGlobal && allPatientsGlobal.length > 0) {
                    const index = allPatientsGlobal.findIndex(p => p.id === patientId);
                    if (index > -1) {
                        allPatientsGlobal.splice(index, 1);
                    }
                }
                
                // Recarregar a lista
                if (renderPatientCardsGlobal) {
                    // Usar a função global que atualizará a variável currentPage no escopo local
                    renderPatientCardsGlobal();
                }
                
                // Mostrar mensagem de sucesso
                if (showToastGlobal) {
                    showToastGlobal('Paciente excluído com sucesso!', 'success');
                }
            })
            .catch(error => {
                console.error('Erro ao excluir paciente:', error);
                confirmBtn.innerHTML = originalText;
                confirmBtn.disabled = false;
                if (showToastGlobal) {
                    showToastGlobal('Erro ao excluir paciente. Tente novamente.', 'danger');
                }
            });
        }

        // Fechar dropdowns ao clicar fora
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.patient-actions-dropdown')) {
                document.querySelectorAll('.dropdown-menu').forEach(menu => {
                    menu.classList.remove('show');
                });
            }
        });
    </script>

    <script type="module">
        // Define os modelos de URL usando Jinja2 para serem avaliados no servidor
        const prontuarioUrlTemplate = "{{ url_for('ver_prontuario', paciente_doc_id='__ID__') }}";
        const peiUrlTemplate = "{{ url_for('peis.ver_peis_paciente', paciente_doc_id='__ID__') }}";
        const editUrlTemplate = "{{ url_for('editar_paciente', paciente_doc_id='__ID__') }}";

        document.addEventListener('DOMContentLoaded', () => {
            const htmlEl = document.documentElement;
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            const menuBtnMobile = document.querySelector('.menu-btn-mobile');
            const toggleBtnDesktop = document.querySelector('.toggle-btn-desktop');
            const themeToggle = document.querySelector('#theme-toggle');
            const logoutButton = document.getElementById('logoutButton');
            const cardListContainer = document.querySelector('.card-list-container');
            const noResultsMessage = document.getElementById('no-results-message');

            const searchForm = document.getElementById('searchForm');
            const searchInput = document.getElementById('searchInput');
            const prevPageBtn = document.getElementById('prevPageBtn');
            const nextPageBtn = document.getElementById('nextPageBtn');
            const pageInfo = document.getElementById('pageInfo');

            // Dados de pacientes passados pelo Jinja2
            const allPatients = {{ pacientes | tojson | safe }};
            let filteredPatients = []; // Lista de pacientes após a filtragem

            let currentPage = 1;
            const itemsPerPage = 20; // 20 cards por página

            // Conectar variáveis locais com as globais para as funções de exclusão
            allPatientsGlobal = allPatients;
            currentPageGlobal = currentPage;

            // --- Lógica para Notificações Toast ---
            const toastContainer = document.getElementById('toast-container');
            function showToast(message, category = 'info') {
                if (!toastContainer) return;

                const toast = document.createElement('div');
                toast.className = `toast ${category}`;
                
                let iconClass = 'fa-solid fa-circle-info';
                let title = 'Informação';
                if (category === 'success') {
                    iconClass = 'fa-solid fa-check-circle';
                    title = 'Sucesso';
                }
                if (category === 'danger') {
                    iconClass = 'fa-solid fa-times-circle';
                    title = 'Erro';
                }
                if (category === 'warning') {
                    iconClass = 'fa-solid fa-exclamation-triangle';
                    title = 'Atenção';
                }

                toast.innerHTML = `
                    <div class="toast-icon">
                        <i class="${iconClass}"></i>
                    </div>
                    <div class="toast-content">
                        <strong class="toast-title">${title}</strong>
                        <span class="toast-message">${message}</span>
                    </div>
                    <button class="toast-close">&times;</button>
                    <div class="toast-progress"></div>
                `;
                
                toastContainer.appendChild(toast);

                const closeButton = toast.querySelector('.toast-close');
                closeButton.addEventListener('click', () => {
                    toast.classList.add('fade-out');
                    toast.addEventListener('animationend', () => toast.remove());
                });

                setTimeout(() => {
                    toast.classList.add('fade-out');
                    toast.addEventListener('animationend', () => toast.remove());
                }, 5000); // A notificação desaparece após 5 segundos
            }

            // Conectar a função showToast com a global
            showToastGlobal = showToast;

            // --- Lógica para Modal de Alerta Geral ---
            const generalAlertOverlay = document.getElementById('general-alert-modal-overlay');
            const alertModalIcon = document.getElementById('alert-modal-icon');
            const alertModalTitle = document.getElementById('alert-modal-title');
            const alertModalMessage = document.getElementById('alert-modal-message');
            const alertModalCloseBtn = document.getElementById('alert-modal-close-btn');

            function showGeneralAlertModal(title, message, category = 'info') {
                alertModalTitle.textContent = title;
                alertModalMessage.textContent = message;
                
                alertModalIcon.className = 'alert-modal-icon'; // Reset class
                let iconClass = '';
                switch (category) {
                    case 'info': iconClass = 'fas fa-info-circle'; break;
                    case 'success': iconClass = 'fas fa-check-circle'; break;
                    case 'warning': iconClass = 'fas fa-exclamation-triangle'; break;
                    case 'danger': iconClass = 'fas fa-times-circle'; break;
                }
                alertModalIcon.classList.add(category);
                alertModalIcon.innerHTML = `<i class="${iconClass}"></i>`;

                generalAlertOverlay.classList.add('show');
                document.body.style.overflow = 'hidden'; // Bloquear scroll do body
            }

            function closeGeneralAlertModal() {
                generalAlertOverlay.classList.remove('show');
                document.body.style.overflow = 'auto'; // Restaurar scroll do body
            }
            // Conectar a função showGeneralAlertModal com a global
            showGeneralAlertModalGlobal = showGeneralAlertModal;

            alertModalCloseBtn.addEventListener('click', closeGeneralAlertModal);
            generalAlertOverlay.addEventListener('click', (e) => {
                if (e.target === generalAlertOverlay) {
                    closeGeneralAlertModal();
                }
            });


            // --- Processa mensagens flash do backend e as exibe como toasts ---
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% for category, message in messages %}
                    showToast({{ message|tojson|safe }}, "{{ category }}");
                {% endfor %}
            {% endwith %}

            // --- Lógica da Sidebar ---
            function setupSidebar() {
                if (!sidebar || !mainContent) return;
                const updateDesktopToggleIcon = () => {
                    if (!toggleBtnDesktop) return;
                    const icon = toggleBtnDesktop.querySelector('i');
                    icon.className = sidebar.classList.contains('collapsed') ? 'fa-solid fa-bars' : 'fa-solid fa-bars-staggered';
                };
                const applyInitialState = () => {
                    if (window.innerWidth > 768) {
                        if (localStorage.getItem('sidebarCollapsed') === 'true') {
                            sidebar.classList.add('collapsed');
                            mainContent.classList.add('collapsed');
                        }
                    } else {
                        sidebar.classList.remove('open', 'collapsed');
                        mainContent.classList.remove('collapsed');
                    }
                    updateDesktopToggleIcon();
                };
                if (toggleBtnDesktop) {
                    toggleBtnDesktop.addEventListener('click', () => {
                        sidebar.classList.toggle('collapsed');
                        mainContent.classList.toggle('collapsed');
                        localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
                        updateDesktopToggleIcon();
                    });
                }
                if (menuBtnMobile) {
                    menuBtnMobile.addEventListener('click', (e) => {
                        e.stopPropagation();
                        sidebar.classList.toggle('open');
                    });
                }
                document.addEventListener('click', (e) => {
                    if (window.innerWidth <= 768 && sidebar.classList.contains('open') && !sidebar.contains(e.target) && !menuBtnMobile.contains(e.target)) {
                        sidebar.classList.remove('open');
                    }
                });
                applyInitialState();
                window.addEventListener('resize', applyInitialState);
            }

            // --- Lógica do Tema ---
            function setupTheme() {
                if (!themeToggle) return;
                const updateThemeUI = (theme) => {
                    htmlEl.setAttribute('data-theme', theme);
                    const icon = themeToggle.querySelector('i');
                    icon.className = theme === 'dark' ? 'fa-solid fa-moon' : 'fa-solid fa-sun';
                };
                const currentTheme = localStorage.getItem('theme') || 'light';
                updateThemeUI(currentTheme);
                themeToggle.addEventListener('click', () => {
                    const newTheme = htmlEl.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
                    localStorage.setItem('theme', newTheme);
                    updateThemeUI(newTheme);
                });
            }

            // --- Lógica de Logout ---
            function setupLogout() {
                if (!logoutButton) return;
                logoutButton.addEventListener('click', async (event) => {
                    event.preventDefault();
                    fetch("{{ url_for('logout') }}", { method: 'POST' })
                        .then(() => window.location.href = "{{ url_for('login_page') }}")
                        .catch(() => window.location.href = "{{ url_for('login_page') }}");
                });
            }

            // --- Função para filtrar pacientes ---
            function filterPatients(query) {
                if (!query) {
                    return allPatients;
                }
                const lowerCaseQuery = query.toLowerCase();
                return allPatients.filter(paciente => {
                    const matchesName = paciente.nome && paciente.nome.toLowerCase().includes(lowerCaseQuery);
                    const matchesPhone = paciente.contato_telefone && paciente.contato_telefone.toLowerCase().includes(lowerCaseQuery);
                    const matchesCpf = paciente.cpf && paciente.cpf.toLowerCase().includes(lowerCaseQuery);
                    return matchesName || matchesPhone || matchesCpf;
                });
            }

            // --- Renderização dos Cartões de Paciente (Moderna e Orgânica) ---
            function renderPatientCards() {
                cardListContainer.innerHTML = ''; // Limpa os cartões existentes
                
                const currentSearchQuery = searchInput.value;
                filteredPatients = filterPatients(currentSearchQuery);

                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                const patientsToRender = filteredPatients.slice(startIndex, endIndex);

                if (patientsToRender.length === 0) {
                    renderEmptyState();
                } else {
                    noResultsMessage.style.display = 'none';
                    
                    // Adicionar skeleton loading para feedback visual
                    showSkeletonLoading();
                    
                    setTimeout(() => {
                        cardListContainer.innerHTML = ''; // Remove skeleton
                        patientsToRender.forEach((paciente, index) => {
                            const card = createModernPatientCard(paciente, index);
                            cardListContainer.appendChild(card);
                        });
                        // Adicionar animação escalonada aos cards
                        animateCardsEntrance();
                    }, 150); // Pequeno delay para mostrar o skeleton
                }
                renderPaginationControls(); // Atualiza os controles de paginação
            }

            // Skeleton loading para melhor UX
            function showSkeletonLoading() {
                const skeletonCount = Math.min(itemsPerPage, 3);
                cardListContainer.innerHTML = '';
                
                for (let i = 0; i < skeletonCount; i++) {
                    const skeleton = document.createElement('div');
                    skeleton.className = 'patient-card-skeleton';
                    skeleton.innerHTML = `
                        <div class="skeleton-header">
                            <div class="skeleton-avatar"></div>
                            <div class="skeleton-info">
                                <div class="skeleton-line skeleton-name"></div>
                                <div class="skeleton-line skeleton-meta"></div>
                            </div>
                        </div>
                        <div class="skeleton-body">
                            <div class="skeleton-line"></div>
                            <div class="skeleton-line"></div>
                            <div class="skeleton-line skeleton-short"></div>
                        </div>
                    `;
                    cardListContainer.appendChild(skeleton);
                }
            }

            // Criar card moderno para paciente
            function createModernPatientCard(paciente, index) {
                const card = document.createElement('div');
                card.className = 'paciente-card modern-card';
                card.style.setProperty('--animation-delay', `${index * 0.1}s`);
                
                // Calcular idade se houver data de nascimento
                const idade = calculateAge(paciente.data_nascimento);
                const idadeText = formatAge(idade);
                
                // Determinar avatar baseado no gênero
                const avatarIcon = getAvatarIcon(paciente.genero);
                
                // Determinar cor do convênio
                const convenioColor = getConvenioColor(paciente.convenio_nome);
                
                // Adicionar gradiente dinâmico baseado no nome
                const gradientColor = getPatientGradient(paciente.nome);

                // Formatar endereço completo
                const fullAddress = formatAddress(paciente);
                
                card.innerHTML = `
                    <div class="patient-card-modern">
                        <div class="patient-header" style="background: ${gradientColor};">
                            <div class="patient-avatar">
                                <i class="${avatarIcon}"></i>
                                <div class="patient-status-indicator status-active"></div>
                            </div>
                            <div class="patient-info">
                                <h3 class="patient-name">${paciente.nome}</h3>
                                <div class="patient-meta">
                                    <span class="patient-age">
                                        <i class="fas fa-birthday-cake"></i>
                                        ${idadeText}
                                    </span>
                                    <span class="patient-id">
                                        <i class="fas fa-hashtag"></i>
                                        ID: ${paciente.id.slice(-6)}
                                    </span>
                                </div>
                            </div>
                            <div class="patient-actions-dropdown">
                                <button class="dropdown-toggle" onclick="togglePatientActions('${paciente.id}')">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <div class="dropdown-menu" id="actions-${paciente.id}">
                                    <div class="dropdown-section-label">
                                        <i class="fas fa-cog"></i> Ações
                                    </div>
                                    <button type="button" class="dropdown-item" onclick="openPatientStepsModal('${paciente.id}')">
                                        <i class="fas fa-edit"></i>
                                        Editar Dados
                                    </button>
                                    <button type="button" class="dropdown-item dropdown-item-danger" onclick="deletePatient('${paciente.id}', '${paciente.nome}')">
                                        <i class="fas fa-trash"></i>
                                        Excluir Paciente
                                    </button>
                                    
                                    <div class="dropdown-divider"></div>
                                    <div class="dropdown-section-label">
                                        <i class="fas fa-file-medical"></i> Dados Médicos
                                    </div>
                                    <a href="${prontuarioUrlTemplate.replace('__ID__', paciente.id)}" class="dropdown-item">
                                        <i class="fas fa-notes-medical"></i>
                                        Ver Prontuário
                                    </a>
                                    <a href="${peiUrlTemplate.replace('__ID__', paciente.id)}" class="dropdown-item">
                                        <i class="fas fa-child-reaching"></i>
                                        Ver PEI
                                    </a>
                                    ${paciente.contato_telefone || paciente.contato_email ? `
                                        <div class="dropdown-divider"></div>
                                        <div class="dropdown-section-label">
                                            <i class="fas fa-address-book"></i> Contatos
                                        </div>
                                    ` : ''}
                                    ${paciente.contato_telefone ? `
                                        <button type="button" class="dropdown-item" onclick="callPatient('${paciente.contato_telefone}')">
                                            <i class="fab fa-whatsapp"></i>
                                            ${formatPhone(paciente.contato_telefone)}
                                        </button>
                                        <button type="button" class="dropdown-item" onclick="makePhoneCall('${paciente.contato_telefone}')">
                                            <i class="fas fa-phone"></i>
                                            ${formatPhone(paciente.contato_telefone)}
                                        </button>
                                    ` : ''}
                                    ${paciente.contato_email ? `
                                        <button type="button" class="dropdown-item" onclick="emailPatient('${paciente.contato_email}')">
                                            <i class="fas fa-envelope"></i>
                                            ${paciente.contato_email}
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                        
                        <div class="patient-details">
                            <div class="detail-grid">
                                <!-- CPF - sempre exibido -->
                                <div class="detail-item">
                                    <div class="detail-icon">
                                        <i class="fas fa-id-card"></i>
                                    </div>
                                    <div class="detail-content">
                                        <span class="detail-label">CPF</span>
                                        <span class="detail-value ${!paciente.cpf ? 'detail-empty' : ''}">${paciente.cpf ? formatCPF(paciente.cpf) : 'Não informado'}</span>
                                    </div>
                                </div>
                                
                                <!-- Telefone - sempre exibido -->
                                <div class="detail-item ${paciente.contato_telefone ? 'clickable' : ''}" ${paciente.contato_telefone ? `onclick="callPatient('${paciente.contato_telefone}')"` : ''}>
                                    <div class="detail-icon">
                                        <i class="fas fa-phone"></i>
                                    </div>
                                    <div class="detail-content">
                                        <span class="detail-label">Telefone</span>
                                        <span class="detail-value ${!paciente.contato_telefone ? 'detail-empty' : ''}">${paciente.contato_telefone ? formatPhone(paciente.contato_telefone) : 'Não informado'}</span>
                                    </div>
                                </div>
                                
                                <!-- Email - sempre exibido -->
                                <div class="detail-item ${paciente.contato_email ? 'clickable' : ''}" ${paciente.contato_email ? `onclick="emailPatient('${paciente.contato_email}')"` : ''}>
                                    <div class="detail-icon">
                                        <i class="fas fa-envelope"></i>
                                    </div>
                                    <div class="detail-content">
                                        <span class="detail-label">E-mail</span>
                                        <span class="detail-value ${!paciente.contato_email ? 'detail-empty' : ''}">${paciente.contato_email || 'Não informado'}</span>
                                    </div>
                                </div>
                                
                                <!-- Endereço Completo -->
                                <div class="detail-item">
                                    <div class="detail-icon">
                                        <i class="fas fa-map-marker-alt"></i>
                                    </div>
                                    <div class="detail-content">
                                        <span class="detail-label">Endereço</span>
                                        <span class="detail-value address-value ${!fullAddress ? 'detail-empty' : ''}">${fullAddress || 'Não informado'}</span>
                                    </div>
                                </div>

                                <!-- Convênio - sempre exibido -->
                                <div class="detail-item">
                                    <div class="detail-icon">
                                        <i class="fas fa-handshake"></i>
                                    </div>
                                    <div class="detail-content">
                                        <span class="detail-label">Convênio</span>
                                        <span class="detail-value ${!paciente.convenio_nome ? 'detail-empty' : ''}">
                                            ${paciente.convenio_nome ? `<span class="convenio-badge" style="background-color: ${convenioColor};">${paciente.convenio_nome}</span>` : 'Não informado'}
                                        </span>
                                    </div>
                                </div>
                                
                                <!-- Data de Nascimento - sempre exibido -->
                                <div class="detail-item">
                                    <div class="detail-icon">
                                        <i class="fas fa-calendar-alt"></i>
                                    </div>
                                    <div class="detail-content">
                                        <span class="detail-label">Nascimento</span>
                                        <span class="detail-value ${!paciente.data_nascimento ? 'detail-empty' : ''}">${paciente.data_nascimento ? formatDate(paciente.data_nascimento) : 'Não informado'}</span>
                                    </div>
                                </div>
                                
                                <!-- Gênero - sempre exibido -->
                                <div class="detail-item">
                                    <div class="detail-icon">
                                        <i class="fas fa-${paciente.genero === 'Masculino' ? 'mars' : paciente.genero === 'Feminino' ? 'venus' : 'genderless'}"></i>
                                    </div>
                                    <div class="detail-content">
                                        <span class="detail-label">Gênero</span>
                                        <span class="detail-value ${!paciente.genero ? 'detail-empty' : ''}">${paciente.genero || 'Não informado'}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="patient-footer">
                            <div class="patient-stats">
                                <div class="stat-item">
                                    <i class="fas fa-calendar-plus"></i>
                                    <span>Cadastrado em ${formatDate(paciente.data_cadastro)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                return card;
            }

            // Estado vazio moderno e interativo
            function renderEmptyState() {
                noResultsMessage.style.display = 'none';
                const isSearching = searchInput.value.length > 0;
                
                cardListContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-animation">
                            <div class="empty-state-icon">
                                <i class="fas fa-${isSearching ? 'search' : 'user-friends'}"></i>
                            </div>
                            <div class="empty-state-particles">
                                <div class="particle"></div>
                                <div class="particle"></div>
                                <div class="particle"></div>
                            </div>
                        </div>
                        <h3 class="empty-state-title">
                            ${isSearching ? 'Nenhum paciente encontrado' : 'Nenhum paciente cadastrado'}
                        </h3>
                        <p class="empty-state-description">
                            ${isSearching ? 
                                'Tente ajustar os filtros de busca ou verifique se o nome, telefone ou CPF estão corretos.' : 
                                'Comece criando seu primeiro paciente para começar a gerenciar os dados clínicos.'
                            }
                        </p>
                        <div class="empty-state-actions">
                            <button class="btn btn-primary empty-state-btn" onclick="openPatientStepsModal()">
                                <i class="fas fa-plus"></i>
                                Adicionar Paciente
                            </button>
                            ${isSearching ? `
                                <button class="btn btn-secondary empty-state-btn" onclick="clearSearch()">
                                    <i class="fas fa-times"></i>
                                    Limpar Busca
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                // Animar entrada do estado vazio
                setTimeout(() => {
                    const emptyState = cardListContainer.querySelector('.empty-state');
                    if (emptyState) {
                        emptyState.style.opacity = '0';
                        emptyState.style.transform = 'translateY(20px)';
                        emptyState.style.transition = 'all 0.6s ease';
                        
                        setTimeout(() => {
                            emptyState.style.opacity = '1';
                            emptyState.style.transform = 'translateY(0)';
                        }, 100);
                    }
                }, 50);
            }
            
            // Função para limpar a busca
            function clearSearch() {
                searchInput.value = '';
                currentPage = 1;
                renderPatientCards();
            }

            // Funções auxiliares para formatação e interação
            function calculateAge(birthDate) {
                if (!birthDate) return null;
                
                const today = new Date();
                const birth = new Date(birthDate);
                
                // Evitar problemas de timezone
                today.setHours(0, 0, 0, 0);
                birth.setHours(0, 0, 0, 0);
                
                // Calcular anos
                let years = today.getFullYear() - birth.getFullYear();
                let months = today.getMonth() - birth.getMonth();
                
                // Ajustar se ainda não fez aniversário este ano
                if (months < 0 || (months === 0 && today.getDate() < birth.getDate())) {
                    years--;
                    months += 12;
                }
                
                // Ajustar meses se ainda não completou o mês
                if (today.getDate() < birth.getDate()) {
                    months--;
                    if (months < 0) {
                        months = 11;
                        years--;
                    }
                }
                
                return {
                    years: Math.max(0, years),
                    months: Math.max(0, months),
                    totalMonths: Math.max(0, years * 12 + months)
                };
            }

            function formatAge(ageData) {
                if (!ageData) return 'N/A';
                
                const { years, months, totalMonths } = ageData;
                
                // Para bebês menores de 2 anos, mostrar em meses
                if (years < 2) {
                    if (totalMonths === 0) {
                        return 'Recém-nascido';
                    } else if (totalMonths === 1) {
                        return '1 mês';
                    } else if (totalMonths < 12) {
                        return `${totalMonths} meses`;
                    } else if (totalMonths < 24) {
                        const remainingMonths = totalMonths - 12;
                        if (remainingMonths === 0) {
                            return '1 ano';
                        } else if (remainingMonths === 1) {
                            return '1 ano e 1 mês';
                        } else {
                            return `1 ano e ${remainingMonths} meses`;
                        }
                    }
                }
                
                // Para crianças e adultos, mostrar em anos
                if (years === 1) {
                    return '1 ano';
                } else {
                    return `${years} anos`;
                }
            }

            function getAvatarIcon(genero) {
                switch(genero?.toLowerCase()) {
                    case 'masculino': return 'fas fa-user-tie';
                    case 'feminino': return 'fas fa-user-crown';
                    default: return 'fas fa-user';
                }
            }

            function getConvenioColor(convenio) {
                if (!convenio || convenio === 'Particular') return '#6b7280';
                const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#f97316', '#84cc16'];
                const hash = convenio.split('').reduce((a, b) => {
                    a = ((a << 5) - a) + b.charCodeAt(0);
                    return a & a;
                }, 0);
                return colors[Math.abs(hash) % colors.length];
            }

            // Gerar gradiente dinâmico baseado no nome do paciente
            function getPatientGradient(nome) {
                // Cor sólida única para todos os cards
                return 'linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%)';
            }

            function formatCPF(cpf) {
                if (!cpf) return '';
                return cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
            }

            function formatPhone(phone) {
                if (!phone) return '';
                const cleaned = phone.replace(/\D/g, '');
                if (cleaned.length === 11) {
                    return cleaned.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
                }
                return phone;
            }

            function formatDate(dateStr) {
                if (!dateStr) return 'N/A';
                try {
                    const date = new Date(dateStr);
                    return date.toLocaleDateString('pt-BR');
                } catch {
                    return 'N/A';
                }
            }

            function formatAddress(paciente) {
                // Access the nested 'endereco' object
                const endereco = paciente.endereco || {}; 

                const parts = [];
                if (endereco.logradouro) parts.push(endereco.logradouro);
                if (endereco.numero) parts.push(`, ${endereco.numero}`);
                if (endereco.complemento) parts.push(` (${endereco.complemento})`);
                if (endereco.bairro) parts.push(` - ${endereco.bairro}`);
                if (endereco.cidade) parts.push(`, ${endereco.cidade}`);
                if (endereco.estado) parts.push(`/${endereco.estado}`);
                if (endereco.cep) parts.push(` - ${formatCEP(endereco.cep)}`);
                
                return parts.join('');
            }

            function formatCEP(cep) {
                if (!cep) return '';
                return cep.replace(/(\d{5})(\d{3})/, '$1-$2');
            }

            function animateCardsEntrance() {
                const cards = cardListContainer.querySelectorAll('.paciente-card');
                
                // Intersection Observer para animação quando entra na viewport
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach((entry) => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('animate-in');
                            observer.unobserve(entry.target);
                        }
                    });
                }, {
                    threshold: 0.1,
                    rootMargin: '50px'
                });
                
                cards.forEach((card, index) => {
                    card.style.opacity = '0';
                    card.style.transform = 'translateY(30px) scale(0.95)';
                    
                    // Animar com delay escalonado
                    setTimeout(() => {
                        card.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
                        card.style.opacity = '1';
                        card.style.transform = 'translateY(0) scale(1)';
                        
                        // Adicionar efeito de destaque sutil
                        setTimeout(() => {
                            card.style.boxShadow = '0 4px 20px rgba(0, 0, 0, 0.1)';
                        }, 300);
                    }, index * 150);
                    
                    observer.observe(card);
                });
            }

            // --- Lógica dos Controles de Paginação ---
            function renderPaginationControls() {
                const totalPages = Math.ceil(filteredPatients.length / itemsPerPage);
                pageInfo.textContent = `Página ${currentPage} de ${totalPages}`;

                prevPageBtn.disabled = currentPage === 1;
                nextPageBtn.disabled = currentPage === totalPages;
            }

            // --- Event Listener para o Formulário de Busca ---
            searchForm.addEventListener('submit', (event) => {
                event.preventDefault(); // Impede o envio padrão do formulário
                currentPage = 1; // Reseta a página para 1 ao realizar uma nova busca
                renderPatientCards(); // Renderiza os cards com o filtro aplicado
            });

            prevPageBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderPatientCards();
                }
            });

            nextPageBtn.addEventListener('click', () => {
                const totalPages = Math.ceil(filteredPatients.length / itemsPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    renderPatientCards();
                }
            });

            // Função auxiliar para bloquear interação com elementos de fundo
            function createModalBackdrop() {
                const backdrop = document.createElement('div');
                backdrop.id = 'modal-backdrop';
                backdrop.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100vw;
                    height: 100vh;
                    background: rgba(0, 0, 0, 0.5);
                    z-index: 3400;
                    pointer-events: auto;
                `;
                document.body.appendChild(backdrop);
                return backdrop;
            }

            function removeModalBackdrop() {
                const backdrop = document.getElementById('modal-backdrop');
                if (backdrop) {
                    backdrop.remove();
                }
            }

            // --- Lógica da Função openPatientStepsModal ---
            window.openPatientStepsModal = function(patientId) {
                // Fechar qualquer modal de exclusão que possa estar aberta
                const deleteModal = document.querySelector('.delete-modal-overlay');
                if (deleteModal) {
                    deleteModal.remove();
                }
                
                const overlay = document.getElementById('patient-steps-modal-overlay');
                const modal = document.getElementById('patient-steps-modal');
                
                if (!overlay || !modal) {
                    return;
                }
                
                const steps = modal.querySelectorAll('.paciente-step');
                const sections = modal.querySelectorAll('.paciente-card-section');
                const form = document.getElementById('steps-patient-form');
                
                if (!form) {
                    return;
                }
                
                // Configurar navegação dos steps TODA VEZ que a modal for aberta
                function setupStepsForThisModal() {
                    let currentStep = 0;
                    
                    function showStep(idx) {
                        steps.forEach((s,i) => {
                            s.classList.toggle('active', i === idx);
                        });
                        sections.forEach((sec,i) => {
                            sec.style.display = i === idx ? 'block' : 'none';
                        });
                        currentStep = idx;
                    }
                    
                    if (steps.length === 0 || sections.length === 0) {
                        return;
                    }
                    
                    steps.forEach((step, i) => {
                        step.onclick = null;
                        step.removeEventListener('click', step._clickHandler);
                        
                        const clickHandler = (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            showStep(i);
                        };
                        
                        step._clickHandler = clickHandler;
                        step.addEventListener('click', clickHandler);
                        
                        step.style.cursor = 'pointer';
                        step.style.userSelect = 'none';
                        step.setAttribute('data-step-index', i);
                    });
                    
                    const nextBtns = modal.querySelectorAll('.steps-next');
                    const prevBtns = modal.querySelectorAll('.steps-prev');
                    
                    nextBtns.forEach((btn, index) => {
                        btn.onclick = null;
                        btn.addEventListener('click', () => {
                            showStep(Math.min(currentStep + 1, sections.length - 1));
                        });
                    });
                    
                    prevBtns.forEach((btn, index) => {
                        btn.onclick = null;
                        btn.addEventListener('click', () => {
                            showStep(Math.max(currentStep - 1, 0));
                        });
                    });
                    
                    showStep(0);
                    
                    const closeBtn = modal.querySelector('.steps-modal-close');
                    if (closeBtn) {
                        closeBtn.onclick = () => {
                            overlay.classList.remove('visible');
                            document.body.style.overflow = 'auto';
                            if (modal._focusTrap) {
                                document.removeEventListener('keydown', modal._focusTrap);
                                modal._focusTrap = null;
                            }
                            if (modal._backdrop) {
                                modal._backdrop.remove();
                                modal._backdrop = null;
                            }
                            setTimeout(() => overlay.style.display = 'none', 300);
                        };
                    }
                    
                    overlay.onclick = (e) => {
                        if (e.target === overlay) {
                            overlay.classList.remove('visible');
                            document.body.style.overflow = 'auto';
                            if (modal._focusTrap) {
                                document.removeEventListener('keydown', modal._focusTrap);
                                modal._focusTrap = null;
                            }
                            if (modal._backdrop) {
                                modal._backdrop.remove();
                                modal._backdrop = null;
                            }
                            setTimeout(() => overlay.style.display = 'none', 300);
                        }
                    };
                }
                
                form.reset();
                clearValidationClasses();
                
                if (patientId) {
                    form.action = editUrlTemplate.replace('__ID__', patientId);
                    const paciente = allPatients.find(p => String(p.id) === String(patientId));
                    if (paciente) {
                        form.elements['nome'].value = paciente.nome || '';
                        const dataNascimento = paciente.data_nascimento;
                        if (dataNascimento) {
                            const formattedDate = formatDateToYMD(dataNascimento);
                            form.elements['data_nascimento'].value = formattedDate;
                            const displayInput = document.getElementById('steps-data_nascimento_display');
                            if (displayInput && formattedDate) {
                                displayInput.value = formatDateToDMY(formattedDate);
                            }
                        }
                        form.elements['genero'].value = paciente.genero || '';
                        form.elements['cpf'].value = paciente.cpf || '';
                        form.elements['rg'].value = paciente.rg || '';
                        form.elements['telefone'].value = paciente.contato_telefone || '';
                        form.elements['email'].value = paciente.contato_email || '';
                        // Acessar os campos de endereço aninhados
                        form.elements['cep'].value = paciente.endereco?.cep || '';
                        form.elements['cidade'].value = paciente.endereco?.cidade || '';
                        form.elements['estado'].value = paciente.endereco?.estado || '';
                        form.elements['logradouro'].value = paciente.endereco?.logradouro || '';
                        form.elements['numero'].value = paciente.endereco?.numero || '';
                        form.elements['bairro'].value = paciente.endereco?.bairro || '';
                        form.elements['complemento'].value = paciente.endereco?.complemento || '';
                        form.elements['convenio_id'].value = paciente.convenio_id || '';
                        form.elements['observacoes'].value = paciente.observacoes || '';
                    }
                } else {
                    form.action = "{{ url_for('adicionar_paciente') }}";
                }
                
                overlay.style.display='flex';
                
                // Criar backdrop adicional para garantir bloqueio
                const backdrop = createModalBackdrop();
                
                setTimeout(() => {
                    overlay.classList.add('visible');
                    
                    // Bloquear scroll do body quando modal estiver aberta
                    document.body.style.overflow = 'hidden';
                    
                    // Configurar navegação dos steps APÓS a modal ser exibida
                    setupStepsForThisModal();
                    
                    // Focar no primeiro input da modal
                    const firstInput = modal.querySelector('input:not([type="hidden"]), select, textarea');
                    if (firstInput) {
                        firstInput.focus();
                    }
                    
                    // Trap de foco - garantir que o Tab não saia da modal
                    const focusableElements = modal.querySelectorAll(
                        'button, [href], input:not([type="hidden"]), select, textarea, [tabindex]:not([tabindex="-1"])'
                    );
                    const firstFocusableElement = focusableElements[0];
                    const lastFocusableElement = focusableElements[focusableElements.length - 1];
                    
                    // Função para interceptar Tab
                    const trapFocus = (e) => {
                        if (e.key === 'Tab') {
                            if (e.shiftKey) {
                                // Shift + Tab
                                if (document.activeElement === firstFocusableElement) {
                                    lastFocusableElement.focus();
                                    e.preventDefault();
                                }
                            } else {
                                // Tab
                                if (document.activeElement === lastFocusableElement) {
                                    firstFocusableElement.focus();
                                    e.preventDefault();
                                }
                            }
                        }
                        // Fechar modal com Escape
                        if (e.key === 'Escape') {
                            closeBtn?.click();
                        }
                    };
                    
                    // Adicionar trap de foco
                    document.addEventListener('keydown', trapFocus);
                    
                    // Armazenar referência para poder remover depois
                    modal._focusTrap = trapFocus;
                    modal._backdrop = backdrop;
                }, 10);
            };

            function clearValidationClasses() {
                const requiredFields = document.querySelectorAll('.paciente-field.required input, .paciente-field.required select, .paciente-field.required textarea');
                requiredFields.forEach(field => {
                    field.classList.remove('valid', 'invalid');
                    if (field.classList.contains('date-input-display')) {
                        field.classList.remove('valid', 'error');
                    }
                    // Remover animação de shake
                    field.classList.remove('shake');
                    // Remover has-error dos steps
                    const stepParent = field.closest('[data-step-content]');
                    if (stepParent) {
                        const stepIndex = Array.from(stepParent.parentNode.children).indexOf(stepParent);
                        const stepElement = document.querySelector(`.paciente-step[data-step="${stepIndex + 1}"]`);
                        if (stepElement) {
                            stepElement.classList.remove('has-error');
                        }
                    }
                });
            }

            function setupRequiredFieldValidation() {
                const requiredFields = document.querySelectorAll('.paciente-field.required input, .paciente-field.required select, .paciente-field.required textarea');
                requiredFields.forEach(field => {
                    if (field.type === 'hidden') return;
                    
                    if (field.name === 'cpf') {
                        applyCPFMask(field);
                    }
                    
                    field.addEventListener('blur', function() {
                        validateRequiredField(this);
                    });
                    
                    field.addEventListener('input', function() {
                        if (this.classList.contains('invalid')) {
                            this.classList.remove('invalid');
                        }
                        
                        if (this.name === 'cpf' && this.value.replace(/\D/g, '').length === 11) {
                            validateRequiredField(this);
                        }
                    });
                });
            }

            function validateRequiredField(field) {
                let isValid = false;
                
                if (field.name === 'cpf') {
                    isValid = validateCPF(field.value);
                } else if (field.classList.contains('date-input-display')) {
                    const hiddenInput = document.getElementById('steps-data_nascimento');
                    isValid = hiddenInput && hiddenInput.value.trim() !== '' && isValidDate(hiddenInput.value);
                } else {
                    isValid = field.value.trim() !== '';
                }
                
                if (isValid) {
                    field.classList.remove('invalid');
                    field.classList.add('valid');
                    if (field.classList.contains('date-input-display')) {
                        field.classList.remove('error');
                        field.classList.add('valid');
                    }
                } else {
                    field.classList.remove('valid');
                    field.classList.add('invalid');
                    if (field.classList.contains('date-input-display')) {
                        field.classList.remove('valid');
                        field.classList.add('error');
                    }
                }
                
                return isValid;
            }

            function validateCPF(cpf) {
                cpf = cpf.replace(/\D/g, '');
                
                if (cpf.length !== 11) return false;
                
                if (/^(\d)\1+$/.test(cpf)) return false;
                
                let sum = 0;
                for (let i = 0; i < 9; i++) {
                    sum += parseInt(cpf[i]) * (10 - i);
                }
                let remainder = sum % 11;
                let digit1 = remainder < 2 ? 0 : 11 - remainder;
                
                if (parseInt(cpf[9]) !== digit1) return false;
                
                sum = 0;
                for (let i = 0; i < 10; i++) {
                    sum += parseInt(cpf[i]) * (11 - i);
                }
                remainder = sum % 11;
                let digit2 = remainder < 2 ? 0 : 11 - remainder;
                
                return parseInt(cpf[10]) === digit2;
            }

            function applyCPFMask(input) {
                input.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    
                    if (value.length > 11) {
                        value = value.slice(0, 11);
                    }
                    
                    if (value.length > 9) {
                        value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{0,2})/, '$1.$2.$3-$4');
                    } else if (value.length > 6) {
                        value = value.replace(/(\d{3})(\d{3})(\d{0,3})/, '$1.$2.$3');
                    } else if (value.length > 3) {
                        value = value.replace(/(\d{3})(\d{0,3})/, '$1.$2');
                    }
                    
                    e.target.value = value;
                });
                
                input.addEventListener('keypress', function(e) {
                    if (!/[0-9]/.test(e.key) && 
                        !['Backspace', 'Delete', 'Tab', 'Enter', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                        e.preventDefault();
                    }
                });
            }

            // --- Validação de formulário antes do submit ---
            const patientForm = document.getElementById('steps-patient-form');
            patientForm.addEventListener('submit', function(event) {
                let allFieldsValid = true;
                const requiredFields = patientForm.querySelectorAll('.paciente-field.required input:not([type="hidden"]), .paciente-field.required select, .paciente-field.required textarea');
                
                // Limpar classes de erro e shake de todos os campos e steps
                requiredFields.forEach(field => {
                    field.classList.remove('invalid', 'shake');
                });
                document.querySelectorAll('.paciente-step').forEach(step => step.classList.remove('has-error'));

                const invalidFieldsPerStep = new Map();

                requiredFields.forEach(field => {
                    const isValid = validateRequiredField(field);
                    if (!isValid) {
                        allFieldsValid = false;
                        field.classList.add('invalid');
                        field.classList.add('shake'); // Adiciona animação de shake
                        
                        // Marca o step como tendo erro
                        const stepContent = field.closest('[data-step-content]');
                        if (stepContent) {
                            const stepIndex = Array.from(stepContent.parentNode.children).indexOf(stepContent);
                            const stepElement = document.querySelector(`.paciente-step[data-step="${stepIndex + 1}"]`);
                            if (stepElement) {
                                stepElement.classList.add('has-error');
                            }
                            // Armazena o primeiro campo inválido por step
                            if (!invalidFieldsPerStep.has(stepIndex)) {
                                invalidFieldsPerStep.set(stepIndex, field);
                            }
                        }
                    }
                });

                if (!allFieldsValid) {
                    event.preventDefault(); // Impede o envio do formulário
                    
                    // Encontra o primeiro step com erro e o exibe
                    const firstInvalidStepIndex = Array.from(invalidFieldsPerStep.keys()).sort((a,b) => a - b)[0];
                    if (firstInvalidStepIndex !== undefined) {
                        const steps = patientForm.querySelectorAll('.paciente-step');
                        const sections = patientForm.querySelectorAll('.paciente-card-section');
                        
                        steps.forEach((s,i) => {
                            s.classList.toggle('active', i === firstInvalidStepIndex);
                        });
                        sections.forEach((sec,i) => {
                            sec.style.display = i === firstInvalidStepIndex ? 'block' : 'none';
                        });
                        
                        // Foca no primeiro campo inválido do primeiro step com erro
                        const firstInvalidField = invalidFieldsPerStep.get(firstInvalidStepIndex);
                        if (firstInvalidField) {
                            firstInvalidField.focus();
                        }
                    }

                    showGeneralAlertModal('Campos Obrigatórios', 'Por favor, preencha todos os campos obrigatórios e corrija os erros indicados.', 'danger');
                }
            });

            setupSidebar();
            setupTheme();
            setupLogout();
            setupRequiredFieldValidation();
            renderPatientCards();
            
            renderPatientCardsGlobal = renderPatientCards;
        });

        function formatDateToYMD(dateStr) {
            if (!dateStr) return '';
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return dateStr;
            const d = new Date(dateStr);
            if (!isNaN(d.getTime())) {
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${y}-${m}-${day}`;
            }
            return '';
        }

        function formatDateToDMY(dateStr) {
            if (!dateStr) return '';
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                const [year, month, day] = dateStr.split('-');
                return `${day}/${month}/${year}`;
            }
            return '';
        }

        function parseDateFromDMY(dateStr) {
            if (!dateStr) return '';
            const cleanStr = dateStr.replace(/[^\d\/]/g, '');
            const match = cleanStr.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
            if (match) {
                const [, day, month, year] = match;
                return `${year}-${month}-${day}`;
            }
            return '';
        }

        function isValidDate(dateStr) {
            if (!dateStr) return false;
            const d = new Date(dateStr);
            return !isNaN(d.getTime()) && d.getFullYear() > 1900 && d.getTime() <= Date.now();
        }

        document.addEventListener('DOMContentLoaded', function() {
            const displayInput = document.getElementById('steps-data_nascimento_display');
            const hiddenInput = document.getElementById('steps-data_nascimento');
            const cepInput = document.getElementById('steps-cep');
            const logradouroInput = document.getElementById('steps-logradouro');
            const bairroInput = document.getElementById('steps-bairro');
            const cidadeInput = document.getElementById('steps-cidade');
            const estadoInput = document.getElementById('steps-estado');

            // Máscara e validação para Data de Nascimento
            if (displayInput && hiddenInput) {
                displayInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    
                    if (value.length > 8) {
                        value = value.slice(0, 8);
                    }
                    
                    if (value.length >= 5) {
                        value = value.replace(/(\d{2})(\d{2})(\d{0,4})/, '$1/$2/$3');
                    } else if (value.length >= 3) {
                        value = value.replace(/(\d{2})(\d{0,2})/, '$1/$2');
                    }
                    
                    e.target.value = value;
                    
                    const parsedDate = parseDateFromDMY(value);
                    hiddenInput.value = parsedDate;
                    
                    if (value.length === 10) {
                        if (isValidDate(parsedDate)) {
                            e.target.classList.remove('error');
                            e.target.classList.add('valid');
                        } else {
                            e.target.classList.remove('valid');
                            e.target.classList.add('error');
                        }
                    } else {
                        e.target.classList.remove('valid', 'error');
                    }
                });
                
                displayInput.addEventListener('keypress', function(e) {
                    if (!/[0-9]/.test(e.key) && 
                        !['Backspace', 'Delete', 'Tab', 'Enter', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                        e.preventDefault();
                    }
                });
                
                displayInput.addEventListener('paste', function(e) {
                    e.preventDefault();
                    const pastedText = (e.clipboardData || window.clipboardData).getData('text');
                    const digitsOnly = pastedText.replace(/\D/g, '').slice(0, 8);
                    
                    if (digitsOnly.length >= 6) {
                        let formatted = digitsOnly;
                        if (formatted.length >= 5) {
                            formatted = formatted.replace(/(\d{2})(\d{2})(\d{0,4})/, '$1/$2/$3');
                        } else if (formatted.length >= 3) {
                            formatted = formatted.replace(/(\d{2})(\d{0,2})/, '$1/$2');
                        }
                        
                        displayInput.value = formatted;
                        hiddenInput.value = parseDateFromDMY(formatted);
                        
                        displayInput.dispatchEvent(new Event('input'));
                    }
                });
            }

            // Busca CEP
            if (cepInput) {
                cepInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length > 8) {
                        value = value.slice(0, 8);
                    }
                    if (value.length > 5) {
                        value = value.replace(/(\d{5})(\d{0,3})/, '$1-$2');
                    }
                    e.target.value = value;
                });

                cepInput.addEventListener('blur', async function() {
                    const cep = this.value.replace(/\D/g, '');
                    if (cep.length === 8) {
                        try {
                            // Adicionar um indicador de carregamento
                            this.style.background = `url('https://cdnjs.cloudflare.com/ajax/libs/galleriffic/2.0.1/css/loader.gif') no-repeat right 10px center / 20px 20px`;
                            this.style.backgroundSize = '20px 20px'; // Ajustar o tamanho da imagem
                            this.style.paddingRight = '40px'; // Adicionar padding para o ícone

                            const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                            const data = await response.json();

                            if (data.erro) {
                                showGeneralAlertModal('CEP Inválido', 'O CEP informado não foi encontrado.', 'warning');
                                // Limpar campos de endereço se o CEP for inválido
                                logradouroInput.value = '';
                                bairroInput.value = '';
                                cidadeInput.value = '';
                                estadoInput.value = '';
                            } else {
                                logradouroInput.value = data.logradouro || '';
                                bairroInput.value = data.bairro || '';
                                cidadeInput.value = data.localidade || '';
                                estadoInput.value = data.uf || '';
                            }
                        } catch (error) {
                            console.error('Erro ao buscar CEP:', error);
                            showGeneralAlertModal('Erro na Busca de CEP', 'Não foi possível buscar o CEP. Verifique sua conexão ou tente novamente.', 'danger');
                            // Limpar campos de endereço em caso de erro
                            logradouroInput.value = '';
                            bairroInput.value = '';
                            cidadeInput.value = '';
                            estadoInput.value = '';
                        } finally {
                            // Remover indicador de carregamento
                            this.style.background = '';
                            this.style.paddingRight = '';
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>
