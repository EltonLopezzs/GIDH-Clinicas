<!DOCTYPE html>
<html lang="pt-br" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prontuário de {{ paciente.nome if paciente else 'Paciente' }} - {{ session.clinica_nome_display or 'Clínica On' }}</title>

    <link rel="icon" type="image/png" href="https://placehold.co/40x40/0d9488/ffffff?text=C">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


    <style>
        :root {
            --bg: #f1f5f9;
            --card: #ffffff;
            --text: #0f172a;
            --muted: #64748b;
            --accent: #0f172a;
            --primary: #0d9488; /* Teal-600 */
            --primary-dark: #115e59;
            --primary-light: #ccfbf1;
            --secondary: #f59e0b; /* Amber-500 */
            --danger: #dc2626; /* Red-600 */
            --success: #16a34a; /* Green-600 */
            --warning: #f59e0b;
            --info: #0ea5e9;
            --pei-color: #A0C4FF; /* Soft pastel blue for PEI */
            --pei-color-dark: #3F51B5; /* Darker shade for text in light mode */
            --border-color: #e2e8f0;
            --shadow-light: 0 4px 12px -2px rgba(0,0,0,0.1), 0 2px 8px -2px rgba(0,0,0,0.06);
            --shadow-medium: 0 10px 25px rgba(0,0,0,0.2);

            --dark-bg: #0f172a;
            --dark-card: #1e293b;
            --dark-text: #f1f5f9;
            --dark-muted: #94a3b8;
            --dark-border-color: #334155;
            --dark-shadow-light: 0 4px 12px -2px rgba(0,0,0,0.3), 0 2px 8px -2px rgba(0,0,0,0.2);
            --dark-shadow-medium: 0 10px 25px rgba(0,0,0,0.4);

            /* Chat colors */
            --chat-bubble-bg-user: #e2e8f0;
            --chat-bubble-bg-other: #ccfbf1; /* Primary Light */
            --dark-chat-bubble-bg-user: #334155;
            --dark-chat-bubble-bg-other: #115e59; /* Primary Dark */


            color-scheme: light;

            /* Cores para os status dos agendamentos */
            --status-confirmado: #16a34a;
            --status-concluido: #0ea5e9;
            --status-pendente: #f59e0b;
            --status-cancelado: #dc2626;
        }

        [data-theme="dark"] {
            --bg: var(--dark-bg);
            --text: var(--dark-text);
            --card: var(--dark-card);
            --muted: var(--dark-muted);
            --border-color: var(--dark-border-color);
            --shadow-light: var(--dark-shadow-light);
            --shadow-medium: var(--dark-shadow-medium);
            color-scheme: dark;
            --status-confirmado: #22c55e;
            --status-concluido: #38bdf8;
            --status-pendente: #fbbf24;
            --status-cancelado: #ef4444;

            --chat-bubble-bg-user: var(--dark-chat-bubble-bg-user);
            --chat-bubble-bg-other: var(--dark-chat-bubble-bg-other);

            --pei-color: #3f51b5; /* Darker blue for PEI in dark mode */
            --pei-color-dark: #A0C4FF; /* Lighter shade for text in dark mode */
        }

        /* Base Styles */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; overflow-x: hidden; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .layout { display: flex; min-height: 100vh; width: 100%; }

        /* --- Sidebar & Topbar (KEEP AS IS) --- */
        .sidebar { width: 260px; background: linear-gradient(180deg, var(--primary), var(--accent)); color: white; position: fixed; top: 0; left: 0; height: 100vh; transition: width 0.3s ease, transform 0.3s ease; z-index: 1000; display: flex; flex-direction: column; }
        .sidebar-inner-content { padding: 0; height: 100%; overflow-y: auto; display: flex; flex-direction: column; }
        .sidebar-header { padding: 0 1rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1); flex-shrink: 0; height: 70px; display: flex; align-items: center; justify-content: center; }
        .sidebar-header .logo { font-size: 1.4rem; font-weight: 700; color: white; text-decoration: none; display: flex; align-items: center; gap: 0.75rem; white-space: nowrap; overflow: hidden; }
        .sidebar-header .logo i { font-size: 1.8rem; }
        .sidebar.collapsed { width: 78px; }
        .sidebar.collapsed .sidebar-header .logo span, .sidebar.collapsed nav ul li a span, .sidebar.collapsed .sidebar-footer span { display: none; }
        .sidebar nav { flex-grow: 1; margin-top: 1rem; padding: 0 0.75rem; }
        .sidebar nav ul { list-style: none; padding: 0; }
        .sidebar nav ul li { margin-bottom: 0.5rem; }
        .sidebar nav ul li a { color: #e2e8f0; text-decoration: none; display: flex; align-items: center; padding: 0.75rem 1rem; gap: 1rem; border-radius: 8px; font-size: 0.95rem; font-weight: 500; white-space: nowrap; overflow: hidden; transition: background 0.2s ease, color 0.2s ease; }
        .sidebar nav ul li a i { width: 24px; text-align: center; font-size: 1.2rem; flex-shrink: 0; }
        .sidebar.collapsed nav ul li a { justify-content: center; padding: 0.75rem; }
        .sidebar nav ul li a:hover { background: rgba(255, 255, 255, 0.1); color: white; }
        .sidebar nav ul li.active a { background: white; color: var(--primary); font-weight: 600; }
        .sidebar-footer { padding: 1rem 0.75rem; margin-top: auto; flex-shrink: 0; }
        .sidebar-footer button, .sidebar-footer a { background: none; border: none; cursor: pointer; color: #e2e8f0; padding: 0.75rem 1rem; border-radius: 8px; width: 100%; display: flex; align-items: center; gap: 1rem; transition: background 0.2s ease, color 0.2s ease; font-family: 'Inter', sans-serif; font-size: 0.95rem; text-decoration: none; }
        .sidebar-footer button:hover, .sidebar-footer a:hover { background: rgba(255, 255, 255, 0.1); color: white; }
        .main-content { flex: 1; margin-left: 260px; transition: margin-left 0.3s ease; display: flex; flex-direction: column; width: calc(100% - 260px); }
        .main-content.collapsed { margin-left: 78px; width: calc(100% - 78px); }
        .topbar { background-color: var(--card); color: var(--text); padding: 0 1.5rem; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border-color); height: 70px; flex-shrink: 0; position: sticky; top: 0; z-index: 900; }
        .topbar-left { display: flex; align-items: center; gap: 1rem; }
        .topbar .page-title { font-weight: 600; font-size: 1.25rem; color: var(--text); }
        /* Adjusted display for toggle buttons to ensure only one is visible */
        .toggle-btn-desktop { display: none; } /* Hidden by default on small screens */
        .menu-btn-mobile { display: block; } /* Visible by default on small screens */

        @media(min-width: 769px) {
            .toggle-btn-desktop { display: grid; } /* Visible on desktop */
            .menu-btn-mobile { display: none; } /* Hidden on desktop */
            span.btn-text-desktop { display: inline; }
            .sidebar.collapsed .sidebar-header .logo span, .sidebar.collapsed nav ul li a span, .sidebar.collapsed .sidebar-footer span { display: none; }
        }

        main { flex-grow: 1; padding: 1.5rem; overflow-y: auto; }

        /* --- Buttons & Actions --- */
        .btn {
            padding: 0.7rem 1.4rem; /* Aumentado */
            font-size: 0.95rem; /* Levemente aumentado */
            border-radius: 10px; /* Mais arredondado */
            text-decoration: none;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.6rem; /* Mais espaço para o ícone */
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08); /* Sombra mais sutil */
        }
        .btn:active {
            transform: translateY(1px); /* Efeito de clique */
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
        }
        .btn-sm { padding: 0.5rem 1rem; font-size: 0.88rem; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: var(--primary-dark); box-shadow: 0 4px 8px rgba(0,0,0,0.12); }
        .btn-secondary { background-color: var(--card); color: var(--text); border-color: var(--border-color); box-shadow: var(--shadow-light); }
        .btn-secondary:hover { border-color: #a7b7c8; background-color: var(--bg); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .btn-warning { background-color: var(--warning); color: #854d0e; box-shadow: 0 2px 4px rgba(245, 158, 11, 0.2); }
        .btn-warning:hover { background-color: #d97706; color: white; }
        .btn-success { background-color: var(--success); color: white; box-shadow: 0 2px 4px rgba(22, 163, 74, 0.2); }
        .btn-success:hover { background-color: #15803d; }
        .btn-danger-outline { background-color: transparent; color: var(--danger); border: 1px solid var(--danger); box-shadow: none; }
        .btn-danger-outline:hover { background-color: var(--danger); color: white; box-shadow: 0 2px 4px rgba(220, 38, 38, 0.2); }
        .btn-info { background-color: var(--info); color: white; box-shadow: 0 2px 4px rgba(14, 165, 233, 0.2); }
        .btn-info:hover { background-color: #0369a1; }
        .topbar-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            justify-content: flex-end;
            align-items: center; /* Alinha os itens verticalmente no centro */
        }

        /* --- Paciente Info --- */
        .paciente-info-card {
            background: var(--card);
            padding: 2rem 2.5rem; /* Aumentado o padding */
            border-radius: 16px; /* Mais arredondado */
            box-shadow: var(--shadow-medium); /* Sombra mais proeminente */
            margin-bottom: 2.5rem; /* Mais espaço */
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .paciente-info-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 10px; /* Mais espessa */
            background: linear-gradient(to right, var(--primary), var(--primary-dark));
            border-radius: 16px 16px 0 0;
        }
        .paciente-info-card:hover {
            transform: translateY(-3px); /* Efeito de elevação sutil */
            box-shadow: 0 12px 20px rgba(0,0,0,0.15);
        }
        .paciente-info-card h3 { font-size: 2rem; color: var(--text); margin-bottom: 1.5rem; font-weight: 700; padding-top: 0.5rem; }
        .paciente-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); /* Ajustado minmax */
            gap: 1.5rem 2.5rem; /* Mais espaçamento */
            font-size: 1rem; /* Levemente aumentado */
        }
        .paciente-info-item strong {
            color: var(--muted);
            display: block;
            font-weight: 600;
            font-size: 0.85rem; /* Levemente aumentado */
            margin-bottom: 0.4rem;
            text-transform: uppercase;
            letter-spacing: 0.06em; /* Mais espaçamento entre letras */
        }
        .paciente-info-item span { font-weight: 600; color: var(--text); word-break: break-word; }

        /* --- Seções & Registros --- */
        .prontuario-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.8rem; flex-wrap: wrap; gap: 1.2rem; } /* Aumentado espaçamento */
        .prontuario-header h2 { font-size: 1.8rem; color: var(--text); margin: 0; font-weight: 700; }
        .registro-card {
            background: var(--card);
            padding: 1.8rem; /* Aumentado */
            border-radius: 14px; /* Mais arredondado */
            box-shadow: var(--shadow-light);
            margin-bottom: 1.8rem; /* Mais espaçamento */
            position: relative;
            border-left: 10px solid transparent; /* Borda mais espessa */
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .registro-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }
        .registro-header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 1px solid var(--border-color); padding-bottom: 1.2rem; margin-bottom: 1.2rem; } /* Aumentado */
        .registro-header h4 { font-size: 1.3rem; color: var(--primary); margin: 0; font-weight: 600; } /* Aumentado */
        .registro-meta { font-size: 0.9rem; color: var(--muted); text-align: right; } /* Aumentado */
        .registro-meta span { display: block; margin-top: 0.2rem; }
        .registro-content {
            font-size: 0.95rem; /* Ajustado para melhor legibilidade */
            color: var(--text);
            line-height: 1.7;
            white-space: pre-wrap;
            overflow-wrap: break-word;
            max-height: 250px;
            overflow-y: auto;
            padding-right: 10px;
        }
        .registro-content::-webkit-scrollbar { width: 8px; } /* Scrollbar mais larga */
        .registro-content::-webkit-scrollbar-track { background: var(--bg); border-radius: 4px; }
        .registro-content::-webkit-scrollbar-thumb { background: var(--muted); border-radius: 4px; border: 2px solid var(--bg); }
        .registro-content::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        .registro-actions { margin-top: 1.8rem; border-top: 1px solid var(--border-color); padding-top: 1.8rem; display: flex; justify-content: flex-end; gap: 0.8rem; flex-wrap: wrap;} /* Aumentado espaçamento e adicionado flex-wrap */
        .empty-state {
            text-align: center;
            padding: 3rem; /* Mais padding */
            color: var(--muted);
            background: var(--card);
            border-radius: 12px;
            font-size: 1.1rem;
            border: 1px dashed var(--border-color);
        }

        .registro-card--anamnese { border-left-color: var(--primary); }
        .registro-card--laudo { border-left-color: var(--info); }
        .registro-card--orientacao { border-left-color: var(--warning); }
        .registro-card--procedimento { border-left-color: var(--success); }
        .registro-card--evolucao_pei { border-left-color: var(--pei-color-dark); } /* Use a darker shade for the border */

        /* --- Tabs --- */
        .tabs-container { margin-bottom: 2rem; }
        .tab-nav {
            display: flex;
            gap: 8px; /* Mais espaço entre tabs */
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 2rem; /* Mais espaço */
            flex-wrap: wrap;
        }
        .tab-nav-item {
            padding: 0.8rem 1.5rem; /* Maior padding */
            cursor: pointer;
            font-weight: 600;
            color: var(--muted);
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            transform: translateY(2px);
            transition: color 0.2s ease, border-color 0.2s ease, background-color 0.2s ease;
            font-size: 1rem; /* Aumentado */
            border-radius: 8px 8px 0 0; /* Apenas topo arredondado */
        }
        .tab-nav-item:hover {
            color: var(--text);
            background-color: var(--bg); /* Fundo sutil ao passar o mouse */
        }
        .tab-nav-item.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background-color: var(--card); /* Fundo para a aba ativa */
            box-shadow: 0 -2px 8px rgba(0,0,0,0.05); /* Sombra sutil na aba ativa */
        }
        .tab-panel { display: none; padding-top: 0.5rem; } /* Ajuste de padding */
        .tab-panel.active { display: block; }

        /* --- Modals --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7); /* Fundo mais escuro */
            display: flex; /* Usar flex para centralizar */
            align-items: center; /* Centralizar verticalmente */
            justify-content: center; /* Centralizar horizontalmente */
            padding: 2vh 1rem; /* Padding responsivo */
            z-index: 2000;
            opacity: 0;
            visibility: hidden; /* Controlar visibilidade para transição */
            transition: opacity 0.3s ease, visibility 0.3s ease;
            overflow-y: auto; /* Permitir scroll para conteúdo longo */
            -webkit-overflow-scrolling: touch; /* Suavizar scroll em mobile */
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: var(--card);
            color: var(--text);
            border-radius: 16px; /* Mais arredondado */
            box-shadow: var(--shadow-medium);
            width: 95%; /* Responsivo */
            max-width: 700px; /* Largura máxima padrão */
            max-height: 96vh; /* Altura máxima para caber na tela */
            transform: translateY(-30px); /* Começa um pouco acima */
            transition: transform 0.3s ease, opacity 0.3s ease;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Garante que o conteúdo não vaze */
        }
        .modal-overlay.active .modal-content {
            transform: translateY(0); /* Desliza para a posição final */
        }

        /* Styling for the new large viewer modal */
        #modalVisualizarRegistro .modal-content {
            max-width: 950px; /* Mais largo para visualização */
            width: 95%;
            max-height: 95vh;
        }
        #modalVisualizarRegistro .modal-body {
            font-size: 1.05rem; /* Fonte ligeiramente maior para leitura */
            line-height: 1.7;
            white-space: pre-wrap;
            overflow-wrap: break-word;
            padding: 2rem; /* Mais padding */
        }


        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.2rem 1.8rem; /* Padding maior */
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
            background-color: var(--bg); /* Fundo sutil */
        }
        .modal-header h3 { font-size: 1.3rem; color: var(--text); margin: 0; font-weight: 600; }
        .modal-close-btn {
            background: none;
            border: none;
            font-size: 1.7rem; /* Ícone maior */
            color: var(--muted);
            cursor: pointer;
            line-height: 1;
            transition: color 0.2s ease, transform 0.2s ease;
            padding: 0.2rem; /* Área de toque maior */
        }
        .modal-close-btn:hover { color: var(--danger); transform: rotate(90deg); }
        .modal-body { overflow-y: auto; padding: 1.5rem; flex-grow: 1; }
        .modal-footer {
            padding: 1.2rem 1.8rem; /* Padding maior */
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 0.8rem; /* Mais espaço entre botões */
            flex-shrink: 0;
            background-color: var(--bg); /* Fundo sutil */
        }
        .form-group { margin-bottom: 1.5rem; } /* Mais espaçamento */
        .form-group:last-child { margin-bottom: 0; }
        .form-group label {
            display: block;
            font-size: 0.95rem; /* Levemente maior */
            color: var(--muted);
            font-weight: 500;
            margin-bottom: 0.6rem; /* Mais espaço */
        }
        .form-group input, .form-group select, .form-group textarea {
            font-size: 1rem; /* Aumentado */
            padding: 0.8rem 1rem; /* Padding maior */
            width: 100%;
            border: 1px solid var(--border-color);
            border-radius: 10px; /* Mais arredondado */
            background-color: var(--bg);
            color: var(--text);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus, .editor-content:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px color-mix(in srgb, var(--primary) 25%, transparent); /* Sombra maior e mais suave */
            outline: none;
        }
        .confirm-modal-content { max-width: 550px; padding: 2rem; } /* Aumentado */

        /* Rich Text Editor */
        .editor-toolbar {
            background-color: var(--bg);
            border: 1px solid var(--border-color);
            border-bottom: none;
            border-radius: 10px 10px 0 0; /* Mais arredondado */
            padding: 0.6rem; /* Mais padding */
            display: flex;
            flex-wrap: wrap;
            gap: 6px; /* Mais espaço */
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); /* Sombra interna sutil */
        }
        .editor-toolbar button {
            background: none;
            border: 1px solid transparent;
            padding: 9px; /* Área de clique maior */
            cursor: pointer;
            font-size: 1.05rem; /* Levemente maior */
            color: var(--text);
            border-radius: 6px; /* Mais arredondado */
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        .editor-toolbar button:hover { background-color: color-mix(in srgb, var(--primary) 15%, transparent); border-color: color-mix(in srgb, var(--primary) 30%, transparent); }
        .editor-toolbar button.is-active { background-color: color-mix(in srgb, var(--primary) 25%, transparent); border-color: var(--primary); }
        .editor-content {
            min-height: 280px; /* Altura mínima aumentada */
            max-height: 450px; /* Altura máxima aumentada */
            overflow-y: auto;
            padding: 1.2rem; /* Mais padding */
            border: 1px solid var(--border-color);
            border-radius: 0 0 10px 10px; /* Mais arredondado */
            font-size: 1rem;
            background-color: var(--card);
            color: var(--text);
            outline: none;
            line-height: 1.7; /* Mais espaçamento entre linhas */
            resize: vertical;
        }
        .editor-content[data-placeholder]:empty:before {
            content: attr(data-placeholder);
            color: var(--muted);
            pointer-events: none;
            display: block;
            padding-top: 0.1rem; /* Ajuste para centralizar visualmente */
        }

        /* --- Gemini IA --- */
        .gemini-generator {
            margin-bottom: 2rem; /* Mais espaçamento */
            background-color: color-mix(in srgb, var(--primary) 8%, transparent); /* Cor de fundo mais notável */
            padding: 1.5rem; /* Mais padding */
            border-radius: 12px; /* Mais arredondado */
            border: 1px solid color-mix(in srgb, var(--primary) 20%, transparent);
            box-shadow: inset 0 1px 4px rgba(0,0,0,0.05); /* Sombra interna */
        }
        .gemini-generator .form-group { margin-bottom: 1rem; }
        .gemini-generator-actions { display: flex; gap: 12px; align-items: center; } /* Mais espaço */
        .gemini-generator-actions input { flex-grow: 1; padding-right: 1.5rem; /* Espaço para o ícone de carregamento */ }
        .consent-text {
            font-size: 0.9rem; /* Levemente maior */
            color: var(--muted);
            font-weight: 500;
            line-height: 1.5;
            padding: 0.8rem 1rem; /* Mais padding */
            border-radius: 8px;
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
            display: flex;
            align-items: center;
        }
        .consent-text:hover { border-color: color-mix(in srgb, var(--primary) 40%, transparent); }
        .consent-text.active {
            background-color: color-mix(in srgb, var(--success) 20%, transparent);
            color: var(--success);
            font-weight: 600;
            border-color: color-mix(in srgb, var(--success) 40%, transparent);
        }
        .consent-text.active::before {
            content: '\f00c'; /* Font Awesome check icon */
            font-family: 'Font Awesome 6 Free';
            font-weight: 900; margin-right: 0.8rem;
            animation: bounceIn 0.5s;
        }
        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); }
        }


        /* --- PEI Accordion --- */
        .pei-accordion { display: flex; flex-direction: column; gap: 1.2rem; }
        .pei-card {
            background-color: var(--card);
            border: 1px solid var(--border-color);
            border-radius: 14px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); /* Mais suave e presente */
            transition: all 0.3s ease;
            position: relative;
        }
        .pei-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 6px; /* Linha superior mais fina */
            background: var(--pei-color); /* Solid color, no gradient */
            border-radius: 14px 14px 0 0;
        }
        .pei-card:hover {
            transform: translateY(-4px); /* Efeito de elevação mais perceptível */
            box-shadow: 0 12px 25px rgba(0,0,0,0.15); /* Sombra maior no hover */
        }
        .pei-header {
            display: flex;
            justify-content: space-between; /* To push title left and actions right */
            align-items: center;
            padding: 1.2rem 1.8rem;
            cursor: pointer;
            background-color: var(--pei-color); /* Fundo integrado */
            border-bottom: 1px solid var(--border-color);
            border-radius: 0; /* Remove rounded top from here */
        }
        [data-theme="dark"] .pei-header {
            background-color: var(--pei-color);
            border-bottom: 1px solid var(--dark-border-color);
        }
        .pei-header h4 {
            font-size: 1.3rem;
            color: var(--pei-color-dark);
            margin: 0;
            font-weight: 600;
            flex-grow: 1; /* Allow title to grow and push other elements */
        }
        [data-theme="dark"] .pei-header h4 { color: var(--pei-color-dark); }

        .pei-header-actions {
            display: flex;
            align-items: center;
            gap: 1.2rem; /* Space between dates and toggle button */
        }

        .pei-header .pei-dates {
            font-size: 0.88rem;
            color: var(--muted); /* Use muted for less prominence, or pei-color-dark */
            display: flex;
            flex-direction: column; /* Stack dates vertically */
            gap: 0.2rem;
            text-align: right; /* Align dates to the right within their container */
        }
        .pei-toggle-btn {
            background: none;
            border: none;
            font-size: 1.1rem;
            color: var(--pei-color-dark);
            cursor: pointer;
            transition: transform 0.3s ease;
            padding: 0.5rem; /* Aumenta a área de clique */
        }
        [data-theme="dark"] .pei-toggle-btn { color: var(--pei-color-dark); }
        .pei-content {
            padding: 0 1.8rem; /* Changed to 0 padding initially */
            border-top: 1px solid var(--border-color);
            max-height: 0; /* Collapsed by default */
            overflow: hidden;
            transition: max-height 0.5s ease-out, padding 0.5s ease-out;
        }
        .pei-content.expanded {
            max-height: 2000px; /* Ample height for content */
            padding: 1.8rem; /* Padding when expanded */
        }

        .pei-metas-list { list-style: none; padding-left: 0; }
        .pei-metas-list li {
            background-color: var(--bg);
            padding: 1.4rem; /* Mais padding */
            border-radius: 10px;
            margin-bottom: 1.2rem; /* Mais espaçamento */
            border-left: 6px solid var(--primary); /* Borda mais espessa */
            box-shadow: inset 0 1px 5px rgba(0,0,0,0.07); /* Sombra interna mais presente */
            transition: all 0.2s ease;
            position: relative;
        }
        [data-theme="dark"] .pei-metas-list li { background-color: color-mix(in srgb, var(--dark-card) 10%, transparent); }

        /* Meta status specific left borders */
        .pei-metas-list li[data-meta-status="nao-iniciada"] { border-left-color: var(--muted); }
        .pei-metas-list li[data-meta-status="em-andamento"] { border-left-color: var(--info); }
        .pei-metas-list li[data-meta-status="concluida"] { border-left-color: var(--success); }


        .meta-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.8rem; flex-wrap: wrap; gap: 0.6rem;}
        .meta-header strong { font-size: 1.15rem; color: var(--text); flex-grow: 1; } /* Slightly larger and more prominent */
        .meta-status-badge {
            font-weight: 700; /* Mais bold */
            padding: 0.4em 0.9em; /* Maior padding */
            border-radius: 20px; /* Mais arredondado */
            font-size: 0.78em; /* Levemente maior */
            text-transform: uppercase;
            color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            min-width: 100px; /* Ensure consistent width */
            text-align: center;
        }
        .meta-status-nao-iniciada { background-color: var(--muted); }
        .meta-status-em-andamento { background-color: var(--info); }
        .meta-status-concluida { background-color: var(--success); }
        .meta-description { margin-bottom: 1.2rem; font-size: 0.95rem; color: var(--text); } /* Ensure good contrast */
        .meta-actions-bar { display: flex; gap: 0.8rem; margin-top: 1.2rem; flex-wrap: wrap; align-items: center; }
        .meta-timer-controls {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            background: var(--card);
            padding: 0.4rem 0.8rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        [data-theme="dark"] .meta-timer-controls { background: var(--dark-bg); border-color: var(--dark-border-color); }
        .meta-timer-controls .timer-display { font-family: 'Roboto Mono', monospace; font-size: 1.05rem; font-weight: 600; min-width: 80px; text-align: center; color: var(--text);}
        .meta-timer-controls .btn-timer-toggle, .meta-timer-controls .btn-timer-reset {
            padding: 0.4rem 0.7rem;
            font-size: 0.9rem;
            line-height: 1;
            border-radius: 6px;
            box-shadow: none; /* Remove sombra extra dos botões internos */
        }
        .meta-evolutions {
            margin-top: 1.8rem;
            padding-top: 0; /* Changed to 0 padding initially */
            border-top: 1px dashed var(--border-color);
            max-height: 0; /* Collapsed by default */
            overflow: hidden;
            transition: max-height 0.5s ease-out, padding-top 0.5s ease-out, padding-bottom 0.5s ease-out, margin-top 0.5s ease-out;
            opacity: 0;
            display: block; /* Ensure it's a block for max-height transition */
        }
        .meta-evolutions.expanded {
            max-height: 1000px; /* Valor grande o suficiente para o conteúdo */
            opacity: 1;
            padding-top: 1.2rem; /* Padding when expanded */
            padding-bottom: 1.2rem;
            margin-top: 1.8rem;
        }

        .metas-section-header {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text);
            padding: 0.6rem 0;
            margin-top: 1.5rem;
            margin-bottom: 0.8rem;
            border-bottom: 2px solid var(--border-color);
        }
        .collapsible-header {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: color 0.2s ease;
        }
        .collapsible-header:hover { color: var(--primary); }
        .collapsible-header .fa-chevron-down {
            transition: transform 0.3s ease;
            font-size: 0.9em;
        }
        .collapsible-header.collapsed .fa-chevron-down {
            transform: rotate(-90deg);
        }
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out, padding 0.5s ease-out;
            padding-top: 0;
            padding-bottom: 0;
        }
        .collapsible-content.expanded {
            max-height: 5000px; /* Adjusted to a large fixed height */
            padding-top: 1rem; /* Adiciona padding quando expandido */
            padding-bottom: 1rem;
        }


        /* --- Agenda & Chat --- */
        .agenda-paciente-container {
            background-color: var(--card);
            border-radius: 16px;
            box-shadow: var(--shadow-light);
            padding: 2rem;
            border: 1px solid var(--border-color);
        }
        .agenda-paciente-container h3 { font-size: 1.6rem; color: var(--text); margin-bottom: 1.8rem; text-align: center; }
        .agenda-scroll-container { max-height: 65vh; overflow-y: auto; padding-right: 12px; } /* Scrollbar mais larga */
        .agenda-scroll-container::-webkit-scrollbar { width: 8px; }
        .agenda-scroll-container::-webkit-scrollbar-track { background: var(--bg); border-radius: 4px; }
        .agenda-scroll-container::-webkit-scrollbar-thumb { background: var(--muted); border-radius: 4px; border: 2px solid var(--bg); }
        .agenda-scroll-container::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        .agenda-paciente-card {
            background-color: var(--bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 1.2rem;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.03);
            transition: all 0.2s ease;
        }
        .agenda-paciente-card:hover {
            transform: translateY(-1px);
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.07);
        }
        [data-theme="dark"] .agenda-paciente-card { background-color: color-mix(in srgb, var(--dark-card) 10%, transparent); }
        .agenda-paciente-card .card-header {
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            background-color: color-mix(in srgb, var(--primary) 15%, transparent); /* Fundo colorido no header */
            color: var(--primary-dark);
        }
        [data-theme="dark"] .agenda-paciente-card .card-header { background-color: color-mix(in srgb, var(--dark-border-color), transparent 50%); color: var(--primary); }
        .agenda-paciente-card .card-header h4 { font-size: 1.1rem; font-weight: 600; margin: 0; }
        .agenda-paciente-card .card-body { padding: 1.2rem 1.5rem; font-size: 0.95rem; }
        .agenda-paciente-card .card-body p { margin-bottom: 0.4rem; }
        .agenda-paciente-card .card-body strong { color: var(--text); }
        .agenda-paciente-card .card-footer { padding: 1rem 1.5rem; text-align: right; border-top: 1px dashed var(--border-color); font-size: 0.85rem;}
        .status-badge {
            padding: 0.35em 0.8em;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: 700;
            text-transform: uppercase;
            color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .status-badge.status-confirmado { background-color: var(--status-confirmado); }
        .status-badge.status-concluido { background-color: var(--status-concluido); }
        .status-badge.status-pendente { background-color: var(--status-pendente); }
        .status-badge.status-cancelado { background-color: var(--status-cancelado); }


        /* --- Chat-like Evolutions (NEW) --- */
        .chat-container {
            background-color: var(--card); /* Mudado para card para melhor contraste */
            border-radius: 10px;
            padding: 1rem;
            max-height: 400px; /* Ajuste conforme necessário */
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            border: 1px solid var(--border-color);
        }
        [data-theme="dark"] .chat-container { background-color: var(--dark-card); }

        .chat-message-wrapper {
            display: flex;
            flex-direction: column;
        }

        .chat-message {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            font-size: 0.9rem;
            line-height: 1.5;
            word-wrap: break-word;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: relative;
        }
        .chat-message.self { /* Messages by the current user (e.g., professional) */
            background-color: var(--chat-bubble-bg-user);
            align-self: flex-end; /* Align right */
            border-bottom-right-radius: 2px; /* Pointy corner */
        }
        .chat-message.other { /* Messages about the patient (e.g., from assistant/AI or other sources) */
            background-color: var(--chat-bubble-bg-other);
            color: var(--primary-dark); /* Texto escuro para bolha clara */
            align-self: flex-start; /* Align left */
            border-bottom-left-radius: 2px; /* Pointy corner */
        }
        [data-theme="dark"] .chat-message.other { color: var(--dark-text); } /* Texto claro para bolha escura */


        .chat-message-meta {
            font-size: 0.75rem;
            color: var(--muted);
            margin-top: 5px;
            text-align: right;
            display: flex; /* Para alinhar o botão apagar */
            justify-content: flex-end; /* Alinha o meta à direita */
            align-items: center;
            gap: 5px;
        }
        .chat-message.other + .chat-message-meta {
            text-align: left;
            justify-content: flex-start; /* Alinha o meta à esquerda */
        }
        .chat-message-meta .btn-danger-outline {
            padding: 0.2rem 0.4rem; /* Botão menor */
            font-size: 0.7rem;
            border-radius: 5px;
            line-height: 1;
        }


        .chat-input-area {
            display: flex;
            gap: 10px;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
            margin-top: 1rem;
        }
        .chat-input-area textarea {
            flex-grow: 1;
            resize: none;
            padding: 0.8rem;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background-color: var(--bg); /* Fundo do textarea ajustado */
            color: var(--text);
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
        .chat-input-area textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary) 25%, transparent);
            outline: none;
        }
        [data-theme="dark"] .chat-input-area textarea { background-color: var(--dark-bg); border-color: var(--dark-border-color); }


        /* --- Responsive Adjustments (CONTINUED) --- */
        @media(max-width: 768px) {
            .chat-message { max-width: 95%; font-size: 0.85rem; }
            .chat-input-area { flex-direction: column; }
            .chat-input-area textarea { width: 100%; }
            .chat-input-area .btn { width: 100%; }
            .meta-actions-bar { justify-content: flex-start; } /* Alinha botões para a esquerda em mobile */
            .btn-text-desktop { display: none; } /* Esconde o texto dos botões para o mobile */
        }
        @media(min-width: 769px) { /* Only show on desktop */
            .btn-text-desktop { display: inline; }
        }

    </style>
</head>
<body>
    <div class="layout">
        <aside class="sidebar">
            <div class="sidebar-inner-content">
                <div class="sidebar-header">
                    <a href="{{ url_for('index') }}" class="logo">
                        <i class="fa-solid fa-staff-snake"></i> <span>{{ session.clinica_nome_display or 'ClínicaOn' }}</span>
                    </a>
                </div>
                <nav>
                    <ul>
                        <li><a href="{{ url_for('index') }}"><i class="fa-solid fa-house-chimney"></i> <span>Dashboard</span></a></li>
                        <li><a href="{{ url_for('listar_pacientes') }}"><i class="fa-solid fa-hospital-user"></i> <span>Pacientes</span></a></li>
                        <li class="active"><a href="{{ url_for('buscar_prontuario') }}"><i class="fa-solid fa-notes-medical"></i> <span>Prontuários</span></a></li>
                        <li><a href="{{ url_for('listar_profissionais') }}"><i class="fa-solid fa-user-doctor"></i> <span>Profissionais</span></a></li>
                        <li><a href="{{ url_for('listar_servicos_procedimentos') }}"><i class="fa-solid fa-syringe"></i> <span>Serviços/Proc.</span></a></li>
                        <li><a href="{{ url_for('listar_convenios') }}"><i class="fa-solid fa-handshake"></i> <span>Convênios</span></a></li>
                        <li><a href="{{ url_for('listar_horarios') }}"><i class="fa-regular fa-clock"></i> <span>Horários</span></a></li>
                        <li><a href="{{ url_for('listar_agendamentos') }}"><i class="fa-regular fa-calendar-check"></i> <span>Agendamentos</span></a></li>
                        {% if session.user_role == 'admin' %}
                        <li><a href="{{ url_for('listar_usuarios') }}"><i class="fa-solid fa-users-gear"></i> <span>Utilizadores</span></a></li>
                        <li><a href="{{ url_for('listar_modelos_anamnese') }}"><i class="fa-regular fa-file-lines"></i> <span>Modelos Anamnese</span></a></li>
                        <li><a href="{{ url_for('listar_peis') }}"><i class="fa-solid fa-clipboard-check"></i> <span>Gerenciar PEIs</span></a></li>
                        {% endif %}
                    </ul>
                </nav>
                <div class="sidebar-footer">
                    <button id="theme-toggle" aria-label="Alternar tema">
                        <i class="fa-solid fa-sun"></i> <span>Alternar Tema</span>
                    </button>
                    <a href="#" id="logoutButton"><i class="fa-solid fa-arrow-right-from-bracket"></i> <span>Sair</span></a>
                </div>
            </div>
        </aside>

        <div class="main-content">
            <header class="topbar">
                <div class="topbar-left">
                    <button class="toggle-btn menu-btn-mobile"><i class="fa-solid fa-bars"></i></button>
                    <button class="toggle-btn toggle-btn-desktop"><i class="fa-solid fa-bars-staggered"></i></button>
                    <h1 class="page-title">Prontuário de {{ paciente.nome if paciente else 'Paciente' }}</h1>
                </div>
                <div class="topbar-actions">
                    <a href="{{ url_for('adicionar_anamnese', paciente_doc_id=paciente.id) }}" class="btn btn-primary"><i class="fas fa-plus"></i> <span class="btn-text-desktop">Anamnese</span></a>
                    <button type="button" class="btn btn-secondary btn-add-generic" data-tipo="laudo"><i class="fas fa-file-medical"></i> <span class="btn-text-desktop">Laudo</span></button>
                    <button type="button" class="btn btn-secondary btn-add-generic" data-tipo="orientacao"><i class="fas fa-notes-medical"></i> <span class="btn-text-desktop">Orientação</span></button>
                    <button type="button" class="btn btn-secondary btn-add-generic" data-tipo="procedimento"><i class="fas fa-syringe"></i> <span class="btn-text-desktop">Procedimento</span></button>
                </div>
            </header>

            <main>
                {% if paciente %}
                <div class="paciente-info-card">
                    <h3>{{ paciente.nome }}</h3>
                    <div class="paciente-info-grid">
                            <div class="paciente-info-item"><strong>Data Nasc.:</strong> <span>{{ paciente.data_nascimento.split(' ')[0] if paciente.data_nascimento else 'N/A' }}</span></div>
                           <div class="paciente-info-item"><strong>CPF:</strong> <span>{{ paciente.cpf or 'N/A' }}</span></div>
                           <div class="paciente-info-item"><strong>Telefone:</strong> <span>{{ paciente.contato_telefone or 'N/A' }}</span></div>
                           <div class="paciente-info-item"><strong>Convênio:</strong> <span>{{ paciente.convenio_nome or 'Particular' }}</span></div>
                           <div class="paciente-info-item" style="grid-column: 1 / -1;"><strong>Observações:</strong> <span>{{ paciente.observacoes or 'Nenhuma observação.' }}</span></div>
                    </div>
                </div>
                {% endif %}

                <section class="prontuario-section">
                    <div class="tabs-container">
                        <div class="tab-nav">
                            <button class="tab-nav-item active" data-tab="registros">Registros Clínicos</button>
                            {% if peis_do_paciente %}
                            <button class="tab-nav-item" data-tab="peis">Planos Educacionais (PEIs)</button>
                            {% endif %}
                            <button class="tab-nav-item" data-tab="agenda-paciente">Agenda do Paciente</button>
                        </div>
                        <div class="tab-content">
                            <div id="tab-panel-registros" class="tab-panel active">
                                {% set registros_clinicos = registros | rejectattr('tipo_registro', 'equalto', 'evolucao_pei') | list %}
                                {% if registros_clinicos %}
                                        {% for registro in registros_clinicos %}
                                            <div class="registro-card registro-card--{{ registro.tipo_registro }}" id="registro-{{ registro.id }}">
                                                <div class="registro-header">
                                                    <h4>{{ registro.tipo_registro | replace('_', ' ') | capitalize }} - {{ registro.titulo | default('') }}</h4>
                                                    <div class="registro-meta">
                                                        <span><i class="fas fa-calendar-alt"></i> {{ registro.data_registro.split(' ')[0] }}</span>
                                                        <span><i class="fas fa-user-md"></i> {{ registro.profissional_nome | default('N/A') }}</span>
                                                    </div>
                                                </div>
                                                <div class="registro-content" id="content-{{ registro.id }}">{{ registro.conteudo | safe }}</div>
                                                <div class="registro-actions">
                                                    <button class="btn btn-sm btn-secondary btn-print-pdf" data-target-id="content-{{ registro.id }}" data-title="{{ registro.tipo_registro | replace('_', ' ') | capitalize }} - {{ registro.titulo | default('') }}"><i class="fas fa-print"></i> <span class="btn-text-desktop">Imprimir</span></button>
                                                    <button class="btn btn-sm btn-info btn-visualizar-registro"
                                                                data-title="{{ registro.tipo_registro | replace('_', ' ') | capitalize }} - {{ registro.titulo | default('') }}"
                                                                data-content="{{ registro.conteudo | e }}"
                                                                data-type="{{ registro.tipo_registro | replace('_', ' ') | capitalize }}"
                                                                data-date="{{ registro.data_registro.split(' ')[0] }}"
                                                                data-professional="{{ registro.profissional_nome | default('N/A') }}">
                                                                <i class="fas fa-eye"></i> <span class="btn-text-desktop">Visualizar</span>
                                                    </button>

                                                    {% if registro.tipo_registro == 'anamnese' %}
                                                        <a href="{{ url_for('editar_anamnese', paciente_doc_id=paciente.id, anamnese_doc_id=registro.id) }}" class="btn btn-sm btn-warning"><i class="fas fa-edit"></i> <span class="btn-text-desktop">Editar</span></a>
                                                    {% else %}
                                                        <button class="btn btn-sm btn-warning btn-editar-registro" data-registro-id="{{ registro.id }}" data-tipo="{{ registro.tipo_registro }}" data-titulo="{{ registro.titulo }}" data-conteudo="{{ registro.conteudo | e }}"><i class="fas fa-edit"></i> <span class="btn-text-desktop">Editar</span></button>
                                                    {% endif %}

                                                    <button class="btn btn-sm btn-danger-outline btn-apagar-registro" data-registro-id="{{ registro.id }}"><i class="fas fa-trash"></i> <span class="btn-text-desktop">Apagar</span></button>
                                                </div>
                                            </div>
                                        {% endfor %}
                                {% else %}
                                    <div class="empty-state"><p>Nenhum registro clínico encontrado.</p></div>
                                {% endif %}
                            </div>

                            {% if peis_do_paciente %}
                            <div id="tab-panel-peis" class="tab-panel">

                                {% macro render_meta(meta, pei_id, meta_index) %}
                                    <li data-pei-id="{{ pei_id }}" data-meta-titulo="{{ meta.titulo }}"
                                        data-cronometro-inicio="{{ meta.cronometro_inicio if meta.cronometro_inicio else '' }}"
                                        data-tempo-gasto="{{ meta.tempo_total_gasto | default(0) }}"
                                        data-meta-status="{{ meta.status | default('nao-iniciada') | lower | replace(' ', '-') }}">
                                        <div class="meta-header">
                                            <strong>{{ meta.titulo }}</strong>
                                            <span class="meta-status-badge meta-status-{{ meta.status | default('nao-iniciada') | lower | replace(' ', '-') }}">{{ meta.status | default('Não Iniciada') }}</span>
                                        </div>
                                        <p class="meta-description"> (Responsável: {{ meta.responsavel or 'N/A' }})<br>{{ meta.descricao }}</p>

                                        <div class="meta-actions-bar">
                                            <div class="meta-timer-controls">
                                                {% if meta.status != 'Concluída' %}
                                                <button class="btn btn-sm btn-secondary btn-timer-toggle" title="Iniciar/Pausar Cronômetro">
                                                    <i class="fas fa-play"></i>
                                                </button>
                                                {% endif %}
                                                <span class="timer-display">00:00:00</span>
                                                {% if meta.status != 'Concluída' %}
                                                <button class="btn btn-sm btn-danger-outline btn-timer-reset" title="Zerar Cronômetro">
                                                    <i class="fas fa-history"></i>
                                                </button>
                                                {% endif %}
                                            </div>
                                            {% if meta.status != 'Concluída' %}
                                            <button class="btn btn-sm btn-success btn-concluir-meta">
                                                <i class="fas fa-check"></i> <span class="btn-text-desktop">Concluir Meta</span>
                                            </button>
                                            {% endif %}
                                            {# Botão "Atividade" que substitui "Registrar Evolução" e "Visualizar Evoluções" #}
                                            <button class="btn btn-sm btn-primary btn-toggle-evolutions"
                                                         data-pei-id="{{ pei_id }}"
                                                         data-meta-titulo="{{ meta.titulo }}"
                                                         data-meta-index="{{ meta_index }}">
                                                <i class="fas fa-comments"></i> <span class="btn-text-desktop">Atividade</span> (<span class="evolution-count">0</span>)
                                            </button>
                                        </div>

                                        <div class="meta-evolutions">
                                            <div class="chat-container" id="chat-meta-{{ pei_id }}-{{ meta_index }}">
                                                {% if registros %}
                                                {% set evolucoes_meta = registros
                                                    | selectattr('tipo_registro', 'equalto', 'evolucao_pei')
                                                    | selectattr('referencia_pei_id', 'equalto', pei_id)
                                                    | selectattr('referencia_meta_titulo', 'equalto', meta.titulo)
                                                    | list %}

                                                    {% if evolucoes_meta %}
                                                        {% for evolucao in evolucoes_meta %}
                                                            <div class="chat-message-wrapper">
                                                                <div class="chat-message self"> {# Assumindo que a evolução é do profissional logado #}
                                                                    {{ evolucao.conteudo | safe }}
                                                                </div>
                                                                <div class="chat-message-meta" data-registro-id="{{ evolucao.id }}">
                                                                    {{ evolucao.data_registro.split(' ')[0] }} - {{ evolucao.profissional_nome }}
                                                                    <button class="btn btn-sm btn-danger-outline btn-apagar-registro" data-registro-id="{{ evolucao.id }}" title="Apagar Evolução"><i class="fas fa-trash"></i></button>
                                                                </div>
                                                            </div>
                                                        {% endfor %}
                                                    {% else %}
                                                        <div class="empty-state" style="padding:1rem; font-size:0.9rem;"><p>Nenhuma evolução registrada para esta meta.</p></div>
                                                    {% endif %}
                                                {% else %}
                                                    <div class="empty-state" style="padding:1rem; font-size:0.9rem;"><p>Nenhuma evolução registrada para esta meta.</p></div>
                                                {% endif %}
                                            </div>
                                            <div class="chat-input-area">
                                                <textarea placeholder="Digite uma nova evolução..." rows="1"></textarea>
                                                <button class="btn btn-primary btn-send-evolution" data-pei-id="{{ pei_id }}" data-meta-titulo="{{ meta.titulo }}"><i class="fas fa-paper-plane"></i> <span class="btn-text-desktop">Enviar</span></button>
                                            </div>
                                        </div>
                                    </li>
                                {% endmacro %}

                                    <div class="pei-accordion">
                                        {% for pei in peis_do_paciente %}
                                        <div class="pei-card">
                                            <div class="pei-header">
                                                <h4>{{ pei.identificacao_pei }}</h4>
                                                <div class="pei-header-actions">
                                                    <div class="pei-dates">
                                                        <span>Início: {{ pei.data_inicio or 'N/A' }}</span>
                                                        <span>Fim: {{ pei.data_fim or 'N/A' }}</span>
                                                    </div>
                                                    <button class="pei-toggle-btn"><i class="fas fa-chevron-down"></i></button>
                                                </div>
                                            </div>
                                            <div class="pei-content">
                                                <p><strong>Descrição:</strong> {{ pei.descricao_pei or 'N/A' }}</p>
                                                <p><strong>Responsável pelo Plano:</strong> {{ pei.profissional_responsavel_nome or 'Não definido' }}</p>

                                                {% if pei.metas %}
                                                    <div class="metas-section">
                                                        <h5 class="metas-section-header">Metas em Andamento</h5>
                                                        <ul class="pei-metas-list">
                                                            {% set metas_em_andamento = pei.metas | rejectattr('status', 'eq', 'Concluída') | list %}
                                                            {% for meta in metas_em_andamento %}
                                                                {{ render_meta(meta, pei.id, loop.index0) }} {# Passando loop.index0 #}
                                                            {% else %}
                                                                <li class="empty-state" style="padding:1rem; font-size:0.9rem;"><p>Nenhuma meta em andamento.</p></li>
                                                            {% endfor %}
                                                        </ul>
                                                    </div>

                                                    <div class="metas-section">
                                                        <h5 class="metas-section-header collapsible-header {% if not (metas_concluidas is defined and metas_concluidas|length > 0) %}collapsed{% endif %}"> {# Adjusted collapse state #}
                                                            <span>Metas Concluídas</span>
                                                            <i class="fas fa-chevron-down"></i>
                                                        </h5>
                                                        <div class="collapsible-content"> {# Removed inline style to be controlled by JS #}
                                                            <ul class="pei-metas-list">
                                                                {% set metas_concluidas = pei.metas | selectattr('status', 'eq', 'Concluída') | list %}
                                                                {% for meta in metas_concluidas %}
                                                                    {{ render_meta(meta, pei.id, loop.index0) }} {# Passando loop.index0 #}
                                                                {% else %}
                                                                    <li class="empty-state" style="padding:1rem; font-size:0.9rem;"><p>Nenhuma meta concluída.</p></li>
                                                                {% endfor %}
                                                            </ul>
                                                        </div>
                                                    </div>
                                                {% else %}
                                                        <div class="empty-state"><p>Nenhuma meta cadastrada para este PEI.</p></div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                            </div>
                            {% endif %}

                            <div id="tab-panel-agenda-paciente" class="tab-panel">
                                        <div class="agenda-paciente-container">
                                            <h3>Histórico de Agendamentos Concluídos</h3>
                                            <div class="agenda-scroll-container">
                                                <div id="agenda-paciente-list">
                                                    <div class="empty-state" id="agenda-paciente-empty-state"><p>Carregando agendamentos...</p></div>
                                                </div>
                                            </div>
                                        </div>
                            </div>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <div id="modalRegistroGenerico" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalRegistroGenericoTitle">Adicionar Novo Registro</h3>
                <button type="button" class="modal-close-btn" data-close>&times;</button>
            </div>
            <form method="POST" action="" id="formRegistroGenerico">
                <input type="hidden" name="tipo_registro" id="tipo_registro_generico">
                <input type="hidden" name="tipo_registro_feedback" id="tipo_registro_feedback">
                <input type="hidden" name="referencia_pei_id" id="referencia_pei_id">
                <input type="hidden" name="referencia_meta_titulo" id="referencia_meta_titulo">
                <div class="modal-body">
                    <div class="gemini-generator">
                        <div class="form-group">
                            <label for="gemini-prompt">Gerar conteúdo com Inteligência Artificial</label>
                            <div class="gemini-generator-actions">
                                <input type="text" id="gemini-prompt" placeholder="Ex: Laudo para exame de sangue com anemia">
                                <button type="button" id="generate-content-btn" class="btn btn-primary" disabled>
                                    <i class="fas fa-robot"></i>&nbsp;<span>Gerar</span>
                                </button>
                            </div>
                        </div>
                           <div class="form-group">
                             <div id="lgpd-consent-text" class="consent-text">
                                 Estou ciente de que o texto gerado pela IA é uma sugestão e deve ser revisado por um profissional. Nenhum dado de paciente será enviado.
                             </div>
                           </div>
                    </div>

                    <div class="form-group">
                        <label for="titulo_registro_generico">Título</label>
                        <input type="text" id="titulo_registro_generico" name="titulo" required>
                    </div>

                    <div class="form-group">
                        <label for="conteudo_generico">Conteúdo</label>
                        <div class="editor-toolbar">
                            <button type="button" data-command="bold" title="Negrito (Ctrl+B)"><i class="fas fa-bold"></i></button>
                            <button type="button" data-command="italic" title="Itálico (Ctrl+I)"><i class="fas fa-italic"></i></button>
                            <button type="button" data-command="underline" title="Sublinhado (Ctrl+U)"><i class="fas fa-underline"></i></button>
                            <button type="button" data-command="insertUnorderedList" title="Lista não ordenada"><i class="fas fa-list-ul"></i></button>
                            <button type="button" data-command="insertOrderedList" title="Lista ordenada"><i class="fas fa-list-ol"></i></button>
                        </div>
                        <div id="editor-content-generico" contenteditable="true" class="editor-content" data-placeholder="Digite o conteúdo aqui..."></div>
                        <textarea id="conteudo_generico" name="conteudo" style="display:none;"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-close>Cancelar</button>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="concluir-meta-modal" class="modal-overlay">
        <div class="modal-content confirm-modal-content">
               <div class="modal-header">
                <h3>Concluir Meta</h3>
                <button type="button" class="modal-close-btn" data-close>&times;</button>
            </div>
            <div class="modal-body">
                <p>Você está prestes a marcar a meta "<strong id="concluir-meta-titulo"></strong>" como concluída.</p>
                <div class="form-group" style="text-align: left;">
                    <label for="concluir-meta-observacao">Observação de Conclusão (Opcional)</label>
                    <textarea id="concluir-meta-observacao" rows="4"></textarea>
                </div>
            </div>
            <div class="modal-footer" style="justify-content: center;">
                <button type="button" class="btn btn-secondary" data-close>Cancelar</button>
                <button type="button" class="btn btn-success" id="confirmConcluirMetaBtn">Confirmar Conclusão</button>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-content confirm-modal-content">
               <div class="modal-header">
                <h3>Confirmar Ação</h3>
                <button type="button" class="modal-close-btn" data-close>&times;</button>
            </div>
            <div class="modal-body">
                <p id="confirm-modal-text">Tem certeza?</p>
            </div>
            <div class="modal-footer" style="justify-content: center;">
                <button type="button" class="btn btn-secondary" data-close>Cancelar</button>
                <button type="button" class="btn btn-danger-outline" id="confirmModalBtn">Confirmar</button>
            </div>
        </div>
    </div>

    <form id="formApagarRegistro" method="POST" action="{{ url_for('apagar_registro_generico', paciente_doc_id=paciente.id) }}" style="display: none;">
        <input type="hidden" name="registro_id" id="registro_id_apagar">
    </form>

    <div id="modalVisualizarRegistro" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="visualizarRegistroTitle">Visualizar Registro</h3>
                <button type="button" class="modal-close-btn" data-close-viewer-modal>&times;</button>
            </div>
            <div class="modal-body">
                <p><strong>Tipo:</strong> <span id="visualizarRegistroType"></span></p>
                <p><strong>Data:</strong> <span id="visualizarRegistroDate"></span></p>
                <p><strong>Profissional:</strong> <span id="visualizarRegistroProfessional"></span></p>
                <hr style="margin: 1rem 0; border-color: var(--border-color);">
                <div id="visualizarRegistroContent" class="registro-content" style="max-height: none; overflow-y: visible; padding-right: 0;"></div>
            </div>
            <div class="modal-footer" style="justify-content: center;">
                <button type="button" class="btn btn-secondary" data-close-viewer-modal>Fechar</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const pacienteId = "{{ paciente.id if paciente else '' }}";
            const pacienteNome = "{{ paciente.nome if paciente else 'Paciente' }}";
            const clinicaNome = "{{ session.clinica_nome_display or 'Clínica On' }}";
            const usuarioNome = "{{ session.user_name if session.user_name else 'Usuário' }}"; // Obter o nome do usuário logado

            // --- Lógica de UI Geral (Sidebar, Tema, Modals) ---
            const modalController = {
                registro: document.getElementById('modalRegistroGenerico'),
                confirm: document.getElementById('confirm-modal'),
                concluirMeta: document.getElementById('concluir-meta-modal'),
                visualizar: document.getElementById('modalVisualizarRegistro'), // Adicionada a modal de visualização
                open(modal) { modal?.classList.add('active'); },
                close(modal) { modal?.classList.remove('active'); }
            };

            function setupCommonUI() {
                const htmlEl = document.documentElement;
                const sidebar = document.querySelector('.sidebar');
                const mainContent = document.querySelector('.main-content');
                const menuBtnMobile = document.querySelector('.menu-btn-mobile');
                const toggleBtnDesktop = document.querySelector('.toggle-btn-desktop');
                const themeToggle = document.getElementById('theme-toggle');
                const logoutButton = document.getElementById('logoutButton');

                // Lógica do Tema
                if (themeToggle) {
                    const themeIcon = themeToggle.querySelector('i');
                    const storedTheme = localStorage.getItem('theme') || 'light';
                    htmlEl.setAttribute('data-theme', storedTheme);
                    themeIcon.className = storedTheme === 'dark' ? 'fa-solid fa-moon' : 'fa-solid fa-sun';
                    themeToggle.addEventListener('click', () => {
                        const newTheme = htmlEl.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
                        htmlEl.setAttribute('data-theme', newTheme);
                        localStorage.setItem('theme', newTheme);
                        themeIcon.className = newTheme === 'dark' ? 'fa-solid fa-moon' : 'fa-solid fa-sun';
                    });
                }

                // Lógica da Sidebar
                function applySidebarState() {
                    if (window.innerWidth > 768) {
                        const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
                        sidebar.classList.toggle('collapsed', isCollapsed);
                        mainContent.classList.toggle('collapsed', isCollapsed);
                    } else {
                        sidebar.classList.remove('open', 'collapsed');
                        mainContent.classList.remove('collapsed');
                    }
                }
                toggleBtnDesktop?.addEventListener('click', () => {
                    sidebar.classList.toggle('collapsed');
                    mainContent.classList.toggle('collapsed');
                    localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
                });
                menuBtnMobile?.addEventListener('click', (e) => { e.stopPropagation(); sidebar.classList.toggle('open'); });
                document.addEventListener('click', (e) => {
                    if (window.innerWidth <= 768 && sidebar.classList.contains('open') && !sidebar.contains(e.target) && !menuBtnMobile.contains(e.target)) {
                        sidebar.classList.remove('open');
                    }
                });
                window.addEventListener('resize', applySidebarState);
                applySidebarState();

                // Lógica de Logout
                logoutButton?.addEventListener('click', async (e) => {
                    e.preventDefault();
                    Swal.fire({
                        title: 'Tem certeza que deseja sair?',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Sim, sair',
                        cancelButtonText: 'Cancelar',
                        reverseButtons: true
                    }).then(async (result) => {
                        if (result.isConfirmed) {
                            try {
                                await fetch("{{ url_for('logout') }}", { method: 'POST' });
                                window.location.href = "{{ url_for('login_page') }}";
                            } catch (error) {
                                console.error("Erro ao fazer logout:", error);
                                window.location.href = "{{ url_for('login_page') }}"; // Fallback para redirecionar mesmo com erro
                            }
                        }
                    });
                });
            }
            setupCommonUI();

            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modalController.close(modal);
                });
            });
            // Adicionado seletor para o novo botão de fechar da modal de visualização
            document.querySelectorAll('[data-close], [data-close-viewer-modal]').forEach(btn =>
                btn.addEventListener('click', () => modalController.close(btn.closest('.modal-overlay')))
            );

            // --- Lógica de Geração com IA ---
            const generateBtn = document.getElementById('generate-content-btn');
            const promptInput = document.getElementById('gemini-prompt');
            const consentCheck = document.getElementById('lgpd-consent-text');
            const genericEditor = document.getElementById('editor-content-generico');

            if (consentCheck) {
                consentCheck.addEventListener('click', () => {
                    consentCheck.classList.toggle('active');
                    generateBtn.disabled = !consentCheck.classList.contains('active');
                });
            }

            if (generateBtn) {
                generateBtn.addEventListener('click', async () => {
                    const promptText = promptInput.value;
                    const tipoRegistro = document.getElementById('tipo_registro_generico').value;
                    if (!promptText) {
                        Swal.fire('Atenção', 'Por favor, descreva o que você deseja gerar.', 'warning');
                        return;
                    }

                    const fullPrompt = `Você é um assistente da área da saúde. Crie um texto para um(a) "${tipoRegistro}" sobre o seguinte tópico: "${promptText}". O texto deve ser bem estruturado e profissional, sem placeholders como "[...]". O resultado deve ser apenas o HTML, sem a tag html ou outras formatações.`;

                    generateBtn.disabled = true;
                    generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>&nbsp;<span>Gerando...</span>';

                    try {
                        // Using the provided Gemini API call structure
                        let chatHistory = [];
                        chatHistory.push({ role: "user", parts: [{ text: fullPrompt }] });
                        const payload = { contents: chatHistory };
                        const apiKey = ""; // Canvas will provide this at runtime
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        const result = await response.json();

                        if (result.candidates && result.candidates.length > 0 &&
                            result.candidates[0].content && result.candidates[0].content.parts &&
                            result.candidates[0].content.parts.length > 0) {

                            const generatedText = result.candidates[0].content.parts[0].text;

                            if (genericEditor.innerHTML.trim()) {
                                const confirmReplace = await Swal.fire({
                                    title: 'Conteúdo existente',
                                    text: 'Deseja substituir o conteúdo atual pelo texto gerado pela IA?',
                                    icon: 'question',
                                    showCancelButton: true,
                                    confirmButtonText: 'Sim, substituir',
                                    cancelButtonText: 'Não, manter'
                                });
                                if (!confirmReplace.isConfirmed) {
                                    return;
                                }
                            }
                            genericEditor.innerHTML = generatedText;
                        } else {
                            throw new Error('Resposta da IA em formato inesperado ou vazia.');
                        }
                    } catch (error) {
                        console.error("Erro na chamada da API local:", error);
                        Swal.fire('Erro', 'Erro ao gerar conteúdo: ' + error.message, 'error');
                    } finally {
                        generateBtn.disabled = !consentCheck.classList.contains('active');
                        generateBtn.innerHTML = '<i class="fas fa-robot"></i>&nbsp;<span>Gerar</span>';
                    }
                });
            }

            // --- Lógica do Modal para Adicionar/Editar Registros ---
            const formGenerico = document.getElementById('formRegistroGenerico');
            const modalTitle = document.getElementById('modalRegistroGenericoTitle');
            const tituloInput = document.getElementById('titulo_registro_generico');
            const tipoInput = document.getElementById('tipo_registro_generico');
            const tipoFeedbackInput = document.getElementById('tipo_registro_feedback');
            const peiIdInput = document.getElementById('referencia_pei_id');
            const metaTituloInput = document.getElementById('referencia_meta_titulo');
            const hiddenContentTextarea = document.getElementById('conteudo_generico');

            function setupRichTextEditor(editorDiv, hiddenTextarea) {
                const toolbar = editorDiv.previousElementSibling;
                toolbar.querySelectorAll('button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.preventDefault();
                        const command = e.currentTarget.dataset.command;
                        document.execCommand(command, false, null);
                        editorDiv.focus();
                    });
                });
                editorDiv.addEventListener('input', () => {
                    hiddenTextarea.value = editorDiv.innerHTML;
                });
            }
            setupRichTextEditor(genericEditor, hiddenContentTextarea);


            function openModalParaRegistro(tipo, dados = {}) {
                formGenerico.reset();
                consentCheck.classList.remove('active');
                generateBtn.disabled = true;

                const isEdit = !!dados.id;
                const tipoCapitalizado = tipo.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());

                modalTitle.textContent = isEdit ? `Editar ${tipoCapitalizado}` : `Adicionar ${tipoCapitalizado}`;
                tipoInput.value = tipo;
                tipoFeedbackInput.value = tipoCapitalizado;
                // --- MODIFICATION START ---
                // Changed default title for PEI evolution from 'Sem Título' to 'Atividade'
                tituloInput.value = dados.titulo || (tipo === 'evolucao_pei' ? `Evolução - ${dados.metaTitulo || 'Atividade'}` : '');
                // --- MODIFICATION END ---
                genericEditor.innerHTML = dados.conteudo || '';

                // Adiciona referências do PEI se for uma evolução
                peiIdInput.value = dados.peiId || '';
                metaTituloInput.value = dados.metaTitulo || '';

                if (isEdit) {
                    formGenerico.action = `/prontuarios/${pacienteId}/editar_registro_generico/${dados.id}`;
                } else {
                    formGenerico.action = `/prontuarios/${pacienteId}/registrar_registro_generico`;
                }

                formGenerico.onsubmit = () => {
                    hiddenContentTextarea.value = genericEditor.innerHTML;
                };

                modalController.open(modalController.registro);
            }

            // --- Lógica do Acordeão e Metas do PEI ---
            function setupPeiAccordion() {
                const activeTimers = {};

                function formatTime(totalSeconds) {
                    const hours = Math.floor(totalSeconds / 3600).toString().padStart(2, '0');
                    const minutes = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, '0');
                    const seconds = Math.floor(totalSeconds % 60).toString().padStart(2, '0');
                    return `${hours}:${minutes}:${seconds}`;
                }

                function startVisualTimer(liElement, startTimeISO, baseSeconds) {
                    const metaId = liElement.dataset.peiId + '||' + liElement.dataset.metaTitulo;
                    const display = liElement.querySelector('.timer-display');
                    const timerButtonToggle = liElement.querySelector('.btn-timer-toggle'); // Get the button element

                    // Clear any existing timer for this meta
                    clearInterval(activeTimers[metaId]);

                    if (!startTimeISO) {
                        display.textContent = formatTime(baseSeconds);
                        if (timerButtonToggle) timerButtonToggle.querySelector('i').className = 'fas fa-play';
                        return;
                    }

                    const startTime = new Date(startTimeISO).getTime();
                    if (timerButtonToggle) timerButtonToggle.querySelector('i').className = 'fas fa-pause';


                    activeTimers[metaId] = setInterval(() => {
                        const now = new Date().getTime();
                        const elapsed = Math.floor((now - startTime) / 1000);
                        const total = baseSeconds + elapsed;
                        display.textContent = formatTime(total);
                    }, 1000);
                }

                function initializeMetaTimers() {
                    document.querySelectorAll('.pei-metas-list li[data-pei-id]').forEach(li => {
                        const cronometroInicio = li.dataset.cronometroInicio;
                        const tempoGasto = parseInt(li.dataset.tempoGasto, 10) || 0;
                        const timerButtonToggle = li.querySelector('.btn-timer-toggle'); // Seleciona o botão, não o ícone
                        const timerButtonReset = li.querySelector('.btn-timer-reset');
                        const concluirMetaButton = li.querySelector('.btn-concluir-meta');
                        const status = li.dataset.metaStatus;

                        const metaId = li.dataset.peiId + '||' + li.dataset.metaTitulo;

                        // Always clear existing timer for this meta before re-initializing
                        clearInterval(activeTimers[metaId]);

                        if (status === 'concluida') {
                            if (timerButtonToggle) timerButtonToggle.style.display = 'none';
                            if (timerButtonReset) timerButtonReset.style.display = 'none';
                            if (concluirMetaButton) concluirMetaButton.disabled = true; // Desabilita o botão
                            li.querySelector('.timer-display').textContent = formatTime(tempoGasto); // Garante que o tempo final seja exibido
                            li.querySelector('.timer-display').style.fontWeight = 'bold'; // Opcional: destaque o tempo final
                            li.querySelector('.timer-display').style.color = 'var(--text)'; // Opcional: destaque a cor
                        } else {
                            if (timerButtonToggle) timerButtonToggle.style.display = 'inline-flex'; // Mostra se não concluída
                            if (timerButtonReset) timerButtonReset.style.display = 'inline-flex'; // Mostra se não concluída
                            if (concluirMetaButton) concluirMetaButton.disabled = false; // Habilita o botão

                            if (cronometroInicio) {
                                startVisualTimer(li, cronometroInicio, tempoGasto);
                                if (timerButtonToggle) timerButtonToggle.querySelector('i').className = 'fas fa-pause';
                            } else {
                                li.querySelector('.timer-display').textContent = formatTime(tempoGasto);
                                if (timerButtonToggle) timerButtonToggle.querySelector('i').className = 'fas fa-play';
                            }
                        }
                    });
                }

                async function sendMetaUpdate(peiId, metaTitulo, action, extraData = {}) {
                    try {
                        const response = await fetch(`/api/pacientes/${pacienteId}/peis/${peiId}/meta/update`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ meta_titulo: metaTitulo, action, ...extraData })
                        });
                        const result = await response.json();
                        if (!response.ok) throw new Error(result.message || 'Erro no servidor');

                        const li = document.querySelector(`li[data-pei-id="${peiId}"][data-meta-titulo="${metaTitulo}"]`);
                        if (li && result.updated_meta) {
                            const meta = result.updated_meta;

                            li.dataset.cronometroInicio = meta.cronometro_inicio || '';
                            li.dataset.tempoGasto = meta.tempo_total_gasto || 0;

                            const statusBadge = li.querySelector('.meta-status-badge');
                            statusBadge.textContent = meta.status;
                            statusBadge.className = `meta-status-badge meta-status-${meta.status.toLowerCase().replace(/ /g, '-')}`;
                            li.dataset.metaStatus = meta.status.toLowerCase().replace(' ', '-'); // Atualiza o status no dataset

                            // Explicitly clear and re-start/update timer based on new state
                            const metaId = peiId + '||' + metaTitulo;
                            clearInterval(activeTimers[metaId]); // Clear old interval
                            if (meta.cronometro_inicio) {
                                startVisualTimer(li, meta.cronometro_inicio, meta.tempo_total_gasto);
                            } else {
                                li.querySelector('.timer-display').textContent = formatTime(meta.tempo_total_gasto);
                                li.querySelector('.btn-timer-toggle i').className = 'fas fa-play';
                            }

                            // If status changed to 'Concluída' or was reset, reload to move the meta to correct section
                            if (action === 'concluir' || action === 'reset') {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Sucesso!',
                                    text: `Meta ${metaTitulo} ${action === 'concluir' ? 'concluída' : 'resetada'} com sucesso!`,
                                    showConfirmButton: false,
                                    timer: 1500
                                }).then(() => {
                                    window.location.reload();
                                });
                            }
                        }
                        return result;
                    } catch (error) {
                        console.error(`Erro na ação '${action}':`, error);
                        Swal.fire('Erro', `Erro: ${error.message}`, 'error');
                        return null;
                    }
                }

                document.querySelectorAll('.pei-header').forEach(header => {
                    header.addEventListener('click', () => {
                        const content = header.nextElementSibling;
                        const icon = header.querySelector('.pei-toggle-btn i');
                        
                        // Toggle 'expanded' class for smooth transition
                        const isExpanded = content.classList.contains('expanded');
                        content.classList.toggle('expanded', !isExpanded);
                        // Set fixed large height for PEI content when expanded
                        content.style.maxHeight = !isExpanded ? '2000px' : '0'; 
                        content.style.paddingTop = !isExpanded ? '1.8rem' : '0'; 
                        content.style.paddingBottom = !isExpanded ? '1.8rem' : '0'; 

                        icon.className = isExpanded ? 'fas fa-chevron-down' : 'fas fa-chevron-up';
                        
                        // If collapsing, also collapse any expanded meta-evolutions inside
                        if (isExpanded) {
                            content.querySelectorAll('.meta-evolutions.expanded').forEach(evoContainer => {
                                evoContainer.classList.remove('expanded');
                                evoContainer.style.maxHeight = '0';
                                evoContainer.style.paddingTop = '0';
                                evoContainer.style.paddingBottom = '0';
                            });
                        }
                    });
                });

                document.querySelectorAll('.pei-metas-list').forEach(list => {
                    list.addEventListener('click', async (e) => {
                        const li = e.target.closest('li');
                        if (!li || !li.dataset.peiId) return;

                        const peiId = li.dataset.peiId;
                        const metaTitulo = li.dataset.metaTitulo;
                        const metaStatus = li.dataset.metaStatus;

                        if (e.target.closest('.btn-timer-toggle')) {
                            if (metaStatus === 'concluida') return; // Não permite iniciar/pausar se concluído
                            const isRunning = !!li.dataset.cronometroInicio;
                            const action = isRunning ? 'stop_timer' : 'start_timer';
                            await sendMetaUpdate(peiId, metaTitulo, action);
                        } else if (e.target.closest('.btn-timer-reset')) {
                            if (metaStatus === 'concluida') return; // Não permite resetar se concluído
                            Swal.fire({
                                title: 'Zerar Cronômetro',
                                text: 'Tem certeza que deseja zerar o tempo e o status desta meta? Isso irá redefinir a meta para "Não Iniciada".',
                                icon: 'warning',
                                showCancelButton: true,
                                confirmButtonText: 'Sim, zerar',
                                cancelButtonText: 'Cancelar'
                            }).then(async (result) => {
                                if (result.isConfirmed) {
                                    await sendMetaUpdate(peiId, metaTitulo, 'reset');
                                }
                            });
                        } else if (e.target.closest('.btn-concluir-meta')) { // Não permite concluir se já concluído
                            if (metaStatus === 'concluida') return;
                            document.getElementById('concluir-meta-titulo').textContent = metaTitulo;
                            modalController.concluirMeta.dataset.peiId = peiId;
                            modalController.concluirMeta.dataset.metaTitulo = metaTitulo;
                            modalController.open(modalController.concluirMeta);
                        } else if (e.target.closest('.btn-send-evolution')) { // Novo: Enviar Evolução
                            const textArea = li.querySelector('.chat-input-area textarea');
                            const evolutionContent = textArea.value.trim();

                            // Client-side validation for empty evolution content
                            if (!evolutionContent) {
                                Swal.fire('Atenção', 'Por favor, digite o conteúdo da evolução.', 'warning');
                                return; // Stop the function if content is empty
                            }

                            const response = await fetch(`/prontuarios/${pacienteId}/registrar_registro_generico`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    tipo_registro: 'evolucao_pei',
                                    // Garante que o título não seja vazio
                                    titulo: metaTitulo ? `Evolução de ${metaTitulo}` : 'Evolução Registrada',
                                    conteudo: evolutionContent,
                                    referencia_pei_id: peiId,
                                    referencia_meta_titulo: metaTitulo
                                })
                            });
                            const result = await response.json();
                            if (result.success) {
                                Swal.fire('Sucesso!', 'Evolução registrada.', 'success');
                                textArea.value = ''; // Limpa o textarea
                                // Adicionar a nova mensagem ao chat sem recarregar a página
                                const chatContainer = li.querySelector('.chat-container');
                                // Check if the empty state exists and remove it if adding the first message
                                const emptyState = chatContainer.querySelector('.empty-state');
                                if (emptyState) {
                                    emptyState.remove();
                                }
                                const newMessageHtml = `
                                    <div class="chat-message-wrapper">
                                        <div class="chat-message self">
                                            ${evolutionContent}
                                        </div>
                                        <div class="chat-message-meta" data-registro-id="${result.registro_id}">
                                            ${new Date().toLocaleDateString('pt-BR')} - ${usuarioNome}
                                            <button class="btn btn-sm btn-danger-outline btn-apagar-registro" data-registro-id="${result.registro_id}" title="Apagar Evolução"><i class="fas fa-trash"></i></button>
                                        </div>
                                    </div>
                                `;
                                chatContainer.insertAdjacentHTML('beforeend', newMessageHtml);
                                chatContainer.scrollTop = chatContainer.scrollHeight; // Scroll para o final
                                
                                // Atualiza a contagem de evoluções
                                const evolutionCountSpan = li.querySelector('.evolution-count');
                                evolutionCountSpan.textContent = parseInt(evolutionCountSpan.textContent) + 1;
                                const toggleButton = li.querySelector('.btn-toggle-evolutions');
                                if (toggleButton) toggleButton.style.display = 'inline-flex'; // Ensure button is visible

                            } else {
                                // Display specific backend error message if available
                                Swal.fire('Erro!', `Falha ao registrar evolução: ${result.message || 'Erro desconhecido.'}`, 'error');
                            }
                        } else if (e.target.closest('.btn-toggle-evolutions')) { // Botão "Atividade"
                            const li = e.target.closest('li');
                            const evolutionsContainer = li.querySelector('.meta-evolutions');
                            const toggleButton = e.target.closest('.btn-toggle-evolutions');
                            const chatContainer = li.querySelector('.chat-container');

                            // Garantir que o PEI card pai esteja aberto
                            const peiCard = li.closest('.pei-card');
                            if (peiCard) {
                                const peiContent = peiCard.querySelector('.pei-content');
                                if (peiContent && !peiContent.classList.contains('expanded')) {
                                    peiContent.classList.add('expanded');
                                    // Set fixed large height for PEI content when expanded
                                    peiContent.style.maxHeight = '2000px'; 
                                    peiContent.style.paddingTop = '1.8rem';
                                    peiContent.style.paddingBottom = '1.8rem';

                                    const peiHeader = peiCard.querySelector('.pei-header');
                                    if (peiHeader) {
                                        const peiHeaderIcon = peiHeader.querySelector('.pei-toggle-btn i');
                                        if (peiHeaderIcon) peiHeaderIcon.className = 'fas fa-chevron-up';
                                    }
                                }
                            }

                            // Agora, alternar a visibilidade do meta-evolutions (o chat)
                            const isVisible = evolutionsContainer.classList.contains('expanded');
                            evolutionsContainer.classList.toggle('expanded', !isVisible);
                            // Set fixed large height for evolutions content when expanded
                            evolutionsContainer.style.maxHeight = !isVisible ? '1000px' : '0'; 
                            evolutionsContainer.style.paddingTop = !isVisible ? '1.2rem' : '0';
                            evolutionsContainer.style.paddingBottom = !isVisible ? '1.2rem' : '0';
                            
                            // Always show comments icon for 'Atividade'
                            toggleButton.querySelector('i').className = 'fas fa-comments';

                            // Scroll para o final do chat ao abrir
                            if (!isVisible && chatContainer) {
                                chatContainer.scrollTop = chatContainer.scrollHeight;
                            }
                        }
                    });
                });

                document.getElementById('confirmConcluirMetaBtn').addEventListener('click', async () => {
                    const modal = modalController.concluirMeta;
                    const peiId = modal.dataset.peiId;
                    const metaTitulo = modal.dataset.metaTitulo;
                    const observacao = document.getElementById('concluir-meta-observacao').value;
                    await sendMetaUpdate(peiId, metaTitulo, 'concluir', { observacao });
                    modalController.close(modal);
                });

                function setupEvolutionVisibility() {
                    document.querySelectorAll('.pei-metas-list li[data-pei-id]').forEach(metaLi => {
                        const evolutionsContainer = metaLi.querySelector('.meta-evolutions');
                        const toggleBtn = metaLi.querySelector('.btn-toggle-evolutions');
                        if (!evolutionsContainer || !toggleBtn) return;

                        // Calculate initial evolution count
                        const chatMessages = evolutionsContainer.querySelectorAll('.chat-message-wrapper');
                        const count = chatMessages.length;

                        // Always show 'Atividade' button
                        toggleBtn.style.display = 'inline-flex';
                        toggleBtn.querySelector('.evolution-count').textContent = count;
                        toggleBtn.querySelector('i').className = 'fas fa-comments'; // Always show comments icon

                        // Ensure chat container scrolls to bottom on load/toggle
                        const chatContainer = metaLi.querySelector('.chat-container');
                        if (chatContainer) {
                            chatContainer.scrollTop = chatContainer.scrollHeight;
                        }
                    });
                }

                document.querySelectorAll('.collapsible-header').forEach(header => {
                    header.addEventListener('click', () => {
                        const content = header.nextElementSibling;
                        const icon = header.querySelector('i');
                        
                        const isCollapsed = header.classList.contains('collapsed');
                        header.classList.toggle('collapsed', !isCollapsed);
                        content.classList.toggle('expanded', isCollapsed);
                        // Set fixed large height for collapsible content when expanded
                        content.style.maxHeight = isCollapsed ? '5000px' : '0'; 
                        content.style.paddingTop = isCollapsed ? '1rem' : '0';
                        content.style.paddingBottom = isCollapsed ? '1rem' : '0';
                        icon.style.transform = isCollapsed ? 'rotate(0deg)' : 'rotate(-90deg)';

                        // If collapsing, also collapse any expanded meta-evolutions inside
                        if (!isCollapsed) { // Only collapse if it was expanded
                            content.querySelectorAll('.meta-evolutions.expanded').forEach(evoContainer => {
                                evoContainer.classList.remove('expanded');
                                evoContainer.style.maxHeight = '0';
                                evoContainer.style.paddingTop = '0';
                                evoContainer.style.paddingBottom = '0';
                            });
                        }
                    });
                });

                initializeMetaTimers();
                setupEvolutionVisibility();
            }

            // --- Lógica para carregar agendamentos do paciente ---
            async function loadPatientAppointments() {
                const agendaListDiv = document.getElementById('agenda-paciente-list');
                const emptyStateDiv = document.getElementById('agenda-paciente-empty-state');
                agendaListDiv.innerHTML = '<div class="empty-state" id="agenda-paciente-empty-state"><p>Carregando agendamentos...</p></div>';

                try {
                    // Simulação de chamada de API para obter agendamentos
                    // Em um ambiente real, você faria um fetch para seu backend:
                    // const response = await fetch(`/api/pacientes/${pacienteId}/agendamentos`);
                    // const appointments = await response.json();

                    // Dados mockados para demonstração
                    const mockAppointments = [
                        {
                            id: 'agendamento1',
                            data: '2024-06-15',
                            hora: '10:00',
                            servico: 'Consulta Geral',
                            profissional: 'Dr. João Silva',
                            status: 'concluido'
                        },
                        {
                            id: 'agendamento2',
                            data: '2024-06-10',
                            hora: '14:30',
                            servico: 'Exame de Rotina',
                            profissional: 'Dra. Maria Souza',
                            status: 'concluido'
                        },
                        {
                            id: 'agendamento3',
                            data: '2024-05-20',
                            hora: '09:00',
                            servico: 'Sessão de Fisioterapia',
                            profissional: 'Fisiot. Ana Paula',
                            status: 'concluido'
                        },
                           {
                            id: 'agendamento4',
                            data: '2024-06-25',
                            hora: '11:00',
                            servico: 'Retorno Ortopédico',
                            profissional: 'Dr. João Silva',
                            status: 'confirmado' // Exemplo de um agendamento não concluído
                        }
                    ];

                    // Filtrar apenas agendamentos "concluido"
                    const concludedAppointments = mockAppointments.filter(app => app.status === 'concluido');


                    if (concludedAppointments.length > 0) {
                        agendaListDiv.innerHTML = ''; // Limpa o estado de carregamento
                        concludedAppointments.forEach(app => {
                            const card = `
                                <div class="agenda-paciente-card">
                                    <div class="card-header">
                                        <h4>${app.servico}</h4>
                                        <span class="status-badge status-${app.status}">${app.status.toUpperCase()}</span>
                                    </div>
                                    <div class="card-body">
                                        <p><strong>Data:</strong> ${app.data} às ${app.hora}</p>
                                        <p><strong>Profissional:</strong> ${app.profissional}</p>
                                    </div>
                                    <div class="card-footer">
                                        </div>
                                </div>
                            `;
                            agendaListDiv.insertAdjacentHTML('beforeend', card);
                        });
                    } else {
                        agendaListDiv.innerHTML = '<div class="empty-state"><p>Nenhum agendamento concluído encontrado.</p></div>';
                    }
                } catch (error) {
                    console.error("Erro ao carregar agendamentos:", error);
                    agendaListDiv.innerHTML = '<div class="empty-state"><p>Erro ao carregar agendamentos.</p></div>';
                    Swal.fire('Erro', 'Não foi possível carregar o histórico de agendamentos.', 'error');
                }
            }


            // Geração de PDF
            window.jsPDF = window.jspdf.jsPDF;
            async function generatePdfForRecord(targetId, title) {
                const element = document.getElementById(targetId);
                if (!element) {
                    Swal.fire('Erro', 'Elemento para impressão não encontrado.', 'error');
                    return;
                }

                Swal.fire({
                    title: 'Gerando PDF...',
                    text: 'Isso pode levar alguns segundos.',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                try {
                    const pdf = new jsPDF('p', 'mm', 'a4'); // 'p' para retrato, 'mm' para milímetros, 'a4' tamanho
                    const margin = 15; // Increased margin for more side space
                    let y = margin;
                    const pageWidth = pdf.internal.pageSize.getWidth() - (2 * margin);
                    const defaultFontSize = 9; // Reduced from 10 to 9 for body text
                    const lineHeightMultiplier = 1.3; // Slightly increased for better readability


                    // Function to add a new page and the header
                    const addNewPage = () => {
                        pdf.addPage();
                        y = margin; // Reset Y to the top of the new page
                        pdf.setFont('helvetica', 'normal');
                        pdf.setFontSize(9); // Header font size slightly smaller
                        pdf.setTextColor(100);
                        pdf.text(`${clinicaNome}`, margin, y); y += 4;
                        pdf.text(`Paciente: ${pacienteNome}`, margin, y); y += 4;
                        pdf.text(`Documento: ${title}`, margin, y); y += 4;
                        pdf.text(`Data de Emissão: ${new Date().toLocaleDateString('pt-BR')}`, margin, y); y += 12; // Adjusted spacing
                    };

                    // Add header for the first page
                    pdf.setFont('helvetica', 'normal');
                    pdf.setFontSize(9); // Header font size slightly smaller
                    pdf.setTextColor(100);
                    pdf.text(`${clinicaNome}`, margin, y); y += 4;
                    pdf.text(`Paciente: ${pacienteNome}`, margin, y); y += 4;
                    pdf.text(`Documento: ${title}`, margin, y); y += 4;
                    pdf.text(`Data de Emissão: ${new Date().toLocaleDateString('pt-BR')}`, margin, y); y += 12; // Adjusted spacing


                    // Process HTML content
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = element.innerHTML;

                    const processNode = (node, currentStyles = { font: 'helvetica', style: 'normal', size: defaultFontSize, isListItem: false, listType: '', listItemIndex: 0, listLevel: 0 }) => {
                        // Ignore scripts and styles
                        if (node.nodeName === 'SCRIPT' || node.nodeName === 'STYLE') {
                            return;
                        }

                        // Remove empty text nodes or nodes with only whitespace
                        if (node.nodeType === Node.TEXT_NODE && !node.textContent.trim()) {
                            return;
                        }
                        if (node.nodeType === Node.ELEMENT_NODE && node.children.length === 0 && !node.textContent.trim()) {
                            // Ignore empty elements that don't contain other elements or significant text
                            return;
                        }


                        if (node.nodeType === Node.TEXT_NODE) {
                            let text = node.textContent.trim();
                            if (!text) return; // Skip if text is just whitespace after trim

                            let combinedStyle = { ...currentStyles };

                            let parent = node.parentNode;
                            while (parent && parent !== tempDiv) {
                                if (parent.nodeName === 'STRONG' || parent.nodeName === 'B') {
                                    combinedStyle.style = combinedStyle.style.includes('bold') ? combinedStyle.style : (combinedStyle.style + 'bold');
                                }
                                if (parent.nodeName === 'EM' || parent.nodeName === 'I') {
                                    combinedStyle.style = combinedStyle.style.includes('italic') ? combinedStyle.style : (combinedStyle.style + 'italic');
                                }
                                if (parent.nodeName === 'U') {
                                    // For underline, we might need a custom draw function or iterate char by char
                                    // For simplicity in jsPDF, it's often omitted or handled manually if really needed.
                                    // document.execCommand('underline') just toggles text-decoration.
                                    // PDF rendering needs explicit underline command for each segment.
                                    // This example does not implement underline drawing.
                                }
                                parent = parent.parentNode;
                            }

                            // Adjust size and style for headings (proportionally reduced)
                            if (node.parentNode.nodeName.match(/^H[1-6]$/)) {
                                switch (node.parentNode.nodeName) {
                                    case 'H1': combinedStyle.size = 18; combinedStyle.style = 'bold'; break;
                                    case 'H2': combinedStyle.size = 16; combinedStyle.style = 'bold'; break;
                                    case 'H3': combinedStyle.size = 14; combinedStyle.style = 'bold'; break;
                                    case 'H4': combinedStyle.size = 12; combinedStyle.style = 'bold'; break;
                                    case 'H5': combinedStyle.size = 11; combinedStyle.style = 'bold'; break;
                                    case 'H6': combinedStyle.size = 10; combinedStyle.style = 'bold'; break;
                                }
                            } else if (!combinedStyle.isListItem) {
                                combinedStyle.size = defaultFontSize; // Reverts to default size
                            }

                            // Clean up duplicate or inconsistent styles
                            let finalStyle = combinedStyle.style.replace('normalbold', 'bold').replace('normalitalic', 'italic');
                            if (finalStyle.includes('bold') && finalStyle.includes('italic')) {
                                finalStyle = 'bolditalic';
                            } else if (finalStyle.includes('bold')) {
                                finalStyle = 'bold';
                            } else if (finalStyle.includes('italic')) {
                                finalStyle = 'italic';
                            } else {
                                finalStyle = 'normal';
                            }

                            pdf.setFont(combinedStyle.font, finalStyle);
                            pdf.setFontSize(combinedStyle.size);

                            // Adjust line height based on current font size
                            const currentLineHeightMm = combinedStyle.size * lineHeightMultiplier * (1 / pdf.internal.scaleFactor);

                            // Calculate available width for text, considering list indentation
                            const textWidth = pageWidth - (combinedStyle.listLevel * 7); // Indentation for nested lists (7mm per level)

                            const lines = pdf.splitTextToSize(text, textWidth);

                            lines.forEach((line, index) => {
                                if (y + currentLineHeightMm > pdf.internal.pageSize.getHeight() - margin) {
                                    addNewPage();
                                    pdf.setFont(combinedStyle.font, finalStyle);
                                    pdf.setFontSize(combinedStyle.size);
                                }

                                let prefix = '';
                                let indent = 0;
                                if (combinedStyle.isListItem && index === 0) { // Only for the first line of a list item
                                    if (combinedStyle.listType === 'ul') {
                                        prefix = '• ';
                                    } else if (combinedStyle.listType === 'ol') {
                                        prefix = `${combinedStyle.listItemIndex}. `;
                                    }
                                    indent = combinedStyle.listLevel * 7; // Indentation for nested lists
                                }

                                pdf.text(prefix + line, margin + indent, y);
                                y += currentLineHeightMm;
                            });
                        } else if (node.nodeType === Node.ELEMENT_NODE) {
                            let newStyles = { ...currentStyles };

                            // Spacing before blocks
                            const blockElements = ['P', 'H1', 'H2', 'H3', 'H4', 'H5', 'H6', 'UL', 'OL', 'LI']; // Include LI as block for spacing purposes
                            if (blockElements.includes(node.nodeName)) {
                                if (node.textContent.trim().length > 0) { // Only add space if there's actual content
                                    // Avoid adding extra space right at the top of a new page or after a header
                                    if (y > margin + 20 || (node.previousElementSibling && !blockElements.includes(node.previousElementSibling.nodeName)) ) { // Smarter spacing, avoids double spacing
                                        y += 3; // Spacing between blocks (reduced from 4 to 3)
                                    }
                                }
                            }

                            // Detect and level lists
                            if (node.nodeName === 'UL' || node.nodeName === 'OL') {
                                newStyles.listLevel++;
                            }
                            if (node.nodeName === 'LI') {
                                newStyles.isListItem = true;
                                const olParent = node.closest('ol');
                                const ulParent = node.closest('ul');
                                if (olParent) {
                                    newStyles.listType = 'ol';
                                    const siblings = Array.from(node.parentNode.children);
                                    newStyles.listItemIndex = siblings.indexOf(node) + 1;
                                } else if (ulParent) {
                                    newStyles.listType = 'ul';
                                }
                            } else {
                                newStyles.isListItem = false; // Reset for non-<li> sub-elements
                                newStyles.listType = '';
                                newStyles.listItemIndex = 0;
                            }


                            if (node.childNodes.length > 0) {
                                Array.from(node.childNodes).forEach(child => processNode(child, newStyles));
                            }

                            // Spacing after blocks
                            if (blockElements.includes(node.nodeName)) {
                                if (node.textContent.trim().length > 0) {
                                    y += 3; // Spacing after blocks (reduced from 4 to 3)
                                }
                            }

                            // Decrement list level after processing all children of the list
                            if (node.nodeName === 'UL' || node.nodeName === 'OL') {
                                newStyles.listLevel--;
                            }
                        }
                    };

                    processNode(tempDiv);

                    pdf.save(`${title.replace(/[^a-z0-9]/gi, '_')}.pdf`);
                    Swal.close();
                    Swal.fire('Sucesso!', 'PDF gerado com sucesso.', 'success');

                } catch (error) {
                    console.error("Erro ao gerar PDF:", error);
                    Swal.fire('Erro', 'Não foi possível gerar o PDF. Detalhes: ' + error.message, 'error');
                }
            }


            // --- Lógica Geral de Eventos e Inicialização ---
            document.body.addEventListener('click', (e) => {
                // Botões de adicionar registro genérico
                if (e.target.closest('.btn-add-generic')) {
                    openModalParaRegistro(e.target.closest('.btn-add-generic').dataset.tipo);
                }
                // Botões para editar registros
                if (e.target.closest('.btn-editar-registro')) {
                    const btn = e.target.closest('.btn-editar-registro');
                    openModalParaRegistro(btn.dataset.tipo, {
                        id: btn.dataset.registroId,
                        titulo: btn.dataset.titulo,
                        conteudo: btn.dataset.conteudo
                    });
                }
                // Botões para apagar registros (geral e evoluções de chat)
                if (e.target.closest('.btn-apagar-registro')) {
                    const btn = e.target.closest('.btn-apagar-registro');
                    const registroIdToDelete = btn.dataset.registroId;

                    Swal.fire({
                        title: 'Confirmar Exclusão',
                        text: 'Tem certeza que deseja apagar este registro? Esta ação é irreversível.',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Sim, apagar',
                        cancelButtonText: 'Cancelar'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            // If it's a chat message, remove it from the DOM directly before sending request
                            const chatMessageWrapper = btn.closest('.chat-message-wrapper');
                            if (chatMessageWrapper) {
                                chatMessageWrapper.remove();
                                // Decrement evolution count
                                const metaLi = btn.closest('.pei-metas-list li');
                                if (metaLi) {
                                    const evolutionCountSpan = metaLi.querySelector('.evolution-count');
                                    evolutionCountSpan.textContent = parseInt(evolutionCountSpan.textContent) - 1;
                                }
                            }

                            // Send deletion request to the backend
                            const form = document.getElementById('formApagarRegistro');
                            document.getElementById('registro_id_apagar').value = registroIdToDelete;
                            form.submit(); // This will reload the page on success
                        }
                    });
                }
                // Botão de imprimir PDF
                if (e.target.closest('.btn-print-pdf')) {
                    const btn = e.target.closest('.btn-print-pdf');
                    generatePdfForRecord(btn.dataset.targetId, btn.dataset.title);
                }
                    // Botão de Visualizar Registro (novo)
                if (e.target.closest('.btn-visualizar-registro')) {
                    const btn = e.target.closest('.btn-visualizar-registro');
                    openVisualizarRegistroModal(
                        btn.dataset.title,
                        btn.dataset.content,
                        btn.dataset.type,
                        btn.dataset.date,
                        btn.dataset.professional
                    );
                }
            });

            // Nova função para abrir a modal de visualização
            function openVisualizarRegistroModal(title, content, type, date, professional) {
                document.getElementById('visualizarRegistroTitle').textContent = title;
                document.getElementById('visualizarRegistroType').textContent = type;
                document.getElementById('visualizarRegistroDate').textContent = date;
                document.getElementById('visualizarRegistroProfessional').textContent = professional;
                document.getElementById('visualizarRegistroContent').innerHTML = content;
                modalController.open(modalController.visualizar);
            }

            // Lógica das Abas
            document.querySelectorAll('.tab-nav-item').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab-nav-item, .tab-panel').forEach(el => el.classList.remove('active'));
                    tab.classList.add('active');
                    const targetPanelId = 'tab-panel-' + tab.dataset.tab;
                    document.getElementById(targetPanelId).classList.add('active');

                    // Carregar agendamentos apenas quando a aba é ativada
                    if (tab.dataset.tab === 'agenda-paciente') {
                        loadPatientAppointments();
                    }
                });
            });

            // Inicialização de todas as funções
            setupPeiAccordion();
            // Load appointments initially if the tab is active by default (it's not, but for completeness)
            // If you want it to load immediately when the page loads, uncomment below:
            // loadPatientAppointments();
        });
    </script>
</body>
</html>
