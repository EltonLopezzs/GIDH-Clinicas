<!DOCTYPE html>
<html lang="pt-br" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ 'Editar' if protocol else 'Novo' }} Protocolo - {{ session.clinica_nome_display or 'Clínica On' }}</title>

    <link rel="icon" type="image/png" href="https://placehold.co/40x40/0d9488/ffffff?text=C">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}"> 
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    
    <style>
        /* Estilos Globais e Variáveis de Tema */
        :root {
            --bg: #f1f5f9;       /* Gray-100 */
            --card: #ffffff;     /* White */
            --text: #0f172a;     /* Gray-900 */
            --muted: #64748b;    /* Gray-500 */
            --accent: #9b53b8;   /* Custom Purple */
            --primary-dark: #115e59;
            --primary: #5587c2;  /* Custom Blue */
            --primary-light: #e0eaf7; /* Lighter Blue */
            --secondary: #f59e0b; /* Yellow-500 */
            --danger: #dc2626;   /* Red-600 */
            --success: #16a34a;  /* Green-600 */
            --warning: #f59e0b;  /* Yellow-500 */
            --info: #0ea5e9;     /* Sky-500 */
            --border-color: #e2e8f0; /* Gray-200 */
            color-scheme: light;
        }

        [data-theme="dark"] {
            --bg: #0f172a;       /* Gray-900 */
            --card: #1e293b;     /* Gray-800 */
            --text: #f1f5f9;     /* Gray-100 */
            --muted: #94a3b8;    /* Gray-400 */
            --border-color: #334155; /* Gray-600 */
            --primary: #60a5fa;  /* Blue-400 */
            --primary-light: #1e293b; /* Gray-800 */
            color-scheme: dark;
        }

        /* Reset e Estilos Base */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Barra de Rolagem */
        ::-webkit-scrollbar { background-color: var(--bg); width: 0.5rem; height: 0.5rem; }
        ::-webkit-scrollbar-thumb { background-color: var(--muted); border-radius: 0.3rem; }
        ::-webkit-scrollbar-thumb:hover { background-color: var(--primary); }

        /* Layout Principal */
        .layout { display: flex; min-height: 100vh; width: 100%; }

        /* --- Conteúdo Principal & Topbar --- */
        .main-content {
            flex: 1; margin-left: 260px;
            transition: margin-left 0.3s ease, width 0.3s ease;
            width: calc(100% - 260px);
        }
        .main-content.collapsed { margin-left: 88px; width: calc(100% - 88px); }
        .topbar {
            background-color: var(--card); color: var(--text); padding: 0 1.5rem;
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid var(--border-color); height: 70px; flex-shrink: 0;
            position: sticky; top: 0; z-index: 900;
        }
        .topbar-left { display: flex; align-items: center; gap: 1rem; }
        .topbar .page-title { font-weight: 600; font-size: 1.25rem; color: var(--text); }
        .toggle-btn {
            background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--muted);
            width: 40px; height: 40px; border-radius: 50%; display: grid; place-items: center;
            transition: background 0.2s ease, color 0.2s ease;
        }
        .toggle-btn:hover { background-color: var(--bg); color: var(--primary); }
        .topbar-actions { display: flex; gap: 0.75rem; align-items: center; }
        
        main { flex-grow: 1; padding: 1.5rem; overflow-y: auto; }

        /* --- Botões --- */
        .btn {
            padding: 0.6rem 1.2rem; font-size: 0.9rem; border-radius: 8px; text-decoration: none;
            font-weight: 600; display: inline-flex; align-items: center; justify-content: center;
            gap: 0.5rem; border: 1px solid transparent; cursor: pointer; transition: all 0.2s ease-in-out;
        }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.85rem; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: var(--accent); }
        .btn-secondary { background-color: var(--muted); color: white; }
        .btn-secondary:hover { background-color: var(--text); }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-danger:hover { background-color: #b91c1c; }

        /* --- Estilos do Formulário --- */
        .form-card {
            background: var(--card);
            border-radius: 18px;
            box-shadow: 0 10px 32px rgba(0,0,0,0.08);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: calc(100vh - 70px - 3rem); /* Altura do Topbar - padding */
        }
        .protocol-steps {
            display: flex;
            width: 100%;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
        }
        .protocol-step {
            flex: 1;
            padding: 18px 10px 14px 10px;
            font-weight: 600;
            font-size: 1rem;
            color: var(--muted);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            background: none;
            transition: all 0.2s;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            min-width: 150px;
        }
        .protocol-step.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: color-mix(in srgb, var(--primary) 10%, transparent);
        }
        .protocol-step i { font-size: 1.1rem; }

        .protocol-card-section {
            padding: 2.5rem 2rem 2rem 2rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .protocol-card-container-form {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            flex-grow: 1;
        }
        .section-content { flex-grow: 1; }
        .section-title {
            font-size: 1.3rem; font-weight: 700; color: var(--primary);
            margin-bottom: 1.5rem; display: flex; align-items: center; gap: 1rem;
        }
        /* New style to align title and button */
        .section-header-with-button {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .section-header-with-button .section-title {
            margin-bottom: 0; /* Remove margin from title when in header */
        }


        .protocol-card-fields {
            display: grid;
            gap: 1.2rem 2rem;
        }
        .protocol-card-fields.grid-2-cols { grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
        .protocol-field { display: flex; flex-direction: column; gap: 0.5rem; }
        .protocol-field label {
            font-size: 1rem; color: var(--muted); font-weight: 600;
        }
        .protocol-field input, .protocol-field select, .protocol-field textarea {
            background: transparent;
            border: none;
            border-bottom: 2px solid var(--border-color);
            font-size: 1rem;
            padding: 0.5rem 0.2rem;
            color: var(--text);
            transition: all 0.2s;
            border-radius: 0;
            outline: none;
            width: 100%;
        }
        .protocol-field input:focus, .protocol-field select:focus, .protocol-field textarea:focus {
            border-color: var(--primary);
        }
        .protocol-field textarea { min-height: 80px; resize: vertical; }

        .protocol-actions {
            display: flex; justify-content: space-between; gap: 1rem; margin-top: 2rem;
            padding-top: 1.5rem; border-top: 1px solid var(--border-color);
        }
        .protocol-actions.justify-end { justify-content: flex-end; }

        /* --- Validação de Campos --- */
        .protocol-field.required label::after { content: ' *'; color: var(--danger); }
        .protocol-field input.invalid, .protocol-field select.invalid, .protocol-field textarea.invalid {
            border-bottom-color: var(--danger) !important;
            background-color: color-mix(in srgb, var(--danger) 10%, transparent);
        }
        @keyframes shake {
            10%, 90% { transform: translateX(-1px); }
            20%, 80% { transform: translateX(2px); }
            30%, 50%, 70% { transform: translateX(-4px); }
            40%, 60% { transform: translateX(4px); }
        }
        .shake { animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both; }
        .protocol-step.has-error {
            color: var(--danger) !important;
            border-bottom-color: var(--danger) !important;
            background: color-mix(in srgb, var(--danger) 10%, transparent);
        }
        .protocol-step.has-error::after { content: '⚠️'; margin-left: 5px; font-size: 0.9rem; }

        /* --- Estilos da Tabela para Itens Dinâmicos --- */
        .table-container {
            width: 100%;
            overflow-x: auto; /* Permite rolagem horizontal em telas pequenas */
            background: var(--card);
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        .table-container table {
            width: 100%;
            border-collapse: separate; /* Permite border-radius nas células */
            border-spacing: 0;
            color: var(--text);
            min-width: 600px; /* Garante que a tabela não fique muito pequena em desktop */
        }

        .table-container th,
        .table-container td {
            padding: 0.9rem 1rem;
            font-size: 0.9rem;
            text-align: left;
            vertical-align: middle;
            border-bottom: 1px solid var(--border-color);
        }

        .table-container thead th {
            font-weight: 600;
            color: var(--muted);
            text-transform: uppercase;
            font-size: 0.8rem;
            background-color: var(--bg);
            border-bottom-width: 2px;
        }

        /* Arredondar cantos da thead */
        .table-container thead th:first-child { border-top-left-radius: 8px; }
        .table-container thead th:last-child { border-top-right-radius: 8px; }

        /* Estilo para as linhas do corpo da tabela */
        .table-container tbody tr:hover {
            background-color: color-mix(in srgb, var(--primary) 8%, transparent);
        }
        .table-container tbody tr:last-child td {
            border-bottom: none; /* Remove a borda inferior da última linha */
        }
        /* Arredondar cantos da tbody (última linha) */
        .table-container tbody tr:last-child td:first-child { border-bottom-left-radius: 8px; }
        .table-container tbody tr:last-child td:last-child { border-bottom-right-radius: 8px; }

        /* Estilos para inputs e textareas dentro das células da tabela */
        .table-container td input[type="text"],
        .table-container td input[type="number"],
        .table-container td textarea,
        .table-container td select { /* Adicionado select aqui */
            background-color: transparent; /* Fundo transparente */
            border: none; /* Sem borda */
            padding: 0; /* Sem padding */
            color: var(--text);
            width: 100%;
            font-size: 0.9rem;
            outline: none; /* Remove outline no focus */
            resize: none; /* Desabilita redimensionamento para textareas */
        }

        /* Estilo para o botão de remover dentro da tabela */
        .table-container .dynamic-field-item-actions {
            text-align: right; /* Alinha o botão à direita na célula */
            white-space: nowrap; /* Evita quebra de linha */
        }
        .table-container .dynamic-field-item-actions .btn-sm {
            margin-left: auto; /* Empurra o botão para a direita */
        }

        /* Estilo para a mensagem de "Nenhum item encontrado" na tabela */
        .table-container .no-results-row td {
            text-align: center;
            padding: 2rem;
            color: var(--muted);
        }

        /* --- Modals --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(15,23,42,0.7);
            display: flex; align-items: center; justify-content: center;
            z-index: 4000; opacity: 0;
            transition: opacity 0.3s ease; pointer-events: none;
        }
        .modal-overlay.show { opacity: 1; pointer-events: auto; }
        .modal {
            background: var(--card); border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            width: 90vw; /* Default width */
            max-width: 1200px !important; /* Increased max-width for modals */
            transform: scale(0.95);
            transition: transform 0.3s ease;
            display: flex; flex-direction: column;
        }
        .modal-overlay.show .modal { transform: scale(1); }
        /* Alert Modal */
        .alert-modal { max-width: 400px; padding: 2rem; text-align: center; align-items: center; gap: 1.5rem;}
        .alert-modal-icon {
            width: 60px; height: 60px; border-radius: 50%; display: grid; place-items: center;
            font-size: 2rem; color: white;
        }
        .alert-modal-icon.info { background: var(--info); }
        .alert-modal-icon.success { background: var(--success); }
        .alert-modal-icon.warning { background: var(--warning); }
        .alert-modal-icon.danger { background: var(--danger); }
        .alert-modal-title { font-size: 1.4rem; font-weight: 600; color: var(--text); }
        .alert-modal-message { font-size: 1rem; color: var(--muted); line-height: 1.6; }
        /* Add Item Modal */
        .add-item-modal { max-width: 800px; } /* Ensure this overrides the general .modal max-width if needed */
        .add-item-modal-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border-color); padding: 1.5rem;
        }
        .add-item-modal-title { font-size: 1.5rem; font-weight: 600; color: var(--text); }
        .add-item-modal-close-btn { background: none; border: none; font-size: 1.5rem; color: var(--muted); cursor: pointer; }
        .add-item-modal-body { padding: 1.5rem; display: flex; flex-direction: column; gap: 1rem; }
        .add-item-modal-actions {
            display: flex; justify-content: flex-end; gap: 1rem;
            padding: 1.5rem; border-top: 1px solid var(--border-color);
            background-color: color-mix(in srgb, var(--border-color) 20%, transparent);
        }

        /* --- Toast Notifications --- */
        #toast-container {
            position: fixed; top: 20px; right: 20px; z-index: 5000;
            display: flex; flex-direction: column; gap: 1rem;
        }
        .toast {
            display: flex; align-items: stretch; max-width: 380px;
            background: var(--card); border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-left: 4px solid var(--info);
            animation: slideIn 0.5s ease, fadeOut 0.5s ease 4.5s forwards;
            overflow: hidden;
        }
        .toast.success { border-color: var(--success); }
        .toast.danger { border-color: var(--danger); }
        .toast.warning { border-color: var(--warning); }
        .toast-icon {
            padding: 1rem; display: grid; place-items: center; font-size: 1.5rem;
        }
        .toast.info .toast-icon { color: var(--info); }
        .toast.success .toast-icon { color: var(--success); }
        .toast.danger .toast-icon { color: var(--danger); }
        .toast.warning .toast-icon { color: var(--warning); }
        .toast-content { padding: 1rem; flex-grow: 1; }
        .toast-title { font-weight: 700; color: var(--text); }
        .toast-message { font-size: 0.9rem; color: var(--muted); }
        .toast-close {
            background: none; border: none; color: var(--muted);
            font-size: 1.2rem; padding: 0 1rem; cursor: pointer;
        }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; transform: translateX(100%); } }

        /* Responsividade */
        @media (max-width: 768px) {
            .main-content, .main-content.collapsed { margin-left: 0; width: 100%; }
            /* Adaptação da tabela para telas pequenas */
            .table-container table {
                min-width: unset; /* Remove min-width para permitir encolhimento */
            }
            .table-container thead {
                display: none; /* Esconde o cabeçalho da tabela em telas pequenas */
            }
            .table-container, .table-container tbody, .table-container tr, .table-container td {
                display: block; /* Faz com que a tabela se comporte como blocos */
                width: 100%;
            }
            .table-container tr {
                margin-bottom: 1rem;
                border: 1px solid var(--border-color);
                border-radius: 12px;
                background-color: var(--card);
                box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
                padding: 1rem;
            }
            .table-container td {
                border-bottom: none;
                padding: 0.5rem 0;
                text-align: right; /* Alinha o valor à direita */
                position: relative;
                padding-left: 50%; /* Espaço para o label */
            }
            .table-container td::before {
                content: attr(data-label); /* Usa o atributo data-label para exibir o cabeçalho */
                position: absolute;
                left: 0;
                width: 45%;
                padding-left: 1rem;
                font-weight: 600;
                color: var(--muted);
                text-align: left;
            }
            .table-container .dynamic-field-item-actions {
                text-align: left; /* Alinha as ações à esquerda em mobile */
                padding-top: 1rem;
                border-top: 1px solid var(--border-color);
                margin-top: 0.5rem;
                display: flex; /* Para centralizar os botões se houver mais de um */
                justify-content: center; /* Centraliza os botões */
                gap: 0.5rem;
            }
            .table-container .dynamic-field-item-actions .btn {
                width: auto; /* Permite que os botões se ajustem ao conteúdo */
                flex-grow: 1; /* Faz com que os botões ocupem o espaço disponível */
            }
            /* Garante que os inputs e textareas dentro das células sejam visíveis e não ocupem toda a largura */
            .table-container td input,
            .table-container td textarea,
            .table-container td select { /* Adicionado select aqui */
                display: inline-block; /* Garante que o valor seja visível */
                width: auto; /* Ajusta a largura para o conteúdo */
                background-color: transparent;
                border: none;
                padding: 0;
            }
        }

    </style>
</head>
<body>
    <div id="toast-container"></div>

    <!-- Modal para Alertas Gerais -->
    <div id="general-alert-modal-overlay" class="modal-overlay alert-modal-overlay">
        <div class="modal alert-modal">
            <div id="alert-modal-icon" class="alert-modal-icon"></div>
            <h3 id="alert-modal-title" class="alert-modal-title"></h3>
            <p id="alert-modal-message" class="alert-modal-message"></p>
            <div class="alert-modal-actions">
                <button id="alert-modal-close-btn" class="btn btn-primary">OK</button>
            </div>
        </div>
    </div>

    <!-- Modal para Adicionar Itens Dinâmicos -->
    <div id="add-item-modal-overlay" class="modal-overlay add-item-modal-overlay">
        <div class="modal add-item-modal">
            <div class="add-item-modal-header">
                <h3 id="add-item-modal-title" class="add-item-modal-title">Adicionar Item</h3>
                <button type="button" id="add-item-modal-close-btn" class="add-item-modal-close-btn">&times;</button>
            </div>
            <div id="add-item-modal-body" class="add-item-modal-body">
                <!-- Campos dinâmicos serão inseridos aqui -->
            </div>
            <div class="add-item-modal-actions">
                <button type="button" id="add-item-modal-cancel-btn" class="btn btn-secondary">Cancelar</button>
                <button type="button" id="add-item-modal-save-btn" class="btn btn-primary">Adicionar</button>
            </div>
        </div>
    </div>

    <div class="layout">
        
        {% include 'Nav.html' %}

        <div class="main-content">
            <header class="topbar">
                <div class="topbar-left">
                    <button class="toggle-btn toggle-btn-desktop"><i class="fa-solid fa-bars-staggered"></i></button>
                    <button class="toggle-btn toggle-btn-mobile"><i class="fa-solid fa-bars"></i></button>
                    <h1 class="page-title">{{ 'Editar' if protocol else 'Novo' }} Protocolo</h1>
                </div>
                <div class="topbar-actions">
                    <a href="{{ url_for('protocols.list_protocols') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> <span class="hidden sm:inline">Voltar</span>
                    </a>
                </div>
            </header>

            <main>
                <form id="protocol-form" class="form-card" action="{{ url_for('protocols.save_protocol') }}" method="POST">
                    <input type="hidden" name="id" value="{{ protocol.id if protocol else '' }}">
                    
                    <div class="protocol-steps">
                        <div class="protocol-step active" data-step="1"><i class="fa-solid fa-file-alt"></i> Geral</div>
                        <div class="protocol-step" data-step="2"><i class="fa-solid fa-list-ol"></i> Etapas</div>
                        <div class="protocol-step" data-step="3"><i class="fa-solid fa-layer-group"></i> Níveis</div>
                        <div class="protocol-step" data-step="4"><i class="fa-solid fa-brain"></i> Habilidades</div>
                        <div class="protocol-step" data-step="5"><i class="fa-solid fa-star-half-alt"></i> Pontuação</div>
                        <div class="protocol-step" data-step="6"><i class="fa-solid fa-tasks"></i> Tarefas</div>
                        <div class="protocol-step" data-step="7"><i class="fa-solid fa-comment-dots"></i> Observações</div>
                    </div>

                    <div class="protocol-step-content-wrapper" style="flex:1; position:relative;">
                        <!-- Step 1: Geral -->
                        <div class="protocol-card-section" data-step-content="1" style="display:flex;">
                            <div class="protocol-card-container-form">
                                <div class="section-content">
                                    <div class="protocol-card-fields grid-2-cols">
                                        <div class="protocol-field required col-span-full">
                                            <label>Tipo de Protocolo:</label>
                                            <div class="flex flex-wrap items-center gap-x-6 gap-y-2 mt-2">
                                                <label class="inline-flex items-center">
                                                    <input type="radio" class="form-radio h-5 w-5 text-blue-600" name="tipo_protocolo" value="Aquisicao de Habilidades" {% if not protocol or protocol.tipo_protocolo == 'Aquisicao de Habilidades' %}checked{% endif %} required>
                                                    <span class="ml-2">Aquisição de Habilidades</span>
                                                </label>
                                                <label class="inline-flex items-center">
                                                    <input type="radio" class="form-radio h-5 w-5 text-blue-600" name="tipo_protocolo" value="Reducao de Comportamentos" {% if protocol and protocol.tipo_protocolo == 'Reducao de Comportamentos' %}checked{% endif %} required>
                                                    <span class="ml-2">Redução de Comportamentos</span>
                                                </label>
                                            </div>
                                        </div>
                                        <div class="protocol-field required">
                                            <label for="nome">Nome do Protocolo:</label>
                                            <input type="text" id="nome" name="nome" value="{{ protocol.nome if protocol else '' }}" required>
                                        </div>
                                        <div class="protocol-field">
                                            <label for="duracao_estimada">Duração Estimada (dias):</label>
                                            <input type="number" id="duracao_estimada" name="duracao_estimada" value="{{ protocol.duracao_estimada if protocol else '' }}">
                                        </div>
                                        <div class="protocol-field col-span-full">
                                            <label for="descricao">Descrição:</label>
                                            <textarea id="descricao" name="descricao" rows="4">{{ protocol.descricao if protocol else '' }}</textarea>
                                        </div>
                                        <div class="protocol-field flex items-center col-span-full">
                                            <input type="checkbox" id="ativo" name="ativo" value="1" {% if protocol and protocol.ativo %}checked{% endif %} class="h-5 w-5 text-blue-600 rounded focus:ring-blue-500">
                                            <label for="ativo" class="ml-2 !font-normal">Protocolo Ativo</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="protocol-actions justify-end">
                                    <button type="button" class="btn btn-primary steps-next">Próximo <i class="fa fa-chevron-right"></i></button>
                                </div>
                            </div>
                        </div>

                        <!-- Step 2: Etapas -->
                        <div class="protocol-card-section" data-step-content="2" style="display:none;">
                            <div class="protocol-card-container-form">
                                <div class="section-header-with-button">
                                    <h3 class="section-title"><i class="fa-solid fa-list-ol"></i> Etapas do Protocolo</h3>
                                    <button type="button" onclick="openAddItemModal('etapa')" class="btn btn-primary btn-sm">
                                        <i class="fas fa-plus"></i> Adicionar Etapa
                                    </button>
                                </div>
                                <div class="table-container">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Nome da Etapa</th>
                                                <th>Descrição</th>
                                                <th style="width: 100px;">Ações</th>
                                            </tr>
                                        </thead>
                                        <tbody id="etapas-container">
                                            {% if protocol and protocol.etapas %}
                                                {% for etapa in protocol.etapas %}
                                                <tr class="dynamic-field-item">
                                                    <td data-label="Nome da Etapa">
                                                        <input type="text" value="{{ etapa.nome }}" readonly>
                                                        <input type="hidden" name="etapa_nome[]" value="{{ etapa.nome }}">
                                                    </td>
                                                    <td data-label="Descrição">
                                                        <textarea rows="1" readonly>{{ etapa.descricao }}</textarea>
                                                        <input type="hidden" name="etapa_descricao[]" value="{{ etapa.descricao }}">
                                                    </td>
                                                    <td class="dynamic-field-item-actions">
                                                        <button type="button" onclick="removeDynamicField(this)" class="btn btn-danger btn-sm">Remover</button>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            {% else %}
                                                <tr class="no-results-row">
                                                    <td colspan="3">Nenhuma etapa cadastrada.</td>
                                                </tr>
                                            {% endif %}
                                        </tbody>
                                    </table>
                                </div>
                                <div class="protocol-actions">
                                    <button type="button" class="btn btn-secondary steps-prev"><i class="fa fa-chevron-left"></i> Voltar</button>
                                    <button type="button" class="btn btn-primary steps-next">Próximo <i class="fa fa-chevron-right"></i></button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Step 3: Níveis -->
                        <div class="protocol-card-section" data-step-content="3" style="display:none;">
                            <div class="protocol-card-container-form">
                                <div class="section-header-with-button">
                                    <h3 class="section-title"><i class="fa-solid fa-layer-group"></i> Níveis</h3>
                                    <button type="button" onclick="openAddItemModal('nivel')" class="btn btn-primary btn-sm">
                                        <i class="fas fa-plus"></i> Adicionar Nível
                                    </button>
                                </div>
                                <div class="table-container">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Ordem</th>
                                                <th>Nível</th>
                                                <th>Faixa Etária</th>
                                                <th style="width: 100px;">Ações</th>
                                            </tr>
                                        </thead>
                                        <tbody id="niveis-container">
                                            {% if protocol and protocol.niveis %}
                                                {% for nivel in protocol.niveis %}
                                                <tr class="dynamic-field-item">
                                                    <td data-label="Ordem">
                                                        <input type="number" value="{{ nivel.ordem }}" readonly>
                                                        <input type="hidden" name="nivel_ordem[]" value="{{ nivel.ordem }}">
                                                    </td>
                                                    <td data-label="Nível">
                                                        <input type="number" value="{{ nivel.nivel }}" readonly>
                                                        <input type="hidden" name="nivel_valor[]" value="{{ nivel.nivel }}">
                                                    </td>
                                                    <td data-label="Faixa Etária">
                                                        <input type="text" value="{{ nivel.faixa_etaria }}" readonly>
                                                        <input type="hidden" name="nivel_faixa_etaria[]" value="{{ nivel.faixa_etaria }}">
                                                    </td>
                                                    <td class="dynamic-field-item-actions">
                                                        <button type="button" onclick="removeDynamicField(this)" class="btn btn-danger btn-sm">Remover</button>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            {% else %}
                                                <tr class="no-results-row">
                                                    <td colspan="4">Nenhum nível cadastrado.</td>
                                                </tr>
                                            {% endif %}
                                        </tbody>
                                    </table>
                                </div>
                                <div class="protocol-actions">
                                    <button type="button" class="btn btn-secondary steps-prev"><i class="fa fa-chevron-left"></i> Voltar</button>
                                    <button type="button" class="btn btn-primary steps-next">Próximo <i class="fa fa-chevron-right"></i></button>
                                </div>
                            </div>
                        </div>

                        <!-- Step 4: Habilidades -->
                        <div class="protocol-card-section" data-step-content="4" style="display:none;">
                           <div class="protocol-card-container-form">
                                <div class="section-header-with-button">
                                    <h3 class="section-title"><i class="fa-solid fa-brain"></i> Habilidades</h3>
                                    <button type="button" onclick="openAddItemModal('habilidade')" class="btn btn-primary btn-sm">
                                        <i class="fas fa-plus"></i> Adicionar Habilidade
                                    </button>
                                </div>
                                <div class="table-container">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Ordem</th>
                                                <th>Habilidade</th>
                                                <th style="width: 100px;">Ações</th>
                                            </tr>
                                        </thead>
                                        <tbody id="habilidades-container">
                                            {% if protocol and protocol.habilidades %}
                                                {% for habilidade in protocol.habilidades %}
                                                <tr class="dynamic-field-item">
                                                    <td data-label="Ordem">
                                                        <input type="number" value="{{ habilidade.ordem }}" readonly>
                                                        <input type="hidden" name="habilidade_ordem[]" value="{{ habilidade.ordem }}">
                                                    </td>
                                                    <td data-label="Habilidade">
                                                        <input type="text" value="{{ habilidade.nome }}" readonly>
                                                        <input type="hidden" name="habilidade_nome[]" value="{{ habilidade.nome }}">
                                                    </td>
                                                    <td class="dynamic-field-item-actions">
                                                        <button type="button" onclick="removeDynamicField(this)" class="btn btn-danger btn-sm">Remover</button>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            {% else %}
                                                <tr class="no-results-row">
                                                    <td colspan="3">Nenhuma habilidade cadastrada.</td>
                                                </tr>
                                            {% endif %}
                                        </tbody>
                                    </table>
                                </div>
                                <div class="protocol-actions">
                                    <button type="button" class="btn btn-secondary steps-prev"><i class="fa fa-chevron-left"></i> Voltar</button>
                                    <button type="button" class="btn btn-primary steps-next">Próximo <i class="fa fa-chevron-right"></i></button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Step 5: Pontuação -->
                        <div class="protocol-card-section" data-step-content="5" style="display:none;">
                            <div class="protocol-card-container-form">
                                <div class="section-header-with-button">
                                    <h3 class="section-title"><i class="fa-solid fa-star-half-alt"></i> Pontuação</h3>
                                    <button type="button" onclick="openAddItemModal('pontuacao')" class="btn btn-primary btn-sm">
                                        <i class="fas fa-plus"></i> Adicionar Pontuação
                                    </button>
                                </div>
                                <div class="table-container">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Ordem</th>
                                                <th>Tipo</th>
                                                <th>Descrição</th>
                                                <th>Valor</th>
                                                <th style="width: 100px;">Ações</th>
                                            </tr>
                                        </thead>
                                        <tbody id="pontuacoes-container">
                                            {% if protocol and protocol.pontuacao %}
                                                {% for item in protocol.pontuacao %}
                                                <tr class="dynamic-field-item">
                                                    <td data-label="Ordem">
                                                        <input type="number" value="{{ item.ordem }}" readonly>
                                                        <input type="hidden" name="pontuacao_ordem[]" value="{{ item.ordem }}">
                                                    </td>
                                                    <td data-label="Tipo">
                                                        <input type="text" value="{{ item.tipo }}" readonly>
                                                        <input type="hidden" name="pontuacao_tipo[]" value="{{ item.tipo }}">
                                                    </td>
                                                    <td data-label="Descrição">
                                                        <input type="text" value="{{ item.descricao }}" readonly>
                                                        <input type="hidden" name="pontuacao_descricao[]" value="{{ item.descricao }}">
                                                    </td>
                                                    <td data-label="Valor">
                                                        <input type="number" step="0.1" value="{{ item.valor }}" readonly>
                                                        <input type="hidden" name="pontuacao_valor[]" value="{{ item.valor }}">
                                                    </td>
                                                    <td class="dynamic-field-item-actions">
                                                        <button type="button" onclick="removeDynamicField(this)" class="btn btn-danger btn-sm">Remover</button>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            {% else %}
                                                <tr class="no-results-row">
                                                    <td colspan="5">Nenhuma pontuação cadastrada.</td>
                                                </tr>
                                            {% endif %}
                                        </tbody>
                                    </table>
                                </div>
                                <div class="protocol-actions">
                                    <button type="button" class="btn btn-secondary steps-prev"><i class="fa fa-chevron-left"></i> Voltar</button>
                                    <button type="button" class="btn btn-primary steps-next">Próximo <i class="fa fa-chevron-right"></i></button>
                                </div>
                            </div>
                        </div>

                        <!-- Step 6: Tarefas -->
                        <div class="protocol-card-section" data-step-content="6" style="display:none;">
                            <div class="protocol-card-container-form">
                                <div class="section-header-with-button">
                                    <h3 class="section-title"><i class="fa-solid fa-tasks"></i> Tarefas/Testes</h3>
                                    <button type="button" onclick="openAddItemModal('tarefa')" class="btn btn-primary btn-sm">
                                        <i class="fas fa-plus"></i> Adicionar Tarefa/Teste
                                    </button>
                                </div>
                                <div class="table-container">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Nível</th>
                                                <th>Ordem</th>
                                                <th>Item</th>
                                                <th>Nome</th>
                                                <th>Habilidade/Marco</th>
                                                <th>Resultado/Observação</th>
                                                <th>Pergunta</th>
                                                <th>Exemplo</th>
                                                <th>Critério</th>
                                                <th>Objetivo</th>
                                                <th style="width: 100px;">Ações</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tarefas-container">
                                            {% if protocol and protocol.tarefas_testes %}
                                                {% for tarefa in protocol.tarefas_testes %}
                                                <tr class="dynamic-field-item">
                                                    <td data-label="Nível">
                                                        <input type="number" value="{{ tarefa.nivel }}" readonly>
                                                        <input type="hidden" name="tarefa_nivel[]" value="{{ tarefa.nivel }}">
                                                    </td>
                                                    <td data-label="Ordem">
                                                        <input type="number" value="{{ tarefa.ordem }}" readonly>
                                                        <input type="hidden" name="tarefa_ordem[]" value="{{ tarefa.ordem }}">
                                                    </td>
                                                    <td data-label="Item">
                                                        <input type="text" value="{{ tarefa.item }}" readonly>
                                                        <input type="hidden" name="tarefa_item[]" value="{{ tarefa.item }}">
                                                    </td>
                                                    <td data-label="Nome">
                                                        <input type="text" value="{{ tarefa.nome }}" readonly>
                                                        <input type="hidden" name="tarefa_nome[]" value="{{ tarefa.nome }}">
                                                    </td>
                                                    <td data-label="Habilidade/Marco">
                                                        <input type="text" value="{{ tarefa.habilidade_marco }}" readonly>
                                                        <input type="hidden" name="tarefa_habilidade_marco[]" value="{{ tarefa.habilidade_marco }}">
                                                    </td>
                                                    <td data-label="Resultado/Observação">
                                                        <textarea rows="1" readonly>{{ tarefa.resultado_observacao }}</textarea>
                                                        <input type="hidden" name="tarefa_resultado_observacao[]" value="{{ tarefa.resultado_observacao }}">
                                                    </td>
                                                    <td data-label="Pergunta">
                                                        <textarea rows="1" readonly>{{ tarefa.pergunta if tarefa.pergunta else '' }}</textarea>
                                                        <input type="hidden" name="tarefa_pergunta[]" value="{{ tarefa.pergunta if tarefa.pergunta else '' }}">
                                                    </td>
                                                    <td data-label="Exemplo">
                                                        <textarea rows="1" readonly>{{ tarefa.exemplo if tarefa.exemplo else '' }}</textarea>
                                                        <input type="hidden" name="tarefa_exemplo[]" value="{{ tarefa.exemplo if tarefa.exemplo else '' }}">
                                                    </td>
                                                    <td data-label="Critério">
                                                        <textarea rows="1" readonly>{{ tarefa.criterio if tarefa.criterio else '' }}</textarea>
                                                        <input type="hidden" name="tarefa_criterio[]" value="{{ tarefa.criterio if tarefa.criterio else '' }}">
                                                    </td>
                                                    <td data-label="Objetivo">
                                                        <textarea rows="1" readonly>{{ tarefa.objetivo if tarefa.objetivo else '' }}</textarea>
                                                        <input type="hidden" name="tarefa_objetivo[]" value="{{ tarefa.objetivo if tarefa.objetivo else '' }}">
                                                    </td>
                                                    <td class="dynamic-field-item-actions">
                                                        <button type="button" onclick="removeDynamicField(this)" class="btn btn-danger btn-sm">Remover</button>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            {% else %}
                                                <tr class="no-results-row">
                                                    <td colspan="11">Nenhuma tarefa/teste cadastrado.</td>
                                                </tr>
                                            {% endif %}
                                        </tbody>
                                    </table>
                                </div>
                                <div class="protocol-actions">
                                    <button type="button" class="btn btn-secondary steps-prev"><i class="fa fa-chevron-left"></i> Voltar</button>
                                    <button type="button" class="btn btn-primary steps-next">Próximo <i class="fa fa-chevron-right"></i></button>
                                </div>
                            </div>
                        </div>

                        <!-- Step 7: Observações -->
                        <div class="protocol-card-section" data-step-content="7" style="display:none;">
                            <div class="protocol-card-container-form">
                                <div class="section-content">
                                    <h3 class="section-title"><i class="fa-solid fa-comment-dots"></i> Observações</h3>
                                    <div class="protocol-card-fields">
                                        <div class="protocol-field">
                                            <label for="observacoes_gerais">Observações Gerais:</label>
                                            <textarea id="observacoes_gerais" name="observacoes_gerais" rows="8">{{ protocol.observacoes_gerais if protocol else '' }}</textarea>
                                        </div>
                                    </div>
                                </div>
                                <div class="protocol-actions">
                                    <button type="button" class="btn btn-secondary steps-prev"><i class="fa fa-chevron-left"></i> Voltar</button>
                                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Salvar Protocolo</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </main>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const protocolForm = document.getElementById('protocol-form');
        const steps = document.querySelectorAll('.protocol-step');
        const sections = document.querySelectorAll('.protocol-card-section');
        const nextBtns = document.querySelectorAll('.steps-next');
        const prevBtns = document.querySelectorAll('.steps-prev');

        let currentStepIndex = 0;

        // --- Lógica para Notificações Toast ---
        const toastContainer = document.getElementById('toast-container');
        function showToast(message, category = 'info') {
            if (!toastContainer) return;
            const toast = document.createElement('div');
            toast.className = `toast ${category}`;
            let iconClass = 'fa-solid fa-circle-info';
            let title = 'Informação';
            if (category === 'success') { iconClass = 'fa-solid fa-check-circle'; title = 'Sucesso'; }
            if (category === 'danger') { iconClass = 'fa-solid fa-times-circle'; title = 'Erro'; }
            if (category === 'warning') { iconClass = 'fa-solid fa-exclamation-triangle'; title = 'Atenção'; }
            toast.innerHTML = `
                <div class="toast-icon"><i class="${iconClass}"></i></div>
                <div class="toast-content">
                    <strong class="toast-title">${title}</strong>
                    <span class="toast-message">${message}</span>
                </div>
                <button class="toast-close">&times;</button>`;
            toast.querySelector('.toast-close').addEventListener('click', () => toast.remove());
            toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }

        // Processa mensagens flash do backend
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% for category, message in messages %}
                showToast("{{ message }}", "{{ category }}");
            {% endfor %}
        {% endwith %}

        // --- Lógica para Modal de Alerta Geral ---
        const generalAlertOverlay = document.getElementById('general-alert-modal-overlay');
        function showGeneralAlertModal(title, message, category = 'info') {
            const alertModalIcon = document.getElementById('alert-modal-icon');
            document.getElementById('alert-modal-title').textContent = title;
            document.getElementById('alert-modal-message').textContent = message;
            alertModalIcon.className = 'alert-modal-icon ' + category;
            let iconClass = '';
            switch (category) {
                case 'info': iconClass = 'fas fa-info-circle'; break;
                case 'success': iconClass = 'fas fa-check-circle'; break;
                case 'warning': iconClass = 'fas fa-exclamation-triangle'; break;
                case 'danger': iconClass = 'fas fa-times-circle'; break;
            }
            alertModalIcon.innerHTML = `<i class="${iconClass}"></i>`;
            if(generalAlertOverlay) generalAlertOverlay.classList.add('show');
        }
        function closeGeneralAlertModal() {
            if(generalAlertOverlay) generalAlertOverlay.classList.remove('show');
        }
        const alertModalCloseBtn = document.getElementById('alert-modal-close-btn');
        if(alertModalCloseBtn) alertModalCloseBtn.addEventListener('click', closeGeneralAlertModal);
        
        if(generalAlertOverlay) generalAlertOverlay.addEventListener('click', (e) => {
            if (e.target === generalAlertOverlay) closeGeneralAlertModal();
        });

        // --- Lógica para Modal de Adição de Itens ---
        const addItemModalOverlay = document.getElementById('add-item-modal-overlay');
        const addItemModalTitle = document.getElementById('add-item-modal-title');
        const addItemModalBody = document.getElementById('add-item-modal-body');
        let currentAddItemType = '';

        window.openAddItemModal = function(type) {
            currentAddItemType = type;
            addItemModalBody.innerHTML = '';
            let fieldsHtml = '';
            let titleText = '';

            switch (type) {
                case 'etapa':
                    titleText = 'Adicionar Etapa';
                    fieldsHtml = `<div class="protocol-field required"><label for="modal_etapa_nome">Nome da Etapa:</label><input type="text" id="modal_etapa_nome" required></div>
                                  <div class="protocol-field"><label for="modal_etapa_descricao">Descrição:</label><textarea id="modal_etapa_descricao" rows="3"></textarea></div>`;
                    break;
                case 'nivel':
                    titleText = 'Adicionar Nível';
                    fieldsHtml = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                      <div class="protocol-field required"><label for="modal_nivel_ordem">Ordem:</label><input type="number" id="modal_nivel_ordem" required></div>
                                      <div class="protocol-field required"><label for="modal_nivel_valor">Nível:</label><input type="number" id="modal_nivel_valor" required></div>
                                  </div>
                                  <div class="protocol-field"><label for="modal_nivel_faixa_etaria">Faixa Etária:</label><input type="text" id="modal_nivel_faixa_etaria"></div>`;
                    break;
                case 'habilidade':
                    titleText = 'Adicionar Habilidade';
                    fieldsHtml = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                      <div class="protocol-field required"><label for="modal_habilidade_ordem">Ordem:</label><input type="number" id="modal_habilidade_ordem" required></div>
                                      <div class="protocol-field required"><label for="modal_habilidade_nome">Habilidade:</label><input type="text" id="modal_habilidade_nome" required></div>
                                  </div>`;
                    break;
                case 'pontuacao':
                    titleText = 'Adicionar Pontuação';
                    fieldsHtml = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                      <div class="protocol-field required"><label for="modal_pontuacao_ordem">Ordem:</label><input type="number" id="modal_pontuacao_ordem" required></div>
                                      <div class="protocol-field required"><label for="modal_pontuacao_tipo">Tipo:</label><input type="text" id="modal_pontuacao_tipo" required></div>
                                  </div>
                                  <div class="protocol-field"><label for="modal_pontuacao_descricao">Descrição:</label><input type="text" id="modal_pontuacao_descricao"></div>
                                  <div class="protocol-field required"><label for="modal_pontuacao_valor">Valor:</label><input type="number" step="0.1" id="modal_pontuacao_valor" required></div>`;
                    break;
                case 'tarefa':
                    titleText = 'Adicionar Tarefa/Teste';
                    // Get existing habilidades and niveis from the current form
                    const existingHabilidades = Array.from(document.querySelectorAll('#habilidades-container input[name="habilidade_nome[]"]')).map(input => input.value);
                    const existingNiveis = Array.from(document.querySelectorAll('#niveis-container input[name="nivel_valor[]"]')).map(input => input.value);

                    let habilidadesOptions = '<option value="">Selecione uma Habilidade</option>';
                    existingHabilidades.forEach(h => {
                        habilidadesOptions += `<option value="${h}">${h}</option>`;
                    });

                    let niveisOptions = '<option value="">Selecione um Nível</option>';
                    existingNiveis.forEach(n => {
                        niveisOptions += `<option value="${n}">${n}</option>`;
                    });

                    fieldsHtml = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                      <div class="protocol-field required"><label for="modal_tarefa_nivel">Nível:</label><select id="modal_tarefa_nivel" required>${niveisOptions}</select></div>
                                      <div class="protocol-field required"><label for="modal_tarefa_ordem">Ordem:</label><input type="number" id="modal_tarefa_ordem" required></div>
                                      <div class="protocol-field"><label for="modal_tarefa_item">Item:</label><input type="text" id="modal_tarefa_item"></div>
                                      <div class="protocol-field required col-span-full"><label for="modal_tarefa_nome">Nome da Tarefa:</label><input type="text" id="modal_tarefa_nome" required></div>
                                      <div class="protocol-field col-span-full md:col-span-1"><label for="modal_tarefa_habilidade_marco">Habilidade/Marco:</label><select id="modal_tarefa_habilidade_marco">${habilidadesOptions}</select></div>
                                      <div class="protocol-field col-span-full md:col-span-1"><label for="modal_tarefa_resultado_observacao">Resultado/Observação:</label><textarea rows="3" id="modal_tarefa_resultado_observacao"></textarea></div>
                                      <div class="protocol-field col-span-full"><label for="modal_tarefa_pergunta">Pergunta:</label><textarea rows="3" id="modal_tarefa_pergunta"></textarea></div>
                                      <div class="protocol-field col-span-full"><label for="modal_tarefa_exemplo">Exemplo:</label><textarea rows="3" id="modal_tarefa_exemplo"></textarea></div>
                                      <div class="protocol-field col-span-full"><label for="modal_tarefa_criterio">Critério:</label><textarea rows="3" id="modal_tarefa_criterio"></textarea></div>
                                      <div class="protocol-field col-span-full"><label for="modal_tarefa_objetivo">Objetivo:</label><textarea rows="3" id="modal_tarefa_objetivo"></textarea></div>
                                  </div>`;
                    break;
            }

            addItemModalTitle.textContent = titleText;
            addItemModalBody.innerHTML = fieldsHtml;
            addItemModalOverlay.classList.add('show');
        }
        
        const addItemModalSaveBtn = document.getElementById('add-item-modal-save-btn');
        if (addItemModalSaveBtn) {
            addItemModalSaveBtn.addEventListener('click', function() {
                console.log('Botão Adicionar clicado no modal.'); // Debug
                const requiredFields = addItemModalBody.querySelectorAll('[required]');
                let allValid = true;
                requiredFields.forEach(field => {
                    if (!field.value.trim()) {
                        allValid = false;
                        field.classList.add('invalid');
                    } else {
                        field.classList.remove('invalid');
                    }
                });

                if (allValid) {
                    console.log('Todos os campos obrigatórios do modal preenchidos. Salvando dados...'); // Debug
                    saveModalData(currentAddItemType);
                    addItemModalOverlay.classList.remove('show');
                } else {
                    console.log('Campos obrigatórios do modal faltando.'); // Debug
                    showToast('Preencha todos os campos obrigatórios.', 'danger');
                }
            });
        }
        
        function saveModalData(type) {
            let containerId;
            if (type === 'nivel') {
                containerId = 'niveis-container'; // Correção para o ID do container de níveis
            } else if (type === 'pontuacao') {
                containerId = 'pontuacoes-container';
            } else {
                containerId = `${type}s-container`;
            }
            
            let container = document.getElementById(containerId);
            console.log(`saveModalData acionada para o tipo: ${type}`); // Debug
            console.log('Container alvo (ID):', containerId); // Debug
            console.log('Container alvo (Elemento):', container); // Debug

            if (!container) {
                console.error(`Container não encontrado para o tipo: ${type}. ID esperado: ${containerId}`); // Debug
                return;
            }
            
            let newFieldHtml = '';
            let values = {};
            
            // Lógica para obter valores do modal e construir a nova linha da tabela
            if (type === 'etapa') {
                values.nome = document.getElementById('modal_etapa_nome').value;
                values.descricao = document.getElementById('modal_etapa_descricao').value;
                newFieldHtml = `
                    <tr class="dynamic-field-item">
                        <td data-label="Nome da Etapa">
                            <input type="text" value="${values.nome}" readonly>
                            <input type="hidden" name="etapa_nome[]" value="${values.nome}">
                        </td>
                        <td data-label="Descrição">
                            <textarea rows="1" readonly>${values.descricao}</textarea>
                            <input type="hidden" name="etapa_descricao[]" value="${values.descricao}">
                        </td>
                        <td class="dynamic-field-item-actions">
                            <button type="button" onclick="removeDynamicField(this)" class="btn btn-danger btn-sm">Remover</button>
                        </td>
                    </tr>`;
            } else if (type === 'nivel') {
                values.ordem = document.getElementById('modal_nivel_ordem').value;
                values.nivel = document.getElementById('modal_nivel_valor').value;
                values.faixa_etaria = document.getElementById('modal_nivel_faixa_etaria').value;
                newFieldHtml = `
                    <tr class="dynamic-field-item">
                        <td data-label="Ordem">
                            <input type="number" value="${values.ordem}" readonly>
                            <input type="hidden" name="nivel_ordem[]" value="${values.ordem}">
                        </td>
                        <td data-label="Nível">
                            <input type="number" value="${values.nivel}" readonly>
                            <input type="hidden" name="nivel_valor[]" value="${values.nivel}">
                        </td>
                        <td data-label="Faixa Etária">
                            <input type="text" value="${values.faixa_etaria}" readonly>
                            <input type="hidden" name="nivel_faixa_etaria[]" value="${values.faixa_etaria}">
                        </td>
                        <td class="dynamic-field-item-actions">
                            <button type="button" onclick="removeDynamicField(this)" class="btn btn-danger btn-sm">Remover</button>
                        </td>
                    </tr>`;
            } else if (type === 'habilidade') {
                values.ordem = document.getElementById('modal_habilidade_ordem').value;
                values.nome = document.getElementById('modal_habilidade_nome').value;
                newFieldHtml = `
                    <tr class="dynamic-field-item">
                        <td data-label="Ordem">
                            <input type="number" value="${values.ordem}" readonly>
                            <input type="hidden" name="habilidade_ordem[]" value="${values.ordem}">
                        </td>
                        <td data-label="Habilidade">
                            <input type="text" value="${values.nome}" readonly>
                            <input type="hidden" name="habilidade_nome[]" value="${values.nome}">
                        </td>
                        <td class="dynamic-field-item-actions">
                            <button type="button" onclick="removeDynamicField(this)" class="btn btn-danger btn-sm">Remover</button>
                        </td>
                    </tr>`;
            } else if (type === 'pontuacao') {
                values.ordem = document.getElementById('modal_pontuacao_ordem').value;
                values.tipo = document.getElementById('modal_pontuacao_tipo').value;
                values.descricao = document.getElementById('modal_pontuacao_descricao').value;
                values.valor = document.getElementById('modal_pontuacao_valor').value;
                newFieldHtml = `
                    <tr class="dynamic-field-item">
                        <td data-label="Ordem">
                            <input type="number" value="${values.ordem}" readonly>
                            <input type="hidden" name="pontuacao_ordem[]" value="${values.ordem}">
                        </td>
                        <td data-label="Tipo">
                            <input type="text" value="${values.tipo}" readonly>
                            <input type="hidden" name="pontuacao_tipo[]" value="${values.tipo}">
                        </td>
                        <td data-label="Descrição">
                            <input type="text" value="${values.descricao}" readonly>
                            <input type="hidden" name="pontuacao_descricao[]" value="${values.descricao}">
                        </td>
                        <td data-label="Valor">
                            <input type="number" step="0.1" value="${values.valor}" readonly>
                            <input type="hidden" name="pontuacao_valor[]" value="${values.valor}">
                        </td>
                        <td class="dynamic-field-item-actions">
                            <button type="button" onclick="removeDynamicField(this)" class="btn btn-danger btn-sm">Remover</button>
                        </td>
                    </tr>`;
            } else if (type === 'tarefa') {
                values.nivel = document.getElementById('modal_tarefa_nivel').value;
                values.ordem = document.getElementById('modal_tarefa_ordem').value;
                values.item = document.getElementById('modal_tarefa_item').value;
                values.nome = document.getElementById('modal_tarefa_nome').value;
                values.habilidade_marco = document.getElementById('modal_tarefa_habilidade_marco').value; 
                values.resultado_observacao = document.getElementById('modal_tarefa_resultado_observacao').value;
                values.pergunta = document.getElementById('modal_tarefa_pergunta').value;
                values.exemplo = document.getElementById('modal_tarefa_exemplo').value;
                values.criterio = document.getElementById('modal_tarefa_criterio').value;
                values.objetivo = document.getElementById('modal_tarefa_objetivo').value;
                
                newFieldHtml = `
                    <tr class="dynamic-field-item">
                        <td data-label="Nível">
                            <input type="number" value="${values.nivel}" readonly>
                            <input type="hidden" name="tarefa_nivel[]" value="${values.nivel}">
                        </td>
                        <td data-label="Ordem">
                            <input type="number" value="${values.ordem}" readonly>
                            <input type="hidden" name="tarefa_ordem[]" value="${values.ordem}">
                        </td>
                        <td data-label="Item">
                            <input type="text" value="${values.item}" readonly>
                            <input type="hidden" name="tarefa_item[]" value="${values.item}">
                        </td>
                        <td data-label="Nome">
                            <input type="text" value="${values.nome}" readonly>
                            <input type="hidden" name="tarefa_nome[]" value="${values.nome}">
                        </td>
                        <td data-label="Habilidade/Marco">
                            <input type="text" value="${values.habilidade_marco}" readonly>
                            <input type="hidden" name="tarefa_habilidade_marco[]" value="${values.habilidade_marco}">
                        </td>
                        <td data-label="Resultado/Observação">
                            <textarea rows="1" readonly>${values.resultado_observacao}</textarea>
                            <input type="hidden" name="tarefa_resultado_observacao[]" value="${values.resultado_observacao}">
                        </td>
                        <td data-label="Pergunta">
                            <textarea rows="1" readonly>${values.pergunta}</textarea>
                            <input type="hidden" name="tarefa_pergunta[]" value="${values.pergunta}">
                        </td>
                        <td data-label="Exemplo">
                            <textarea rows="1" readonly>${values.exemplo}</textarea>
                            <input type="hidden" name="tarefa_exemplo[]" value="${values.exemplo}">
                        </td>
                        <td data-label="Critério">
                            <textarea rows="1" readonly>${values.criterio}</textarea>
                            <input type="hidden" name="tarefa_criterio[]" value="${values.criterio}">
                        </td>
                        <td data-label="Objetivo">
                            <textarea rows="1" readonly>${values.objetivo}</textarea>
                            <input type="hidden" name="tarefa_objetivo[]" value="${values.objetivo}">
                        </td>
                        <td class="dynamic-field-item-actions">
                            <button type="button" onclick="removeDynamicField(this)" class="btn btn-danger btn-sm">Remover</button>
                        </td>
                    </tr>`;
            }

            console.log('Valores capturados:', values); // Debug
            console.log('HTML da nova linha:', newFieldHtml); // Debug

            // Remove a linha "Nenhum item encontrado" se ela existir
            const noResultsRow = container.querySelector('.no-results-row');
            if (noResultsRow) {
                console.log('Removendo linha "Nenhum item cadastrado."'); // Debug
                noResultsRow.remove();
            }
            container.insertAdjacentHTML('beforeend', newFieldHtml);
            console.log('Nova linha adicionada ao container.'); // Debug
        }
        
        window.removeDynamicField = function(button) {
            const rowToRemove = button.closest('.dynamic-field-item');
            const container = rowToRemove.closest('tbody');
            rowToRemove.remove();

            // Se não houver mais linhas, adiciona a mensagem "Nenhum item encontrado"
            if (container && container.children.length === 0) {
                const colspan = container.closest('table').querySelector('thead tr').children.length;
                container.insertAdjacentHTML('beforeend', `<tr class="no-results-row"><td colspan="${colspan}">Nenhum item cadastrado.</td></tr>`);
            }
        }

        const addItemModalCloseBtn = document.getElementById('add-item-modal-close-btn');
        if(addItemModalCloseBtn) addItemModalCloseBtn.addEventListener('click', () => addItemModalOverlay.classList.remove('show'));
        
        const addItemModalCancelBtn = document.getElementById('add-item-modal-cancel-btn');
        if(addItemModalCancelBtn) addItemModalCancelBtn.addEventListener('click', () => addItemModalOverlay.classList.remove('show'));

        // --- Lógica de Navegação por Steps ---
        function showStep(index) {
            steps.forEach((step, i) => step.classList.toggle('active', i === index));
            sections.forEach((section, i) => section.style.display = i === index ? 'flex' : 'none');
            currentStepIndex = index;
        }

        steps.forEach((step, i) => {
            step.addEventListener('click', () => showStep(i));
        });

        nextBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                if (validateCurrentStep()) {
                    showStep(Math.min(currentStepIndex + 1, sections.length - 1));
                } else {
                    showGeneralAlertModal('Campos Obrigatórios', 'Por favor, preencha todos os campos marcados com * nesta seção.', 'danger');
                }
            });
        });

        prevBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                showStep(Math.max(currentStepIndex - 1, 0));
            });
        });
        
        // --- Lógica de Validação ---
        function validateField(field) {
            let isValid = true;
            if (field.type === 'radio') {
                isValid = protocolForm.querySelector(`input[name="${field.name}"]:checked`);
            } else {
                isValid = field.value.trim() !== '';
            }
            field.classList.toggle('invalid', !isValid);
            return isValid;
        }

        function validateCurrentStep() {
            let allValid = true;
            const currentSection = sections[currentStepIndex];
            steps[currentStepIndex].classList.remove('has-error');
            currentSection.querySelectorAll('[required]:not([type=hidden])').forEach(field => {
                if (!validateField(field)) {
                    allValid = false;
                    field.classList.add('shake');
                    setTimeout(() => field.classList.remove('shake'), 500);
                }
            });
            if (!allValid) steps[currentStepIndex].classList.add('has-error');
            return allValid;
        }

        protocolForm.addEventListener('submit', function(event) {
            let allFormFieldsValid = true;
            let firstInvalidStep = -1;

            steps.forEach((step, index) => {
                let stepIsValid = true;
                sections[index].querySelectorAll('[required]:not([type=hidden])').forEach(field => {
                    if (!validateField(field)) {
                        stepIsValid = false;
                        allFormFieldsValid = false;
                    }
                });
                step.classList.toggle('has-error', !stepIsValid);
                if (!stepIsValid && firstInvalidStep === -1) {
                    firstInvalidStep = index;
                }
            });

            if (!allFormFieldsValid) {
                event.preventDefault();
                showGeneralAlertModal('Erro de Validação', 'Por favor, corrija os campos inválidos em todas as seções.', 'danger');
                if (firstInvalidStep !== -1) {
                    showStep(firstInvalidStep);
                }
            }
        });
        
        // Inicializa a página
        showStep(0);
    });
    </script>
</body>
</html>
