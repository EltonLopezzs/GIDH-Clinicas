<!DOCTYPE html>
<html lang="pt-br" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ 'Editar' if protocol else 'Novo' }} Protocolo - {{ session.clinica_nome_display or 'Clínica On' }}</title>

    <link rel="icon" type="image/png" href="https://placehold.co/40x40/0d9488/ffffff?text=C">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}"> 
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    
    <style>
        /* Estilos Globais e Variáveis de Tema */
        :root {
            --bg: #f1f5f9;       /* Gray-100 */
            --card: #ffffff;     /* White */
            --text: #0f172a;     /* Gray-900 */
            --muted: #64748b;    /* Gray-500 */
            --accent: #9b53b8;   /* Custom Purple */
            --primary-dark: #115e59;
            --primary: #5587c2;  /* Custom Blue */
            --primary-light: #e0eaf7; /* Lighter Blue */
            --secondary: #f59e0b; /* Yellow-500 */
            --danger: #dc2626;   /* Red-600 */
            --success: #16a34a;  /* Green-600 */
            --warning: #f59e0b;  /* Yellow-500 */
            --info: #0ea5e9;     /* Sky-500 */
            --border-color: #e2e8f0; /* Gray-200 */
            color-scheme: light;
        }

        [data-theme="dark"] {
            --bg: #0f172a;       /* Gray-900 */
            --card: #1e293b;     /* Gray-800 */
            --text: #f1f5f9;     /* Gray-100 */
            --muted: #94a3b8;    /* Gray-400 */
            --border-color: #334155; /* Gray-600 */
            --primary: #60a5fa;  /* Blue-400 */
            --primary-light: #1e293b; /* Gray-800 */
            color-scheme: dark;
        }

        /* Reset e Estilos Base */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Barra de Rolagem */
        ::-webkit-scrollbar { background-color: var(--bg); width: 0.5rem; height: 0.5rem; }
        ::-webkit-scrollbar-thumb { background-color: var(--muted); border-radius: 0.3rem; }
        ::-webkit-scrollbar-thumb:hover { background-color: var(--primary); }

        /* Layout Principal */
        .layout { display: flex; min-height: 100vh; width: 100%; }

        /* --- Conteúdo Principal & Topbar --- */
        .main-content {
            flex: 1; margin-left: 260px;
            transition: margin-left 0.3s ease, width 0.3s ease;
            width: calc(100% - 260px);
        }
        .main-content.collapsed { margin-left: 88px; width: calc(100% - 88px); }
        .topbar {
            background-color: var(--card); color: var(--text); padding: 0 1.5rem;
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid var(--border-color); height: 70px; flex-shrink: 0;
            position: sticky; top: 0; z-index: 900;
        }
        .topbar-left { display: flex; align-items: center; gap: 1rem; }
        .topbar .page-title { font-weight: 600; font-size: 1.25rem; color: var(--text); }
        .toggle-btn {
            background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--muted);
            width: 40px; height: 40px; border-radius: 50%; display: grid; place-items: center;
            transition: background 0.2s ease, color 0.2s ease;
        }
        .toggle-btn:hover { background-color: var(--bg); color: var(--primary); }
        .topbar-actions { display: flex; gap: 0.75rem; align-items: center; }
        
        main { 
            flex-grow: 1; 
            padding: 1.5rem; 
            overflow-y: auto; 
            max-width: 100%; /* Removido o max-width fixo para ser auto-ajustável */
            margin: 0 auto; /* Centraliza o conteúdo principal */
        }

        /* --- Botões --- */
        .btn {
            padding: 0.6rem 1.2rem; font-size: 0.9rem; border-radius: 8px; text-decoration: none;
            font-weight: 600; display: inline-flex; align-items: center; justify-content: center;
            gap: 0.5rem; border: 1px solid transparent; cursor: pointer; transition: all 0.2s ease-in-out;
        }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.85rem; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: var(--accent); }
        .btn-secondary { background-color: var(--muted); color: white; }
        .btn-secondary:hover { background-color: var(--text); }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-danger:hover { background-color: #b91c1c; }

        /* --- Estilos do Formulário --- */
        .form-card {
            background: var(--card);
            border-radius: 18px;
            box-shadow: 0 10px 32px rgba(0,0,0,0.08);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            /* Removido min-height para evitar espaço em branco excessivo */
        }
        .protocol-steps {
            display: flex;
            width: 100%;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
        }
        .protocol-step {
            flex: 1;
            padding: 18px 10px 14px 10px;
            font-weight: 600;
            font-size: 1rem;
            color: var(--muted);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            background: none;
            transition: all 0.2s;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            min-width: 150px;
        }
        .protocol-step.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: color-mix(in srgb, var(--primary) 10%, transparent);
        }
        .protocol-step i { font-size: 1.1rem; }

        .protocol-card-section {
            padding: 2.5rem 2rem 2rem 2rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .protocol-card-container-form {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            flex-grow: 1;
        }
        .section-content { flex-grow: 1; }
        .section-title {
            font-size: 1.3rem; font-weight: 700; color: var(--primary);
            margin-bottom: 1.5rem; display: flex; align-items: center; gap: 1rem;
        }
        /* New style to align title and button */
        .section-header-with-button {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .section-header-with-button .section-title {
            margin-bottom: 0; /* Remove margin from title when in header */
        }


        .protocol-card-fields {
            display: grid;
            gap: 1.2rem 2rem;
        }
        .protocol-card-fields.grid-2-cols { grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
        .protocol-field { display: flex; flex-direction: column; gap: 0.5rem; }
        .protocol-field label {
            font-size: 1rem; color: var(--muted); font-weight: 600;
        }
        /* Estilos para inputs, selects e textareas com borda quadrada */
        .protocol-field input, .protocol-field select, .protocol-field textarea {
            background: transparent;
            border: 1px solid var(--border-color); /* Borda sólida */
            border-radius: 8px; /* Cantos arredondados */
            font-size: 1rem;
            padding: 0.75rem 1rem; /* Aumenta o padding para melhor visual */
            color: var(--text);
            transition: all 0.2s;
            outline: none;
            width: 100%;
        }
        .protocol-field input:focus, .protocol-field select:focus, .protocol-field textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px color-mix(in srgb, var(--primary) 30%, transparent); /* Adiciona um brilho ao focar */
        }
        .protocol-field textarea { min-height: 80px; resize: vertical; }

        /* Ajuste para alinhamento de radio/checkbox */
        .protocol-field label.inline-flex {
            align-items: center; /* Garante alinhamento vertical do input e texto */
        }
        .protocol-field input[type="radio"],
        .protocol-field input[type="checkbox"] {
            /* Oculta o input nativo */
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            position: relative;
            width: 1.25rem; /* h-5 */
            height: 1.25rem; /* w-5 */
            border: 2px solid var(--muted);
            border-radius: 0.25rem; /* rounded */
            cursor: pointer;
            flex-shrink: 0; /* Evita que o input encolha */
            transition: all 0.2s ease;
        }

        /* Estilo para Radio Buttons */
        .protocol-field input[type="radio"] {
            border-radius: 50%; /* Transforma em círculo */
        }
        .protocol-field input[type="radio"]:checked {
            background-color: var(--primary);
            border-color: var(--primary);
        }
        .protocol-field input[type="radio"]:checked::before {
            content: '';
            display: block;
            width: 0.6rem; /* Tamanho do ponto central */
            height: 0.6rem; /* Tamanho do ponto central */
            background-color: var(--card); /* Cor do ponto central */
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* Estilo para Checkboxes */
        .protocol-field input[type="checkbox"]:checked {
            background-color: var(--primary);
            border-color: var(--primary);
        }
        .protocol-field input[type="checkbox"]:checked::before {
            content: '\f00c'; /* Unicode para o ícone de check (Font Awesome) */
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            font-size: 0.75rem;
            color: var(--card);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* Estilo de Foco para ambos */
        .protocol-field input[type="radio"]:focus,
        .protocol-field input[type="checkbox"]:focus {
            outline: none;
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary) 30%, transparent); /* Anel de foco */
        }


        .protocol-actions {
            display: flex; justify-content: space-between; gap: 1rem; margin-top: 2rem;
            padding-top: 1.5rem; border-top: 1px solid var(--border-color);
        }
        .protocol-actions.justify-end { justify-content: flex-end; }

        /* --- Validação de Campos --- */
        .protocol-field.required label::after { content: ' *'; color: var(--danger); }
        .protocol-field input.invalid, .protocol-field select.invalid, .protocol-field textarea.invalid {
            border-color: var(--danger) !important; /* Muda a cor da borda */
            background-color: color-mix(in srgb, var(--danger) 10%, transparent);
        }
        @keyframes shake {
            10%, 90% { transform: translateX(-1px); }
            20%, 80% { transform: translateX(2px); }
            30%, 50%, 70% { transform: translateX(-4px); }
            40%, 60% { transform: translateX(4px); }
        }
        .shake { animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both; }
        .protocol-step.has-error {
            color: var(--danger) !important;
            border-bottom-color: var(--danger) !important;
            background: color-mix(in srgb, var(--danger) 10%, transparent);
        }
        .protocol-step.has-error::after { content: '⚠️'; margin-left: 5px; font-size: 0.9rem; }

        /* --- Estilos da Tabela para Itens Dinâmicos --- */
        .table-container {
            width: 100%;
            overflow-x: auto; /* Permite rolagem horizontal em telas pequenas */
            background: var(--card);
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        .table-container table {
            width: 100%;
            border-collapse: separate; /* Permite border-radius nas células */
            border-spacing: 0;
            color: var(--text);
            min-width: 600px; /* Garante que a tabela não fique muito pequena em desktop */
        }

        .table-container th,
        .table-container td {
            padding: 0.9rem 1rem;
            font-size: 0.9rem;
            text-align: left;
            vertical-align: middle;
            border-bottom: 1px solid var(--border-color);
        }

        .table-container thead th {
            font-weight: 600;
            color: var(--muted);
            text-transform: uppercase;
            font-size: 0.8rem;
            background-color: var(--bg);
            border-bottom-width: 2px;
            position: relative; /* Para posicionar o input de filtro */
        }

        /* Estilo para a linha de filtros */
        .table-container .filter-row td {
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: none; /* Remove a borda inferior para os campos de filtro */
        }

        .table-container .filter-row input[type="text"] {
            width: 100%;
            padding: 0.4rem 0.6rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.8rem;
            background-color: var(--bg);
            color: var(--text);
        }
        .table-container .filter-row input[type="text"]:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 1px color-mix(in srgb, var(--primary) 30%, transparent);
        }

        /* Estilo para o input de filtro dentro do cabeçalho da coluna */
        .column-filter-input {
            width: calc(100% - 20px); /* Ajusta a largura para caber no TH */
            padding: 0.2rem 0.4rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.75rem;
            background-color: var(--bg);
            color: var(--text);
            position: absolute;
            top: 100%; /* Posiciona abaixo do TH */
            left: 0;
            z-index: 100; /* Garante que fique acima de outros elementos */
            display: none; /* Oculto por padrão */
            margin-top: 2px; /* Pequeno espaçamento */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .column-filter-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 1px color-mix(in srgb, var(--primary) 30%, transparent);
        }
        .filter-icon {
            margin-left: 0.5rem;
            cursor: pointer;
            color: var(--muted);
            transition: color 0.2s ease;
        }
        .filter-icon:hover {
            color: var(--primary);
        }
        .filter-icon.active { /* Estilo para o ícone de filtro ativo */
            color: var(--primary);
        }


        /* Arredondar cantos da thead */
        .table-container thead th:first-child { border-top-left-radius: 8px; }
        .table-container thead th:last-child { border-top-right-radius: 8px; }

        /* Estilo para as linhas do corpo da tabela */
        .table-container tbody tr:hover {
            background-color: color-mix(in srgb, var(--primary) 8%, transparent);
        }
        .table-container tbody tr:last-child td {
            border-bottom: none; /* Remove a borda inferior da última linha */
        }
        /* Arredondar cantos da tbody (última linha) */
        .table-container tbody tr:last-child td:first-child { border-bottom-left-radius: 8px; }
        .table-container tbody tr:last-child td:last-child { border-bottom-right-radius: 8px; }

        /* Estilos para inputs e textareas dentro das células da tabela */
        .table-container td input[type="text"],
        .table-container td input[type="number"],
        .table-container td textarea,
        .table-container td select { /* Adicionado select aqui */
            background-color: transparent; /* Fundo transparente */
            border: none; /* Sem borda */
            padding: 0; /* Sem padding */
            color: var(--text);
            width: 100%;
            font-size: 0.9rem;
            outline: none; /* Remove outline no focus */
            resize: none; /* Desabilita redimensionamento para textareas */
        }

        /* Estilo para o botão de remover dentro da tabela */
        .table-container .dynamic-field-item-actions {
            text-align: right; /* Alinha o botão à direita na célula */
            white-space: nowrap; /* Evita quebra de linha */
        }
        .table-container .dynamic-field-item-actions .btn-sm {
            margin-left: auto; /* Empurra o botão para a direita */
        }

        /* Estilo para a mensagem de "Nenhum item encontrado" na tabela */
        .table-container .no-results-row td {
            text-align: center;
            padding: 2rem;
            color: var(--muted);
        }

        /* --- Modals --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(15,23,42,0.7);
            display: flex; align-items: center; justify-content: center;
            z-index: 4000; opacity: 0;
            transition: opacity 0.3s ease; pointer-events: none;
        }
        .modal-overlay.show { opacity: 1; pointer-events: auto; }
        .modal {
            background: var(--card); border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            width: 90vw; /* Default width */
            max-width: 1200px !important; /* Increased max-width for modals */
            transform: scale(0.95);
            transition: transform 0.3s ease;
            display: flex; flex-direction: column;
        }
        .modal-overlay.show .modal { transform: scale(1); }
        /* Alert Modal */
        .alert-modal { max-width: 400px; padding: 2rem; text-align: center; align-items: center; gap: 1.5rem;}
        .alert-modal-icon {
            width: 60px; height: 60px; border-radius: 50%; display: grid; place-items: center;
            font-size: 2rem; color: white;
        }
        .alert-modal-icon.info { background: var(--info); }
        .alert-modal-icon.success { background: var(--success); }
        .alert-modal-icon.warning { background: var(--warning); }
        .alert-modal-icon.danger { background: var(--danger); }
        .alert-modal-title { font-size: 1.4rem; font-weight: 600; color: var(--text); }
        .alert-modal-message { font-size: 1rem; color: var(--muted); line-height: 1.6; }
        /* Add Item Modal */
        .add-item-modal { 
            max-width: 1000px; /* Increased max-width for modals */
            max-height: 80vh; /* Diminui a altura máxima do modal */
        } 
        .add-item-modal-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border-color); padding: 1.5rem;
        }
        .add-item-modal-title { font-size: 1.5rem; font-weight: 600; color: var(--text); }
        .add-item-modal-close-btn { background: none; border: none; font-size: 1.5rem; color: var(--muted); cursor: pointer; }
        .add-item-modal-body { 
            padding: 1.5rem; 
            display: flex; 
            flex-direction: column; 
            gap: 1rem;
            overflow-y: auto; /* Adiciona rolagem ao corpo do modal se o conteúdo for muito grande */
        }
        .add-item-modal-actions {
            display: flex; justify-content: flex-end; gap: 1rem;
            padding: 1.5rem; border-top: 1px solid var(--border-color);
            background-color: color-mix(in srgb, var(--border-color) 20%, transparent);
        }
        /* Estilos para campos de formulário dentro do modal */
        .add-item-modal .protocol-field input, 
        .add-item-modal .protocol-field select, 
        .add-item-modal .protocol-field textarea {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            color: var(--text);
            transition: all 0.2s;
            outline: none;
        }
        .add-item-modal .protocol-field input:focus, 
        .add-item-modal .protocol-field select:focus, 
        .add-item-modal .protocol-field textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px color-mix(in srgb, var(--primary) 30%, transparent);
        }

        /* Estilos para o botão de três pontos e o dropdown de ações */
        .action-dots-btn {
            background: none;
            border: none;
            font-size: 1.2rem;
            color: var(--muted);
            cursor: pointer;
            padding: 0.2rem 0.5rem;
            border-radius: 50%;
            transition: background 0.2s ease, color 0.2s ease;
        }
        .action-dots-btn:hover {
            background-color: var(--bg);
            color: var(--primary);
        }
        .action-dropdown {
            position: absolute;
            background: var(--card);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 120px;
            padding: 0.5rem 0;
            display: flex;
            flex-direction: column;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s ease;
        }
        .action-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .action-dropdown button {
            background: none;
            border: none;
            text-align: left;
            padding: 0.6rem 1rem;
            font-size: 0.9rem;
            color: var(--text);
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .action-dropdown button:hover {
            background-color: var(--primary-light);
            color: var(--primary);
        }
        .action-dropdown button.danger-option:hover {
            background-color: color-mix(in srgb, var(--danger) 15%, transparent);
            color: var(--danger);
        }


        /* --- Toast Notifications --- */
        #toast-container {
            position: fixed; top: 20px; right: 20px; z-index: 5000;
            display: flex; flex-direction: column; gap: 1rem;
        }
        .toast {
            display: flex; align-items: stretch; max-width: 380px;
            background: var(--card); border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-left: 4px solid var(--info);
            animation: slideIn 0.5s ease, fadeOut 0.5s ease 4.5s forwards;
            overflow: hidden;
        }
        .toast.success { border-color: var(--success); }
        .toast.danger { border-color: var(--danger); }
        .toast.warning { border-color: var(--warning); }
        .toast-icon {
            padding: 1rem; display: grid; place-items: center; font-size: 1.5rem;
        }
        .toast.info .toast-icon { color: var(--info); }
        .toast.success .toast-icon { color: var(--success); }
        .toast.danger .toast-icon { color: var(--danger); }
        .toast.warning .toast-icon { color: var(--warning); }
        .toast-content { padding: 1rem; flex-grow: 1; }
        .toast-title { font-weight: 700; color: var(--text); }
        .toast-message { font-size: 0.9rem; color: var(--muted); }
        .toast-close {
            background: none; border: none; color: var(--muted);
            font-size: 1.2rem; padding: 0 1rem; cursor: pointer;
        }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; transform: translateX(100%); } }

        /* Responsividade */
        @media (max-width: 768px) {
            .main-content, .main-content.collapsed { margin-left: 0; width: 100%; }
            main {
                padding: 1rem; /* Ajusta o padding em telas menores */
                max-width: 100%; /* Permite que o main ocupe 100% da largura em mobile */
            }
            /* Adaptação da tabela para telas pequenas */
            .table-container table {
                min-width: unset; /* Remove min-width para permitir encolhimento */
            }
            .table-container thead {
                display: none; /* Esconde o cabeçalho da tabela em telas pequenas */
            }
            .table-container, .table-container tbody, .table-container tr, .table-container td {
                display: block; /* Faz com que a tabela se comporte como blocos */
                width: 100%;
            }
            .table-container tr {
                margin-bottom: 1rem;
                border: 1px solid var(--border-color);
                border-radius: 12px;
                background-color: var(--card);
                box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
                padding: 1rem;
            }
            .table-container td {
                border-bottom: none;
                padding: 0.5rem 0;
                text-align: right; /* Alinha o valor à direita */
                position: relative;
                padding-left: 50%; /* Espaço para o label */
            }
            .table-container td::before {
                content: attr(data-label); /* Usa o atributo data-label para exibir o cabeçalho */
                position: absolute;
                left: 0;
                width: 45%;
                padding-left: 1rem;
                font-weight: 600;
                color: var(--muted);
                text-align: left;
            }
            .table-container .dynamic-field-item-actions {
                text-align: left; /* Alinha as ações à esquerda em mobile */
                padding-top: 1rem;
                border-top: 1px solid var(--border-color);
                margin-top: 0.5rem;
                display: flex; /* Para centralizar os botões se houver mais de um */
                justify-content: center; /* Centraliza os botões */
                gap: 0.5rem;
            }
            .table-container .dynamic-field-item-actions .btn {
                width: auto; /* Permite que os botões se ajustem ao conteúdo */
                flex-grow: 1; /* Faz com que os botões ocupem o espaço disponível */
            }
            /* Garante que os inputs e textareas dentro das células sejam visíveis e não ocupem toda a largura */
            .table-container td input,
            .table-container td textarea,
            .table-container td select { /* Adicionado select aqui */
                display: inline-block; /* Garante que o valor seja visível */
                width: auto; /* Ajusta a largura para o conteúdo */
                background-color: transparent;
                border: none;
                padding: 0;
            }
        }

    </style>
</head>
<body>
    <div id="toast-container"></div>

    <!-- Modal para Alertas Gerais -->
    <div id="general-alert-modal-overlay" class="modal-overlay alert-modal-overlay">
        <div class="modal alert-modal">
            <div id="alert-modal-icon" class="alert-modal-icon"></div>
            <h3 id="alert-modal-title" class="alert-modal-title"></h3>
            <p id="alert-modal-message" class="alert-modal-message"></p>
            <div class="alert-modal-actions">
                <button id="alert-modal-close-btn" class="btn btn-primary">OK</button>
            </div>
        </div>
    </div>

    <!-- Modal para Adicionar Itens Dinâmicos -->
    <div id="add-item-modal-overlay" class="modal-overlay add-item-modal-overlay">
        <div class="modal add-item-modal">
            <div class="add-item-modal-header">
                <h3 id="add-item-modal-title" class="add-item-modal-title">Adicionar Item</h3>
                <button type="button" id="add-item-modal-close-btn" class="add-item-modal-close-btn">&times;</button>
            </div>
            <div id="add-item-modal-body" class="add-item-modal-body">
                <!-- Campos dinâmicos serão inseridos aqui -->
            </div>
            <div class="add-item-modal-actions">
                <button type="button" id="add-item-modal-cancel-btn" class="btn btn-secondary">Cancelar</button>
                <button type="button" id="add-item-modal-save-btn" class="btn btn-primary">Adicionar</button>
            </div>
        </div>
    </div>

    <!-- Dropdown de Ações para Tabelas Dinâmicas -->
    <div id="action-dropdown" class="action-dropdown">
        <button id="action-dropdown-edit-btn"><i class="fas fa-edit mr-2"></i> Editar</button>
        <button id="action-dropdown-remove-btn" class="danger-option"><i class="fas fa-trash-alt mr-2"></i> Excluir</button>
    </div>

    <div class="layout">
        
        {% include 'Nav.html' %}

        <div class="main-content">
            <header class="topbar">
                <div class="topbar-left">
                      <button class="toggle-btn toggle-btn-desktop"><i class="fa-solid fa-bars-staggered"></i></button>
                    <h1 class="page-title">{{ 'Editar' if protocol else 'Novo' }} Protocolo</h1>
                </div>
                <div class="topbar-actions">
                    <a href="{{ url_for('protocols.list_protocols') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> <span class="hidden sm:inline">Voltar</span>
                    </a>
                    {% if protocol %} {# Show save button in topbar only when editing #}
                    <button type="submit" form="protocol-form" class="btn btn-primary">
                        <i class="fas fa-save"></i> <span class="hidden sm:inline">Salvar Protocolo</span>
                    </button>
                    {% endif %}
                </div>
            </header>

            <main>
                <form id="protocol-form" class="form-card" action="{{ url_for('protocols.save_protocol') }}" method="POST">
                    <input type="hidden" name="id" value="{{ protocol.id if protocol else '' }}">
                    
                    <div class="protocol-steps">
                        <div class="protocol-step active" data-step="1"><i class="fa-solid fa-file-alt"></i> Geral</div>
                        <div class="protocol-step" data-step="2"><i class="fa-solid fa-list-ol"></i> Etapas</div>
                        <div class="protocol-step" data-step="3"><i class="fa-solid fa-layer-group"></i> Níveis</div>
                        <div class="protocol-step" data-step="4"><i class="fa-solid fa-brain"></i> Habilidades</div>
                        <div class="protocol-step" data-step="5"><i class="fa-solid fa-star-half-alt"></i> Pontuação</div>
                        <div class="protocol-step" data-step="6"><i class="fa-solid fa-tasks"></i> Tarefas</div>
                        <div class="protocol-step" data-step="7"><i class="fa-solid fa-comment-dots"></i> Observações</div>
                    </div>

                    <div class="protocol-step-content-wrapper" style="flex:1; position:relative;">
                        <!-- Step 1: Geral -->
                        <div class="protocol-card-section" data-step-content="1" style="display:flex;">
                            <div class="protocol-card-container-form">
                                <div class="section-content">
                                    <div class="protocol-card-fields grid-2-cols">
                                        <div class="protocol-field required col-span-full">
                                            <label>Tipo de Protocolo:</label>
                                            <div class="flex items-center gap-x-8 gap-y-3 mt-3"> {# Adjusted gap and margin-top #}
                                                <label class="inline-flex items-center">
                                                    <input type="radio" class="form-radio h-5 w-5 text-blue-600" name="tipo_protocolo" value="Aquisicao de Habilidades" {% if not protocol or protocol.tipo_protocolo == 'Aquisicao de Habilidades' %}checked{% endif %} required>
                                                    <span class="ml-2">Aquisição de Habilidades</span>
                                                </label>
                                                <label class="inline-flex items-center">
                                                    <input type="radio" class="form-radio h-5 w-5 text-blue-600" name="tipo_protocolo" value="Reducao de Comportamentos" {% if protocol and protocol.tipo_protocolo == 'Reducao de Comportamentos' %}checked{% endif %} required>
                                                    <span class="ml-2">Redução de Comportamentos</span>
                                                </label>
                                            </div>
                                        </div>
                                        <div class="protocol-field required">
                                            <label for="nome">Nome do Protocolo:</label>
                                            <input type="text" id="nome" name="nome" value="{{ protocol.nome if protocol else '' }}" required>
                                        </div>
                                        {# REMOVIDO: Duração Estimada (dias) #}
                                        <div class="protocol-field col-span-full">
                                            <label for="descricao">Descrição:</label>
                                            <textarea id="descricao" name="descricao" rows="8">{{ protocol.descricao if protocol else '' }}</textarea> {# Increased rows to 8 #}
                                        </div>
                                        <div class="protocol-field flex items-center col-span-full mt-4"> {# Added margin-top #}
                                            <label class="inline-flex items-center">
                                                <input type="checkbox" id="ativo" name="ativo" value="1" {% if protocol and protocol.ativo %}checked{% endif %} class="h-5 w-5 text-blue-600 rounded focus:ring-blue-500">
                                                <span class="ml-2 !font-normal">Protocolo Ativo</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="protocol-actions justify-end">
                                    <button type="button" class="btn btn-primary steps-next">Próximo <i class="fa fa-chevron-right"></i></button>
                                </div>
                            </div>
                        </div>

                        <!-- Step 2: Etapas -->
                        <div class="protocol-card-section" data-step-content="2" style="display:none;">
                            <div class="protocol-card-container-form">
                                <div class="section-header-with-button">
                                    <h3 class="section-title"><i class="fa-solid fa-list-ol"></i> Etapas do Protocolo</h3>
                                    <button type="button" onclick="openAddItemModal('etapa')" class="btn btn-primary btn-sm">
                                        <i class="fas fa-plus"></i> Adicionar Etapa
                                    </button>
                                </div>
                                <div class="table-container">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th onclick="toggleColumnFilter(this, 'etapas-container', 0)">
                                                    <span>ID</span>
                                                    <i class="fas fa-filter filter-icon"></i>
                                                    <input type="text" placeholder="Filtrar ID" class="column-filter-input" data-column-index="0" onkeyup="filterTable('etapas-container')">
                                                </th>
                                                <th onclick="toggleColumnFilter(this, 'etapas-container', 1)">
                                                    <span>Nome da Etapa</span>
                                                    <i class="fas fa-filter filter-icon"></i>
                                                    <input type="text" placeholder="Filtrar Nome" class="column-filter-input" data-column-index="1" onkeyup="filterTable('etapas-container')">
                                                </th>
                                                <th onclick="toggleColumnFilter(this, 'etapas-container', 2)">
                                                    <span>Descrição</span>
                                                    <i class="fas fa-filter filter-icon"></i>
                                                    <input type="text" placeholder="Filtrar Descrição" class="column-filter-input" data-column-index="2" onkeyup="filterTable('etapas-container')">
                                                </th>
                                                <th>Ações</th>
                                            </tr>
                                        </thead>
                                        <tbody id="etapas-container">
                                            {% if protocol and protocol.etapas %}
                                                {% for etapa in protocol.etapas %}
                                                <tr class="dynamic-field-item">
                                                    <td data-label="ID">
                                                        <span class="display-id">#{{ etapa.id[:5] if etapa.id else loop.index }}</span>
                                                        <input type="hidden" name="etapa_id[]" value="{{ etapa.id if etapa.id else '' }}">
                                                        <input type="hidden" name="etapa_ordem[]" value="{{ loop.index }}">
                                                    </td>
                                                    <td data-label="Nome da Etapa">
                                                        <input type="text" value="{{ etapa.nome }}" readonly>
                                                        <input type="hidden" name="etapa_nome[]" value="{{ etapa.nome }}">
                                                    </td>
                                                    <td data-label="Descrição">
                                                        <textarea rows="1" readonly>{{ etapa.descricao }}</textarea>
                                                        <input type="hidden" name="etapa_descricao[]" value="{{ etapa.descricao }}">
                                                    </td>
                                                    <td class="dynamic-field-item-actions">
                                                        <button type="button" class="action-dots-btn" onclick="toggleActionDropdown(this, 'etapa')">
                                                            <i class="fas fa-ellipsis-v"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            {% else %}
                                                <tr class="no-results-row">
                                                    <td colspan="4">Nenhuma etapa cadastrada.</td>
                                                </tr>
                                            {% endif %}
                                        </tbody>
                                    </table>
                                </div>
                                <div class="protocol-actions">
                                    <button type="button" class="btn btn-secondary steps-prev"><i class="fa fa-chevron-left"></i> Voltar</button>
                                    <button type="button" class="btn btn-primary steps-next">Próximo <i class="fa fa-chevron-right"></i></button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Step 3: Níveis -->
                        <div class="protocol-card-section" data-step-content="3" style="display:none;">
                            <div class="protocol-card-container-form">
                                <div class="section-header-with-button">
                                    <h3 class="section-title"><i class="fa-solid fa-layer-group"></i> Níveis</h3>
                                    <button type="button" onclick="openAddItemModal('nivel')" class="btn btn-primary btn-sm">
                                        <i class="fas fa-plus"></i> Adicionar Nível
                                    </button>
                                </div>
                                <div class="table-container">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th onclick="toggleColumnFilter(this, 'niveis-container', 0)">
                                                    <span>ID</span>
                                                    <i class="fas fa-filter filter-icon"></i>
                                                    <input type="text" placeholder="Filtrar ID" class="column-filter-input" data-column-index="0" onkeyup="filterTable('niveis-container')">
                                                </th>
                                                <th onclick="toggleColumnFilter(this, 'niveis-container', 1)">
                                                    <span>Nível</span>
                                                    <i class="fas fa-filter filter-icon"></i>
                                                    <input type="text" placeholder="Filtrar Nível" class="column-filter-input" data-column-index="1" onkeyup="filterTable('niveis-container')">
                                                </th>
                                                <th onclick="toggleColumnFilter(this, 'niveis-container', 2)">
                                                    <span>Faixa Etária</span>
                                                    <i class="fas fa-filter filter-icon"></i>
                                                    <input type="text" placeholder="Filtrar Faixa Etária" class="column-filter-input" data-column-index="2" onkeyup="filterTable('niveis-container')">
                                                </th>
                                                <th>Ações</th>
                                            </tr>
                                        </thead>
                                        <tbody id="niveis-container">
                                            {% if protocol and protocol.niveis %}
                                                {% for nivel in protocol.niveis %}
                                                <tr class="dynamic-field-item">
                                                    <td data-label="ID">
                                                        <span class="display-id">#{{ nivel.id[:5] if nivel.id else nivel.ordem }}</span>
                                                        <input type="hidden" name="nivel_id[]" value="{{ nivel.id if nivel.id else '' }}">
                                                        <input type="hidden" name="nivel_ordem[]" value="{{ nivel.ordem }}">
                                                    </td>
                                                    <td data-label="Nível">
                                                        <input type="number" value="{{ nivel.nivel }}" readonly>
                                                        <input type="hidden" name="nivel_valor[]" value="{{ nivel.nivel }}">
                                                    </td>
                                                    <td data-label="Faixa Etária">
                                                        <input type="text" value="{{ nivel.faixa_etaria }}" readonly>
                                                        <input type="hidden" name="nivel_faixa_etaria[]" value="{{ nivel.faixa_etaria }}">
                                                    </td>
                                                    <td class="dynamic-field-item-actions">
                                                        <button type="button" class="action-dots-btn" onclick="toggleActionDropdown(this, 'nivel')">
                                                            <i class="fas fa-ellipsis-v"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            {% else %}
                                                <tr class="no-results-row">
                                                    <td colspan="4">Nenhuma nível cadastrado.</td>
                                                </tr>
                                            {% endif %}
                                        </tbody>
                                    </table>
                                </div>
                                <div class="protocol-actions">
                                    <button type="button" class="btn btn-secondary steps-prev"><i class="fa fa-chevron-left"></i> Voltar</button>
                                    <button type="button" class="btn btn-primary steps-next">Próximo <i class="fa fa-chevron-right"></i></button>
                                </div>
                            </div>
                        </div>

                        <!-- Step 4: Habilidades -->
                        <div class="protocol-card-section" data-step-content="4" style="display:none;">
                            <div class="protocol-card-container-form">
                                <div class="section-header-with-button">
                                    <h3 class="section-title"><i class="fa-solid fa-brain"></i> Habilidades</h3>
                                    <button type="button" onclick="openAddItemModal('habilidade')" class="btn btn-primary btn-sm">
                                        <i class="fas fa-plus"></i> Adicionar Habilidade
                                    </button>
                                </div>
                                <div class="table-container">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th onclick="toggleColumnFilter(this, 'habilidades-container', 0)">
                                                    <span>ID</span>
                                                    <i class="fas fa-filter filter-icon"></i>
                                                    <input type="text" placeholder="Filtrar ID" class="column-filter-input" data-column-index="0" onkeyup="filterTable('habilidades-container')">
                                                </th>
                                                <th onclick="toggleColumnFilter(this, 'habilidades-container', 1)">
                                                    <span>Habilidade</span>
                                                    <i class="fas fa-filter filter-icon"></i>
                                                    <input type="text" placeholder="Filtrar Habilidade" class="column-filter-input" data-column-index="1" onkeyup="filterTable('habilidades-container')">
                                                </th>
                                                <th>Ações</th>
                                            </tr>
                                        </thead>
                                        <tbody id="habilidades-container">
                                            {% if protocol and protocol.habilidades %}
                                                {% for habilidade in protocol.habilidades %}
                                                <tr class="dynamic-field-item">
                                                    <td data-label="ID">
                                                        <span class="display-id">#{{ habilidade.id[:5] if habilidade.id else habilidade.ordem }}</span>
                                                        <input type="hidden" name="habilidade_id[]" value="{{ habilidade.id if habilidade.id else '' }}">
                                                        <input type="hidden" name="habilidade_ordem[]" value="{{ habilidade.ordem }}">
                                                    </td>
                                                    <td data-label="Habilidade">
                                                        <input type="text" value="{{ habilidade.nome }}" readonly>
                                                        <input type="hidden" name="habilidade_nome[]" value="{{ habilidade.nome }}">
                                                    </td>
                                                    <td class="dynamic-field-item-actions">
                                                        <button type="button" class="action-dots-btn" onclick="toggleActionDropdown(this, 'habilidade')">
                                                            <i class="fas fa-ellipsis-v"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            {% else %}
                                                <tr class="no-results-row">
                                                    <td colspan="3">Nenhuma habilidade cadastrada.</td>
                                                </tr>
                                            {% endif %}
                                        </tbody>
                                    </table>
                                </div>
                                <div class="protocol-actions">
                                    <button type="button" class="btn btn-secondary steps-prev"><i class="fa fa-chevron-left"></i> Voltar</button>
                                    <button type="button" class="btn btn-primary steps-next">Próximo <i class="fa fa-chevron-right"></i></button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Step 5: Pontuação -->
                        <div class="protocol-card-section" data-step-content="5" style="display:none;">
                            <div class="protocol-card-container-form">
                                <div class="section-header-with-button">
                                    <h3 class="section-title"><i class="fa-solid fa-star-half-alt"></i> Pontuação</h3>
                                    <button type="button" onclick="openAddItemModal('pontuacao')" class="btn btn-primary btn-sm">
                                        <i class="fas fa-plus"></i> Adicionar Pontuação
                                    </button>
                                </div>
                                <div class="table-container">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th onclick="toggleColumnFilter(this, 'pontuacoes-container', 0)">
                                                    <span>ID</span>
                                                    <i class="fas fa-filter filter-icon"></i>
                                                    <input type="text" placeholder="Filtrar ID" class="column-filter-input" data-column-index="0" onkeyup="filterTable('pontuacoes-container')">
                                                </th>
                                                <th onclick="toggleColumnFilter(this, 'pontuacoes-container', 1)">
                                                    <span>Tipo</span>
                                                    <i class="fas fa-filter filter-icon"></i>
                                                    <input type="text" placeholder="Filtrar Tipo" class="column-filter-input" data-column-index="1" onkeyup="filterTable('pontuacoes-container')">
                                                </th>
                                                <th onclick="toggleColumnFilter(this, 'pontuacoes-container', 2)">
                                                    <span>Descrição</span>
                                                    <i class="fas fa-filter filter-icon"></i>
                                                    <input type="text" placeholder="Filtrar Descrição" class="column-filter-input" data-column-index="2" onkeyup="filterTable('pontuacoes-container')">
                                                </th>
                                                <th onclick="toggleColumnFilter(this, 'pontuacoes-container', 3)">
                                                    <span>Valor</span>
                                                    <i class="fas fa-filter filter-icon"></i>
                                                    <input type="text" placeholder="Filtrar Valor" class="column-filter-input" data-column-index="3" onkeyup="filterTable('pontuacoes-container')">
                                                </th>
                                                <th>Ações</th>
                                            </tr>
                                        </thead>
                                        <tbody id="pontuacoes-container">
                                            {% if protocol and protocol.pontuacao %}
                                                {% for item in protocol.pontuacao %}
                                                <tr class="dynamic-field-item">
                                                    <td data-label="ID">
                                                        <span class="display-id">#{{ item.id[:5] if item.id else item.ordem }}</span>
                                                        <input type="hidden" name="pontuacao_id[]" value="{{ item.id if item.id else '' }}">
                                                        <input type="hidden" name="pontuacao_ordem[]" value="{{ item.ordem }}">
                                                    </td>
                                                    <td data-label="Tipo">
                                                        <input type="text" value="{{ item.tipo }}" readonly>
                                                        <input type="hidden" name="pontuacao_tipo[]" value="{{ item.tipo }}">
                                                    </td>
                                                    <td data-label="Descrição">
                                                        <input type="text" value="{{ item.descricao }}" readonly>
                                                        <input type="hidden" name="pontuacao_descricao[]" value="{{ item.descricao }}">
                                                    </td>
                                                    <td data-label="Valor">
                                                        <input type="number" step="0.1" value="{{ item.valor }}" readonly>
                                                        <input type="hidden" name="pontuacao_valor[]" value="{{ item.valor }}">
                                                    </td>
                                                    <td class="dynamic-field-item-actions">
                                                        <button type="button" class="action-dots-btn" onclick="toggleActionDropdown(this, 'pontuacao')">
                                                            <i class="fas fa-ellipsis-v"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            {% else %}
                                                <tr class="no-results-row">
                                                    <td colspan="5">Nenhuma pontuação cadastrada.</td>
                                                </tr>
                                            {% endif %}
                                        </tbody>
                                    </table>
                                </div>
                                <div class="protocol-actions">
                                    <button type="button" class="btn btn-secondary steps-prev"><i class="fa fa-chevron-left"></i> Voltar</button>
                                    <button type="button" class="btn btn-primary steps-next">Próximo <i class="fa fa-chevron-right"></i></button>
                                </div>
                            </div>
                        </div>

                        <!-- Step 6: Tarefas -->
                        <div class="protocol-card-section" data-step-content="6" style="display:none;">
                            <div class="protocol-card-container-form">
                                <div class="section-header-with-button">
                                    <h3 class="section-title"><i class="fa-solid fa-tasks"></i> Tarefas/Testes</h3>
                                    <button type="button" onclick="openAddItemModal('tarefa')" class="btn btn-primary btn-sm">
                                        <i class="fas fa-plus"></i> Adicionar Tarefa/Teste
                                    </button>
                                </div>
                                <div class="table-container">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th onclick="toggleColumnFilter(this, 'tarefas-container', 0)">
                                                    <span>ID</span>
                                                    <i class="fas fa-filter filter-icon"></i>
                                                    <input type="text" placeholder="Filtrar ID" class="column-filter-input" data-column-index="0" onkeyup="filterTable('tarefas-container')">
                                                </th>
                                                <th onclick="toggleColumnFilter(this, 'tarefas-container', 1)">
                                                    <span>Nível</span>
                                                    <i class="fas fa-filter filter-icon"></i>
                                                    <input type="text" placeholder="Filtrar Nível" class="column-filter-input" data-column-index="1" onkeyup="filterTable('tarefas-container')">
                                                </th>
                                                <th onclick="toggleColumnFilter(this, 'tarefas-container', 2)">
                                                    <span>Item</span>
                                                    <i class="fas fa-filter filter-icon"></i>
                                                    <input type="text" placeholder="Filtrar Item" class="column-filter-input" data-column-index="2" onkeyup="filterTable('tarefas-container')">
                                                </th>
                                                <th onclick="toggleColumnFilter(this, 'tarefas-container', 3)">
                                                    <span>Nome</span>
                                                    <i class="fas fa-filter filter-icon"></i>
                                                    <input type="text" placeholder="Filtrar Nome" class="column-filter-input" data-column-index="3" onkeyup="filterTable('tarefas-container')">
                                                </th>
                                                <th onclick="toggleColumnFilter(this, 'tarefas-container', 4)">
                                                    <span>Habilidade/Marco</span>
                                                    <i class="fas fa-filter filter-icon"></i>
                                                    <input type="text" placeholder="Filtrar Habilidade/Marco" class="column-filter-input" data-column-index="4" onkeyup="filterTable('tarefas-container')">
                                                </th>
                                                <th onclick="toggleColumnFilter(this, 'tarefas-container', 5)">
                                                    <span>Resultado/Observação</span>
                                                    <i class="fas fa-filter filter-icon"></i>
                                                    <input type="text" placeholder="Filtrar Resultado/Observação" class="column-filter-input" data-column-index="5" onkeyup="filterTable('tarefas-container')">
                                                </th>
                                                <th onclick="toggleColumnFilter(this, 'tarefas-container', 6)">
                                                    <span>Pergunta</span>
                                                    <i class="fas fa-filter filter-icon"></i>
                                                    <input type="text" placeholder="Filtrar Pergunta" class="column-filter-input" data-column-index="6" onkeyup="filterTable('tarefas-container')">
                                                </th>
                                                <th onclick="toggleColumnFilter(this, 'tarefas-container', 7)">
                                                    <span>Exemplo</span>
                                                    <i class="fas fa-filter filter-icon"></i>
                                                    <input type="text" placeholder="Filtrar Exemplo" class="column-filter-input" data-column-index="7" onkeyup="filterTable('tarefas-container')">
                                                </th>
                                                <th onclick="toggleColumnFilter(this, 'tarefas-container', 8)">
                                                    <span>Critério</span>
                                                    <i class="fas fa-filter filter-icon"></i>
                                                    <input type="text" placeholder="Filtrar Critério" class="column-filter-input" data-column-index="8" onkeyup="filterTable('tarefas-container')">
                                                </th>
                                                <th onclick="toggleColumnFilter(this, 'tarefas-container', 9)">
                                                    <span>Objetivo</span>
                                                    <i class="fas fa-filter filter-icon"></i>
                                                    <input type="text" placeholder="Filtrar Objetivo" class="column-filter-input" data-column-index="9" onkeyup="filterTable('tarefas-container')">
                                                </th>
                                                <th>Ações</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tarefas-container">
                                            {% if protocol and protocol.tarefas_testes %}
                                                {% for tarefa in protocol.tarefas_testes %}
                                                <tr class="dynamic-field-item">
                                                    <td data-label="ID">
                                                        <span class="display-id">#{{ tarefa.id[:5] if tarefa.id else tarefa.ordem }}</span>
                                                        <input type="hidden" name="tarefa_id[]" value="{{ tarefa.id if tarefa.id else '' }}">
                                                        <input type="hidden" name="tarefa_ordem[]" value="{{ tarefa.ordem }}">
                                                    </td>
                                                    <td data-label="Nível">
                                                        <input type="number" value="{{ tarefa.nivel }}" readonly>
                                                        <input type="hidden" name="tarefa_nivel[]" value="{{ tarefa.nivel }}">
                                                    </td>
                                                    <td data-label="Item">
                                                        <input type="text" value="{{ tarefa.item }}" readonly>
                                                        <input type="hidden" name="tarefa_item[]" value="{{ tarefa.item }}">
                                                    </td>
                                                    <td data-label="Nome">
                                                        <input type="text" value="{{ tarefa.nome }}" readonly>
                                                        <input type="hidden" name="tarefa_nome[]" value="{{ tarefa.nome }}">
                                                    </td>
                                                    <td data-label="Habilidade/Marco">
                                                        <input type="text" value="{{ tarefa.habilidade_marco }}" readonly>
                                                        <input type="hidden" name="tarefa_habilidade_marco[]" value="{{ tarefa.habilidade_marco }}">
                                                    </td>
                                                    <td data-label="Resultado/Observação">
                                                        <textarea rows="1" readonly>{{ tarefa.resultado_observacao }}</textarea>
                                                        <input type="hidden" name="tarefa_resultado_observacao[]" value="{{ tarefa.resultado_observacao }}">
                                                    </td>
                                                    <td data-label="Pergunta">
                                                        <textarea rows="1" readonly>{{ tarefa.pergunta if tarefa.pergunta else '' }}</textarea>
                                                        <input type="hidden" name="tarefa_pergunta[]" value="{{ tarefa.pergunta if tarefa.pergunta else '' }}">
                                                    </td>
                                                    <td data-label="Exemplo">
                                                        <textarea rows="1" readonly>{{ tarefa.exemplo if tarefa.exemplo else '' }}</textarea>
                                                        <input type="hidden" name="tarefa_exemplo[]" value="{{ tarefa.exemplo if tarefa.exemplo else '' }}">
                                                    </td>
                                                    <td data-label="Critério">
                                                        <textarea rows="1" readonly>{{ tarefa.criterio if tarefa.criterio else '' }}</textarea>
                                                        <input type="hidden" name="tarefa_criterio[]" value="{{ tarefa.criterio if tarefa.criterio else '' }}">
                                                    </td>
                                                    <td data-label="Objetivo">
                                                        <textarea rows="1" readonly>{{ tarefa.objetivo if tarefa.objetivo else '' }}</textarea>
                                                        <input type="hidden" name="tarefa_objetivo[]" value="{{ tarefa.objetivo if tarefa.objetivo else '' }}">
                                                    </td>
                                                    <td class="dynamic-field-item-actions">
                                                        <button type="button" class="action-dots-btn" onclick="toggleActionDropdown(this, 'tarefa')">
                                                            <i class="fas fa-ellipsis-v"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            {% else %}
                                                <tr class="no-results-row">
                                                    <td colspan="11">Nenhuma tarefa/teste cadastrado.</td>
                                                </tr>
                                            {% endif %}
                                        </tbody>
                                    </table>
                                </div>
                                <div class="protocol-actions">
                                    <button type="button" class="btn btn-secondary steps-prev"><i class="fa fa-chevron-left"></i> Voltar</button>
                                    <button type="button" class="btn btn-primary steps-next">Próximo <i class="fa fa-chevron-right"></i></button>
                                </div>
                            </div>
                        </div>

                        <!-- Step 7: Observações -->
                        <div class="protocol-card-section" data-step-content="7" style="display:none;">
                            <div class="protocol-card-container-form">
                                <div class="section-content">
                                    <h3 class="section-title"><i class="fa-solid fa-comment-dots"></i> Observações</h3>
                                    <p class="text-sm text-gray-500 mb-4">Adicione quaisquer observações gerais relevantes para este protocolo.</p>
                                    <div class="protocol-card-fields">
                                        <div class="protocol-field">
                                            <label for="observacoes_gerais">Observações Gerais:</label>
                                            <textarea id="observacoes_gerais" name="observacoes_gerais" rows="10" placeholder="Ex: Este protocolo deve ser aplicado em ambiente tranquilo, com reforçadores de alta preferência.">{{ protocol.observacoes_gerais if protocol else '' }}</textarea>
                                        </div>
                                    </div>
                                </div>
                                <div class="protocol-actions">
                                    <button type="button" class="btn btn-secondary steps-prev"><i class="fa fa-chevron-left"></i> Voltar</button>
                                    {% if not protocol %} {# Show save button at bottom only when adding new protocol #}
                                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Salvar Protocolo</button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </main>
        </div>
    </div>

    <script>
    // Função para gerar UUID
    function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        const protocolForm = document.getElementById('protocol-form');
        const steps = document.querySelectorAll('.protocol-step');
        const sections = document.querySelectorAll('.protocol-card-section');
        const nextBtns = document.querySelectorAll('.steps-next');
        const prevBtns = document.querySelectorAll('.steps-prev');

        let currentStepIndex = 0;
        let editingRowElement = null; // Guarda a referência da linha sendo editada
        let editingItemId = null; // Guarda o ID do item sendo editado
        let currentActionDropdown = null; // Guarda a referência do dropdown de ações aberto

        // --- Lógica para Notificações Toast ---
        const toastContainer = document.getElementById('toast-container');
        function showToast(message, category = 'info') {
            if (!toastContainer) return;
            const toast = document.createElement('div');
            toast.className = `toast ${category}`;
            let iconClass = 'fa-solid fa-circle-info';
            let title = 'Informação';
            if (category === 'success') { iconClass = 'fa-solid fa-check-circle'; title = 'Sucesso'; }
            if (category === 'danger') { iconClass = 'fa-solid fa-times-circle'; title = 'Erro'; }
            if (category === 'warning') { iconClass = 'fa-solid fa-exclamation-triangle'; title = 'Atenção'; }
            toast.innerHTML = `
                <div class="toast-icon"><i class="${iconClass}"></i></div>
                <div class="toast-content">
                    <strong class="toast-title">${title}</strong>
                    <span class="toast-message">${message}</span>
                </div>
                <button class="toast-close">&times;</button>`;
            toast.querySelector('.toast-close').addEventListener('click', () => toast.remove());
            toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }

        // Processa mensagens flash do backend
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% for category, message in messages %}
                showToast("{{ message }}", "{{ category }}");
            {% endfor %}
        {% endwith %}

        // --- Lógica para Modal de Alerta Geral ---
        const generalAlertOverlay = document.getElementById('general-alert-modal-overlay');
        function showGeneralAlertModal(title, message, category = 'info') {
            const alertModalIcon = document.getElementById('alert-modal-icon');
            document.getElementById('alert-modal-title').textContent = title;
            document.getElementById('alert-modal-message').textContent = message;
            alertModalIcon.className = 'alert-modal-icon ' + category;
            let iconClass = '';
            switch (category) {
                case 'info': iconClass = 'fas fa-info-circle'; break;
                case 'success': iconClass = 'fas fa-check-circle'; break;
                case 'warning': iconClass = 'fas fa-exclamation-triangle'; break;
                case 'danger': iconClass = 'fas fa-times-circle'; break;
            }
            alertModalIcon.innerHTML = `<i class="${iconClass}"></i>`;
            if(generalAlertOverlay) generalAlertOverlay.classList.add('show');
        }
        function closeGeneralAlertModal() {
            if(generalAlertOverlay) generalAlertOverlay.classList.remove('show');
        }
        const alertModalCloseBtn = document.getElementById('alert-modal-close-btn');
        if(alertModalCloseBtn) alertModalCloseBtn.addEventListener('click', closeGeneralAlertModal);
        
        if(generalAlertOverlay) generalAlertOverlay.addEventListener('click', (e) => {
            if (e.target === generalAlertOverlay) closeGeneralAlertModal();
        });

        // --- Lógica para Modal de Adição/Edição de Itens ---
        const addItemModalOverlay = document.getElementById('add-item-modal-overlay');
        const addItemModalTitle = document.getElementById('add-item-modal-title');
        const addItemModalBody = document.getElementById('add-item-modal-body');
        const addItemModalSaveBtn = document.getElementById('add-item-modal-save-btn');
        let currentAddItemType = '';

        window.openAddItemModal = function(type, isEditing = false, rowElement = null) {
            currentAddItemType = type;
            addItemModalBody.innerHTML = '';
            let fieldsHtml = '';
            let titleText = '';
            
            editingRowElement = rowElement; // Armazena a referência da linha
            editingItemId = isEditing ? rowElement.querySelector(`input[name="${type}_id[]"]`).value : null;

            if (isEditing) {
                titleText = `Editar ${type.charAt(0).toUpperCase() + type.slice(1)}`;
                addItemModalSaveBtn.textContent = 'Salvar Alterações';
            } else {
                titleText = `Adicionar ${type.charAt(0).toUpperCase() + type.slice(1)}`;
                addItemModalSaveBtn.textContent = 'Adicionar';
            }

            let itemData = {};
            if (isEditing && rowElement) {
                // Coleta os dados da linha para preencher o modal
                const hiddenInputs = rowElement.querySelectorAll('input[type="hidden"]');
                hiddenInputs.forEach(input => {
                    const name = input.name.replace(`${type}_`, '').replace('[]', '');
                    itemData[name] = input.value;
                });
                // Para textareas que não são hidden
                const textareas = rowElement.querySelectorAll('textarea');
                textareas.forEach(textarea => {
                    const name = textarea.closest('td').dataset.label.toLowerCase().replace(/[^a-z0-9]/g, '_');
                    itemData[name] = textarea.value;
                });
            }

            switch (type) {
                case 'etapa':
                    fieldsHtml = `<div class="protocol-field required"><label for="modal_etapa_nome">Nome da Etapa:</label><input type="text" id="modal_etapa_nome" value="${itemData.nome || ''}" required></div>
                                  <div class="protocol-field"><label for="modal_etapa_descricao">Descrição:</label><textarea id="modal_etapa_descricao" rows="3">${itemData.descricao || ''}</textarea></div>`;
                    break;
                case 'nivel':
                    fieldsHtml = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                      <div class="protocol-field required"><label for="modal_nivel_valor">Nível:</label><input type="number" id="modal_nivel_valor" value="${itemData.nivel || ''}" required></div>
                                  </div>
                                  <div class="protocol-field"><label for="modal_nivel_faixa_etaria">Faixa Etária:</label><input type="text" id="modal_nivel_faixa_etaria" value="${itemData.faixa_etaria || ''}"></div>`;
                    break;
                case 'habilidade':
                    fieldsHtml = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                      <div class="protocol-field required"><label for="modal_habilidade_nome">Habilidade:</label><input type="text" id="modal_habilidade_nome" value="${itemData.nome || ''}" required></div>
                                  </div>`;
                    break;
                case 'pontuacao':
                    fieldsHtml = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                      <div class="protocol-field required"><label for="modal_pontuacao_tipo">Tipo:</label><input type="text" id="modal_pontuacao_tipo" value="${itemData.tipo || ''}" required></div>
                                  </div>
                                  <div class="protocol-field"><label for="modal_pontuacao_descricao">Descrição:</label><input type="text" id="modal_pontuacao_descricao" value="${itemData.descricao || ''}"></div>
                                  <div class="protocol-field required"><label for="modal_pontuacao_valor">Valor:</label><input type="number" step="0.1" id="modal_pontuacao_valor" value="${itemData.valor || ''}" required></div>`;
                    break;
                case 'tarefa':
                    const existingHabilidades = Array.from(document.querySelectorAll('#habilidades-container input[name="habilidade_nome[]"]')).map(input => input.value);
                    const existingNiveis = Array.from(document.querySelectorAll('#niveis-container input[name="nivel_valor[]"]')).map(input => ({
                        nivel: input.value,
                        faixa_etaria: input.closest('tr').querySelector('[name="nivel_faixa_etaria[]"]').value
                    }));

                    let habilidadesOptions = '<option value="">Selecione uma Habilidade</option>';
                    existingHabilidades.forEach(h => {
                        const selected = (h === itemData.habilidade_marco) ? 'selected' : '';
                        habilidadesOptions += `<option value="${h}" ${selected}>${h}</option>`;
                    });

                    let niveisOptions = '<option value="">Selecione um Nível</option>';
                    existingNiveis.forEach(n => {
                        const displayText = n.faixa_etaria ? `${n.nivel} - ${n.faixa_etaria}` : n.nivel;
                        const selected = (n.nivel == itemData.nivel) ? 'selected' : ''; // Comparar número
                        niveisOptions += `<option value="${n.nivel}" ${selected}>${displayText}</option>`;
                    });

                    fieldsHtml = `<div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4"> {# Adjusted gap for better spacing #}
                                      <div class="protocol-field required col-span-full"><label for="modal_tarefa_nome">Nome da Tarefa:</label><input type="text" id="modal_tarefa_nome" value="${itemData.nome || ''}" required></div>
                                      <div class="protocol-field required"><label for="modal_tarefa_nivel">Nível:</label><select id="modal_tarefa_nivel" required>${niveisOptions}</select></div>
                                      <div class="protocol-field"><label for="modal_tarefa_item">Item:</label><input type="text" id="modal_tarefa_item" value="${itemData.item || ''}"></div>
                                      <div class="protocol-field col-span-full mb-4"><label for="modal_tarefa_habilidade_marco">Habilidade/Marco:</label><select id="modal_tarefa_habilidade_marco">${habilidadesOptions}</select></div> {# Added mb-4 for spacing #}
                                      <div class="protocol-field col-span-full mb-4"><label for="modal_tarefa_resultado_observacao">Resultado/Observação:</label><textarea rows="3" id="modal_tarefa_resultado_observacao">${itemData.resultado_observacao || ''}</textarea></div> {# Added mb-4 #}
                                      <div class="protocol-field col-span-full mb-4"><label for="modal_tarefa_pergunta">Pergunta:</label><textarea rows="3" id="modal_tarefa_pergunta">${itemData.pergunta || ''}</textarea></div> {# Added mb-4 #}
                                      <div class="protocol-field col-span-full mb-4"><label for="modal_tarefa_exemplo">Exemplo:</label><textarea rows="3" id="modal_tarefa_exemplo">${itemData.exemplo || ''}</textarea></div> {# Added mb-4 #}
                                      <div class="protocol-field col-span-full mb-4"><label for="modal_tarefa_criterio">Critério:</label><textarea rows="3" id="modal_tarefa_criterio">${itemData.criterio || ''}</textarea></div> {# Added mb-4 #}
                                      <div class="protocol-field col-span-full"><label for="modal_tarefa_objetivo">Objetivo:</label><textarea rows="3" id="modal_tarefa_objetivo">${itemData.objetivo || ''}</textarea></div>
                                  </div>`;
                    break;
            }

            addItemModalTitle.textContent = titleText;
            addItemModalBody.innerHTML = fieldsHtml;
            addItemModalOverlay.classList.add('show');
        }
        
        if (addItemModalSaveBtn) {
            addItemModalSaveBtn.addEventListener('click', function() {
                console.log('Botão Adicionar/Salvar Alterações clicado no modal.'); // Debug
                const requiredFields = addItemModalBody.querySelectorAll('[required]');
                let allValid = true;
                requiredFields.forEach(field => {
                    if (!field.value.trim()) {
                        allValid = false;
                        field.classList.add('invalid');
                    } else {
                        field.classList.remove('invalid');
                    }
                });

                if (allValid) {
                    console.log('Todos os campos obrigatórios do modal preenchidos. Salvando dados...'); // Debug
                    saveModalData(currentAddItemType);
                    addItemModalOverlay.classList.remove('show');
                } else {
                    console.log('Campos obrigatórios do modal faltando.'); // Debug
                    showToast('Preencha todos os campos obrigatórios.', 'danger');
                }
            });
        }
        
        function saveModalData(type) {
            let containerId;
            if (type === 'nivel') {
                containerId = 'niveis-container';
            } else if (type === 'pontuacao') {
                containerId = 'pontuacoes-container';
            } else {
                containerId = `${type}s-container`;
            }
            
            let container = document.getElementById(containerId);
            console.log(`saveModalData acionada para o tipo: ${type}`); // Debug
            console.log('Container alvo (ID):', containerId); // Debug
            console.log('Container alvo (Elemento):', container); // Debug

            if (!container) {
                console.error(`Container não encontrado para o tipo: ${type}. ID esperado: ${containerId}`); // Debug
                return;
            }
            
            let values = {};
            // Coleta os valores do modal
            if (type === 'etapa') {
                values.nome = document.getElementById('modal_etapa_nome').value;
                values.descricao = document.getElementById('modal_etapa_descricao').value;
            } else if (type === 'nivel') {
                values.nivel = document.getElementById('modal_nivel_valor').value;
                values.faixa_etaria = document.getElementById('modal_nivel_faixa_etaria').value;
            } else if (type === 'habilidade') {
                values.nome = document.getElementById('modal_habilidade_nome').value;
            } else if (type === 'pontuacao') {
                values.tipo = document.getElementById('modal_pontuacao_tipo').value;
                values.descricao = document.getElementById('modal_pontuacao_descricao').value;
                values.valor = document.getElementById('modal_pontuacao_valor').value;
            } else if (type === 'tarefa') {
                values.nivel = document.getElementById('modal_tarefa_nivel').value;
                values.item = document.getElementById('modal_tarefa_item').value;
                values.nome = document.getElementById('modal_tarefa_nome').value;
                values.habilidade_marco = document.getElementById('modal_tarefa_habilidade_marco').value; 
                values.resultado_observacao = document.getElementById('modal_tarefa_resultado_observacao').value;
                values.pergunta = document.getElementById('modal_tarefa_pergunta').value;
                values.exemplo = document.getElementById('modal_tarefa_exemplo').value;
                values.criterio = document.getElementById('modal_tarefa_criterio').value;
                values.objetivo = document.getElementById('modal_tarefa_objetivo').value;
            }

            if (editingRowElement) {
                // Modo Edição: Atualiza a linha existente
                console.log('Modo Edição: Atualizando linha existente.'); // Debug
                const currentIdInput = editingRowElement.querySelector(`input[name="${type}_id[]"]`);
                const currentOrdemInput = editingRowElement.querySelector(`input[name="${type}_ordem[]"]`);
                
                // Atualiza os campos ocultos
                currentIdInput.value = editingItemId; // Mantém o ID original
                currentOrdemInput.value = currentOrdemInput.value; // Mantém a ordem original

                // Atualiza os campos visíveis na tabela
                if (type === 'etapa') {
                    editingRowElement.querySelector('td[data-label="Nome da Etapa"] input').value = values.nome;
                    editingRowElement.querySelector('td[data-label="Descrição"] textarea').value = values.descricao;
                    editingRowElement.querySelector(`input[name="etapa_nome[]"]`).value = values.nome;
                    editingRowElement.querySelector(`input[name="etapa_descricao[]"]`).value = values.descricao;
                } else if (type === 'nivel') {
                    editingRowElement.querySelector('td[data-label="Nível"] input').value = values.nivel;
                    editingRowElement.querySelector('td[data-label="Faixa Etária"] input').value = values.faixa_etaria;
                    editingRowElement.querySelector(`input[name="nivel_valor[]"]`).value = values.nivel;
                    editingRowElement.querySelector(`input[name="nivel_faixa_etaria[]"]`).value = values.faixa_etaria;
                } else if (type === 'habilidade') {
                    editingRowElement.querySelector('td[data-label="Habilidade"] input').value = values.nome;
                    editingRowElement.querySelector(`input[name="habilidade_nome[]"]`).value = values.nome;
                } else if (type === 'pontuacao') {
                    editingRowElement.querySelector('td[data-label="Tipo"] input').value = values.tipo;
                    editingRowElement.querySelector('td[data-label="Descrição"] input').value = values.descricao;
                    editingRowElement.querySelector('td[data-label="Valor"] input').value = values.valor;
                    editingRowElement.querySelector(`input[name="pontuacao_tipo[]"]`).value = values.tipo;
                    editingRowElement.querySelector(`input[name="pontuacao_descricao[]"]`).value = values.descricao;
                    editingRowElement.querySelector(`input[name="pontuacao_valor[]"]`).value = values.valor;
                } else if (type === 'tarefa') {
                    editingRowElement.querySelector('td[data-label="Nível"] input').value = values.nivel;
                    editingRowElement.querySelector('td[data-label="Item"] input').value = values.item;
                    editingRowElement.querySelector('td[data-label="Nome"] input').value = values.nome;
                    editingRowElement.querySelector('td[data-label="Habilidade/Marco"] input').value = values.habilidade_marco;
                    editingRowElement.querySelector('td[data-label="Resultado/Observação"] textarea').value = values.resultado_observacao;
                    editingRowElement.querySelector('td[data-label="Pergunta"] textarea').value = values.pergunta;
                    editingRowElement.querySelector('td[data-label="Exemplo"] textarea').value = values.exemplo;
                    editingRowElement.querySelector('td[data-label="Critério"] textarea').value = values.criterio;
                    editingRowElement.querySelector('td[data-label="Objetivo"] textarea').value = values.objetivo;

                    editingRowElement.querySelector(`input[name="tarefa_nivel[]"]`).value = values.nivel;
                    editingRowElement.querySelector(`input[name="tarefa_item[]"]`).value = values.item;
                    editingRowElement.querySelector(`input[name="tarefa_nome[]"]`).value = values.nome;
                    editingRowElement.querySelector(`input[name="tarefa_habilidade_marco[]"]`).value = values.habilidade_marco;
                    editingRowElement.querySelector(`input[name="tarefa_resultado_observacao[]"]`).value = values.resultado_observacao;
                    editingRowElement.querySelector(`input[name="tarefa_pergunta[]"]`).value = values.pergunta;
                    editingRowElement.querySelector(`input[name="tarefa_exemplo[]"]`).value = values.exemplo;
                    editingRowElement.querySelector(`input[name="tarefa_criterio[]"]`).value = values.criterio;
                    editingRowElement.querySelector(`input[name="tarefa_objetivo[]"]`).value = values.objetivo;
                }

                editingRowElement = null; // Reseta a referência
                editingItemId = null; // Reseta o ID
            } else {
                // Modo Adição: Adiciona uma nova linha
                console.log('Modo Adição: Adicionando nova linha.'); // Debug
                const newId = generateUUID();
                const newOrdem = container.children.length + 1; // Ordem automática

                let newFieldHtml = '';
                if (type === 'etapa') {
                    newFieldHtml = `
                        <tr class="dynamic-field-item">
                            <td data-label="ID">
                                <span class="display-id">#${newId.substring(0, 5)}</span>
                                <input type="hidden" name="etapa_id[]" value="${newId}">
                                <input type="hidden" name="etapa_ordem[]" value="${newOrdem}">
                            </td>
                            <td data-label="Nome da Etapa">
                                <input type="text" value="${values.nome}" readonly>
                                <input type="hidden" name="etapa_nome[]" value="${values.nome}">
                            </td>
                            <td data-label="Descrição">
                                <textarea rows="1" readonly>${values.descricao}</textarea>
                                <input type="hidden" name="etapa_descricao[]" value="${values.descricao}">
                            </td>
                            <td class="dynamic-field-item-actions">
                                <button type="button" class="action-dots-btn" onclick="toggleActionDropdown(this, 'etapa')">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                            </td>
                        </tr>`;
                } else if (type === 'nivel') {
                    newFieldHtml = `
                        <tr class="dynamic-field-item">
                            <td data-label="ID">
                                <span class="display-id">#${newId.substring(0, 5)}</span>
                                <input type="hidden" name="nivel_id[]" value="${newId}">
                                <input type="hidden" name="nivel_ordem[]" value="${newOrdem}">
                            </td>
                            <td data-label="Nível">
                                <input type="number" value="${values.nivel}" readonly>
                                <input type="hidden" name="nivel_valor[]" value="${values.nivel}">
                            </td>
                            <td data-label="Faixa Etária">
                                <input type="text" value="${values.faixa_etaria}" readonly>
                                <input type="hidden" name="nivel_faixa_etaria[]" value="${values.faixa_etaria}">
                            </td>
                            <td class="dynamic-field-item-actions">
                                <button type="button" class="action-dots-btn" onclick="toggleActionDropdown(this, 'nivel')">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                            </td>
                        </tr>`;
                } else if (type === 'habilidade') {
                    newFieldHtml = `
                        <tr class="dynamic-field-item">
                            <td data-label="ID">
                                <span class="display-id">#${newId.substring(0, 5)}</span>
                                <input type="hidden" name="habilidade_id[]" value="${newId}">
                                <input type="hidden" name="habilidade_ordem[]" value="${newOrdem}">
                            </td>
                            <td data-label="Habilidade">
                                <input type="text" value="${values.nome}" readonly>
                                <input type="hidden" name="habilidade_nome[]" value="${values.nome}">
                            </td>
                            <td class="dynamic-field-item-actions">
                                <button type="button" class="action-dots-btn" onclick="toggleActionDropdown(this, 'habilidade')">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                            </td>
                        </tr>`;
                } else if (type === 'pontuacao') {
                    newFieldHtml = `
                        <tr class="dynamic-field-item">
                            <td data-label="ID">
                                <span class="display-id">#${newId.substring(0, 5)}</span>
                                <input type="hidden" name="pontuacao_id[]" value="${newId}">
                                <input type="hidden" name="pontuacao_ordem[]" value="${newOrdem}">
                            </td>
                            <td data-label="Tipo">
                                <input type="text" value="${values.tipo}" readonly>
                                <input type="hidden" name="pontuacao_tipo[]" value="${values.tipo}">
                            </td>
                            <td data-label="Descrição">
                                <input type="text" value="${values.descricao}" readonly>
                                <input type="hidden" name="pontuacao_descricao[]" value="${values.descricao}">
                            </td>
                            <td data-label="Valor">
                                <input type="number" step="0.1" value="${values.valor}" readonly>
                                <input type="hidden" name="pontuacao_valor[]" value="${values.valor}">
                            </td>
                            <td class="dynamic-field-item-actions">
                                <button type="button" class="action-dots-btn" onclick="toggleActionDropdown(this, 'pontuacao')">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                            </td>
                        </tr>`;
                } else if (type === 'tarefa') {
                    newFieldHtml = `
                        <tr class="dynamic-field-item">
                            <td data-label="ID">
                                <span class="display-id">#${newId.substring(0, 5)}</span>
                                <input type="hidden" name="tarefa_id[]" value="${newId}">
                                <input type="hidden" name="tarefa_ordem[]" value="${newOrdem}">
                            </td>
                            <td data-label="Nível">
                                <input type="number" value="${values.nivel}" readonly>
                                <input type="hidden" name="tarefa_nivel[]" value="${values.nivel}">
                            </td>
                            <td data-label="Item">
                                <input type="text" value="${values.item}" readonly>
                                <input type="hidden" name="tarefa_item[]" value="${values.item}">
                            </td>
                            <td data-label="Nome">
                                <input type="text" value="${values.nome}" readonly>
                                <input type="hidden" name="tarefa_nome[]" value="${values.nome}">
                            </td>
                            <td data-label="Habilidade/Marco">
                                <input type="text" value="${values.habilidade_marco}" readonly>
                                <input type="hidden" name="tarefa_habilidade_marco[]" value="${values.habilidade_marco}">
                            </td>
                            <td data-label="Resultado/Observação">
                                <textarea rows="1" readonly>${values.resultado_observacao}</textarea>
                                <input type="hidden" name="tarefa_resultado_observacao[]" value="${values.resultado_observacao}">
                            </td>
                            <td data-label="Pergunta">
                                <textarea rows="1" readonly>${values.pergunta}</textarea>
                                <input type="hidden" name="tarefa_pergunta[]" value="${values.pergunta}">
                            </td>
                            <td data-label="Exemplo">
                                <textarea rows="1" readonly>${values.exemplo}</textarea>
                                <input type="hidden" name="tarefa_exemplo[]" value="${values.exemplo}">
                            </td>
                            <td data-label="Critério">
                                <textarea rows="1" readonly>${values.criterio}</textarea>
                                <input type="hidden" name="tarefa_criterio[]" value="${values.criterio}">
                            </td>
                            <td data-label="Objetivo">
                                <textarea rows="1" readonly>${values.objetivo}</textarea>
                                <input type="hidden" name="tarefa_objetivo[]" value="${values.objetivo}">
                            </td>
                            <td class="dynamic-field-item-actions">
                                <button type="button" class="action-dots-btn" onclick="toggleActionDropdown(this, 'tarefa')">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                            </td>
                        </tr>`;
                }

                // Remove a linha "Nenhum item encontrado" se ela existir
                const noResultsRow = container.querySelector('.no-results-row');
                if (noResultsRow) {
                    console.log('Removendo linha "Nenhum item cadastrado."'); // Debug
                    noResultsRow.remove();
                }
                container.insertAdjacentHTML('beforeend', newFieldHtml);
                console.log('Nova linha adicionada ao container.'); // Debug
            }
            // Após adicionar ou editar, re-aplicar filtros caso algum esteja ativo
            filterTable(containerId);
        }
        
        window.editDynamicField = function(button, type) {
            const rowToEdit = button.closest('.dynamic-field-item');
            openAddItemModal(type, true, rowToEdit);
            closeActionDropdown(); // Fecha o dropdown após clicar em editar
        };

        window.removeDynamicField = function(button) {
            const rowToRemove = button.closest('.dynamic-field-item');
            const container = rowToRemove.closest('tbody');
            rowToRemove.remove();

            // Se não houver mais linhas, adiciona a mensagem "Nenhum item encontrado"
            if (container && container.children.length === 0) {
                const colspan = container.closest('table').querySelector('thead tr').children.length;
                container.insertAdjacentHTML('beforeend', `<tr class="no-results-row"><td colspan="${colspan}">Nenhum item cadastrado.</td></tr>`);
            }
            // Após remover, re-aplicar filtros caso algum esteja ativo
            filterTable(container.id);
            closeActionDropdown(); // Fecha o dropdown após clicar em remover
        }

        const addItemModalCloseBtn = document.getElementById('add-item-modal-close-btn');
        if(addItemModalCloseBtn) addItemModalCloseBtn.addEventListener('click', () => addItemModalOverlay.classList.remove('show'));
        
        const addItemModalCancelBtn = document.getElementById('add-item-modal-cancel-btn');
        if(addItemModalCancelBtn) addItemModalCancelBtn.addEventListener('click', () => addItemModalOverlay.classList.remove('show'));

        // --- Lógica de Navegação por Steps ---
        function showStep(index) {
            steps.forEach((step, i) => step.classList.toggle('active', i === index));
            sections.forEach((section, i) => section.style.display = i === index ? 'flex' : 'none');
            currentStepIndex = index;
            // Ao mudar de aba, re-aplicar filtros para garantir que a tabela esteja correta
            const currentContainerId = sections[currentStepIndex].querySelector('.table-container tbody')?.id;
            if (currentContainerId) {
                filterTable(currentContainerId);
            }
            closeActionDropdown(); // Fecha qualquer dropdown de ação aberto ao mudar de aba
        }

        steps.forEach((step, i) => {
            step.addEventListener('click', () => showStep(i));
        });

        nextBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                if (validateCurrentStep()) {
                    showStep(Math.min(currentStepIndex + 1, sections.length - 1));
                } else {
                    showGeneralAlertModal('Campos Obrigatórios', 'Por favor, preencha todos os campos marcados com * nesta seção.', 'danger');
                }
            });
        });

        prevBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                showStep(Math.max(currentStepIndex - 1, 0));
            });
        });
        
        // --- Lógica de Validação ---
        function validateField(field) {
            let isValid = true;
            if (field.type === 'radio') {
                isValid = protocolForm.querySelector(`input[name="${field.name}"]:checked`);
            } else {
                isValid = field.value.trim() !== '';
            }
            field.classList.toggle('invalid', !isValid);
            return isValid;
        }

        function validateCurrentStep() {
            let allValid = true;
            const currentSection = sections[currentStepIndex];
            steps[currentStepIndex].classList.remove('has-error');
            currentSection.querySelectorAll('[required]:not([type=hidden])').forEach(field => {
                if (!validateField(field)) {
                    allValid = false;
                    field.classList.add('shake');
                    setTimeout(() => field.classList.remove('shake'), 500);
                }
            });
            if (!allValid) steps[currentStepIndex].classList.add('has-error');
            return allValid;
        }

        protocolForm.addEventListener('submit', function(event) {
            let allFormFieldsValid = true;
            let firstInvalidStep = -1;

            steps.forEach((step, index) => {
                let stepIsValid = true;
                sections[index].querySelectorAll('[required]:not([type=hidden])').forEach(field => {
                    if (!validateField(field)) {
                        stepIsValid = false;
                        allFormFieldsValid = false;
                    }
                });
                step.classList.toggle('has-error', !stepIsValid);
                if (!stepIsValid && firstInvalidStep === -1) {
                    firstInvalidStep = index;
                }
            });

            if (!allFormFieldsValid) {
                event.preventDefault();
                showGeneralAlertModal('Erro de Validação', 'Por favor, corrija os campos inválidos em todas as seções.', 'danger');
                if (firstInvalidStep !== -1) {
                    showStep(firstInvalidStep);
                }
            }
        });

        // --- Lógica de Filtro de Tabela ---
        window.filterTable = function(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            const table = container.closest('table');
            const filterInputs = table.querySelectorAll('.column-filter-input');
            const filters = {}; // { columnIndex: filterText }

            filterInputs.forEach(input => {
                const columnIndex = parseInt(input.dataset.columnIndex);
                filters[columnIndex] = input.value.toLowerCase();
                // Atualiza a classe 'active' do ícone de filtro
                const icon = input.closest('th').querySelector('.filter-icon');
                if (icon) {
                    if (input.value.trim() !== '') {
                        icon.classList.add('active');
                    } else {
                        icon.classList.remove('active');
                    }
                }
            });

            const rows = container.querySelectorAll('.dynamic-field-item');
            let hasVisibleRows = false;

            rows.forEach(row => {
                let rowMatches = true;
                const cells = row.querySelectorAll('td');

                for (const columnIndex in filters) {
                    const filterText = filters[columnIndex];
                    if (filterText === '') continue; // Pula se não houver filtro para esta coluna

                    const cell = cells[columnIndex];
                    if (!cell) {
                        rowMatches = false;
                        break;
                    }

                    // Coleta o conteúdo da célula, incluindo spans e inputs ocultos
                    let cellContent = '';
                    const displaySpan = cell.querySelector('.display-id');
                    const visibleInput = cell.querySelector('input[type="text"], input[type="number"], textarea, select');
                    const hiddenInputs = cell.querySelectorAll('input[type="hidden"]');

                    if (displaySpan) {
                        cellContent += displaySpan.textContent;
                    }
                    if (visibleInput) {
                        cellContent += ' ' + visibleInput.value;
                    }
                    hiddenInputs.forEach(input => {
                        cellContent += ' ' + input.value;
                    });
                    
                    if (!cellContent.toLowerCase().includes(filterText)) {
                        rowMatches = false;
                        break;
                    }
                }

                if (rowMatches) {
                    row.style.display = '';
                    hasVisibleRows = true;
                } else {
                    row.style.display = 'none';
                }
            });

            // Gerencia a mensagem "Nenhum item cadastrado."
            const noResultsRow = container.querySelector('.no-results-row');
            if (noResultsRow) {
                if (hasVisibleRows) {
                    noResultsRow.style.display = 'none';
                } else {
                    noResultsRow.style.display = '';
                }
            }
        };

        // Função para alternar a visibilidade do input de filtro da coluna
        window.toggleColumnFilter = function(headerElement, tableId, columnIndex) {
            const input = headerElement.querySelector('.column-filter-input');
            const icon = headerElement.querySelector('.filter-icon');
            if (!input || !icon) return;

            // Fecha outros filtros abertos na mesma tabela
            const currentTable = document.getElementById(tableId);
            currentTable.querySelectorAll('.column-filter-input').forEach(otherInput => {
                if (otherInput !== input && otherInput.style.display !== 'none') {
                    otherInput.style.display = 'none';
                    // Remove a classe 'active' do ícone de outros filtros fechados
                    const otherIcon = otherInput.closest('th').querySelector('.filter-icon');
                    if (otherIcon && otherInput.value === '') {
                        otherIcon.classList.remove('active');
                    }
                }
            });

            if (input.style.display === 'block') {
                input.style.display = 'none';
                if (input.value === '') { // Limpa e esconde se estiver vazio
                    icon.classList.remove('active');
                    filterTable(tableId);
                } else {
                    icon.classList.add('active'); // Mantém ativo se tiver valor
                }
            } else {
                input.style.display = 'block';
                input.focus();
                icon.classList.add('active'); // Ativa o ícone ao abrir
            }
        };

        // Adiciona um listener global para fechar filtros ao clicar fora
        document.addEventListener('click', function(event) {
            document.querySelectorAll('.column-filter-input').forEach(input => {
                const header = input.closest('th');
                const icon = header.querySelector('.filter-icon');
                if (input.style.display === 'block' && !header.contains(event.target)) {
                    if (input.value === '') {
                        input.style.display = 'none';
                        if (icon) icon.classList.remove('active');
                    } else {
                        if (icon) icon.classList.add('active');
                    }
                }
            });
        });

        // --- Lógica para o Dropdown de Ações (três pontos) ---
        const actionDropdown = document.getElementById('action-dropdown');
        const actionDropdownEditBtn = document.getElementById('action-dropdown-edit-btn');
        const actionDropdownRemoveBtn = document.getElementById('action-dropdown-remove-btn');
        let currentDropdownRow = null; // Armazena a linha associada ao dropdown aberto
        let currentDropdownType = null; // Armazena o tipo de item associado ao dropdown aberto

        window.toggleActionDropdown = function(buttonElement, type) {
            const rowElement = buttonElement.closest('.dynamic-field-item');
            
            // Se o dropdown já estiver aberto e for o mesmo botão, fecha
            if (currentActionDropdown && currentActionDropdown.classList.contains('show') && currentDropdownRow === rowElement) {
                closeActionDropdown();
                return;
            }

            // Fecha qualquer dropdown de ação que esteja aberto
            closeActionDropdown();

            // Posiciona o dropdown
            const rect = buttonElement.getBoundingClientRect();
            // Ajuste para alinhar a direita do dropdown com a direita do botão
            actionDropdown.style.top = `${rect.bottom + window.scrollY + 5}px`;
            actionDropdown.style.left = `${rect.right + window.scrollX - actionDropdown.offsetWidth}px`;
            
            // Garante que o dropdown não saia da tela à esquerda
            if (parseFloat(actionDropdown.style.left) < 0) {
                 actionDropdown.style.left = `0px`;
            }


            currentDropdownRow = rowElement;
            currentDropdownType = type;

            // Atribui as ações aos botões do dropdown
            actionDropdownEditBtn.onclick = () => window.editDynamicField(buttonElement, type);
            actionDropdownRemoveBtn.onclick = () => window.removeDynamicField(buttonElement);

            actionDropdown.classList.add('show');
            currentActionDropdown = actionDropdown; // Define o dropdown atual como o aberto
        };

        function closeActionDropdown() {
            if (currentActionDropdown) {
                currentActionDropdown.classList.remove('show');
                currentDropdownRow = null;
                currentDropdownType = null;
                currentActionDropdown = null; // Limpa a referência
            }
        }

        // Fecha o dropdown ao clicar fora
        document.addEventListener('click', function(event) {
            // Verifica se o clique não foi no botão de três pontos e não foi dentro do dropdown
            if (currentActionDropdown && !actionDropdown.contains(event.target) && !event.target.closest('.action-dots-btn')) {
                closeActionDropdown();
            }
        });
        
        // Inicializa a página
        showStep(0);
    });
    </script>
</body>
</html>
