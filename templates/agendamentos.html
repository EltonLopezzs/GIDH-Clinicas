<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Horários - {{ session.clinica_nome_display or 'Clínica On' }}</title>
    
    <link rel="icon" type="image/png" href="https://placehold.co/40x40/0d9488/ffffff?text=C">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        :root {
            --bg: #f1f5f9;
            --card: #ffffff;
            --text: #0f172a;
            --muted: #64748b;
            --accent: #0f172a;
            --primary: #0d9488; /* Teal-600 */
            --primary-dark: #115e59;
            --secondary: #f59e0b; /* Amber-500 */
            --danger: #dc2626; /* Red-600 */
            --success: #16a34a; /* Green-600 */
            --warning: #f59e0b;
            --info: #0ea5e9;
            --border-color: #e2e8f0;
            
            /* Cores para os status dos agendamentos */
            --status-confirmado: #16a344; /* Verde */
            --status-concluido: #0ea5e9; /* Azul */
            --status-pendente: #f59e0b; /* Laranja */
            --status-cancelado: #dc2626; /* Vermelho */

            --dark-bg: #0f172a;
            --dark-card: #1e293b;
            --dark-text: #f1f5f9;
            --dark-muted: #94a3b8;
            --dark-border-color: #334155;
            
            color-scheme: light;
        }

        [data-theme="dark"] {
            --bg: var(--dark-bg);
            --text: var(--dark-text);
            --card: var(--dark-card);
            --muted: var(--dark-muted);
            --border-color: var(--dark-border-color);
            color-scheme: dark;

            /* Cores para os status em tema escuro (opcionalmente ajustadas) */
            --status-confirmado: #22c55e;
            --status-concluido: #38bdf8;
            --status-pendente: #fbbf24;
            --status-cancelado: #ef4444;
        }

        /* Reset básico e box-sizing */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; } /* Removido overflow-x: hidden; */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow: hidden; /* Adicionado overflow: hidden; para desativar o scroll da página */
        }
        .layout { display: flex; min-height: 100vh; width: 100%; }

        /* ============================================
          --- SIDEBAR ---
          ============================================
        */
        .sidebar {
            width: 260px;
            background: linear-gradient(180deg, var(--primary), var(--accent));
            color: white;
            position: fixed;
            top: 0; left: 0;
            height: 100vh;
            transition: width 0.3s ease, transform 0.3s ease;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }
        .sidebar-inner-content { padding: 0; height: 100%; overflow-y: auto; display: flex; flex-direction: column; }
        .sidebar-header {
            padding: 0 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sidebar-header .logo {
            font-size: 1.4rem; font-weight: 700; color: white; text-decoration: none;
            display: flex; align-items: center; gap: 0.75rem;
            white-space: nowrap; overflow: hidden;
        }
        .sidebar-header .logo i { font-size: 1.8rem; }
        
        .sidebar.collapsed { width: 78px; }
        .sidebar.collapsed .sidebar-header .logo span, .sidebar.collapsed nav ul li a span, .sidebar.collapsed .sidebar-footer span { display: none; }
        .sidebar.collapsed nav ul li a, .sidebar.collapsed .sidebar-footer button, .sidebar.collapsed .sidebar-footer a { justify-content: center; padding: 0.75rem; }

        .sidebar nav { flex-grow: 1; margin-top: 1rem; padding: 0 0.75rem; }
        .sidebar.collapsed nav { padding: 0 0.5rem; }
        .sidebar nav ul { list-style: none; padding: 0; }
        .sidebar nav ul li { margin-bottom: 0.5rem; }
        .sidebar nav ul li a {
            color: #e2e8f0; text-decoration: none; display: flex; align-items: center;
            padding: 0.75rem 1rem; gap: 1rem; border-radius: 8px; font-size: 0.95rem;
            font-weight: 500; white-space: nowrap; overflow: hidden;
            transition: background 0.2s ease, color 0.2s ease;
        }
        .sidebar nav ul li a i { width: 24px; text-align: center; font-size: 1.2rem; flex-shrink: 0; }
        .sidebar nav ul li a:hover { background: rgba(255, 255, 255, 0.1); color: white; }
        .sidebar nav ul li.active a { background: white; color: var(--primary); font-weight: 600; }

        .sidebar-footer { padding: 1rem 0.75rem; margin-top: auto; flex-shrink: 0; }
        .sidebar.collapsed .sidebar-footer { padding: 1rem 0.5rem; }
        .sidebar-footer button, .sidebar-footer a {
            background: none; border: none; cursor: pointer; color: #e2e8f0;
            padding: 0.75rem 1rem; border-radius: 8px; width: 100%;
            display: flex; align-items: center; gap: 1rem;
            transition: background 0.2s ease, color 0.2s ease;
            font-family: 'Inter', sans-serif; font-size: 0.95rem; text-decoration: none;
        }
        .sidebar-footer button:hover, .sidebar-footer a:hover { background: rgba(255, 255, 255, 0.1); color: white; }
        
        /* ============================================
          --- CONTEÚDO PRINCIPAL & TOPBAR ---
          ============================================
        */
        .main-content {
            flex: 1; margin-left: 260px; transition: margin-left 0.3s ease;
            display: flex; flex-direction: column; width: calc(100% - 260px);
            height: calc(100vh - 2px); /* Definindo a altura do main-content */
            overflow: hidden; /* Garante que o main-content não tenha scroll próprio */
        }
        .main-content.collapsed { margin-left: 78px; width: calc(100% - 78px); }

        .topbar {
            background-color: var(--card); color: var(--text); padding: 0 1.5rem;
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid var(--border-color); height: 70px; flex-shrink: 0;
            position: sticky; top: 0; z-index: 900;
        }
        .topbar-left { display: flex; align-items: center; gap: 1rem; }
        .topbar .page-title { font-weight: 600; font-size: 1.25rem; color: var(--text); }
        .toggle-btn {
            background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--muted);
            width: 40px; height: 40px; border-radius: 50%; display: grid; place-items: center;
            transition: background 0.2s ease, color 0.2s ease;
        }
        .toggle-btn:hover { background-color: var(--bg); color: var(--primary); }
        .toggle-btn-desktop { display: none; }
        .menu-btn-mobile { display: block; }
        @media(min-width: 769px) {
            .toggle-btn-desktop { display: grid; }
            .menu-btn-mobile { display: none; }
        }

        /* New Filter Button in Topbar */
        .topbar-right { 
            display: flex; 
            align-items: center; 
            gap: 1rem; 
            flex-wrap: wrap; /* Permite que os itens quebrem para a próxima linha em telas menores */
            justify-content: flex-end; /* Alinha os itens à direita */
        }
        .btn-filter {
            background: none;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            background-color: var(--card);
            color: var(--text);
        }
        .btn-filter:hover {
            background-color: var(--bg);
            color: var(--primary);
            border-color: var(--primary);
        }
        /* Style for active filter button */
        .btn-filter.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary-dark);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn-filter.active:hover {
            background-color: var(--primary-dark);
            color: white;
        }

        /* View Toggle Buttons */
        .view-toggle-buttons {
            display: flex;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }
        .view-toggle-buttons .btn {
            border-radius: 0; /* Remove rounded corners for individual buttons in the group */
            border: none; /* Remove individual borders */
            padding: 0.6rem 1rem;
            background-color: var(--card);
            color: var(--muted);
            font-weight: 500;
        }
        .view-toggle-buttons .btn:hover {
            background-color: var(--bg);
            color: var(--primary);
        }
        .view-toggle-buttons .btn.active {
            background-color: var(--primary);
            color: white;
            font-weight: 600;
        }
        .view-toggle-buttons .btn.active:hover {
            background-color: var(--primary-dark);
            color: white;
        }
        .view-toggle-buttons .btn:first-child { border-top-left-radius: 7px; border-bottom-left-radius: 7px; }
        .view-toggle-buttons .btn:last-child { border-top-right-radius: 7px; border-bottom-right-radius: 7px; }


        main { 
            flex-grow: 1; 
            padding: 1.5rem; 
            overflow: hidden; /* Adicionado para evitar scroll no main, deixando o scroll para o calendário */
            display: flex; 
            gap: 1.5rem; /* Espaçamento entre o painel esquerdo e o calendário principal */
            height: 100%; /* Ocupa a altura total do main-content */
        }

        /* Novo contêiner para o mini-calendário e a lista de profissionais */
        .left-panel {
            display: flex;
            flex-direction: column; /* Empilha os itens verticalmente */
            gap: 0.75rem; /* Reduzido o espaçamento entre o mini-calendário e a lista de profissionais */
            flex-shrink: 0; /* Evita que o painel encolha */
            max-width: 250px; /* Reduzido a largura fixa para o painel esquerdo de 180px para 150px */
            align-self: flex-start; /* Alinha o painel ao topo do contêiner 'main' */
            flex-grow: 1; /* Permite que o painel cresça para preencher o espaço vertical */
            height: 100%; /* Garante que o painel ocupe a altura total disponível */
        }

        /* ============================================
          --- CALENDÁRIO SEMANAL (NOVO) ---
          ============================================
        */
        .weekly-calendar-container {
            background-color: var(--card);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            flex-grow: 1; /* Ocupa o espaço disponível */
            /* Controlado por JS para display: none; */
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .calendar-header h2 {
            font-size: 1.5rem;
            color: var(--text);
            margin: 0;
        }
        .calendar-nav {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        .calendar-nav span { /* Estilo para o display da semana atual */
            font-weight: 600;
            color: var(--text);
        }
        .calendar-nav select, .calendar-nav button, .btn-filter {
            background: none;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.5rem 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            background-color: var(--card);
            color: var(--text);
        }
        .calendar-nav select:hover, .calendar-nav button:hover, .btn-filter:hover {
            background-color: var(--bg);
            color: var(--primary);
        }

        /* New: Weekly Grid Styles */
        .calendar-grid-week {
            display: grid;
            grid-template-columns: 90px repeat(7, minmax(120px, 1fr)); 
            /* Define a primeira linha (cabeçalhos) com 70px de altura e as demais com min de 40px */
            grid-template-rows: 70px repeat(auto-fill, minmax(40px, auto)); 
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden; /* Contains children within rounded corners */
            flex-grow: 1;
            overflow-y: auto; /* Adiciona rolagem vertical para o calendário */
            /* Ajustado para preencher o espaço disponível dentro do weekly-calendar-container */
            /*height: calc(100% - 90px); /* Altura do cabeçalho do calendário */
        }

        .time-column-header, .day-header-week {
            padding: 1rem 0.5rem; /* Aumentado o padding vertical */
            font-weight: 600;
            text-align: center;
            background-color: var(--bg);
            border-bottom: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
            font-size: 1rem; /* Alterado de 0.85rem para 1rem */
            color: var(--muted);
            display: flex;
            flex-direction: column; /* Para empilhar dia da semana e número */
            align-items: center;
            justify-content: center;
            position: sticky; /* Fixa os cabeçalhos */
            top: 0; /* Fixa no topo do grid-week */
            z-index: 20; /* Garante que fiquem acima dos eventos */
            box-sizing: border-box; /* Adicionado para incluir padding na largura/altura */
        }
        .time-column-header {
            background-color: var(--card); /* Different background for time column header */
            border-right: 1px solid var(--border-color);
            left: 0; /* Fixa a coluna de tempo */
            z-index: 25; /* Maior z-index para a coluna de tempo */
            position: sticky; /* Adicionado para fixar a coluna de tempo */
        }
        .day-header-week:last-child, .time-cell:last-child {
            border-right: none;
        }
        .day-header-week .day-number {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text);
            margin-top: 4px;
            position: relative; /* Necessário para o pseudo-elemento */
            z-index: 1; /* Garante que o número fique acima do círculo */
        }
        .day-header-week.today .day-number {
            color: white; /* Torna o número branco quando destacado */
        }
        /* Adiciona um pseudo-elemento para o círculo azul */
        .day-header-week.today .day-number::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 36px; /* Tamanho do círculo */
            height: 36px; /* Tamanho do círculo */
            background-color: var(--primary); /* Cor azul para o círculo */
            border-radius: 50%;
            z-index: -1; /* Posiciona atrás do número */
        }

        .time-cell {
            padding: 0.5rem 0.5rem;
            font-size: 0.8rem;
            color: var(--muted);
            text-align: right;
            border-right: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            background-color: var(--card);
            position: relative; /* For positioning appointments */
            height: 40px; /* Fixed height for each slot */
            display: flex; /* Use flexbox for alignment */
            align-items: center; /* Center vertically */
            justify-content: flex-end; /* Align to the right */
            padding-right: 10px; /* Add some padding to the right */
        }
        .time-cell span {
            position: static;
            transform: none;
        }

        .event-cell {
            border-right: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            position: relative;
            background-color: var(--card);
            cursor: pointer;
            transition: background-color 0.2s ease;
            overflow: hidden; /* Para garantir que eventos longos não transbordem visualmente */
        }
        .event-cell:hover {
            background-color: var(--bg);
        }

        .appointment-event {
            background-color: color-mix(in srgb, var(--primary) 15%, transparent);
            color: var(--primary-dark);
            border-left: 3px solid var(--primary);
            padding: 2px 5px;
            font-size: 0.75rem;
            border-radius: 4px;
            margin: 1px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            position: absolute;
            height: 18px; /* Fixed height for consistent display */
            line-height: 18px; /* Vertically center text */
            box-sizing: border-box; /* Include padding and border in width/height */
            z-index: 10;
            cursor: pointer;
            transition: all 0.1s ease-out; /* Smooth transitions */
            box-shadow: 0 1px 2px rgba(0,0,0,0.1); /* Subtle shadow */
        }
        .appointment-event.status-concluido { background-color: color-mix(in srgb, var(--status-concluido) 15%, transparent); color: var(--status-concluido); border-left-color: var(--status-concluido); }
        .appointment-event.status-pendente { background-color: color-mix(in srgb, var(--status-pendente) 15%, transparent); color: var(--status-pendente); border-left-color: var(--status-pendente); }
        .appointment-event.status-cancelado { background-color: color-mix(in srgb, var(--status-cancelado) 15%, transparent); color: var(--status-cancelado); border-left-color: var(--status-cancelado); }
        .appointment-event.status-confirmado { background-color: color-mix(in srgb, var(--status-confirmado) 15%, transparent); color: var(--status-confirmado); border-left-color: var(--status-confirmado); }

        /* New style for 'more' indicator */
        .appointment-event.more-indicator {
            background-color: var(--muted); /* A neutral color */
            color: white;
            text-align: center;
            font-weight: 600;
            padding: 2px 5px;
            border-left: none; /* No colored border for indicator */
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .appointment-event.more-indicator:hover {
            background-color: var(--accent);
        }

        /* ============================================
          --- LISTA DE CARDS (NOVO) ---
          ============================================
        */
        .card-list-container {
            background-color: var(--card);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            flex-grow: 1;
            overflow-y: auto; /* Adiciona rolagem vertical para a lista de cards */
            display: none; /* Escondido por padrão, controlado por JS */
            flex-direction: column; /* Garante que os cards se empilhem */
            gap: 1rem; /* Espaçamento entre os cards */
        }

        .appointment-card {
            background-color: var(--card); /* Fundo do card mais claro */
            border-radius: 12px;
            padding: 1.5rem; /* Aumenta o padding para mais espaço */
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 1rem; /* Aumenta o espaçamento interno */
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
            position: relative; /* Para a barra de status */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* Sombra mais pronunciada */
        }
        .appointment-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* Sombra maior no hover */
        }

        .appointment-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 0.75rem; /* Mais padding abaixo do cabeçalho */
            border-bottom: 1px solid var(--border-color);
        }
        .appointment-card-header h4 {
            font-size: 1.4rem; /* Título maior */
            font-weight: 700; /* Negrito */
            color: var(--text); /* Cor do texto principal */
            margin: 0;
        }
        [data-theme="dark"] .appointment-card-header h4 {
            color: var(--dark-text); /* Cor do texto principal no modo escuro */
        }

        .appointment-card-header .status-badge {
            padding: 0.4rem 0.9rem; /* Aumenta o padding do badge */
            border-radius: 9999px; /* Totalmente arredondado */
            font-size: 0.8rem; /* Tamanho da fonte do badge */
            font-weight: 700; /* Negrito */
            color: white;
            text-transform: uppercase; /* Texto em maiúsculas */
            letter-spacing: 0.05em; /* Espaçamento entre letras */
        }
        .appointment-card-header .status-badge.status-confirmado { background-color: var(--status-confirmado); }
        .appointment-card-header .status-badge.status-concluido { background-color: var(--status-concluido); }
        .appointment-card-header .status-badge.status-pendente { background-color: var(--status-pendente); }
        .appointment-card-header .status-badge.status-cancelado { background-color: var(--status-cancelado); }

        .appointment-card-body {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); /* Layout mais flexível */
            gap: 1rem; /* Espaçamento entre os itens do corpo */
            font-size: 0.95rem; /* Tamanho da fonte do corpo */
        }
        .appointment-card-item {
            display: flex;
            align-items: center;
            gap: 0.75rem; /* Espaçamento entre ícone e texto */
            color: var(--text);
        }
        .appointment-card-item i {
            color: var(--muted); 
            font-size: 1.1rem; /* Ícones maiores */
            width: 24px; /* Largura fixa para alinhar ícones */
            text-align: center;
        }
        .appointment-card-item .label {
            font-weight: 600; /* Labels mais fortes */
            color: var(--muted);
        }
        .appointment-card-item .value {
            font-weight: 500; /* Valor normal */
            color: var(--text);
        }
        [data-theme="dark"] .appointment-card-item .value {
            color: var(--dark-text);
        }


        /* ============================================
          --- MODAIS (REUTILIZADOS) ---
          ============================================
        */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 2000; opacity: 0; transition: opacity 0.25s ease; }
        .modal-overlay.active { opacity: 1; display: flex; }
        .modal-content { 
            background-color: var(--card); 
            color: var(--text); 
            border-radius: 16px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); 
            width: 95%; /* Aumentado para 95% */
            max-width: 1200px; /* Aumentado de 1000px para 1200px */
            transform: translateY(-20px); 
            transition: transform 0.25s ease; 
            max-height: calc(100vh - 40px); 
            display: flex; 
            flex-direction: column; 
        }
        .modal-overlay.active .modal-content { transform: translateY(0); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 1.5rem 2rem; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .modal-header h3 { font-size: 1.4rem; color: var(--text); margin: 0; font-weight: 600; }
        .modal-header h3 i { margin-right: 0.75rem; color: var(--primary); }
        .modal-close-btn { background: none; border: none; font-size: 1.5rem; color: var(--muted); cursor: pointer; line-height: 1; transition: color 0.2s ease; }
        .modal-close-btn:hover { color: var(--danger); }
        .modal-body { overflow-y: auto; padding: 2rem; }
        .form-group { margin-bottom: 1.5rem; }
        .form-group:last-child { margin-bottom: 0; }
        .form-group label { display: block; font-size: 0.9rem; color: var(--muted); font-weight: 500; margin-bottom: 0.5rem; }
        .form-group input, .form-group select { font-size: 0.95rem; padding: 0.7rem 0.8rem; width: 100%; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--bg); color: var(--text); transition: border-color 0.2s ease, box-shadow 0.2s ease; }
        .form-group input:focus, .form-group select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary) 20%, transparent); outline: none; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        .modal-footer { padding: 1.5rem 2rem; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 0.75rem; flex-shrink: 0; background-color: var(--bg); }
        
        .form-section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary);
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 1.5rem;
            margin-top: 1.5rem;
        }
        .modal-body .form-section-title:first-of-type {
            margin-top: 0;
        }

        /* New Info Card Styles */
        .info-card { background-color: var(--bg); padding: 1.5rem; border-radius: 8px; }
        .info-card .info-item { display: flex; align-items: flex-start; gap: 1rem; margin-bottom: 1rem; }
        .info-card .info-item:last-child { margin-bottom: 0; }
        .info-card .info-item i { font-size: 1.1rem; color: var(--muted); margin-top: 4px; width: 20px; text-align: center; }
        .info-card .info-item-content .label { font-size: 0.85rem; color: var(--muted); font-weight: 500; }
        .info-card .info-item-content .value { font-size: 1rem; font-weight: 600; color: var(--text); }

        /* Style for the new status select control in details modal */
        .info-card .status-select-control {
            padding: 0.4rem 0.8rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--bg);
            color: var(--text);
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            -webkit-appearance: none; /* Remove default arrow on WebKit browsers */
            -moz-appearance: none;    /* Remove default arrow on Firefox */
            appearance: none;         /* Remove default arrow */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='currentColor'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3E%3C/svg%3E"); /* Custom arrow */
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.25rem;
            width: auto; /* Allow select to size based on content */
            min-width: 150px; /* Ensure a minimum width */
            text-align: left; /* Align text to the left */
        }

        .info-card .status-select-control:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary) 20%, transparent);
            outline: none;
        }
        /* ============================================
          --- BOTÕES ---
          ============================================
        */
        .btn { padding: 0.6rem 1.2rem; font-size: 0.9rem; border-radius: 8px; text-decoration: none; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; border: 1px solid transparent; cursor: pointer; transition: all 0.2s ease-in-out; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: var(--primary-dark); }
        .btn-danger-outline { background-color: transparent; color: var(--danger); border-color: var(--danger); }
        .btn-danger-outline:hover { background-color: var(--danger); color: white; }

        .btn-secondary { background-color: var(--card); color: var(--text); border-color: var(--border-color); box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); }
        [data-theme="dark"] .btn-secondary { background-color: var(--dark-card); border-color: var(--dark-border-color); color: var(--dark-text); }
        
        /* ============================================
          --- RESPONSIVIDADE ---
          ============================================
        */
        @media (max-width: 992px) { /* Ajuste para telas menores que 992px */
            main { flex-direction: column; overflow: auto; }
            .weekly-calendar-container, .card-list-container { padding: 1rem; } /* Reduz o padding do container principal */
            .calendar-header { flex-direction: column; align-items: flex-start; } /* Empilha elementos do cabeçalho */
            .calendar-nav { width: 100%; justify-content: space-between; margin-bottom: 0.5rem; } /* Ocupa largura total */
            .calendar-nav span { flex-grow: 1; text-align: center; } /* Centraliza o display da semana */
            .btn-filter { width: 100%; margin-left: 0; } /* Botão de filtro ocupa largura total */
            
            .calendar-grid-week {
                grid-template-columns: 60px repeat(7, minmax(70px, 1fr)); 
                font-size: 0.75rem;
            }
            .time-column-header, .day-header-week { 
                padding: 0.5rem 0.2rem; 
                font-size: 0.9rem; /* Aumentado de 0.75rem para 0.9rem para telas menores */
            }
            .time-cell { height: 30px; /* Altura menor para slots de tempo */ }
            .appointment-event { font-size: 0.7rem; padding: 1px 3px; }

            .appointment-card-body {
                grid-template-columns: 1fr; /* Empilha itens do card em mobile */
            }
        }

        @media (max-width: 768px) { /* Ajustes para mobile */
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .main-content, .main-content.collapsed { margin-left: 0; }
            main { padding: 1rem; flex-direction: column; } /* Garante que o main empilhe os elementos em mobile */
            .topbar { padding: 0 1rem; }
            .mini-calendar-wrapper { display: none; } /* Esconde o mini-calendário em mobile */
            .form-row { grid-template-columns: 1fr; }
            .professional-list-container { margin-top: 1rem; } /* Adiciona espaçamento em mobile */
            .topbar-right {
                flex-direction: column; /* Empilha botões em mobile */
                align-items: stretch; /* Estica botões para largura total */
                gap: 0.5rem;
            }
            .topbar-right .btn, .topbar-right .view-toggle-buttons {
                width: 100%; /* Ocupa largura total */
            }
            .view-toggle-buttons {
                border-radius: 8px; /* Mantém bordas arredondadas para o grupo */
            }
            .view-toggle-buttons .btn:first-child { border-radius: 8px 0 0 8px; }
            .view-toggle-buttons .btn:last-child { border-radius: 0 8px 8px 0; }
            
            /* Ajuste da modal para telas menores */
            .modal-content {
                width: 95%; /* Garante que a modal ocupe a maior parte da largura em telas menores */
                max-width: 95%; /* Limita a largura máxima para não estourar a tela */
            }
        }

        /* ============================================
          --- MINI CALENDÁRIO LATERAL (NOVO) ---
          ============================================
        */
        .mini-calendar-wrapper {
            /* Removido: width: 350px; - agora controlado por .left-panel */
            /* Removido: align-self: flex-start; - agora controlado por .left-panel */
            background-color: var(--card); 
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 0.75rem; 
            flex-shrink: 0; 
            z-index: 500; 
        }

        .mini-calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem; 
            color: var(--text); 
            font-weight: 600;
            font-size: 0.9rem; 
        }

        .mini-calendar-header button {
            background: none;
            border: none;
            color: var(--muted); 
            font-size: 0.9rem; 
            cursor: pointer;
            padding: 0.2rem;
            border-radius: 50%; 
            transition: background-color 0.2s ease, color 0.2s ease;
            width: 24px; 
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .mini-calendar-header button:hover {
            background-color: var(--bg); 
            color: var(--primary); 
        }

        .mini-calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            font-size: 0.7rem; 
            text-align: center;
        }

        .mini-calendar-day-header {
            color: var(--muted); 
            font-weight: 500;
            padding: 0.2rem;
        }

        .mini-calendar-day {
            padding: 0.3rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
            color: var(--text); 
            font-weight: 500;
            height: 28px; 
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mini-calendar-day.other-month {
            color: var(--muted); 
            opacity: 0.6;
        }

        .mini-calendar-day:hover {
            background-color: var(--bg); 
        }

        .mini-calendar-day.selected {
            background-color: var(--primary); 
            color: white; 
            font-weight: 700;
        }
        .mini-calendar-day.current-day {
            background-color: var(--secondary); 
            color: white;
            font-weight: 700;
        }

        /* --- Estilos para Notificações Toast (MELHORADO) --- */
        .toast-container {
            position: fixed;
            top: 85px; /* Abaixo do topbar */
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 360px;
        }

        .toast {
            background-color: var(--card);
            color: var(--text);
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1), 0 5px 5px rgba(0,0,0,0.05);
            display: flex;
            align-items: flex-start; /* Alinha ícone ao topo do texto */
            gap: 1rem;
            border: 1px solid var(--border-color);
            animation: toast-slide-in 0.5s cubic-bezier(0.215, 0.610, 0.355, 1.000);
            position: relative;
            overflow: hidden; /* Para a barra de progresso */
        }

        .toast.success { border-left: 5px solid var(--success); }
        .toast.danger { border-left: 5px solid var(--danger); }
        .toast.warning { border-left: 5px solid var(--warning); }
        .toast.info { border-left: 5px solid var(--info); }

        .toast-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
            margin-top: 2px;
        }
        .toast.success .toast-icon { color: var(--success); }
        .toast.danger .toast-icon { color: var(--danger); }
        .toast.warning .toast-icon { color: var(--warning); }
        .toast.info .toast-icon { color: var(--info); }

        .toast-content {
            flex-grow: 1;
        }
        .toast-title {
            font-weight: 700;
            font-size: 1rem;
            color: var(--text);
            display: block;
            margin-bottom: 0.25rem;
        }
        .toast-message {
            font-size: 0.9rem;
            color: var(--muted);
            line-height: 1.4;
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--muted);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            opacity: 0.7;
            transition: opacity 0.2s ease, color 0.2s ease;
            flex-shrink: 0;
        }
        .toast-close:hover {
            opacity: 1;
            color: var(--text);
        }

        .toast-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 4px;
            width: 100%;
            animation: toast-progress-bar 5s linear forwards;
        }
        .toast.success .toast-progress { background-color: var(--success); }
        .toast.danger .toast-progress { background-color: var(--danger); }
        .toast.warning .toast-progress { background-color: var(--warning); }
        .toast.info .toast-progress { background-color: var(--info); }


        @keyframes toast-slide-in {
            from {
                opacity: 0;
                transform: translateX(110%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes toast-fade-out {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-20px);
            }
        }
        .toast.fade-out {
            animation: toast-fade-out 0.4s ease-in forwards;
        }

        @keyframes toast-progress-bar {
            from { width: 100%; }
            to { width: 0%; }
        }

        /* Novas Regras para a Modal de Notificações */
        .notification-modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 2100; /* Higher than other modals */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.6); /* Black w/ opacity */
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.25s ease;
        }
        .notification-modal.active {
            opacity: 1;
            display: flex;
        }
        .notification-modal-content {
            background-color: var(--card);
            color: var(--text);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 500px;
            transform: translateY(-20px);
            transition: transform 0.25s ease;
            position: relative;
            text-align: center;
        }
        .notification-modal.active .notification-modal-content {
            transform: translateY(0);
        }
        .notification-modal-close-button {
            color: var(--muted);
            font-size: 1.8rem;
            font-weight: bold;
            position: absolute;
            top: 15px;
            right: 20px;
            cursor: pointer;
            transition: color 0.2s ease;
        }
        .notification-modal-close-button:hover,
        .notification-modal-close-button:focus {
            color: var(--danger);
            text-decoration: none;
        }
        .notification-modal-title {
            font-size: 1.6rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--primary); /* Cor do título da notificação */
        }
        .notification-modal-message {
            font-size: 1.1rem;
            color: var(--text);
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }
        .notification-modal-button {
            background-color: var(--primary);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .notification-modal-button:hover {
            background-color: var(--primary-dark);
        }

        /* Estilos para a nova lista de profissionais */
        .professional-list-container {
            /* Removido: width: 350px; - agora controlado por .left-panel */
            /* Removido: margin-top: 1.5rem; - agora controlado por .left-panel */
            /* Removido: align-self: flex-start; - agora controlado por .left-panel */
            background-color: var(--card);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1rem;
            overflow-y: auto; /* Adiciona rolagem se a lista for muito longa */
            /* Removido: max-height: 300px; */
            flex-grow: 1; /* Permite que este contêiner cresça para preencher o espaço restante */
        }

        .professional-list-container h4 {
            font-size: 1rem;
            color: var(--text);
            margin-bottom: 0.75rem;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }

        .professional-list-item {
            display: flex;
            align-items: center;
            padding: 0.6rem 0.8rem;
            margin-bottom: 0.4rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
            color: var(--text);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .professional-list-item:hover {
            background-color: var(--bg);
            color: var(--primary);
        }

        .professional-list-item.selected {
            background-color: var(--primary);
            color: white;
            font-weight: 700;
        }
        .professional-list-item.selected:hover {
            background-color: var(--primary-dark);
        }

        /* Styles for recurring appointment section */
        .recurring-options {
            display: none; /* Hidden by default */
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }

        .day-checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .day-checkbox-group label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            font-weight: normal; /* Override form-group label default */
            color: var(--text);
        }

        .day-checkbox-group input[type="checkbox"] {
            width: auto;
            margin: 0;
            transform: scale(1.2); /* Make checkbox slightly larger */
            accent-color: var(--primary); /* Change checkbox color */
        }

        /* New class for consistent input styling */
        .form-input {
            font-size: 0.95rem;
            padding: 0.7rem 0.8rem;
            width: 100%;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--bg);
            color: var(--text);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .form-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary) 20%, transparent);
            outline: none;
        }
    </style>
</head>
<body>
    <div id="toast-container"></div>
    <div class="layout">
        <aside class="sidebar">
            <div class="sidebar-inner-content">
                <div class="sidebar-header">
                    <a href="{{ url_for('index') }}" class="logo">
                        <i class="fa-solid fa-staff-snake"></i> <span>{{ session.clinica_nome_display or 'ClínicaOn' }}</span>
                    </a>
                </div>
                <nav>
                    <ul>
                        <li><a href="{{ url_for('index') }}"><i class="fa-solid fa-house-chimney"></i> <span>Dashboard</span></a></li>
                        <li><a href="{{ url_for('listar_pacientes') }}"><i class="fa-solid fa-hospital-user"></i> <span>Pacientes</span></a></li>
                        <li><a href="{{ url_for('buscar_prontuario') }}"><i class="fa-solid fa-notes-medical"></i> <span>Prontuários</span></a></li>
                        <li><a href="{{ url_for('listar_profissionais') }}"><i class="fa-solid fa-user-doctor"></i> <span>Profissionais</span></a></li>
                        <li><a href="{{ url_for('listar_servicos_procedimentos') }}"><i class="fa-solid fa-syringe"></i> <span>Serviços/Proc.</span></a></li>
                        <li><a href="{{ url_for('listar_convenios') }}"><i class="fa-solid fa-handshake"></i> <span>Convênios</span></a></li>
                        <li><a href="{{ url_for('listar_horarios') }}"><i class="fa-regular fa-clock"></i> <span>Horários</span></a></li>
                        <li class="active"><a href="{{ url_for('listar_agendamentos') }}"><i class="fa-regular fa-calendar-check"></i> <span>Agendamentos</span></a></li>
                        {% if session.user_role == 'admin' %}
                        <li><a href="{{ url_for('listar_usuarios') }}"><i class="fa-solid fa-users-gear"></i> <span>Utilizadores</span></a></li>
                        <li><a href="{{ url_for('listar_modelos_anamnese') }}"><i class="fa-regular fa-file-lines"></i> <span>Modelos Anamnese</span></a></li>
                        <li><a href="{{ url_for('listar_estoque') }}"><i class="fa-solid fa-boxes-stacked"></i> <span>Estoque</span></a></li>
                        <li><a href="{{ url_for('listar_contas_a_pagar') }}"><i class="fa-solid fa-money-bill-wave"></i> <span>Contas a Pagar</span></a></li>
                        <li><a href="{{ url_for('patrimonio.listar_patrimonio') }}"><i class="fa-solid fa-building-columns"></i> <span>Patrimônio</span></a></li>
                        {% endif %}
                    </ul>
                </nav>
                <div class="sidebar-footer">
                    <button id="theme-toggle" aria-label="Alternar tema">
                        <i class="fa-solid fa-sun"></i> <span>Alternar Tema</span>
                    </button>
                    <a href="#" id="logoutButton"><i class="fa-solid fa-arrow-right-from-bracket"></i> <span>Sair</span></a>
                </div>
            </div>
        </aside>

        <div class="main-content">
            <header class="topbar">
                <div class="topbar-left">
                    <button class="toggle-btn menu-btn-mobile"><i class="fa-solid fa-bars"></i></button>
                    <button class="toggle-btn toggle-btn-desktop"><i class="fa-solid fa-bars-staggered"></i></button>
                    <h1 class="page-title">Agendamentos</h1>
                </div>
                <div class="topbar-right">
                    <!-- Botões de Alternar Visualização -->
                    <div class="view-toggle-buttons">
                        <button id="calendarViewBtn" class="btn active"><i class="fas fa-calendar-alt"></i> Calendário</button>
                        <button id="listViewBtn" class="btn"><i class="fas fa-list"></i> Lista</button>
                    </div>
                    <button type="button" class="btn btn-primary" id="addManualAppointmentBtn">
                        <i class="fas fa-plus"></i> <span class="btn-text-desktop">Novo Agendamento</span>
                    </button>
                </div>
            </header>

            <main>
                <div class="left-panel">
                    <!-- Mini Calendário Lateral (Movido para o main) -->
                    <div class="mini-calendar-wrapper">
                        <div class="mini-calendar-header">
                            <button id="mini-prev-month-btn"><i class="fas fa-chevron-left"></i></button>
                            <span id="mini-current-month-year"></span>
                            <button id="mini-next-month-btn"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        <div class="mini-calendar-grid" id="mini-calendar-grid">
                            <!-- Dias da semana e números serão gerados aqui via JS -->
                        </div>
                    </div>

                    <!-- Novo Contêiner para a Lista de Profissionais -->
                    <div class="professional-list-container">
                        <h4>Filtrar por Profissional</h4>
                        <div id="professional-filter-list">
                            <!-- A lista de profissionais será gerada aqui via JS -->
                        </div>
                    </div>
                </div>

                <!-- Contêiner para a Visualização de Calendário -->
                <div id="calendarViewContainer" class="weekly-calendar-container">
                    <div class="calendar-header">
                        <div class="calendar-nav">
                            <button id="prev-week-btn" title="Semana Anterior"><i class="fas fa-chevron-left"></i></button>
                            <span id="current-week-display" class="font-semibold text-lg text-gray-800 dark:text-gray-200"></span>
                            <button id="next-week-btn" title="Próxima Semana"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                    <div class="calendar-grid-week" id="calendar-grid-week">
                        <!-- Cabeçalhos dos dias e horários serão gerados aqui via JS -->
                    </div>
                </div>

                <!-- Contêiner para a Visualização de Lista/Cards -->
                <div id="listViewContainer" class="card-list-container">
                    <!-- Os cards de agendamento serão gerados aqui via JS -->
                </div>
            </main>
        </div>
    </div>

    <!-- Modal de Detalhes do Agendamento -->
    <div class="modal-overlay" id="modalDetalhesAgendamento">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fa-solid fa-calendar-check" style="color: var(--info);"></i> Detalhes do Agendamento</h3>
                <button type="button" class="modal-close-btn" data-close>&times;</button>
            </div>
            <div class="modal-body">
                <div class="info-card" id="infoCardAgendamento">
                    <!-- Conteúdo preenchido via JS -->
                </div>
            </div>
            <div class="modal-footer" style="justify-content: space-between;">
                <button type="button" class="btn btn-danger-outline" id="btnApagarAgendamento"><i class="fas fa-trash"></i> Apagar Registro</button>
                <button type="button" class="btn btn-primary" id="btnEditarAgendamento"><i class="fas fa-edit"></i> Editar Registro</button>
            </div>
        </div>
    </div>

    <!-- Modal de Registro/Edição Manual de Agendamento -->
    <div class="modal-overlay" id="modalRegistroManual">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('registrar_atendimento_manual') }}" id="formRegistroManual">
                <input type="hidden" name="agendamento_id" id="agendamento_id_manual">
                <div class="modal-header">
                    <h3 id="modalRegistroManualTitle"><i class="fa-solid fa-calendar-plus"></i> Registrar Atendimento</h3>
                    <button type="button" class="modal-close-btn" data-close>&times;</button>
                </div>
                <div class="modal-body">
                    <h4 class="form-section-title">Informações do Paciente</h4>
                    <div class="form-group">
                        <label for="paciente_id_manual">Paciente Existente</label>
                        <select id="paciente_id_manual" name="paciente_id" class="form-input">
                            <option value="">-- Selecione ou cadastre um novo abaixo --</option>
                            {% for paciente in pacientes_para_filtro %}
                                <option value="{{ paciente.id }}" data-telefone="{{ paciente.contato_telefone or '' }}">{{ paciente.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="cliente_nome_manual">Selecione o paciente ou digite o nome</label>
                            <input type="text" id="cliente_nome_manual" name="cliente_nome_manual" placeholder="Digite se for um novo paciente" class="form-input">
                        </div>
                        <div class="form-group">
                            <label for="cliente_telefone_manual">Telefone</label>
                            <input type="tel" id="cliente_telefone_manual" name="cliente_telefone_manual" placeholder="(XX) XXXXX-XXXX" class="form-input">
                        </div>
                    </div>

                    <h4 class="form-section-title">Detalhes do Agendamento</h4>
                    <div class="form-group">
                        <label for="profissional_id_manual">Profissional</label>
                        <select id="profissional_id_manual" name="barbeiro_id_manual" required class="form-input">
                        <option value="">Selecione o profissional</option>
                            {% for professional in profissionais_para_filtro %} 
                            <option value="{{ professional.id }}">{{ professional.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="servico_id_manual">Serviço/Procedimento</label>
                        <select id="servico_id_manual" name="servico_id_manual" required class="form-input">
                            <option value="">Selecione o serviço/procedimento</option>
                            {% for servico_proc in servicos_ativos %} 
                            <option value="{{ servico_proc.id }}" data-preco="{{ servico_proc.preco|float }}">{{ servico_proc.nome }} (R$ {{ "%.2f"|format(servico_proc.preco|float) }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="data_agendamento_manual">Data</label>
                            <input type="date" id="data_agendamento_manual" name="data_agendamento_manual" required class="form-input">
                        </div>
                        <div class="form-group">
                            <label for="hora_agendamento_manual">Hora</labeL>
                            <input type="time" id="hora_agendamento_manual" name="hora_agendamento_manual" required class="form-input">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="preco_manual">Preço (R$)</label>
                            <input type="number" id="preco_manual" name="preco_manual" step="0.01" min="0" required readonly class="form-input">
                        </div>
                        <div class="form-group">
                            <label for="status_manual">Status</label>
                            <select id="status_manual" name="status_manual" required class="form-input">
                                <option value="confirmado" selected>Confirmado</option>
                                <option value="concluido">Concluido</option>
                                <option value="pendente">Pendente</option>
                                <option value="cancelado">Cancelado</option>
                            </select>
                        </div>
                    </div>

                    <!-- New: Recurring Appointment Options -->
                    <div class="form-group">
                        <label for="recorrente_checkbox" class="flex items-center gap-2 font-semibold text-gray-800 dark:text-gray-200 cursor-pointer">
                            <input type="checkbox" id="recorrente_checkbox" name="recorrente_checkbox" value="true" class="w-auto h-auto transform scale-125 accent-primary">
                            Agendamento Recorrente
                        </label>
                    </div>

                    <div id="recurringOptions" class="recurring-options">
                        <h4 class="form-section-title">Opções de Recorrência</h4>
                        <div class="form-group">
                            <label class="block text-sm text-gray-600 dark:text-gray-400 font-medium mb-2">Repetir em:</label>
                            <div class="day-checkbox-group">
                                <label class="flex items-center gap-1 cursor-pointer text-gray-800 dark:text-gray-200"><input type="checkbox" name="dias_semana" value="1" class="w-auto h-auto transform scale-110 accent-primary"> Segunda</label>
                                <label class="flex items-center gap-1 cursor-pointer text-gray-800 dark:text-gray-200"><input type="checkbox" name="dias_semana" value="2" class="w-auto h-auto transform scale-110 accent-primary"> Terça</label>
                                <label class="flex items-center gap-1 cursor-pointer text-gray-800 dark:text-gray-200"><input type="checkbox" name="dias_semana" value="3" class="w-auto h-auto transform scale-110 accent-primary"> Quarta</label>
                                <label class="flex items-center gap-1 cursor-pointer text-gray-800 dark:text-gray-200"><input type="checkbox" name="dias_semana" value="4" class="w-auto h-auto transform scale-110 accent-primary"> Quinta</label>
                                <label class="flex items-center gap-1 cursor-pointer text-gray-800 dark:text-gray-200"><input type="checkbox" name="dias_semana" value="5" class="w-auto h-auto transform scale-110 accent-primary"> Sexta</label>
                                <label class="flex items-center gap-1 cursor-pointer text-gray-800 dark:text-gray-200"><input type="checkbox" name="dias_semana" value="6" class="w-auto h-auto transform scale-110 accent-primary"> Sábado</label>
                                <label class="flex items-center gap-1 cursor-pointer text-gray-800 dark:text-gray-200"><input type="checkbox" name="dias_semana" value="0" class="w-auto h-auto transform scale-110 accent-primary"> Domingo</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="data_fim_recorrencia">Data de Fim da Recorrência</label>
                            <input type="date" id="data_fim_recorrencia" name="data_fim_recorrencia" class="form-input">
                        </div>
                    </div>
                    <!-- End New: Recurring Appointment Options -->

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-close>Cancelar</button>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Formulário para Apagar Agendamento (escondido) -->
    <form id="formApagarAgendamento" method="POST" action="{{ url_for('apagar_agendamento') }}" style="display: none;">
        <input type="hidden" name="agendamento_id" id="agendamento_id_apagar">
    </form>

    <!-- Modal de Múltiplos Agendamentos no Mesmo Horário -->
    <div class="modal-overlay" id="modalMultiAgendamentos">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fa-solid fa-calendar-days" style="color: var(--primary);"></i> Agendamentos no Slot</h3>
                <button type="button" class="modal-close-btn" data-close-multi>&times;</button>
            </div>
            <div class="modal-body" id="multiAppointmentsList">
                <!-- Lista de agendamentos será preenchida aqui via JS -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-close-multi>Fechar</button>
            </div>
        </div>
    </div>

    <!-- The Notification Modal -->
    <div id="notificationModal" class="notification-modal">
        <!-- Modal content -->
        <div class="notification-modal-content">
            <span class="notification-modal-close-button">&times;</span>
            <h3 id="notificationModalTitle" class="notification-modal-title"></h3>
            <p id="notificationModalMessage" class="notification-modal-message"></p>
            <button onclick="closeNotificationModal()" class="notification-modal-button">Fechar</button>
        </div>
    </div>

    <script type="module">
        // Placeholder para Firebase, caso não esteja configurado no ambiente Canvas
        const FAKE_FIREBASE = {
            initializeApp: () => ({}),
            getAuth: () => ({ currentUser: null, signOut: () => new Promise(res => res()) })
        };
        const { initializeApp } = FAKE_FIREBASE;
        const { getAuth, signOut: firebaseSignOut } = FAKE_FIREBASE;
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        let auth = getAuth(initializeApp(firebaseConfig));


        document.addEventListener('DOMContentLoaded', () => {
            const htmlEl = document.documentElement;
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            const menuBtnMobile = document.querySelector('.menu-btn-mobile');
            const toggleBtnDesktop = document.querySelector('.toggle-btn-desktop');
            const themeToggle = document.getElementById('theme-toggle');
            const logoutButton = document.getElementById('logoutButton');

            // --- Lógica para Notificações Toast (mantida, mas não usada para flash messages) ---
            const toastContainer = document.getElementById('toast-container');
            function showToast(message, category = 'info') {
                if (!toastContainer) return;

                const toast = document.createElement('div');
                toast.className = `toast ${category}`;
                
                let iconClass = 'fa-solid fa-circle-info';
                let title = 'Informação';
                if (category === 'success') {
                    iconClass = 'fa-solid fa-check-circle';
                    title = 'Sucesso';
                }
                if (category === 'danger') {
                    iconClass = 'fa-solid fa-times-circle';
                    title = 'Erro';
                }
                if (category === 'warning') {
                    iconClass = 'fa-solid fa-exclamation-triangle';
                    title = 'Atenção';
                }

                toast.innerHTML = `
                    <div class="toast-icon">
                        <i class="${iconClass}"></i>
                    </div>
                    <div class="toast-content">
                        <strong class="toast-title">${title}</strong>
                        <span class="toast-message">${message}</span>
                    </div>
                    <button class="toast-close">&times;</button>
                    <div class="toast-progress"></div>
                `;
                
                toastContainer.appendChild(toast);

                const closeButton = toast.querySelector('.toast-close');
                closeButton.addEventListener('click', () => {
                    toast.classList.add('fade-out');
                    toast.addEventListener('animationend', () => toast.remove());
                });

                setTimeout(() => {
                    toast.classList.add('fade-out');
                    toast.addEventListener('animationend', () => toast.remove());
                }, 5000); // A notificação desaparece após 5 segundos
            }

            // --- Lógica para a Nova Modal de Notificações ---
            const notificationModal = document.getElementById("notificationModal");
            const notificationModalTitle = document.getElementById("notificationModalTitle");
            const notificationModalMessage = document.getElementById("notificationModalMessage");
            const notificationModalCloseButton = document.querySelector(".notification-modal-close-button");

            // Function to open the notification modal with a specific message and title
            window.openNotificationModal = function(title, message, category = 'info') {
                notificationModalTitle.innerText = title;
                notificationModalMessage.innerText = message;
                
                // Set title color based on category
                if (category === 'success') {
                    notificationModalTitle.style.color = 'var(--success)';
                } else if (category === 'danger') {
                    notificationModalTitle.style.color = 'var(--danger)';
                } else if (category === 'warning') {
                    notificationModalTitle.style.color = 'var(--warning)';
                } else {
                    notificationModalTitle.style.color = 'var(--primary)'; // Default or info
                }

                notificationModal.classList.add('active');
            }

            // Function to close the notification modal
            window.closeNotificationModal = function() {
                notificationModal.classList.remove('active');
            }

            // When the user clicks on <span> (x), close the modal
            if (notificationModalCloseButton) {
                notificationModalCloseButton.onclick = function() {
                    closeNotificationModal();
                }
            }

            // When the user clicks anywhere outside of the modal, close it
            if (notificationModal) {
                notificationModal.addEventListener('click', function(event) {
                    if (event.target === notificationModal) {
                        closeNotificationModal();
                    }
                });
            }

            // --- Processa mensagens flash do backend e as exibe na MODAL ---
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% for category, message in messages %}
                    // Use a nova função openNotificationModal para as mensagens flash
                    openNotificationModal(
                        "{{ 'Sucesso!' if category == 'success' else ('Erro!' if category == 'error' else ('Atenção!' if category == 'warning' else 'Informação')) }}",
                        {{ message|tojson|safe }},
                        "{{ category }}"
                    );
                {% endfor %}
            {% endwith %}


            // --- Sidebar Logic (reused) ---
            function setupSidebar() {
                if (!sidebar || !mainContent) return;
                const updateDesktopToggleIcon = () => {
                    if (!toggleBtnDesktop) return;
                    const icon = toggleBtnDesktop.querySelector('i'); /* Corrigido: toggleBtnBtnDesktop para toggleBtnDesktop */
                    icon.className = sidebar.classList.contains('collapsed') ? 'fa-solid fa-bars' : 'fa-solid fa-bars-staggered';
                };
                const applyInitialState = () => {
                    if (window.innerWidth > 768) {
                        if (localStorage.getItem('sidebarCollapsed') === 'true') {
                            sidebar.classList.add('collapsed');
                            mainContent.classList.add('collapsed');
                        }
                    } else {
                        sidebar.classList.remove('open', 'collapsed');
                        mainContent.classList.remove('collapsed');
                    }
                    updateDesktopToggleIcon();
                };
                if (toggleBtnDesktop) {
                    toggleBtnDesktop.addEventListener('click', () => {
                        sidebar.classList.toggle('collapsed');
                        mainContent.classList.toggle('collapsed');
                        localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
                        updateDesktopToggleIcon();
                    });
                }
                if (menuBtnMobile) {
                    menuBtnMobile.addEventListener('click', (e) => { /* Corrigido: de menu_btn_mobile para menuBtnMobile */
                        e.stopPropagation();
                        sidebar.classList.toggle('open');
                    });
                }
                document.addEventListener('click', (e) => {
                    if (window.innerWidth <= 768 && sidebar.classList.contains('open') && !sidebar.contains(e.target) && !menuBtnMobile.contains(e.target)) {
                        sidebar.classList.remove('open');
                    }
                });
                applyInitialState();
                window.addEventListener('resize', applyInitialState);
            }

            // --- Theme Logic (reused) ---
            function setupTheme() {
                if (!themeToggle) return;
                const updateThemeUI = (theme) => {
                    htmlEl.setAttribute('data-theme', theme);
                    const icon = themeToggle.querySelector('i');
                    icon.className = theme === 'dark' ? 'fa-solid fa-moon' : 'fa-solid fa-sun';
                };
                const currentTheme = localStorage.getItem('theme') || 'light';
                updateThemeUI(currentTheme);
                themeToggle.addEventListener('click', () => {
                    const newTheme = htmlEl.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
                    localStorage.setItem('theme', newTheme);
                    updateThemeUI(newTheme);
                });
            }

            // --- Logout Logic (reused) ---
            function setupLogout() {
                if (!logoutButton) return;
                logoutButton.addEventListener('click', async (event) => {
                    event.preventDefault();
                    fetch("{{ url_for('logout') }}", { method: 'POST' })
                        .then(() => window.location.href = "{{ url_for('login_page') }}")
                        .catch(() => window.location.href = "{{ url_for('login_page') }}");
                });
            }

            // Function to parse URL parameters
            function getUrlParameter(name) {
                name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
                var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
                var results = regex.exec(location.search);
                return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
            };

            // Initialize dates based on URL parameters or current date
            let initialDataInicio = getUrlParameter('data_inicio');
            let initialDate;

            if (initialDataInicio) {
                // Parse the date from the URL parameter (e.g., "2023-10-01")
                // Add 'T00:00:00' to ensure it's parsed as local time to avoid timezone issues
                initialDate = new Date(initialDataInicio + 'T00:00:00');
            } else {
                initialDate = new Date(); // Default to current date if no parameter
            }

            // Variáveis globais para o calendário e agendamentos
            let currentWeekStart = getMonday(initialDate); // Começa na semana da data inicial
            let currentMiniCalendarDate = new Date(initialDate.getFullYear(), initialDate.getMonth(), 1); // Primeiro dia do mês da data inicial
            let currentFilterMonth = new Date(initialDate.getFullYear(), initialDate.getMonth(), 1); // Primeiro dia do mês da data inicial

            // CORREÇÃO: Função para obter a segunda-feira da semana de uma data, tratando corretamente o fuso horário.
            function getMonday(d) {
                d = new Date(d);
                d.setHours(12, 0, 0, 0); // Define a hora para o meio-dia para evitar problemas de fuso horário perto da meia-noite.
                const day = d.getDay();
                const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Ajusta para o domingo ser o último dia da semana.
                const monday = new Date(d.setDate(diff));
                monday.setHours(0, 0, 0, 0); // Reseta a hora para o início do dia.
                return monday;
            }
            // currentWeekStart é inicializado acima com base em initialDate

            // Dados de agendamentos e profissionais passados pelo Jinja2
            const allAppointments = {{ agendamentos | tojson | safe }};
            const allProfessionalsForFilter = {{ profissionais_para_filtro | tojson | safe }};
            const allPatientsForFilter = {{ pacientes_para_filtro | tojson | safe }}; // Adicionado para o modal

            let professionalFilterId = "{{ filtros_atuais.profissional_id or '' }}"; // Filtro inicial do backend

            // Mapeia o dia da semana de número para nome
            const dayNames = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
            const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];

            // Elementos de visualização
            const calendarViewBtn = document.getElementById('calendarViewBtn');
            const listViewBtn = document.getElementById('listViewBtn');
            const calendarViewContainer = document.getElementById('calendarViewContainer');
            listViewContainer.style.display = 'none'; // Esconde a lista por padrão
            const listViewContainerInitialDisplay = listViewContainer.style.display;


            // Estado da visualização atual
            let currentView = localStorage.getItem('appointmentView') || 'calendar'; // Padrão é 'calendar'

            // Função para alternar a visualização
            function switchView(view) {
                currentView = view;
                localStorage.setItem('appointmentView', view);

                if (view === 'calendar') {
                    calendarViewContainer.style.display = 'flex';
                    listViewContainer.style.display = 'none';
                    calendarViewBtn.classList.add('active');
                    listViewBtn.classList.remove('active');
                    renderWeeklyGrid(currentWeekStart); // Re-renderiza o calendário para garantir que esteja atualizado
                } else {
                    calendarViewContainer.style.display = 'none';
                    listViewContainer.style.display = 'flex';
                    calendarViewBtn.classList.remove('active');
                    listViewBtn.classList.add('active');
                    renderCardView(); // Re-renderiza a lista de cards
                }
            }

            // Função para formatar o intervalo de datas da semana
            function formatDateRange(start, end) {
                const formatOptions = { month: 'short', day: 'numeric' };
                const startStr = start.toLocaleDateString('pt-BR', formatOptions);
                const endStr = end.toLocaleDateString('pt-BR', formatOptions);
                const year = start.getFullYear();
                return `${startStr} - ${endStr} ${year}`;
            }

            // Função principal para renderizar a grade semanal
            function renderWeeklyGrid(weekStartDate) {
                const calendarGridWeek = document.getElementById('calendar-grid-week');
                const currentWeekDisplay = document.getElementById('current-week-display');
                
                calendarGridWeek.innerHTML = ''; // Limpa a grade existente

                console.log('renderWeeklyGrid called for week starting:', weekStartDate.toISOString().split('T')[0]);
                console.log('Current filter month for weekly grid (from mini-calendar):', currentFilterMonth.toISOString().split('T')[0]);

                // Define as colunas do grid: 90px para a coluna de tempo, e 7 colunas flexíveis para os dias
                calendarGridWeek.style.gridTemplateColumns = '90px repeat(7, minmax(120px, 1fr))'; // Aumentado min-width para 120px
                // A altura da primeira linha (cabeçalhos) é 70px, e as demais linhas de horários têm min de 40px
                calendarGridWeek.style.gridTemplateRows = '70px repeat(auto-fill, minmax(40px, auto));'; 

                // Cria o cabeçalho da grade (dias da semana)
                const cornerHeader = document.createElement('div');
                cornerHeader.className = 'time-column-header border-none';
                calendarGridWeek.appendChild(cornerHeader);

                const days = [];
                for (let i = 0; i < 7; i++) {
                    const currentDay = new Date(weekStartDate);
                    currentDay.setDate(weekStartDate.getDate() + i);
                    days.push(currentDay);

                    const dayHeader = document.createElement('div');
                    dayHeader.className = 'day-header-week';
                    dayHeader.innerHTML = `${dayNames[currentDay.getDay()]}. <span class="day-number">${currentDay.getDate()}</span>`;
                    if (currentDay.toDateString() === new Date().toDateString()) {
                        dayHeader.classList.add('today'); // Adiciona classe para destacar o dia atual
                    }
                    calendarGridWeek.appendChild(dayHeader); // Adiciona a linha de cabeçalho ao grid
                }

                // Horários (das 00:00 às 23:30, em intervalos de 30 minutos)
                for (let hour = 0; hour < 24; hour++) { // Loop para todas as 24 horas
                    for (let minute = 0; minute < 60; minute += 30) {
                        const timeStr = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
                        
                        // Célula da coluna de tempo
                        const timeCell = document.createElement('div');
                        timeCell.className = 'time-cell';
                        timeCell.innerHTML = `<span>${timeStr}</span>`;
                        calendarGridWeek.appendChild(timeCell);

                        // Células de eventos para cada dia da semana
                        days.forEach(day => {
                            const eventCell = document.createElement('div');
                            eventCell.className = 'event-cell';
                            const dateString = day.toISOString().split('T')[0]; // Formato-MM-dd
                            eventCell.dataset.date = dateString;
                            eventCell.dataset.time = timeStr;

                            // Filtra agendamentos para este slot específico e para o profissional selecionado.
                            // A restrição de mês foi removida para exibir agendamentos de meses adjacentes na semana.
                            const appointmentsInSlot = allAppointments.filter(app => {
                                const matchesDate = app.data_agendamento === dateString;
                                const matchesTime = app.hora_agendamento === timeStr;
                                const matchesProfessional = !professionalFilterId || app.profissional_id === professionalFilterId;
                                
                                return matchesDate && matchesTime && matchesProfessional;
                            });

                            // Sort appointments for consistent horizontal order
                            appointmentsInSlot.sort((a, b) => a.paciente_nome.localeCompare(b.paciente_nome)); // Sort alphabetically by patient name

                            const maxVisibleHorizontalEvents = 3; // Max events to show side-by-side before "+X mais"
                            const overlapWidth = 8; // Pixels of visual overlap between events

                            // Calculate the effective width for each event
                            let numEventsToRender = Math.min(appointmentsInSlot.length, maxVisibleHorizontalEvents);
                            let singleEventWidth;

                            if (numEventsToRender === 0) {
                                singleEventWidth = '100%'; // No events, this won't be used
                            } else {
                                // Calculate width to fit events with overlap
                                // Total width available for events (100% of cell width)
                                // minus the total overlap for N-1 events
                                // divided by N events.
                                singleEventWidth = `calc((100% - ${overlapWidth * (numEventsToRender - 1)}px) / ${numEventsToRender})`;
                            }


                            appointmentsInSlot.forEach((app, index) => {
                                if (index < maxVisibleHorizontalEvents) {
                                    const appElement = document.createElement('div');
                                    appElement.className = `appointment-event status-${app.status}`;
                                    appElement.textContent = `${app.paciente_nome}`; 
                                    appElement.dataset.appointmentId = app.id;

                                    appElement.style.top = `0px`;
                                    appElement.style.width = singleEventWidth;
                                    appElement.style.left = `calc(${index} * (${singleEventWidth} - ${overlapWidth}px))`; // Position based on calculated width and overlap
                                    appElement.style.zIndex = 10 + index;

                                    appElement.addEventListener('click', (e) => {
                                        e.stopPropagation();
                                        openDetailsModal(app);
                                    });
                                    eventCell.appendChild(appElement);
                                }
                            });

                            if (appointmentsInSlot.length > maxVisibleHorizontalEvents) {
                                const moreIndicator = document.createElement('div');
                                moreIndicator.className = 'appointment-event more-indicator';
                                moreIndicator.textContent = `+${appointmentsInSlot.length - maxVisibleHorizontalEvents} mais`;
                                
                                // Position the "more" indicator
                                moreIndicator.style.top = `0px`;
                                // Position it after the last visible event, considering its width and overlap
                                moreIndicator.style.left = `calc(${maxVisibleHorizontalEvents} * (${singleEventWidth} - ${overlapWidth}px))`;
                                moreIndicator.style.width = `auto`; // Let content define width
                                moreIndicator.style.padding = `2px 8px`;
                                moreIndicator.style.zIndex = 10 + maxVisibleHorizontalEvents;
                                moreIndicator.addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    openMultipleAppointmentsModal(appointmentsInSlot, dateString, timeStr);
                                });
                                eventCell.appendChild(moreIndicator);
                            }

                            // Adiciona o ouvinte de evento para abrir o modal de agendamento ao clicar em um slot
                            eventCell.addEventListener('click', () => openBookingModal(day, timeStr));
                            
                            calendarGridWeek.appendChild(eventCell);
                        });
                    }
                }

                // Atualiza o display da semana atual
                const weekEnd = new Date(weekStartDate);
                weekEnd.setDate(weekStartDate.getDate() + 6);
                currentWeekDisplay.textContent = formatDateRange(weekStartDate, weekEnd);
            }

            // Função para renderizar a lista de cards
            function renderCardView() {
                listViewContainer.innerHTML = ''; // Limpa a lista existente

                console.log('renderCardView called. Current filter month:', currentFilterMonth.toISOString().split('T')[0]);

                // Filtra os agendamentos com base no profissional selecionado E no mês selecionado
                // A restrição de mês permanece para a visualização em lista
                const filteredAppointments = allAppointments.filter(app => {
                    const appDate = new Date(app.data_agendamento + 'T00:00:00'); // Garante fuso horário local
                    const matchesProfessional = !professionalFilterId || app.profissional_id === professionalFilterId;
                    
                    // Verifica se o agendamento está dentro do mês selecionado no mini-calendário
                    const isSameMonth = appDate.getMonth() === currentFilterMonth.getMonth() &&
                                         appDate.getFullYear() === currentFilterMonth.getFullYear();

                    return matchesProfessional && isSameMonth;
                });

                console.log('Number of filtered appointments in card view:', filteredAppointments.length);

                // Ordena os agendamentos por data e hora
                filteredAppointments.sort((a, b) => {
                    const dateTimeA = new Date(`${a.data_agendamento}T${a.hora_agendamento}`);
                    const dateTimeB = new Date(`${b.data_agendamento}T${b.hora_agendamento}`);
                    return dateTimeA - dateTimeB;
                });

                if (filteredAppointments.length === 0) {
                    const noAppointmentsMessage = document.createElement('p');
                    noAppointmentsMessage.textContent = 'Nenhum agendamento encontrado para o mês e filtro selecionados.';
                    noAppointmentsMessage.style.textAlign = 'center';
                    noAppointmentsMessage.style.color = 'var(--muted)';
                    noAppointmentsMessage.style.marginTop = '2rem';
                    listViewContainer.appendChild(noAppointmentsMessage);
                    return;
                }

                filteredAppointments.forEach(app => {
                    const card = document.createElement('div');
                    card.className = 'appointment-card';
                    card.dataset.appointmentId = app.id;
                    card.addEventListener('click', () => openDetailsModal(app));

                    card.innerHTML = `
                        <div class="appointment-card-header">
                            <h4>${app.paciente_nome}</h4>
                            <span class="status-badge status-${app.status}">${app.status.charAt(0).toUpperCase() + app.status.slice(1)}</span>
                        </div>
                        <div class="appointment-card-body">
                            <div class="appointment-card-item">
                                <i class="fas fa-calendar-alt"></i>
                                <span class="label">Data:</span>
                                <span class="value">${new Date(app.data_agendamento + 'T00:00:00').toLocaleDateString('pt-BR')}</span>
                            </div>
                            <div class="appointment-card-item">
                                <i class="fas fa-clock"></i>
                                <span class="label">Hora:</span>
                                <span class="value">${app.hora_agendamento}</span>
                            </div>
                            <div class="appointment-card-item">
                                <i class="fas fa-user-doctor"></i>
                                <span class="label">Profissional:</span>
                                <span class="value">${app.profissional_nome}</span>
                            </div>
                            <div class="appointment-card-item">
                                <i class="fas fa-syringe"></i>
                                <span class="label">Serviço:</span>
                                <span class="value">${app.servico_procedimento_nome}</span>
                            </div>
                            <div class="appointment-card-item">
                                <i class="fas fa-hand-holding-dollar"></i>
                                <span class="label">Preço:</span>
                                <span class="value">R$ ${parseFloat(app.servico_procedimento_preco).toFixed(2).replace('.', ',')}</span>
                            </div>
                        </div>
                    `;
                    listViewContainer.appendChild(card);
                });
            }


            // Função para renderizar a lista de profissionais
            function renderProfessionalFilterList() {
                const professionalFilterListContainer = document.getElementById('professional-filter-list');
                if (!professionalFilterListContainer) return;

                professionalFilterListContainer.innerHTML = ''; // Limpa a lista existente

                // Adiciona a opção "Todos os Profissionais"
                const allProfessionalsItem = document.createElement('div');
                allProfessionalsItem.className = `professional-list-item ${!professionalFilterId ? 'selected' : ''}`;
                allProfessionalsItem.textContent = 'Todos os Profissionais';
                allProfessionalsItem.dataset.professionalId = ''; // ID vazio para "todos"
                allProfessionalsItem.addEventListener('click', () => {
                    professionalFilterId = '';
                    // Ao mudar o filtro de profissional, também recarrega a página para que o backend filtre
                    const baseUrl = window.location.origin + window.location.pathname;
                    // Ao clicar em 'Todos os Profissionais', queremos resetar o filtro de profissional
                    // e manter o mês atual do mini-calendário como referência para a busca de 3 meses.
                    const year = currentMiniCalendarDate.getFullYear();
                    const month = currentMiniCalendarDate.getMonth();
                    const startDate = new Date(year, month, 1);
                    const formattedStartDate = `${startDate.getFullYear()}-${String(startDate.getMonth() + 1).padStart(2, '0')}-${String(startDate.getDate()).padStart(2, '0')}`;
                    
                    // Calcula a data de fim como 3 meses a partir do primeiro dia do mês atual do mini-calendário
                    const endDate = new Date(year, month + 3, 0); 
                    const formattedEndDate = `${endDate.getFullYear()}-${String(endDate.getMonth() + 1).padStart(2, '0')}-${String(endDate.getDate()).padStart(2, '0')}`;
                    
                    const newUrl = `${baseUrl}?data_inicio=${formattedStartDate}&data_fim=${formattedEndDate}&profissional_id=${professionalFilterId}`;
                    window.location.href = newUrl;
                });
                professionalFilterListContainer.appendChild(allProfessionalsItem);

                // Adiciona os profissionais individuais
                allProfessionalsForFilter.forEach(professional => {
                    const professionalItem = document.createElement('div');
                    professionalItem.className = `professional-list-item ${professionalFilterId === professional.id ? 'selected' : ''}`;
                    professionalItem.textContent = professional.nome;
                    professionalItem.dataset.professionalId = professional.id;
                    professionalItem.addEventListener('click', () => {
                        professionalFilterId = professional.id;
                        // Ao mudar o filtro de profissional, também recarrega a página para que o backend filtre
                        const baseUrl = window.location.origin + window.location.pathname;
                        // Ao clicar em um profissional, queremos manter o mês atual do mini-calendário como referência para a busca de 3 meses.
                        const year = currentMiniCalendarDate.getFullYear();
                        const month = currentMiniCalendarDate.getMonth();
                        const startDate = new Date(year, month, 1);
                        const formattedStartDate = `${startDate.getFullYear()}-${String(startDate.getMonth() + 1).padStart(2, '0')}-${String(startDate.getDate()).padStart(2, '0')}`;
                        
                        // Calcula a data de fim como 3 meses a partir do primeiro dia do mês atual do mini-calendário
                        const endDate = new Date(year, month + 3, 0); 
                        const formattedEndDate = `${endDate.getFullYear()}-${String(endDate.getMonth() + 1).padStart(2, '0')}-${String(endDate.getDate()).padStart(2, '0')}`;
                        
                        const newUrl = `${baseUrl}?data_inicio=${formattedStartDate}&data_fim=${formattedEndDate}&profissional_id=${professionalFilterId}`;
                        window.location.href = newUrl;
                    });
                    professionalFilterListContainer.appendChild(professionalItem);
                });
            }

            // Função para atualizar a seleção na lista de profissionais
            function updateProfessionalListSelection() {
                document.querySelectorAll('.professional-list-item').forEach(item => {
                    if (item.dataset.professionalId === professionalFilterId) {
                        item.classList.add('selected');
                    } else {
                        item.classList.remove('selected');
                    }
                });
            }


            // --- Funções de interação do Calendário ---
            function setupCalendarInteractions() {
                const prevWeekBtn = document.getElementById('prev-week-btn');
                const nextWeekBtn = document.getElementById('next-week-btn');
                const addManualAppointmentBtn = document.getElementById('addManualAppointmentBtn');

                prevWeekBtn.addEventListener('click', () => {
                    // Calcula a nova data de início da semana
                    const newWeekStart = new Date(currentWeekStart);
                    newWeekStart.setDate(newWeekStart.getDate() - 7);
                    
                    // Atualiza a data do mini-calendário para refletir o mês da nova semana de início
                    currentMiniCalendarDate = new Date(newWeekStart.getFullYear(), newWeekStart.getMonth(), 1);

                    // Formata a data para a URL
                    const formattedNewWeekStart = `${newWeekStart.getFullYear()}-${String(newWeekStart.getMonth() + 1).padStart(2, '0')}-${String(newWeekStart.getDate()).padStart(2, '0')}`;
                    
                    // Calcula a data de fim como 3 meses a partir do mês da nova semana de início
                    const endDateForBackend = new Date(newWeekStart.getFullYear(), newWeekStart.getMonth() + 3, 0); // Último dia do mês, 3 meses à frente
                    const formattedEndDate = `${endDateForBackend.getFullYear()}-${String(endDateForBackend.getMonth() + 1).padStart(2, '0')}-${String(endDateForBackend.getDate()).padStart(2, '0')}`;

                    const baseUrl = window.location.origin + window.location.pathname;
                    const newUrl = `${baseUrl}?data_inicio=${formattedNewWeekStart}&data_fim=${formattedEndDate}&profissional_id=${professionalFilterId}`;
                    window.location.href = newUrl; 
                });

                nextWeekBtn.addEventListener('click', () => {
                    // Calcula a nova data de início da semana
                    const newWeekStart = new Date(currentWeekStart);
                    newWeekStart.setDate(newWeekStart.getDate() + 7);

                    // Atualiza a data do mini-calendário para refletir o mês da nova semana de início
                    currentMiniCalendarDate = new Date(newWeekStart.getFullYear(), newWeekStart.getMonth(), 1);

                    // Formata a data para a URL
                    const formattedNewWeekStart = `${newWeekStart.getFullYear()}-${String(newWeekStart.getMonth() + 1).padStart(2, '0')}-${String(newWeekStart.getDate()).padStart(2, '0')}`;
                    
                    // Calcula a data de fim como 3 meses a partir do mês da nova semana de início
                    const endDateForBackend = new Date(newWeekStart.getFullYear(), newWeekStart.getMonth() + 3, 0); // Último dia do mês, 3 meses à frente
                    const formattedEndDate = `${endDateForBackend.getFullYear()}-${String(endDateForBackend.getMonth() + 1).padStart(2, '0')}-${String(endDateForBackend.getDate()).padStart(2, '0')}`;
                    
                    const baseUrl = window.location.origin + window.location.pathname;
                    const newUrl = `${baseUrl}?data_inicio=${formattedNewWeekStart}&data_fim=${formattedEndDate}&profissional_id=${professionalFilterId}`;
                    window.location.href = newUrl; 
                });

                addManualAppointmentBtn.addEventListener('click', () => {
                    openBookingModal(new Date(), '08:00'); // Abre o modal para a data atual e 8:00
                });
            }

            // --- Funções para Modais (Registro/Edição e Detalhes) ---
            const modalRegistro = document.getElementById('modalRegistroManual');
            const modalFormRegistro = document.getElementById('formRegistroManual');
            const modalTitleRegistro = document.getElementById('modalRegistroManualTitle');
            
            const modalDetalhes = document.getElementById('modalDetalhesAgendamento');
            const infoCardDetalhes = document.getElementById('infoCardAgendamento');
            const btnEditar = document.getElementById('btnEditarAgendamento');
            const btnApagar = document.getElementById('btnApagarAgendamento');
            const formApagar = document.getElementById('formApagarAgendamento');

            // Recurring appointment elements
            const recorrenteCheckbox = document.getElementById('recorrente_checkbox');
            const recurringOptionsDiv = document.getElementById('recurringOptions');
            const dataFimRecorrenciaInput = document.getElementById('data_fim_recorrencia');
            const diasSemanaCheckboxes = document.querySelectorAll('input[name="dias_semana"]');

            // Toggle recurring options visibility
            if (recorrenteCheckbox && recurringOptionsDiv) {
                recorrenteCheckbox.addEventListener('change', () => {
                    if (recorrenteCheckbox.checked) {
                        recurringOptionsDiv.style.display = 'block';
                        dataFimRecorrenciaInput.setAttribute('required', 'true');
                        // Removed setting 'required' on individual day checkboxes
                        // Validation for at least one day selected will be handled by backend or custom JS
                    } else {
                        recurringOptionsDiv.style.display = 'none';
                        dataFimRecorrenciaInput.removeAttribute('required');
                        diasSemanaCheckboxes.forEach(checkbox => {
                            checkbox.checked = false; // Uncheck days when recurring is off
                            // No need to remove 'required' as it's not set here anymore
                        });
                    }
                });
            }


            // Abre o modal de registro/edição
            function openBookingModal(date, time) {
                modalFormRegistro.reset();
                modalFormRegistro.action = "{{ url_for('registrar_atendimento_manual') }}";
                modalTitleRegistro.innerHTML = '<i class="fa-solid fa-calendar-plus"></i> Registrar Atendimento';
                document.getElementById('agendamento_id_manual').value = '';

                // Reset recurring fields
                if (recorrenteCheckbox) recorrenteCheckbox.checked = false;
                if (recurringOptionsDiv) recurringOptionsDiv.style.display = 'none';
                if (dataFimRecorrenciaInput) dataFimRecorrenciaInput.removeAttribute('required');
                if (diasSemanaCheckboxes) diasSemanaCheckboxes.forEach(checkbox => {
                    checkbox.checked = false;
                    checkbox.removeAttribute('required'); // IMPORTANT: Ensure required is removed on reset
                });


                // CORREÇÃO: Formata a data manualmente para evitar problemas de fuso horário com toISOString().
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0'); // Os meses são 0-indexados
                const dayOfMonth = String(date.getDate()).padStart(2, '0');
                const formattedDate = `${year}-${month}-${dayOfMonth}`;
                
                document.getElementById('data_agendamento_manual').value = formattedDate;
                document.getElementById('hora_agendamento_manual').value = time;
                document.getElementById('cliente_nome_manual').readOnly = false;
                document.getElementById('cliente_telefone_manual').readOnly = false;
                
                // Limpa e preenche o select de pacientes existentes
                const pacienteSelectManual = document.getElementById('paciente_id_manual');
                pacienteSelectManual.innerHTML = '<option value="">-- Selecione ou cadastre um novo abaixo --</option>';
                allPatientsForFilter.forEach(paciente => {
                    const option = document.createElement('option');
                    option.value = paciente.id;
                    option.textContent = paciente.nome;
                    option.dataset.telefone = paciente.contato_telefone || '';
                    pacienteSelectManual.appendChild(option);
                });

                modalRegistro.classList.add('active');
            }

            // Abre o modal de detalhes do agendamento
            function openDetailsModal(agendamento) {
                infoCardDetalhes.innerHTML = `
                    <div class="info-item">
                        <i class="fa-solid fa-user"></i>
                        <div class="info-item-content">
                            <span class="label">Paciente</span>
                            <span class="value">${agendamento.paciente_nome}</span>
                        </div>
                    </div>
                    <div class="info-item">
                        <i class="fa-solid fa-user-doctor"></i>
                        <div class="info-item-content">
                            <span class="label">Profissional</span>
                            <span class="value">${agendamento.profissional_nome}</span>
                        </div>
                    </div>
                    <div class="info-item">
                        <i class="fa-solid fa-syringe"></i>
                        <div class="info-item-content">
                            <span class="label">Serviço</span>
                            <span class="value">${agendamento.servico_procedimento_nome}</span>
                        </div>
                    </div>
                        <div class="info-item">
                        <i class="fa-solid fa-hand-holding-dollar"></i>
                        <div class="info-item-content">
                            <span class="label">Preço</span>
                            <span class="value">R$ ${parseFloat(agendamento.servico_procedimento_preco).toFixed(2).replace('.', ',')}</span>
                        </div>
                    </div>
                    <div class="info-item">
                        <i class="fa-solid fa-toggle-on"></i>
                        <div class="info-item-content">
                            <span class="label">Status</span>
                            <select id="status_details_modal" class="status-select-control" data-appointment-id="${agendamento.id}">
                                <option value="confirmado" ${agendamento.status === 'confirmado' ? 'selected' : ''}>Confirmado</option>
                                <option value="concluido" ${agendamento.status === 'concluido' ? 'selected' : ''}>Concluído</option>
                                <option value="pendente" ${agendamento.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                <option value="cancelado" ${agendamento.status === 'cancelado' ? 'selected' : ''}>Cancelado</option>
                            </select>
                        </div>
                    </div>
                `;

                const statusSelect = document.getElementById('status_details_modal');
                if (statusSelect) {
                    statusSelect.addEventListener('change', async (e) => {
                        const appointmentId = e.target.dataset.appointmentId;
                        const newStatus = e.target.value;

                        try {
                            // Em uma aplicação real, isso seria uma chamada fetch para o seu backend Flask:
                            // const response = await fetch(`/api/appointments/${appointmentId}/status`, {
                            //      method: 'POST', // ou PUT, dependendo da sua API
                            //      headers: { 'Content-Type': 'application/json' },
                            //      body: JSON.stringify({ status: newStatus })
                            // });
                            // if (!response.ok) throw new Error('Falha ao atualizar o status');
                            // const result = await response.json(); // Se o seu backend retornar dados atualizados

                            // Atualiza o array de dados local (simulação do backend)
                            const appIndex = allAppointments.findIndex(app => app.id === appointmentId);
                            if (appIndex !== -1) {
                                allAppointments[appIndex].status = newStatus;
                            }

                            showToast(`Status do agendamento atualizado para "${newStatus.charAt(0).toUpperCase() + newStatus.slice(1)}".`, 'success');
                            
                            // Re-renderiza a visualização atual para refletir a mudança de status
                            switchView(currentView);

                        } catch (error) {
                            console.error('Erro ao atualizar status:', error);
                            showToast('Erro ao atualizar o status do agendamento.', 'danger');
                        }
                    });
                }

                btnEditar.onclick = () => {
                    modalDetalhes.classList.remove('active');
                    openEditModal(agendamento);
                };

                btnApagar.onclick = () => {
                    // Substituído o confirm nativo pela nova modal de notificação para confirmação
                    openNotificationModal(
                        "Confirmação de Exclusão",
                        "Tem certeza que deseja apagar este agendamento? Esta ação não pode ser desfeita.",
                        "warning"
                    );
                    // Adiciona um listener temporário ao botão de fechar da modal de notificação para a ação de exclusão
                    const confirmDeleteButton = document.querySelector(".notification-modal-button");
                    confirmDeleteButton.onclick = () => {
                        closeNotificationModal(); // Fecha a modal de notificação
                        formApagar.action = "{{ url_for('apagar_agendamento') }}";
                        document.getElementById('agendamento_id_apagar').value = agendamento.id;
                        formApagar.submit();
                    };
                    // Se o usuário clicar no 'x' ou fora da modal, ela apenas fecha sem ação
                    notificationModalCloseButton.onclick = () => {
                        closeNotificationModal();
                        // Restaura o onclick original do botão de fechar da modal de notificação
                        notificationModalCloseButton.onclick = function() {
                            closeNotificationModal();
                        };
                    };
                };

                modalDetalhes.classList.add('active');
            }

            // Abre o modal de edição
            function openEditModal(agendamento) {
                modalFormRegistro.reset();
                modalFormRegistro.action = `{{ url_for('editar_agendamento') }}`;
                modalTitleRegistro.innerHTML = '<i class="fas fa-edit"></i> Editar Agendamento';
                
                document.getElementById('agendamento_id_manual').value = agendamento.id;
                document.getElementById('cliente_nome_manual').value = agendamento.paciente_nome;
                document.getElementById('profissional_id_manual').value = agendamento.profissional_id;
                document.getElementById('servico_id_manual').value = agendamento.servico_procedimento_id;
                document.getElementById('data_agendamento_manual').value = agendamento.data_agendamento;
                document.getElementById('hora_agendamento_manual').value = agendamento.hora_agendamento;
                document.getElementById('preco_manual').value = parseFloat(agendamento.servico_procedimento_preco).toFixed(2);
                document.getElementById('status_manual').value = agendamento.status;
                
                // Recurring fields should not be editable for existing appointments
                if (recorrenteCheckbox) recorrenteCheckbox.checked = false;
                if (recurringOptionsDiv) recurringOptionsDiv.style.display = 'none';
                if (dataFimRecorrenciaInput) dataFimRecorrenciaInput.removeAttribute('required');
                if (diasSemanaCheckboxes) diasSemanaCheckboxes.forEach(checkbox => {
                    checkbox.checked = false;
                    checkbox.removeAttribute('required');
                });


                // Preenche o select de pacientes existentes e seleciona o paciente correto
                const pacienteSelectManual = document.getElementById('paciente_id_manual');
                pacienteSelectManual.innerHTML = '<option value="">-- Selecione um paciente existente --</option>';
                allPatientsForFilter.forEach(paciente => {
                    const option = document.createElement('option');
                    option.value = paciente.id;
                    option.textContent = paciente.nome;
                    option.dataset.telefone = paciente.contato_telefone || '';
                    if (paciente.id === agendamento.paciente_id) {
                        option.selected = true;
                    }
                    pacienteSelectManual.appendChild(option);
                });

                // Preenche o campo de telefone do paciente a partir do paciente selecionado
                const selectedPatientOption = pacienteSelectManual.options[pacienteSelectManual.selectedIndex];
                document.getElementById('cliente_telefone_manual').value = selectedPatientOption.dataset.telefone || agendamento.paciente_numero || '';

                // Define readOnly para o nome do paciente se um paciente existente for selecionado
                document.getElementById('cliente_nome_manual').readOnly = !!agendamento.paciente_id;
                
                modalRegistro.classList.add('active');
            }

            // Lógica para fechar modais (genérica para todos os modais com data-close)
            document.querySelectorAll('.modal-overlay').forEach(modalEl => {
                modalEl.querySelectorAll('[data-close]').forEach(btn => btn.addEventListener('click', () => modalEl.classList.remove('active')));
                modalEl.addEventListener('click', (e) => { if (e.target === modalEl) modalEl.classList.remove('active'); });
            });

            // Lógica para fechar a nova modal de múltiplos agendamentos
            const modalMultiAgendamentos = document.getElementById('modalMultiAgendamentos');
            if (modalMultiAgendamentos) {
                modalMultiAgendamentos.querySelectorAll('[data-close-multi]').forEach(btn => btn.addEventListener('click', () => modalMultiAgendamentos.classList.remove('active')));
                modalMultiAgendamentos.addEventListener('click', (e) => { if (e.target === modalMultiAgendamentos) modalMultiAgendamentos.classList.remove('active'); });
            }
            
            // Lógica para preencher preço do serviço automaticamente
            const servicoSelect = document.getElementById('servico_id_manual');
            const precoInput = document.getElementById('preco_manual');
            if (servicoSelect && precoInput) {
                servicoSelect.addEventListener('change', (e) => {
                    const selectedOption = e.target.options[e.target.selectedIndex];
                    const price = selectedOption.dataset.preco || '';
                    precoInput.value = price ? parseFloat(price).toFixed(2) : '';
                });
            }
            
            // Lógica para preencher nome e telefone do paciente a partir do select
            const pacienteSelectManual = document.getElementById('paciente_id_manual');
            const nomeInputManual = document.getElementById('cliente_nome_manual');
            const telefoneInputManual = document.getElementById('cliente_telefone_manual');
            if(pacienteSelectManual && nomeInputManual && telefoneInputManual) {
                pacienteSelectManual.addEventListener('change', function() {
                    const selectedOption = this.options[this.selectedIndex];
                    if (selectedOption.value) {
                        nomeInputManual.value = selectedOption.text;
                        telefoneInputManual.value = selectedOption.dataset.telefone || '';
                        nomeInputManual.readOnly = true;
                        telefoneInputManual.readOnly = false; // Permite editar o telefone mesmo para paciente existente
                    } else {
                        // Se "Nenhum" for selecionado, limpa e permite edição
                        nomeInputManual.value = '';
                        telefoneInputManual.value = '';
                        nomeInputManual.readOnly = false;
                        telefoneInputManual.readOnly = false;
                    }
                });
            }

            // --- Mini Calendário Lateral ---
            // A variável currentMiniCalendarDate já está definida globalmente
            // A variável currentFilterMonth já está definida globalmente

            function renderMiniCalendar(date) {
                const miniCalendarGrid = document.getElementById('mini-calendar-grid');
                const miniCurrentMonthYear = document.getElementById('mini-current-month-year');
                const today = new Date(); // Data de hoje

                miniCalendarGrid.innerHTML = ''; // Limpa o calendário existente

                const year = date.getFullYear();
                const month = date.getMonth();

                miniCurrentMonthYear.textContent = `${monthNames[month]} ${year}`;

                // Adiciona os cabeçalhos dos dias da semana (Dom a Sáb)
                const miniDayNames = ['D', 'S', 'T', 'Q', 'Q', 'S', 'S'];
                miniDayNames.forEach(dayName => {
                    const header = document.createElement('div');
                    header.className = 'mini-calendar-day-header';
                    header.textContent = dayName;
                    miniCalendarGrid.appendChild(header);
                });

                const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0 for Sunday, 1 for Monday...
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                // Preenche os dias vazios antes do primeiro dia do mês
                for (let i = 0; i < firstDayOfMonth; i++) {
                    const emptyDay = document.createElement('div');
                    emptyDay.className = 'mini-calendar-day other-month';
                    miniCalendarGrid.appendChild(emptyDay);
                }

                // Preenche os dias do mês
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayElement = document.createElement('div');
                    dayElement.className = 'mini-calendar-day';
                    dayElement.textContent = day;
                    dayElement.dataset.date = new Date(year, month, day).toISOString().split('T')[0];

                    // Destaca o dia atual
                    if (new Date(year, month, day).toDateString() === today.toDateString()) {
                        dayElement.classList.add('current-day');
                    }
                    
                    dayElement.addEventListener('click', () => {
                        const clickedDate = new Date(`${dayElement.dataset.date}T00:00:00`);
                        
                        // Calcula o início da semana do dia clicado
                        const startOfWeek = getMonday(clickedDate);

                        const formattedStartDate = `${startOfWeek.getFullYear()}-${String(startOfWeek.getMonth() + 1).padStart(2, '0')}-${String(startOfWeek.getDate()).padStart(2, '0')}`;
                        
                        // Calcula a data de fim como 3 meses a partir do mês da semana de início
                        const endDateForBackend = new Date(startOfWeek.getFullYear(), startOfWeek.getMonth() + 3, 0); // Último dia do mês, 3 meses à frente
                        const formattedEndDate = `${endDateForBackend.getFullYear()}-${String(endDateForBackend.getMonth() + 1).padStart(2, '0')}-${String(endDateForBackend.getDate()).padStart(2, '0')}`;

                        // Redireciona a página com os parâmetros da semana
                        const baseUrl = window.location.origin + window.location.pathname;
                        const newUrl = `${baseUrl}?data_inicio=${formattedStartDate}&data_fim=${formattedEndDate}&profissional_id=${professionalFilterId}`;
                        
                        console.log('Mini-calendar day clicked. Redirecting to:', newUrl);
                        window.location.href = newUrl; // Redireciona para recarregar os dados do backend
                    });
                    miniCalendarGrid.appendChild(dayElement);
                }
            }

            function setupMiniCalendarInteractions() {
                const miniPrevMonthBtn = document.getElementById('mini-prev-month-btn');
                const miniNextMonthBtn = document.getElementById('mini-next-month-btn');

                miniPrevMonthBtn.addEventListener('click', () => {
                    // Atualiza a data do mini-calendário para o mês anterior
                    currentMiniCalendarDate.setMonth(currentMiniCalendarDate.getMonth() - 1);
                    
                    // Calcula a nova data de início para a URL (primeiro dia do mês atualizado do mini-calendário)
                    const newStartDate = new Date(currentMiniCalendarDate.getFullYear(), currentMiniCalendarDate.getMonth(), 1);
                    const formattedStartDate = `${newStartDate.getFullYear()}-${String(newStartDate.getMonth() + 1).padStart(2, '0')}-${String(newStartDate.getDate()).padStart(2, '0')}`;
                    
                    // Calcula a data de fim como 3 meses a partir da newStartDate
                    const endDateForBackend = new Date(newStartDate.getFullYear(), newStartDate.getMonth() + 3, 0); // Último dia do mês, 3 meses à frente
                    const formattedEndDate = `${endDateForBackend.getFullYear()}-${String(endDateForBackend.getMonth() + 1).padStart(2, '0')}-${String(endDateForBackend.getDate()).padStart(2, '0')}`;

                    const baseUrl = window.location.origin + window.location.pathname;
                    const newUrl = `${baseUrl}?data_inicio=${formattedStartDate}&data_fim=${formattedEndDate}&profissional_id=${professionalFilterId}`;
                    
                    console.log('Mini-calendar previous month clicked. Redirecting to:', newUrl);
                    window.location.href = newUrl; // Redireciona para recarregar os dados do backend
                });

                miniNextMonthBtn.addEventListener('click', () => {
                    // Atualiza a data do mini-calendário para o próximo mês
                    currentMiniCalendarDate.setMonth(currentMiniCalendarDate.getMonth() + 1);
                    
                    // Calcula a nova data de início para a URL (primeiro dia do mês atualizado do mini-calendário)
                    const newStartDate = new Date(currentMiniCalendarDate.getFullYear(), currentMiniCalendarDate.getMonth(), 1);
                    const formattedStartDate = `${newStartDate.getFullYear()}-${String(newStartDate.getMonth() + 1).padStart(2, '0')}-${String(newStartDate.getDate()).padStart(2, '0')}`;
                    
                    // Calcula a data de fim como 3 meses a partir da newStartDate
                    const endDateForBackend = new Date(newStartDate.getFullYear(), newStartDate.getMonth() + 3, 0); // Último dia do mês, 3 meses à frente
                    const formattedEndDate = `${endDateForBackend.getFullYear()}-${String(endDateForBackend.getMonth() + 1).padStart(2, '0')}-${String(endDateForBackend.getDate()).padStart(2, '0')}`;

                    const baseUrl = window.location.origin + window.location.pathname;
                    const newUrl = `${baseUrl}?data_inicio=${formattedStartDate}&data_fim=${formattedEndDate}&profissional_id=${professionalFilterId}`;

                    console.log('Mini-calendar next month clicked. Redirecting to:', newUrl);
                    window.location.href = newUrl; // Redireciona para recarregar os dados do backend
                });
            }

            // Função para abrir a modal de múltiplos agendamentos
            function openMultipleAppointmentsModal(appointments, date, time) {
                const modalMulti = document.getElementById('modalMultiAgendamentos');
                const multiAppointmentsList = document.getElementById('multiAppointmentsList');
                multiAppointmentsList.innerHTML = ''; // Limpa o conteúdo anterior

                const header = document.createElement('h4');
                header.className = 'form-section-title';
                header.textContent = `Agendamentos em ${new Date(date + 'T00:00:00').toLocaleDateString('pt-BR')} às ${time}`;
                multiAppointmentsList.appendChild(header);

                appointments.forEach(app => {
                    const card = document.createElement('div');
                    card.className = 'appointment-card'; // Reutiliza o estilo de card existente
                    card.style.marginBottom = '10px';
                    card.dataset.appointmentId = app.id;
                    card.addEventListener('click', () => {
                        modalMulti.classList.remove('active'); // Fecha a modal de múltiplos
                        openDetailsModal(app); // Abre os detalhes do agendamento individual
                    });

                    card.innerHTML = `
                        <div class="appointment-card-header">
                            <h4>${app.paciente_nome}</h4>
                            <span class="status-badge status-${app.status}">${app.status.charAt(0).toUpperCase() + app.status.slice(1)}</span>
                        </div>
                        <div class="appointment-card-body">
                            <div class="appointment-card-item">
                                <i class="fas fa-user-doctor"></i>
                                <span class="label">Profissional:</span>
                                <span class="value">${app.profissional_nome}</span>
                            </div>
                            <div class="appointment-card-item">
                                <i class="fas fa-syringe"></i>
                                <span class="label">Serviço:</span>
                                <span class="value">${app.servico_procedimento_nome}</span>
                            </div>
                            <div class="appointment-card-item">
                                <i class="fas fa-hand-holding-dollar"></i>
                                <span class="label">Preço:</span>
                                <span class="value">R$ ${parseFloat(app.servico_procedimento_preco).toFixed(2).replace('.', ',')}</span>
                            </div>
                        </div>
                    `;
                    multiAppointmentsList.appendChild(card);
                });

                modalMulti.classList.add('active');
            }


            // --- Inicialização ---
            setupSidebar();
            setupTheme();
            setupLogout();
            setupCalendarInteractions(); // Configura as interações do calendário principal
            setupMiniCalendarInteractions(); // Configura as interações do mini-calendário
            renderProfessionalFilterList(); // Renderiza a nova lista de profissionais

            // Configura os listeners dos botões de visualização
            calendarViewBtn.addEventListener('click', () => switchView('calendar'));
            listViewBtn.addEventListener('click', () => switchView('list'));

            // Renderiza a visualização inicial com base no localStorage
            switchView(currentView);
            renderMiniCalendar(currentMiniCalendarDate); // Garante que o mini-calendário reflita a semana inicial


            // --- NOVA VALIDAÇÃO DE AGENDAMENTO ---
            modalFormRegistro.addEventListener('submit', function(event) {
                const profissionalId = document.getElementById('profissional_id_manual').value;
                const dataAgendamento = document.getElementById('data_agendamento_manual').value;
                const horaAgendamento = document.getElementById('hora_agendamento_manual').value;
                const agendamentoIdSendoEditado = document.getElementById('agendamento_id_manual').value; // ID do agendamento se estiver editando

                // Verifica se é um agendamento recorrente e se algum dia da semana foi selecionado
                const isRecorrente = document.getElementById('recorrente_checkbox').checked;
                const selectedDays = Array.from(diasSemanaCheckboxes).filter(cb => cb.checked).map(cb => parseInt(cb.value));

                if (isRecorrente && selectedDays.length === 0) {
                    openNotificationModal("Erro de Agendamento", "Para agendamentos recorrentes, selecione pelo menos um dia da semana.", "danger");
                    event.preventDefault(); // Impede o envio do formulário
                    return;
                }

                // Validação de conflito apenas para agendamentos não recorrentes ou para a primeira instância de um recorrente
                if (!isRecorrente) {
                    const conflito = allAppointments.some(app => {
                        // Ignora o próprio agendamento se estiver em modo de edição
                        if (agendamentoIdSendoEditado && app.id === agendamentoIdSendoEditado) {
                            return false;
                        }
                        return app.profissional_id === profissionalId &&
                               app.data_agendamento === dataAgendamento &&
                               app.hora_agendamento === horaAgendamento;
                    });

                    if (conflito) {
                        openNotificationModal("Erro de Agendamento", "Este profissional já possui um agendamento para o mesmo dia e horário.", "danger");
                        event.preventDefault(); // Impede o envio do formulário
                        return;
                    }
                }
                // Se for um agendamento recorrente, a validação de conflito para cada instância será feita no backend.
                // O frontend apenas valida a seleção de pelo menos um dia da semana.
            });
        });
    </script>
</html>
