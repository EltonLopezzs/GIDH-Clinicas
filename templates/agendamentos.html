<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendamentos - {{ session.clinica_nome_display or 'Clínica On' }}</title>
    
    <!-- Favicon para a aba do navegador -->
    <link rel="icon" type="image/png" href="https://placehold.co/40x40/0d9488/ffffff?text=C">
    
    <!-- Fontes e ícones externos: Inter e Font Awesome -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        /* ============================================
         --- ESTILOS GERAIS E VARIÁVEIS DE TEMA ---
         ============================================
        */
        :root {
            --bg: #f1f5f9;
            --card: #ffffff;
            --text: #0f172a;
            --muted: #64748b;
            --accent: #0f172a;
            --primary: #0d9488; /* Teal-600 */
            --primary-light: #ccfbf1; /* Teal-100 */
            --primary-dark: #115e59; /* Teal-800 */
            --secondary: #f59e0b; /* Amber-500 */
            --danger: #dc2626;
            --danger-dark: #b91c1c;
            --success: #16a34a;
            --warning: #f59e0b;
            --info: #0ea5e9;
            --border-color: #e2e8f0;
            
            /* Cores para os status dos agendamentos */
            --status-confirmado: #16a344; /* Verde */
            --status-concluido: #0ea5e9; /* Azul */
            --status-pendente: #f59e0b; /* Laranja */
            --status-cancelado: #dc2626; /* Vermelho */

            --dark-bg: #0f172a;
            --dark-card: #1e293b;
            --dark-text: #f1f5f9;
            --dark-muted: #94a3b8;
            --dark-border-color: #334155;
            
            color-scheme: light;
        }

        [data-theme="dark"] {
            --bg: var(--dark-bg);
            --text: var(--dark-text);
            --card: var(--dark-card);
            --muted: var(--dark-muted);
            --border-color: var(--dark-border-color);
            color-scheme: dark;

            /* Cores para os status em tema escuro (opcionalmente ajustadas) */
            --status-confirmado: #22c55e;
            --status-concluido: #38bdf8;
            --status-pendente: #fbbf24;
            --status-cancelado: #ef4444;
        }

        /* Reset básico e box-sizing */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; overflow-x: hidden; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .layout { display: flex; min-height: 100vh; width: 100%; }

        /* ============================================
         --- SIDEBAR ---
         ============================================
        */
        .sidebar {
            width: 260px;
            background: linear-gradient(180deg, var(--primary), var(--accent));
            color: white;
            position: fixed;
            top: 0; left: 0;
            height: 100vh;
            transition: width 0.3s ease, transform 0.3s ease;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }
        .sidebar-inner-content { padding: 0; height: 100%; overflow-y: auto; display: flex; flex-direction: column; }
        .sidebar-header {
            padding: 0 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sidebar-header .logo {
            font-size: 1.4rem; font-weight: 700; color: white; text-decoration: none;
            display: flex; align-items: center; gap: 0.75rem;
            white-space: nowrap; overflow: hidden;
        }
        .sidebar-header .logo i { font-size: 1.8rem; }
        
        .sidebar.collapsed { width: 78px; }
        .sidebar.collapsed .sidebar-header .logo span, .sidebar.collapsed nav ul li a span, .sidebar.collapsed .sidebar-footer span { display: none; }
        .sidebar.collapsed nav ul li a, .sidebar.collapsed .sidebar-footer button, .sidebar.collapsed .sidebar-footer a { justify-content: center; padding: 0.75rem; }

        .sidebar nav { flex-grow: 1; margin-top: 1rem; padding: 0 0.75rem; }
        .sidebar.collapsed nav { padding: 0 0.5rem; }
        .sidebar nav ul { list-style: none; padding: 0; }
        .sidebar nav ul li { margin-bottom: 0.5rem; }
        .sidebar nav ul li a {
            color: #e2e8f0; text-decoration: none; display: flex; align-items: center;
            padding: 0.75rem 1rem; gap: 1rem; border-radius: 8px; font-size: 0.95rem;
            font-weight: 500; white-space: nowrap; overflow: hidden;
            transition: background 0.2s ease, color 0.2s ease;
        }
        .sidebar nav ul li a i { width: 24px; text-align: center; font-size: 1.2rem; flex-shrink: 0; }
        .sidebar nav ul li a:hover { background: rgba(255, 255, 255, 0.1); color: white; }
        .sidebar nav ul li.active a { background: white; color: var(--primary); font-weight: 600; }

        .sidebar-footer { padding: 1rem 0.75rem; margin-top: auto; flex-shrink: 0; }
        .sidebar.collapsed .sidebar-footer { padding: 1rem 0.5rem; }
        .sidebar-footer button, .sidebar-footer a {
            background: none; border: none; cursor: pointer; color: #e2e8f0;
            padding: 0.75rem 1rem; border-radius: 8px; width: 100%;
            display: flex; align-items: center; gap: 1rem;
            transition: background 0.2s ease, color 0.2s ease;
            font-family: 'Inter', sans-serif; font-size: 0.95rem; text-decoration: none;
        }
        .sidebar-footer button:hover, .sidebar-footer a:hover { background: rgba(255, 255, 255, 0.1); color: white; }
        
        /* ============================================
         --- CONTEÚDO PRINCIPAL & TOPBAR ---
         ============================================
        */
        .main-content {
            flex: 1; margin-left: 260px; transition: margin-left 0.3s ease;
            display: flex; flex-direction: column; width: calc(100% - 260px);
        }
        .main-content.collapsed { margin-left: 78px; width: calc(100% - 78px); }

        .topbar {
            background-color: var(--card); color: var(--text); padding: 0 1.5rem;
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid var(--border-color); height: 70px; flex-shrink: 0;
            position: sticky; top: 0; z-index: 900;
        }
        .topbar-left { display: flex; align-items: center; gap: 1rem; }
        .topbar .page-title { font-weight: 600; font-size: 1.25rem; color: var(--text); }
        .toggle-btn {
            background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--muted);
            width: 40px; height: 40px; border-radius: 50%; display: grid; place-items: center;
            transition: background 0.2s ease, color 0.2s ease;
        }
        .toggle-btn:hover { background-color: var(--bg); color: var(--primary); }
        .toggle-btn-desktop { display: none; }
        .menu-btn-mobile { display: block; }
        @media(min-width: 769px) {
            .toggle-btn-desktop { display: grid; }
            .menu-btn-mobile { display: none; }
        }

        /* New Filter Button in Topbar */
        .topbar-right { display: flex; align-items: center; gap: 1rem; }
        .btn-filter {
            background: none;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            background-color: var(--card);
            color: var(--text);
        }
        .btn-filter:hover {
            background-color: var(--bg);
            color: var(--primary);
            border-color: var(--primary);
        }
        /* Style for active filter button */
        .btn-filter.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary-dark);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn-filter.active:hover {
            background-color: var(--primary-dark);
            color: white;
        }

        main { 
            flex-grow: 1; 
            padding: 1.5rem; 
            overflow: hidden; 
            display: flex; 
            gap: 1.5rem; /* Espaçamento entre o calendário principal e o mini-calendário */
        }

        /* ============================================
         --- CALENDÁRIO SEMANAL (NOVO) ---
         ============================================
        */
        .weekly-calendar-container {
            background-color: var(--card);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            flex-grow: 1; /* Ocupa o espaço disponível */
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .calendar-header h2 {
            font-size: 1.5rem;
            color: var(--text);
            margin: 0;
        }
        .calendar-nav {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        .calendar-nav span { /* Estilo para o display da semana atual */
            font-weight: 600;
            color: var(--text);
        }
        .calendar-nav select, .calendar-nav button, .btn-filter {
            background: none;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.5rem 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            background-color: var(--card);
            color: var(--text);
        }
        .calendar-nav select:hover, .calendar-nav button:hover, .btn-filter:hover {
            background-color: var(--bg);
            color: var(--primary);
        }

        /* New: Weekly Grid Styles */
        .calendar-grid-week {
            display: grid;
            grid-template-columns: 90px repeat(7, minmax(120px, 1fr)); 
            grid-auto-rows: minmax(40px, auto); /* Minimum row height for hourly slots */
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden; /* Contains children within rounded corners */
            flex-grow: 1;
            overflow-y: auto; /* Adiciona rolagem vertical para o calendário */
            max-height: calc(100vh - 2px); /* Ajuste a altura máxima conforme necessário */
        }

        .time-column-header, .day-header-week {
            padding: 0.75rem 0.5rem;
            font-weight: 600;
            text-align: center;
            background-color: var(--bg);
            border-bottom: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
            font-size: 0.85rem;
            color: var(--muted);
            display: flex;
            flex-direction: column; /* Para empilhar dia da semana e número */
            align-items: center;
            justify-content: center;
            position: sticky; /* Fixa os cabeçalhos */
            top: 0; /* Fixa no topo do grid-week */
            z-index: 20; /* Garante que fiquem acima dos eventos */
        }
        .time-column-header {
            background-color: var(--card); /* Different background for time column header */
            border-right: 1px solid var(--border-color);
            left: 0; /* Fixa a coluna de tempo */
            z-index: 25; /* Maior z-index para a coluna de tempo */
        }
        .day-header-week:last-child, .time-cell:last-child {
            border-right: none;
        }
        .day-header-week .day-number {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text);
            margin-top: 4px;
            position: relative; /* Necessário para o pseudo-elemento */
            z-index: 1; /* Garante que o número fique acima do círculo */
        }
        .day-header-week.today .day-number {
            color: white; /* Torna o número branco quando destacado */
        }
        /* Adiciona um pseudo-elemento para o círculo azul */
        .day-header-week.today .day-number::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 36px; /* Tamanho do círculo */
            height: 36px; /* Tamanho do círculo */
            background-color: var(--primary); /* Cor azul para o círculo */
            border-radius: 50%;
            z-index: -1; /* Posiciona atrás do número */
        }

        .time-cell {
            padding: 0.5rem 0.5rem;
            font-size: 0.8rem;
            color: var(--muted);
            text-align: right;
            border-right: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            background-color: var(--card);
            position: relative; /* For positioning appointments */
            height: 40px; /* Fixed height for each slot */
            display: flex; /* Use flexbox for alignment */
            align-items: center; /* Center vertically */
            justify-content: flex-end; /* Align to the right */
            padding-right: 10px; /* Add some padding to the right */
        }
        .time-cell span {
            position: static;
            transform: none;
        }

        .event-cell {
            border-right: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            position: relative;
            background-color: var(--card);
            cursor: pointer;
            transition: background-color 0.2s ease;
            overflow: hidden; /* Para garantir que eventos longos não transbordem visualmente */
        }
        .event-cell:hover {
            background-color: var(--bg);
        }

        .appointment-event {
            background-color: color-mix(in srgb, var(--primary) 15%, transparent);
            color: var(--primary-dark);
            border-left: 3px solid var(--primary);
            padding: 2px 5px;
            font-size: 0.75rem;
            border-radius: 4px;
            margin: 1px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            position: absolute;
            width: calc(100% - 2px); /* Full width minus margin */
            box-sizing: border-box;
            z-index: 10;
            cursor: pointer;
            line-height: 1.2;
            left: 1px; /* Alinha à esquerda */
        }
        .appointment-event.status-concluido { background-color: color-mix(in srgb, var(--status-concluido) 15%, transparent); color: var(--status-concluido); border-left-color: var(--status-concluido); }
        .appointment-event.status-pendente { background-color: color-mix(in srgb, var(--status-pendente) 15%, transparent); color: var(--status-pendente); border-left-color: var(--status-pendente); }
        .appointment-event.status-cancelado { background-color: color-mix(in srgb, var(--status-cancelado) 15%, transparent); color: var(--status-cancelado); border-left-color: var(--status-cancelado); }
        .appointment-event.status-confirmado { background-color: color-mix(in srgb, var(--status-confirmado) 15%, transparent); color: var(--status-confirmado); border-left-color: var(--status-confirmado); }

        /* ============================================
         --- MODAIS (REUTILIZADOS) ---
         ============================================
        */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 2000; opacity: 0; transition: opacity 0.25s ease; }
        .modal-overlay.active { opacity: 1; display: flex; }
        .modal-content { 
            background-color: var(--card); 
            color: var(--text); 
            border-radius: 16px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); 
            width: 90%; 
            max-width: 800px; 
            transform: translateY(-20px); 
            transition: transform 0.25s ease; 
            max-height: calc(100vh - 40px); 
            display: flex; 
            flex-direction: column; 
        }
        .modal-overlay.active .modal-content { transform: translateY(0); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 1.5rem 2rem; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .modal-header h3 { font-size: 1.4rem; color: var(--text); margin: 0; font-weight: 600; }
        .modal-header h3 i { margin-right: 0.75rem; color: var(--primary); }
        .modal-close-btn { background: none; border: none; font-size: 1.5rem; color: var(--muted); cursor: pointer; line-height: 1; transition: color 0.2s ease; }
        .modal-close-btn:hover { color: var(--danger); }
        .modal-body { overflow-y: auto; padding: 2rem; }
        .form-group { margin-bottom: 1.5rem; }
        .form-group:last-child { margin-bottom: 0; }
        .form-group label { display: block; font-size: 0.9rem; color: var(--muted); font-weight: 500; margin-bottom: 0.5rem; }
        .form-group input, .form-group select { font-size: 0.95rem; padding: 0.7rem 0.8rem; width: 100%; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--bg); color: var(--text); transition: border-color 0.2s ease, box-shadow 0.2s ease; }
        .form-group input:focus, .form-group select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary) 20%, transparent); outline: none; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        .modal-footer { padding: 1.5rem 2rem; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 0.75rem; flex-shrink: 0; background-color: var(--bg); }
        
        .form-section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary);
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 1.5rem;
            margin-top: 1.5rem;
        }
        .modal-body .form-section-title:first-of-type {
            margin-top: 0;
        }

        /* New Info Card Styles */
        .info-card { background-color: var(--bg); padding: 1.5rem; border-radius: 8px; }
        .info-card .info-item { display: flex; align-items: flex-start; gap: 1rem; margin-bottom: 1rem; }
        .info-card .info-item:last-child { margin-bottom: 0; }
        .info-card .info-item i { font-size: 1.1rem; color: var(--muted); margin-top: 4px; width: 20px; text-align: center; }
        .info-card .info-item-content .label { font-size: 0.85rem; color: var(--muted); font-weight: 500; }
        .info-card .info-item-content .value { font-size: 1rem; font-weight: 600; color: var(--text); }

        /* ============================================
         --- BOTÕES ---
         ============================================
        */
        .btn { padding: 0.6rem 1.2rem; font-size: 0.9rem; border-radius: 8px; text-decoration: none; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; border: 1px solid transparent; cursor: pointer; transition: all 0.2s ease-in-out; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: var(--primary-dark); }
        .btn-danger-outline { background-color: transparent; color: var(--danger); border-color: var(--danger); }
        .btn-danger-outline:hover { background-color: var(--danger); color: white; }

        .btn-secondary { background-color: var(--card); color: var(--text); border-color: var(--border-color); box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); }
        [data-theme="dark"] .btn-secondary { background-color: var(--dark-card); border-color: var(--dark-border-color); color: var(--dark-text); }
        
        /* ============================================
         --- RESPONSIVIDADE ---
         ============================================
        */
        @media (max-width: 992px) { /* Ajuste para telas menores que 992px */
            main { flex-direction: column; overflow: auto; }
            .weekly-calendar-container { padding: 1rem; } /* Reduz o padding do container principal */
            .calendar-header { flex-direction: column; align-items: flex-start; } /* Empilha elementos do cabeçalho */
            .calendar-nav { width: 100%; justify-content: space-between; margin-bottom: 0.5rem; } /* Ocupa largura total */
            .calendar-nav span { flex-grow: 1; text-align: center; } /* Centraliza o display da semana */
            .btn-filter { width: 100%; margin-left: 0; } /* Botão de filtro ocupa largura total */
            
            .calendar-grid-week {
                grid-template-columns: 60px repeat(7, minmax(70px, 1fr)); 
                font-size: 0.75rem;
            }
            .time-column-header, .day-header-week { padding: 0.5rem 0.2rem; font-size: 0.75rem; }
            .time-cell { height: 30px; /* Altura menor para slots de tempo */ }
            .appointment-event { font-size: 0.7rem; padding: 1px 3px; }
        }

        @media (max-width: 768px) { /* Ajustes para mobile */
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .main-content, .main-content.collapsed { margin-left: 0; }
            main { padding: 1rem; flex-direction: column; } /* Garante que o main empilhe os elementos em mobile */
            .topbar { padding: 0 1rem; }
            .mini-calendar-wrapper { display: none; } /* Esconde o mini-calendário em mobile */
            .form-row { grid-template-columns: 1fr; }
        }

        /* ============================================
         --- MINI CALENDÁRIO LATERAL (NOVO) ---
         ============================================
        */
        .mini-calendar-wrapper {
            width: 350px; 
            height: 250px; 
            background-color: var(--card); 
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 0.75rem; 
            flex-shrink: 0; 
            align-self: flex-start; 
            z-index: 500; 
        }

        .mini-calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem; 
            color: var(--text); 
            font-weight: 600;
            font-size: 0.9rem; 
        }

        .mini-calendar-header button {
            background: none;
            border: none;
            color: var(--muted); 
            font-size: 0.9rem; 
            cursor: pointer;
            padding: 0.2rem;
            border-radius: 50%; 
            transition: background-color 0.2s ease, color 0.2s ease;
            width: 24px; 
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .mini-calendar-header button:hover {
            background-color: var(--bg); 
            color: var(--primary); 
        }

        .mini-calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            font-size: 0.7rem; 
            text-align: center;
        }

        .mini-calendar-day-header {
            color: var(--muted); 
            font-weight: 500;
            padding: 0.2rem;
        }

        .mini-calendar-day {
            padding: 0.3rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
            color: var(--text); 
            font-weight: 500;
            height: 28px; 
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mini-calendar-day.other-month {
            color: var(--muted); 
            opacity: 0.6;
        }

        .mini-calendar-day:hover {
            background-color: var(--bg); 
        }

        .mini-calendar-day.selected {
            background-color: var(--primary); 
            color: white; 
            font-weight: 700;
        }
        .mini-calendar-day.current-day {
            background-color: var(--secondary); 
            color: white;
            font-weight: 700;
        }

        /* --- Estilos para Notificações Toast (MELHORADO) --- */
        .toast-container {
            position: fixed;
            top: 85px; /* Abaixo do topbar */
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 360px;
        }

        .toast {
            background-color: var(--card);
            color: var(--text);
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1), 0 5px 5px rgba(0,0,0,0.05);
            display: flex;
            align-items: flex-start; /* Alinha ícone ao topo do texto */
            gap: 1rem;
            border: 1px solid var(--border-color);
            animation: toast-slide-in 0.5s cubic-bezier(0.215, 0.610, 0.355, 1.000);
            position: relative;
            overflow: hidden; /* Para a barra de progresso */
        }

        .toast.success { border-left: 5px solid var(--success); }
        .toast.danger { border-left: 5px solid var(--danger); }
        .toast.warning { border-left: 5px solid var(--warning); }
        .toast.info { border-left: 5px solid var(--info); }

        .toast-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
            margin-top: 2px;
        }
        .toast.success .toast-icon { color: var(--success); }
        .toast.danger .toast-icon { color: var(--danger); }
        .toast.warning .toast-icon { color: var(--warning); }
        .toast.info .toast-icon { color: var(--info); }

        .toast-content {
            flex-grow: 1;
        }
        .toast-title {
            font-weight: 700;
            font-size: 1rem;
            color: var(--text);
            display: block;
            margin-bottom: 0.25rem;
        }
        .toast-message {
            font-size: 0.9rem;
            color: var(--muted);
            line-height: 1.4;
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--muted);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            opacity: 0.7;
            transition: opacity 0.2s ease, color 0.2s ease;
            flex-shrink: 0;
        }
        .toast-close:hover {
            opacity: 1;
            color: var(--text);
        }

        .toast-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 4px;
            width: 100%;
            animation: toast-progress-bar 5s linear forwards;
        }
        .toast.success .toast-progress { background-color: var(--success); }
        .toast.danger .toast-progress { background-color: var(--danger); }
        .toast.warning .toast-progress { background-color: var(--warning); }
        .toast.info .toast-progress { background-color: var(--info); }


        @keyframes toast-slide-in {
            from {
                opacity: 0;
                transform: translateX(110%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes toast-fade-out {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-20px);
            }
        }
        .toast.fade-out {
            animation: toast-fade-out 0.4s ease-in forwards;
        }

        @keyframes toast-progress-bar {
            from { width: 100%; }
            to { width: 0%; }
        }

    </style>
</head>
<body>
    <div id="toast-container"></div>
    <div class="layout">
        <aside class="sidebar">
            <div class="sidebar-inner-content">
                <div class="sidebar-header">
                    <a href="{{ url_for('index') }}" class="logo">
                        <i class="fa-solid fa-staff-snake"></i> <span>{{ session.clinica_nome_display or 'ClínicaOn' }}</span>
                    </a>
                </div>
                <nav>
                    <ul>
                        <li><a href="{{ url_for('index') }}"><i class="fa-solid fa-house-chimney"></i> <span>Dashboard</span></a></li>
                        <li><a href="{{ url_for('listar_pacientes') }}"><i class="fa-solid fa-hospital-user"></i> <span>Pacientes</span></a></li>
                        <li><a href="{{ url_for('buscar_prontuario') }}"><i class="fa-solid fa-notes-medical"></i> <span>Prontuários</span></a></li>
                        <li><a href="{{ url_for('listar_profissionais') }}"><i class="fa-solid fa-user-doctor"></i> <span>Profissionais</span></a></li>
                        <li><a href="{{ url_for('listar_servicos_procedimentos') }}"><i class="fa-solid fa-syringe"></i> <span>Serviços/Proc.</span></a></li>
                        <li><a href="{{ url_for('listar_convenios') }}"><i class="fa-solid fa-handshake"></i> <span>Convênios</span></a></li>
                        <li><a href="{{ url_for('listar_horarios') }}"><i class="fa-regular fa-clock"></i> <span>Horários</span></a></li>
                        <li class="active"><a href="{{ url_for('listar_agendamentos') }}"><i class="fa-regular fa-calendar-check"></i> <span>Agendamentos</span></a></li>
                        {% if session.user_role == 'admin' %}
                        <li><a href="{{ url_for('listar_usuarios') }}"><i class="fa-solid fa-users-gear"></i> <span>Utilizadores</span></a></li>
                        <li><a href="{{ url_for('listar_modelos_anamnese') }}"><i class="fa-regular fa-file-lines"></i> <span>Modelos Anamnese</span></a></li>
                        <li><a href="{{ url_for('listar_estoque') }}"><i class="fa-solid fa-boxes-stacked"></i> <span>Estoque</span></a></li>
                        <li><a href="{{ url_for('listar_contas_a_pagar') }}"><i class="fa-solid fa-money-bill-wave"></i> <span>Contas a Pagar</span></a></li>
                        {% endif %}
                    </ul>
                </nav>
                <div class="sidebar-footer">
                    <button id="theme-toggle" aria-label="Alternar tema">
                        <i class="fa-solid fa-sun"></i> <span>Alternar Tema</span>
                    </button>
                    <a href="#" id="logoutButton"><i class="fa-solid fa-arrow-right-from-bracket"></i> <span>Sair</span></a>
                </div>
            </div>
        </aside>

        <div class="main-content">
            <header class="topbar">
                <div class="topbar-left">
                    <button class="toggle-btn menu-btn-mobile"><i class="fa-solid fa-bars"></i></button>
                    <button class="toggle-btn toggle-btn-desktop"><i class="fa-solid fa-bars-staggered"></i></button>
                    <h1 class="page-title">Agendamentos</h1>
                </div>
                <div class="topbar-right">
                    <button type="button" class="btn btn-primary" id="addManualAppointmentBtn">
                        <i class="fas fa-plus"></i> <span class="btn-text-desktop">Novo Agendamento</span>
                    </button>
                </div>
            </header>

            <main>
                <!-- O bloco de mensagens flash antigo foi removido daqui -->

                <!-- Mini Calendário Lateral (Movido para o main) -->
                <div class="mini-calendar-wrapper">
                    <div class="mini-calendar-header">
                        <button id="mini-prev-month-btn"><i class="fas fa-chevron-left"></i></button>
                        <span id="mini-current-month-year"></span>
                        <button id="mini-next-month-btn"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div class="mini-calendar-grid" id="mini-calendar-grid">
                        <!-- Dias da semana e números serão gerados aqui via JS -->
                    </div>
                </div>

                <div class="weekly-calendar-container">
                    <div class="calendar-header">
                        <div class="calendar-nav">
                            <button id="prev-week-btn" title="Semana Anterior"><i class="fas fa-chevron-left"></i></button>
                            <span id="current-week-display" class="font-semibold text-lg text-gray-800 dark:text-gray-200"></span>
                            <button id="next-week-btn" title="Próxima Semana"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        <select id="professional-filter" class="btn btn-filter ml-auto">
                            <option value="">Todos os Profissionais</option>
                            {% for profissional in profissionais_para_filtro %}
                            <option value="{{ profissional.id }}" {% if filtros_atuais.profissional_id == profissional.id %}selected{% endif %}>{{ profissional.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="calendar-grid-week" id="calendar-grid-week">
                        <!-- Cabeçalhos dos dias e horários serão gerados aqui via JS -->
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal de Detalhes do Agendamento -->
    <div class="modal-overlay" id="modalDetalhesAgendamento">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fa-solid fa-calendar-check" style="color: var(--info);"></i> Detalhes do Agendamento</h3>
                <button type="button" class="modal-close-btn" data-close>&times;</button>
            </div>
            <div class="modal-body">
                <div class="info-card" id="infoCardAgendamento">
                    <!-- Conteúdo preenchido via JS -->
                </div>
            </div>
            <div class="modal-footer" style="justify-content: space-between;">
                <button type="button" class="btn btn-danger-outline" id="btnApagarAgendamento"><i class="fas fa-trash"></i> Apagar Registro</button>
                <button type="button" class="btn btn-primary" id="btnEditarAgendamento"><i class="fas fa-edit"></i> Editar Registro</button>
            </div>
        </div>
    </div>

    <!-- Modal de Registro/Edição Manual de Agendamento -->
    <div class="modal-overlay" id="modalRegistroManual">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('registrar_atendimento_manual') }}" id="formRegistroManual">
                <input type="hidden" name="agendamento_id" id="agendamento_id_manual">
                <div class="modal-header">
                    <h3 id="modalRegistroManualTitle"><i class="fa-solid fa-calendar-plus"></i> Registrar Atendimento</h3>
                    <button type="button" class="modal-close-btn" data-close>&times;</button>
                </div>
                <div class="modal-body">
                    <h4 class="form-section-title">Informações do Paciente</h4>
                    <div class="form-group">
                        <label for="paciente_id_manual">Paciente Existente</label>
                        <select id="paciente_id_manual" name="paciente_id">
                            <option value="">-- Selecione ou cadastre um novo abaixo --</option>
                            {% for paciente in pacientes_para_filtro %}
                                <option value="{{ paciente.id }}" data-telefone="{{ paciente.contato_telefone or '' }}">{{ paciente.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="cliente_nome_manual">Selecione o paciente ou digite o nome</label>
                            <input type="text" id="cliente_nome_manual" name="cliente_nome_manual" placeholder="Digite se for um novo paciente">
                        </div>
                        <div class="form-group">
                            <label for="cliente_telefone_manual">Telefone</label>
                            <input type="tel" id="cliente_telefone_manual" name="cliente_telefone_manual" placeholder="(XX) XXXXX-XXXX">
                        </div>
                    </div>

                    <h4 class="form-section-title">Detalhes do Agendamento</h4>
                    <div class="form-group">
                        <label for="profissional_id_manual">Profissional</label>
                        <select id="profissional_id_manual" name="barbeiro_id_manual" required>
                        <option value="">Selecione o profissional</option>
                            {% for professional in profissionais_para_filtro %} 
                            <option value="{{ professional.id }}">{{ professional.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="servico_id_manual">Serviço/Procedimento</label>
                        <select id="servico_id_manual" name="servico_id_manual" required>
                            <option value="">Selecione o serviço/procedimento</option>
                            {% for servico_proc in servicos_ativos %} 
                            <option value="{{ servico_proc.id }}" data-preco="{{ servico_proc.preco|float }}">{{ servico_proc.nome }} (R$ {{ "%.2f"|format(servico_proc.preco|float) }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="data_agendamento_manual">Data</label>
                            <input type="date" id="data_agendamento_manual" name="data_agendamento_manual" required>
                        </div>
                        <div class="form-group">
                            <label for="hora_agendamento_manual">Hora</label>
                            <input type="time" id="hora_agendamento_manual" name="hora_agendamento_manual" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="preco_manual">Preço (R$)</label>
                            <input type="number" id="preco_manual" name="preco_manual" step="0.01" min="0" required readonly>
                        </div>
                        <div class="form-group">
                            <label for="status_manual">Status</label>
                            <select id="status_manual" name="status_manual" required>
                                <option value="confirmado" selected>Confirmado</option>
                                <option value="concluido">Concluído</option>
                                <option value="pendente">Pendente</option>
                                <option value="cancelado">Cancelado</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-close>Cancelar</button>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Formulário para Apagar Agendamento (escondido) -->
    <form id="formApagarAgendamento" method="POST" action="{{ url_for('apagar_agendamento') }}" style="display: none;">
        <input type="hidden" name="agendamento_id" id="agendamento_id_apagar">
    </form>


    <script type="module">
        // Placeholder para Firebase, caso não esteja configurado no ambiente Canvas
        const FAKE_FIREBASE = {
            initializeApp: () => ({}),
            getAuth: () => ({ currentUser: null, signOut: () => new Promise(res => res()) })
        };
        const { initializeApp } = FAKE_FIREBASE;
        const { getAuth, signOut: firebaseSignOut } = FAKE_FIREBASE;
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        let auth = getAuth(initializeApp(firebaseConfig));


        document.addEventListener('DOMContentLoaded', () => {
            const htmlEl = document.documentElement;
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            const menuBtnMobile = document.querySelector('.menu-btn-mobile');
            const toggleBtnDesktop = document.querySelector('.toggle-btn-desktop');
            const themeToggle = document.querySelector('#theme-toggle');
            const logoutButton = document.getElementById('logoutButton');

            // --- Lógica para Notificações Toast ---
            const toastContainer = document.getElementById('toast-container');
            function showToast(message, category = 'info') {
                if (!toastContainer) return;

                const toast = document.createElement('div');
                toast.className = `toast ${category}`;
                
                let iconClass = 'fa-solid fa-circle-info';
                let title = 'Informação';
                if (category === 'success') {
                    iconClass = 'fa-solid fa-check-circle';
                    title = 'Sucesso';
                }
                if (category === 'danger') {
                    iconClass = 'fa-solid fa-times-circle';
                    title = 'Erro';
                }
                if (category === 'warning') {
                    iconClass = 'fa-solid fa-exclamation-triangle';
                    title = 'Atenção';
                }

                toast.innerHTML = `
                    <div class="toast-icon">
                        <i class="${iconClass}"></i>
                    </div>
                    <div class="toast-content">
                        <strong class="toast-title">${title}</strong>
                        <span class="toast-message">${message}</span>
                    </div>
                    <button class="toast-close">&times;</button>
                    <div class="toast-progress"></div>
                `;
                
                toastContainer.appendChild(toast);

                const closeButton = toast.querySelector('.toast-close');
                closeButton.addEventListener('click', () => {
                    toast.classList.add('fade-out');
                    toast.addEventListener('animationend', () => toast.remove());
                });

                setTimeout(() => {
                    toast.classList.add('fade-out');
                    toast.addEventListener('animationend', () => toast.remove());
                }, 5000); // A notificação desaparece após 5 segundos
            }

            // --- Processa mensagens flash do backend e as exibe como toasts ---
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% for category, message in messages %}
                    showToast({{ message|tojson|safe }}, "{{ category }}");
                {% endfor %}
            {% endwith %}


            // --- Sidebar Logic (reused) ---
            function setupSidebar() {
                if (!sidebar || !mainContent) return;
                const updateDesktopToggleIcon = () => {
                    if (!toggleBtnDesktop) return;
                    const icon = toggleBtnDesktop.querySelector('i');
                    icon.className = sidebar.classList.contains('collapsed') ? 'fa-solid fa-bars' : 'fa-solid fa-bars-staggered';
                };
                const applyInitialState = () => {
                    if (window.innerWidth > 768) {
                        if (localStorage.getItem('sidebarCollapsed') === 'true') {
                            sidebar.classList.add('collapsed');
                            mainContent.classList.add('collapsed');
                        }
                    } else {
                        sidebar.classList.remove('open', 'collapsed');
                        mainContent.classList.remove('collapsed');
                    }
                    updateDesktopToggleIcon();
                };
                if (toggleBtnDesktop) {
                    toggleBtnDesktop.addEventListener('click', () => {
                        sidebar.classList.toggle('collapsed');
                        mainContent.classList.toggle('collapsed');
                        localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
                        updateDesktopToggleIcon();
                    });
                }
                if (menuBtnMobile) {
                    menuBtnMobile.addEventListener('click', (e) => {
                        e.stopPropagation();
                        sidebar.classList.toggle('open');
                    });
                }
                document.addEventListener('click', (e) => {
                    if (window.innerWidth <= 768 && sidebar.classList.contains('open') && !sidebar.contains(e.target) && !menuBtnMobile.contains(e.target)) {
                        sidebar.classList.remove('open');
                    }
                });
                applyInitialState();
                window.addEventListener('resize', applyInitialState);
            }

            // --- Theme Logic (reused) ---
            function setupTheme() {
                if (!themeToggle) return;
                const updateThemeUI = (theme) => {
                    htmlEl.setAttribute('data-theme', theme);
                    const icon = themeToggle.querySelector('i');
                    icon.className = theme === 'dark' ? 'fa-solid fa-moon' : 'fa-solid fa-sun';
                };
                const currentTheme = localStorage.getItem('theme') || 'light';
                updateThemeUI(currentTheme);
                themeToggle.addEventListener('click', () => {
                    const newTheme = htmlEl.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
                    localStorage.setItem('theme', newTheme);
                    updateThemeUI(newTheme);
                });
            }

            // --- Logout Logic (reused) ---
            function setupLogout() {
                if (!logoutButton) return;
                logoutButton.addEventListener('click', async (event) => {
                    event.preventDefault();
                    fetch("{{ url_for('logout') }}", { method: 'POST' })
                        .then(() => window.location.href = "{{ url_for('login_page') }}")
                        .catch(() => window.location.href = "{{ url_for('login_page') }}");
                });
            }

            // --- Calendar & Agenda Logic (MODIFICADA) ---
            // Variáveis globais para o calendário e agendamentos
            let currentWeekStart = new Date(); // Começa na semana atual
            
            // CORREÇÃO: Função para obter a segunda-feira da semana de uma data, tratando corretamente o fuso horário.
            function getMonday(d) {
                d = new Date(d);
                d.setHours(12, 0, 0, 0); // Define a hora para o meio-dia para evitar problemas de fuso horário perto da meia-noite.
                const day = d.getDay();
                const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Ajusta para o domingo ser o último dia da semana.
                const monday = new Date(d.setDate(diff));
                monday.setHours(0, 0, 0, 0); // Reseta a hora para o início do dia.
                return monday;
            }
            currentWeekStart = getMonday(currentWeekStart);

            // Dados de agendamentos e profissionais passados pelo Jinja2
            const allAppointments = {{ agendamentos | tojson | safe }};
            const allProfessionalsForFilter = {{ profissionais_para_filtro | tojson | safe }};
            const allPatientsForFilter = {{ pacientes_para_filtro | tojson | safe }}; // Adicionado para o modal

            let professionalFilterId = "{{ filtros_atuais.profissional_id or '' }}"; // Filtro inicial do backend

            // Mapeia o dia da semana de número para nome
            const dayNames = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
            const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];


            // Função para formatar o intervalo de datas da semana
            function formatDateRange(start, end) {
                const formatOptions = { month: 'short', day: 'numeric' };
                const startStr = start.toLocaleDateString('pt-BR', formatOptions);
                const endStr = end.toLocaleDateString('pt-BR', formatOptions);
                const year = start.getFullYear();
                return `${startStr} - ${endStr} ${year}`;
            }

            // Função principal para renderizar a grade semanal
            function renderWeeklyGrid(weekStartDate) {
                const calendarGridWeek = document.getElementById('calendar-grid-week');
                const currentWeekDisplay = document.getElementById('current-week-display');
                
                calendarGridWeek.innerHTML = ''; // Limpa a grade existente

                // Define as colunas do grid: 90px para a coluna de tempo, e 7 colunas flexíveis para os dias
                calendarGridWeek.style.gridTemplateColumns = '90px repeat(7, minmax(120px, 1fr))'; // Aumentado min-width para 120px
                calendarGridWeek.style.gridAutoRows = 'minmax(40px, auto)'; // Altura mínima para cada slot

                // Cria o cabeçalho da grade (dias da semana)
                const headerRow = document.createElement('div');
                headerRow.className = 'grid grid-cols-8 sticky top-0 bg-white dark:bg-gray-800 z-20 border-b border-r border-l border-gray-200 dark:border-gray-700'; // Tailwind classes for row
                headerRow.style.gridColumn = '1 / -1'; // Ocupa todas as 8 colunas

                // Canto superior esquerdo vazio
                const cornerHeader = document.createElement('div');
                cornerHeader.className = 'time-column-header border-none';
                calendarGridWeek.appendChild(cornerHeader);

                const days = [];
                for (let i = 0; i < 7; i++) {
                    const currentDay = new Date(weekStartDate);
                    currentDay.setDate(weekStartDate.getDate() + i);
                    days.push(currentDay);

                    const dayHeader = document.createElement('div');
                    dayHeader.className = 'day-header-week';
                    dayHeader.innerHTML = `${dayNames[currentDay.getDay()]}. <span class="day-number">${currentDay.getDate()}</span>`;
                    if (currentDay.toDateString() === new Date().toDateString()) {
                        dayHeader.classList.add('today'); // Adiciona classe para destacar o dia atual
                    }
                    calendarGridWeek.appendChild(dayHeader); // Adiciona a linha de cabeçalho ao grid
                }

                // Horários (das 00:00 às 23:30, em intervalos de 30 minutos)
                for (let hour = 0; hour < 24; hour++) { // Loop para todas as 24 horas
                    for (let minute = 0; minute < 60; minute += 30) {
                        const timeStr = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
                        
                        // Célula da coluna de tempo
                        const timeCell = document.createElement('div');
                        timeCell.className = 'time-cell';
                        timeCell.innerHTML = `<span>${timeStr}</span>`;
                        calendarGridWeek.appendChild(timeCell);

                        // Células de eventos para cada dia da semana
                        days.forEach(day => {
                            const eventCell = document.createElement('div');
                            eventCell.className = 'event-cell';
                            const dateString = day.toISOString().split('T')[0]; // Formato yyyy-MM-dd
                            eventCell.dataset.date = dateString;
                            eventCell.dataset.time = timeStr;

                            // Filtra agendamentos para este slot específico
                            const appointmentsInSlot = allAppointments.filter(app => {
                                const appDate = app.data_agendamento; // Já no formato yyyy-MM-dd
                                const appTime = app.hora_agendamento; // Já no formato HH:MM

                                const matchesDate = appDate === dateString;
                                const matchesTime = appTime === timeStr;
                                const matchesProfessional = !professionalFilterId || app.profissional_id === professionalFilterId;
                                
                                return matchesDate && matchesTime && matchesProfessional;
                            });

                            // Adiciona os agendamentos encontrados à célula
                            appointmentsInSlot.forEach(app => {
                                const appElement = document.createElement('div');
                                appElement.className = `appointment-event status-${app.status}`;
                                appElement.textContent = `${app.paciente_nome} (${app.profissional_nome || 'N/A'})`;
                                appElement.dataset.appointmentId = app.id;
                                appElement.addEventListener('click', (e) => {
                                    e.stopPropagation(); // Evita que o clique na div pai também abra o modal de agendamento
                                    openDetailsModal(app);
                                });
                                eventCell.appendChild(appElement);
                            });

                            // Adiciona o ouvinte de evento para abrir o modal de agendamento ao clicar em um slot vazio
                            if (appointmentsInSlot.length === 0) {
                                eventCell.addEventListener('click', () => openBookingModal(day, timeStr));
                            }
                            
                            calendarGridWeek.appendChild(eventCell);
                        });
                    }
                }

                // Atualiza o display da semana atual
                const weekEnd = new Date(weekStartDate);
                weekEnd.setDate(weekStartDate.getDate() + 6);
                currentWeekDisplay.textContent = formatDateRange(weekStartDate, weekEnd);
            }

            // --- Funções de interação do Calendário ---
            function setupCalendarInteractions() {
                const prevWeekBtn = document.getElementById('prev-week-btn');
                const nextWeekBtn = document.getElementById('next-week-btn');
                const professionalFilterSelect = document.getElementById('professional-filter');
                const addManualAppointmentBtn = document.getElementById('addManualAppointmentBtn');

                prevWeekBtn.addEventListener('click', () => {
                    currentWeekStart.setDate(currentWeekStart.getDate() - 7);
                    renderWeeklyGrid(currentWeekStart);
                });

                nextWeekBtn.addEventListener('click', () => {
                    currentWeekStart.setDate(currentWeekStart.getDate() + 7);
                    renderWeeklyGrid(currentWeekStart);
                });

                professionalFilterSelect.addEventListener('change', (event) => {
                    professionalFilterId = event.target.value;
                    renderWeeklyGrid(currentWeekStart); // Re-renderiza com o novo filtro
                });

                addManualAppointmentBtn.addEventListener('click', () => {
                    openBookingModal(new Date(), '08:00'); // Abre o modal para a data atual e 8:00
                });
            }

            // --- Funções para Modais (Registro/Edição e Detalhes) ---
            const modalRegistro = document.getElementById('modalRegistroManual');
            const modalFormRegistro = document.getElementById('formRegistroManual');
            const modalTitleRegistro = document.getElementById('modalRegistroManualTitle');
            
            const modalDetalhes = document.getElementById('modalDetalhesAgendamento');
            const infoCardDetalhes = document.getElementById('infoCardAgendamento');
            const btnEditar = document.getElementById('btnEditarAgendamento');
            const btnApagar = document.getElementById('btnApagarAgendamento');
            const formApagar = document.getElementById('formApagarAgendamento');

            // Abre o modal de registro/edição
            function openBookingModal(date, time) {
                modalFormRegistro.reset();
                modalFormRegistro.action = "{{ url_for('registrar_atendimento_manual') }}";
                modalTitleRegistro.innerHTML = '<i class="fa-solid fa-calendar-plus"></i> Registrar Atendimento';
                document.getElementById('agendamento_id_manual').value = '';

                // CORREÇÃO: Formata a data manualmente para evitar problemas de fuso horário com toISOString().
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0'); // Os meses são 0-indexados
                const dayOfMonth = String(date.getDate()).padStart(2, '0');
                const formattedDate = `${year}-${month}-${dayOfMonth}`;
                
                document.getElementById('data_agendamento_manual').value = formattedDate;
                document.getElementById('hora_agendamento_manual').value = time;
                document.getElementById('cliente_nome_manual').readOnly = false;
                document.getElementById('cliente_telefone_manual').readOnly = false;
                
                // Limpa e preenche o select de pacientes existentes
                const pacienteSelectManual = document.getElementById('paciente_id_manual');
                pacienteSelectManual.innerHTML = '<option value="">-- Selecione um paciente existente --</option>';
                allPatientsForFilter.forEach(paciente => {
                    const option = document.createElement('option');
                    option.value = paciente.id;
                    option.textContent = paciente.nome;
                    option.dataset.telefone = paciente.contato_telefone || '';
                    pacienteSelectManual.appendChild(option);
                });

                modalRegistro.classList.add('active');
            }

            // Abre o modal de detalhes do agendamento
            function openDetailsModal(agendamento) {
                infoCardDetalhes.innerHTML = `
                    <div class="info-item">
                        <i class="fa-solid fa-user"></i>
                        <div class="info-item-content">
                            <span class="label">Paciente</span>
                            <span class="value">${agendamento.paciente_nome}</span>
                        </div>
                    </div>
                    <div class="info-item">
                        <i class="fa-solid fa-user-doctor"></i>
                        <div class="info-item-content">
                            <span class="label">Profissional</span>
                            <span class="value">${agendamento.profissional_nome}</span>
                        </div>
                    </div>
                    <div class="info-item">
                        <i class="fa-solid fa-syringe"></i>
                        <div class="info-item-content">
                            <span class="label">Serviço</span>
                            <span class="value">${agendamento.servico_procedimento_nome}</span>
                        </div>
                    </div>
                       <div class="info-item">
                        <i class="fa-solid fa-hand-holding-dollar"></i>
                        <div class="info-item-content">
                            <span class="label">Preço</span>
                            <span class="value">R$ ${parseFloat(agendamento.servico_procedimento_preco).toFixed(2).replace('.', ',')}</span>
                        </div>
                    </div>
                    <div class="info-item">
                        <i class="fa-solid fa-toggle-on"></i>
                        <div class="info-item-content">
                            <span class="label">Status</span>
                            <span class="value">${agendamento.status.charAt(0).toUpperCase() + agendamento.status.slice(1)}</span>
                        </div>
                    </div>
                `;

                btnEditar.onclick = () => {
                    modalDetalhes.classList.remove('active');
                    openEditModal(agendamento);
                };

                btnApagar.onclick = () => {
                    if (confirm('Tem certeza que deseja apagar este agendamento? Esta ação não pode ser desfeita.')) {
                        formApagar.action = "{{ url_for('apagar_agendamento') }}";
                        document.getElementById('agendamento_id_apagar').value = agendamento.id;
                        formApagar.submit();
                    }
                };

                modalDetalhes.classList.add('active');
            }

            // Abre o modal de edição
            function openEditModal(agendamento) {
                modalFormRegistro.reset();
                modalFormRegistro.action = `{{ url_for('editar_agendamento') }}`;
                modalTitleRegistro.innerHTML = '<i class="fas fa-edit"></i> Editar Agendamento';
                
                document.getElementById('agendamento_id_manual').value = agendamento.id;
                document.getElementById('cliente_nome_manual').value = agendamento.paciente_nome;
                document.getElementById('profissional_id_manual').value = agendamento.profissional_id;
                document.getElementById('servico_id_manual').value = agendamento.servico_procedimento_id;
                document.getElementById('data_agendamento_manual').value = agendamento.data_agendamento;
                document.getElementById('hora_agendamento_manual').value = agendamento.hora_agendamento;
                document.getElementById('preco_manual').value = parseFloat(agendamento.servico_procedimento_preco).toFixed(2);
                document.getElementById('status_manual').value = agendamento.status;
                
                // Preenche o select de pacientes existentes e seleciona o paciente correto
                const pacienteSelectManual = document.getElementById('paciente_id_manual');
                pacienteSelectManual.innerHTML = '<option value="">-- Selecione um paciente existente --</option>';
                allPatientsForFilter.forEach(paciente => {
                    const option = document.createElement('option');
                    option.value = paciente.id;
                    option.textContent = paciente.nome;
                    option.dataset.telefone = paciente.contato_telefone || '';
                    if (paciente.id === agendamento.paciente_id) {
                        option.selected = true;
                    }
                    pacienteSelectManual.appendChild(option);
                });

                // Preenche o campo de telefone do paciente a partir do paciente selecionado
                const selectedPatientOption = pacienteSelectManual.options[pacienteSelectManual.selectedIndex];
                document.getElementById('cliente_telefone_manual').value = selectedPatientOption.dataset.telefone || agendamento.paciente_numero || '';

                // Define readOnly para o nome do paciente se um paciente existente for selecionado
                document.getElementById('cliente_nome_manual').readOnly = !!agendamento.paciente_id;
                
                modalRegistro.classList.add('active');
            }

            // Lógica para fechar modais (genérica para todos os modais com data-close)
            document.querySelectorAll('.modal-overlay').forEach(modalEl => {
                modalEl.querySelectorAll('[data-close]').forEach(btn => btn.addEventListener('click', () => modalEl.classList.remove('active')));
                modalEl.addEventListener('click', (e) => { if (e.target === modalEl) modalEl.classList.remove('active'); });
            });
            
            // Lógica para preencher preço do serviço automaticamente
            const servicoSelect = document.getElementById('servico_id_manual');
            const precoInput = document.getElementById('preco_manual');
            if (servicoSelect && precoInput) {
                servicoSelect.addEventListener('change', (e) => {
                    const selectedOption = e.target.options[e.target.selectedIndex];
                    const price = selectedOption.dataset.preco || '';
                    precoInput.value = price ? parseFloat(price).toFixed(2) : '';
                });
            }
            
            // Lógica para preencher nome e telefone do paciente a partir do select
            const pacienteSelectManual = document.getElementById('paciente_id_manual');
            const nomeInputManual = document.getElementById('cliente_nome_manual');
            const telefoneInputManual = document.getElementById('cliente_telefone_manual');
            if(pacienteSelectManual && nomeInputManual && telefoneInputManual) {
                pacienteSelectManual.addEventListener('change', function() {
                    const selectedOption = this.options[this.selectedIndex];
                    if (selectedOption.value) {
                        nomeInputManual.value = selectedOption.text;
                        telefoneInputManual.value = selectedOption.dataset.telefone || '';
                        nomeInputManual.readOnly = true;
                        telefoneInputManual.readOnly = false; // Permite editar o telefone mesmo para paciente existente
                    } else {
                        // Se "Nenhum" for selecionado, limpa e permite edição
                        nomeInputManual.value = '';
                        telefoneInputManual.value = '';
                        nomeInputManual.readOnly = false;
                        telefoneInputManual.readOnly = false;
                    }
                });
            }

            // --- Mini Calendário Lateral ---
            let currentMiniCalendarDate = new Date(); // Data atual para o mini-calendário

            function renderMiniCalendar(date) {
                const miniCalendarGrid = document.getElementById('mini-calendar-grid');
                const miniCurrentMonthYear = document.getElementById('mini-current-month-year');

                miniCalendarGrid.innerHTML = ''; // Limpa o calendário existente

                const year = date.getFullYear();
                const month = date.getMonth();

                miniCurrentMonthYear.textContent = `${monthNames[month]} ${year}`;

                // Adiciona os cabeçalhos dos dias da semana (Dom a Sáb)
                const miniDayNames = ['D', 'S', 'T', 'Q', 'Q', 'S', 'S'];
                miniDayNames.forEach(dayName => {
                    const header = document.createElement('div');
                    header.className = 'mini-calendar-day-header';
                    header.textContent = dayName;
                    miniCalendarGrid.appendChild(header);
                });

                const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0 for Sunday, 1 for Monday...
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                // Preenche os dias vazios antes do primeiro dia do mês
                for (let i = 0; i < firstDayOfMonth; i++) {
                    const emptyDay = document.createElement('div');
                    emptyDay.className = 'mini-calendar-day other-month';
                    miniCalendarGrid.appendChild(emptyDay);
                }

                // Preenche os dias do mês
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayElement = document.createElement('div');
                    dayElement.className = 'mini-calendar-day';
                    dayElement.textContent = day;
                    dayElement.dataset.date = new Date(year, month, day).toISOString().split('T')[0];

                    // Destaca o dia atual
                    if (new Date(year, month, day).toDateString() === new Date().toDateString()) {
                        dayElement.classList.add('current-day');
                    }
                    // Destaca o dia selecionado (que corresponde à semana exibida no calendário principal)
                    if (new Date(year, month, day).toDateString() === currentWeekStart.toDateString()) {
                        dayElement.classList.add('selected');
                    }


                    dayElement.addEventListener('click', () => {
                        // CORREÇÃO: Adiciona 'T00:00:00' para garantir que a data seja interpretada no fuso horário local.
                        const clickedDate = new Date(`${dayElement.dataset.date}T00:00:00`);
                        currentWeekStart = getMonday(clickedDate); // Atualiza a semana principal para a do dia clicado
                        renderWeeklyGrid(currentWeekStart); // Renderiza a grade semanal principal
                        
                        // Remove a seleção antiga e adiciona a nova no mini-calendário
                        document.querySelectorAll('.mini-calendar-day.selected').forEach(el => el.classList.remove('selected'));
                        dayElement.classList.add('selected');
                    });
                    miniCalendarGrid.appendChild(dayElement);
                }
            }

            function setupMiniCalendarInteractions() {
                const miniPrevMonthBtn = document.getElementById('mini-prev-month-btn');
                const miniNextMonthBtn = document.getElementById('mini-next-month-btn');

                miniPrevMonthBtn.addEventListener('click', () => {
                    currentMiniCalendarDate.setMonth(currentMiniCalendarDate.getMonth() - 1);
                    renderMiniCalendar(currentMiniCalendarDate);
                });

                miniNextMonthBtn.addEventListener('click', () => {
                    currentMiniCalendarDate.setMonth(currentMiniCalendarDate.getMonth() + 1);
                    renderMiniCalendar(currentMiniCalendarDate);
                });
            }


            // --- Inicialização ---
            setupSidebar();
            setupTheme();
            setupLogout();
            setupCalendarInteractions(); // Configura as interações do calendário principal
            setupMiniCalendarInteractions(); // Configura as interações do mini-calendário
            renderWeeklyGrid(currentWeekStart); // Renderiza o calendário semanal na carga da página
            renderMiniCalendar(currentMiniCalendarDate); // Renderiza o mini-calendário na carga da página
        });
    </script>
</body>
</html>
