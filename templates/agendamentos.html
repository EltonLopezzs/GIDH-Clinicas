<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendamentos - {{ session.clinica_nome_display or 'Cl√≠nica On' }}</title>
    
    <link rel="icon" type="image/png" href="https://placehold.co/40x40/0d9488/ffffff?text=C">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        :root {
            --bg: #f1f5f9;
            --card: #ffffff;
            --text: #0f172a;
            --muted: #64748b;
            --accent: #0f172a;
            --primary: #0d9488;
            --primary-dark: #115e59;
            --secondary: #f59e0b;
            --danger: #dc2626;
            --danger-dark: #b91c1c;
            --success: #16a34a;
            --warning: #f59e0b;
            --info: #0ea5e9;
            --border-color: #e2e8f0;
            
            --dark-bg: #0f172a;
            --dark-card: #1e293b;
            --dark-text: #f1f5f9;
            --dark-muted: #94a3b8;
            --dark-border-color: #334155;
            
            color-scheme: light;

            /* Cores para os status dos agendamentos */
            --status-confirmado: #16a34a; /* Verde */
            --status-concluido: #0ea5e9; /* Azul */
            --status-pendente: #f59e0b; /* Laranja */
            --status-cancelado: #dc2626; /* Vermelho */
        }

        [data-theme="dark"] {
            --bg: var(--dark-bg);
            --text: var(--dark-text);
            --card: var(--dark-card);
            --muted: var(--dark-muted);
            --border-color: var(--dark-border-color);
            color-scheme: dark;

            /* Cores para os status em tema escuro (opcionalmente ajustadas) */
            --status-confirmado: #22c55e;
            --status-concluido: #38bdf8;
            --status-pendente: #fbbf24;
            --status-cancelado: #ef4444;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; overflow-x: hidden; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .layout { display: flex; min-height: 100vh; width: 100%; }

        /* Sidebar Styles (Reused) */
        .sidebar { width: 260px; background: linear-gradient(180deg, var(--primary), var(--accent)); color: white; position: fixed; top: 0; left: 0; height: 100vh; transition: width 0.3s ease, transform 0.3s ease; z-index: 1000; display: flex; flex-direction: column; }
        .sidebar-inner-content { padding: 0; height: 100%; overflow-y: auto; display: flex; flex-direction: column; }
        .sidebar-header { padding: 0 1rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1); flex-shrink: 0; height: 70px; display: flex; align-items: center; justify-content: center; }
        .sidebar-header .logo { font-size: 1.4rem; font-weight: 700; color: white; text-decoration: none; display: flex; align-items: center; gap: 0.75rem; white-space: nowrap; overflow: hidden; }
        .sidebar-header .logo i { font-size: 1.8rem; }
        .sidebar.collapsed { width: 78px; }
        .sidebar.collapsed .sidebar-header .logo span, .sidebar.collapsed nav ul li a span, .sidebar.collapsed .sidebar-footer span { display: none; }
        .sidebar.collapsed nav ul li a, .sidebar.collapsed .sidebar-footer button, .sidebar.collapsed .sidebar-footer a { justify-content: center; padding: 0.75rem; }
        .sidebar nav { flex-grow: 1; margin-top: 1rem; padding: 0 0.75rem; }
        .sidebar nav ul { list-style: none; padding: 0; }
        .sidebar nav ul li { margin-bottom: 0.5rem; }
        .sidebar nav ul li a { color: #e2e8f0; text-decoration: none; display: flex; align-items: center; padding: 0.75rem 1rem; gap: 1rem; border-radius: 8px; font-size: 0.95rem; font-weight: 500; white-space: nowrap; overflow: hidden; transition: background 0.2s ease, color 0.2s ease; }
        .sidebar nav ul li a i { width: 24px; text-align: center; font-size: 1.2rem; flex-shrink: 0; }
        .sidebar nav ul li a:hover { background: rgba(255, 255, 255, 0.1); color: white; }
        .sidebar nav ul li.active a { background: white; color: var(--primary); font-weight: 600; }
        .sidebar-footer { padding: 1rem 0.75rem; margin-top: auto; flex-shrink: 0; }
        .sidebar-footer button, .sidebar-footer a { background: none; border: none; cursor: pointer; color: #e2e8f0; padding: 0.75rem 1rem; border-radius: 8px; width: 100%; display: flex; align-items: center; gap: 1rem; transition: background 0.2s ease, color 0.2s ease; font-family: 'Inter', sans-serif; font-size: 0.95rem; text-decoration: none; }
        .sidebar-footer button:hover, .sidebar-footer a:hover { background: rgba(255, 255, 255, 0.1); color: white; }
        
        /* Main Content Styles */
        .main-content { flex: 1; margin-left: 260px; transition: margin-left 0.3s ease; display: flex; flex-direction: column; width: calc(100% - 260px); }
        .main-content.collapsed { margin-left: 78px; width: calc(100% - 78px); }
        .topbar { background-color: var(--card); color: var(--text); padding: 0 1.5rem; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border-color); height: 70px; flex-shrink: 0; position: sticky; top: 0; z-index: 900; }
        .topbar-left { display: flex; align-items: center; gap: 1rem; }
        .topbar .page-title { font-weight: 600; font-size: 1.25rem; color: var(--text); }
        .toggle-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--muted); width: 40px; height: 40px; border-radius: 50%; display: grid; place-items: center; transition: background 0.2s ease, color 0.2s ease; }
        .toggle-btn:hover { background-color: var(--bg); color: var(--primary); }
        
        /* New Filter Button in Topbar */
        .topbar-right { display: flex; align-items: center; gap: 1rem; }
        .btn-filter {
            background-color: var(--card);
            color: var(--text);
            border: 1px solid var(--border-color);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        .btn-filter:hover {
            background-color: var(--bg);
            color: var(--primary);
            border-color: var(--primary);
        }
        /* Style for active filter button */
        .btn-filter.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary-dark);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn-filter.active:hover {
            background-color: var(--primary-dark);
            color: white;
        }

        main { flex-grow: 1; padding: 1.5rem; overflow: hidden; display: flex; gap: 1.5rem; }

        /* Calendar View */
        .calendar-container, .agenda-container { background-color: var(--card); border-radius: 12px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); padding: 1.5rem; display: flex; flex-direction: column; }
        .calendar-container { flex: 2; }
        .agenda-container { flex: 1; min-width: 320px; max-width: 400px;}
        
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
        .calendar-header h2 { font-size: 1.5rem; color: var(--text); }
        .calendar-nav { display: flex; gap: 0.5rem; align-items: center; }
        .calendar-nav select, .calendar-nav button { background: none; border: 1px solid var(--border-color); border-radius: 8px; padding: 0.5rem 0.8rem; cursor: pointer; transition: all 0.2s; font-family: 'Inter', sans-serif; font-size: 0.9rem; background-color: var(--card); color: var(--text); }
        .calendar-nav select:hover, .calendar-nav button:hover { background-color: var(--bg); color: var(--primary); }
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; flex-grow: 1; }
        .calendar-grid .day-header { font-weight: 600; text-align: center; padding: 0.5rem; color: var(--muted); font-size: 0.9rem; }
        .calendar-day { border-radius: 8px; border: 1px solid var(--border-color); padding: 0.5rem; cursor: pointer; transition: all 0.2s; min-height: 100px; display: flex; flex-direction: column; }
        .calendar-day:hover { border-color: var(--primary); transform: translateY(-2px); }
        .calendar-day.other-month { background-color: var(--bg); color: var(--muted); }
        .calendar-day.today { background-color: color-mix(in srgb, var(--primary) 10%, transparent); border-color: var(--primary); }
        .calendar-day.selected { background-color: var(--primary); color: white; border-color: var(--primary-dark); }
        .calendar-day.selected .day-number { color: white; }
        .day-events { font-size: 0.8rem; margin-top: 0.5rem; overflow: hidden; }
        .day-event { background-color: var(--primary-dark); color: white; border-radius: 4px; padding: 2px 5px; margin-bottom: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Agenda View */
        .agenda-header h3 { font-size: 1.25rem; margin-bottom: 1rem; text-align: center; }
        .agenda-timeline { flex-grow: 1; overflow-y: auto; padding-right: 10px; max-height: 450px; /* Added for scroll */}
        .time-slot { display: flex; align-items: center; border-bottom: 1px solid var(--border-color); padding: 0.75rem 0.5rem; border-radius: 6px; margin-bottom: 5px; transition: background-color 0.2s; }
        .time-slot:not(.booked):hover { background-color: color-mix(in srgb, var(--primary) 5%, transparent); cursor: pointer;}
        .time-slot.booked { background-color: color-mix(in srgb, var(--info) 10%, transparent); cursor: pointer; }
        .time-slot.booked:hover { background-color: color-mix(in srgb, var(--info) 20%, transparent); }
        .time-slot .time { font-weight: 600; color: var(--muted); width: 60px; }
        .time-slot .details { flex-grow: 1; font-weight: 500; } /* Removido a cor prim√°ria padr√£o */

        /* Adicionado para colorir o nome do paciente de acordo com o status */
        .time-slot .details.status-confirmado { color: var(--status-confirmado); }
        .time-slot .details.status-concluido { color: var(--status-concluido); }
        .time-slot .details.status-pendente { color: var(--status-pendente); }
        .time-slot .details.status-cancelado { color: var(--status-cancelado); }


        /* Modal Styles (reused) */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 2000; opacity: 0; transition: opacity 0.25s ease; }
        .modal-overlay.active { opacity: 1; display: flex; }
        .modal-content { background-color: var(--card); color: var(--text); border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 90%; max-width: 550px; transform: translateY(-20px); transition: transform 0.25s ease; max-height: calc(100vh - 60px); display: flex; flex-direction: column; }
        .modal-overlay.active .modal-content { transform: translateY(0); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .modal-header h3 { font-size: 1.2rem; color: var(--text); margin: 0; font-weight: 600; }
        .modal-header h3 i { margin-right: 0.75rem; color: var(--primary); }
        .modal-close-btn { background: none; border: none; font-size: 1.5rem; color: var(--muted); cursor: pointer; line-height: 1; transition: color 0.2s ease; }
        .modal-close-btn:hover { color: var(--danger); }
        .modal-body { overflow-y: auto; padding: 1.5rem; }
        .form-group { margin-bottom: 1.25rem; }
        .form-group:last-child { margin-bottom: 0; }
        .form-group label { display: block; font-size: 0.9rem; color: var(--muted); font-weight: 500; margin-bottom: 0.5rem; }
        .form-group input, .form-group select { font-size: 0.95rem; padding: 0.7rem 0.8rem; width: 100%; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--bg); color: var(--text); transition: border-color 0.2s ease, box-shadow 0.2s ease; }
        .form-group input:focus, .form-group select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary) 20%, transparent); outline: none; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1.25rem; }
        .modal-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 0.75rem; flex-shrink: 0; background-color: var(--bg); }
        
        /* New Info Card Styles */
        .info-card { background-color: var(--bg); padding: 1.5rem; border-radius: 8px; }
        .info-card .info-item { display: flex; align-items: flex-start; gap: 1rem; margin-bottom: 1rem; }
        .info-card .info-item:last-child { margin-bottom: 0; }
        .info-card .info-item i { font-size: 1.1rem; color: var(--muted); margin-top: 4px; width: 20px; text-align: center; }
        .info-card .info-item-content .label { font-size: 0.85rem; color: var(--muted); font-weight: 500; }
        .info-card .info-item-content .value { font-size: 1rem; font-weight: 600; color: var(--text); }


        .btn { padding: 0.6rem 1.2rem; font-size: 0.9rem; border-radius: 8px; text-decoration: none; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; border: 1px solid transparent; cursor: pointer; transition: all 0.2s ease-in-out; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: var(--primary-dark); }
        .btn-danger-outline { background-color: transparent; color: var(--danger); border-color: var(--danger); }
        .btn-danger-outline:hover { background-color: var(--danger); color: white; }

        .btn-secondary { background-color: var(--card); color: var(--text); border-color: var(--border-color); box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); }
        [data-theme="dark"] .btn-secondary { background-color: var(--dark-card); border-color: var(--dark-border-color); color: var(--dark-text); }
        
        /* Responsive */
        .toggle-btn-desktop { display: none; }
        .menu-btn-mobile { display: block; }
        @media(min-width: 769px) { .toggle-btn-desktop { display: grid; } .menu-btn-mobile { display: none; } }
        @media (max-width: 992px) { main { flex-direction: column; overflow: auto; } .agenda-container { min-width: 100%; max-width: 100%; } }
        @media (max-width: 768px) { .sidebar { transform: translateX(-100%); } .sidebar.open { transform: translateX(0); } .main-content, .main-content.collapsed { margin-left: 0; } main { padding: 1rem; } .topbar { padding: 0 1rem; } }

        /* Filter Bar Styles (for the modal, hidden initially) */
        .filter-bar-modal-body {
            display: flex;
            flex-direction: column;
            gap: 1.25rem; /* Equivalent to form-group margin-bottom */
        }
        .filter-bar-modal-body .form-row {
            display: grid;
            grid-template-columns: 1fr; /* Stack on small screens */
            gap: 1.25rem;
        }
        @media (min-width: 500px) { /* Adjust breakpoint as needed */
            .filter-bar-modal-body .form-row {
                grid-template-columns: 1fr 1fr; /* Two columns on larger screens */
            }
        }
    </style>
</head>
<body>
    <div class="layout">
        <aside class="sidebar">
            <div class="sidebar-inner-content">
                <div class="sidebar-header">
                    <a href="{{ url_for('index') }}" class="logo">
                        <i class="fa-solid fa-staff-snake"></i> <span>{{ session.clinica_nome_display or 'Cl√≠nicaOn' }}</span>
                    </a>
                </div>
                <nav>
                    <ul>
                        <li><a href="{{ url_for('index') }}"><i class="fa-solid fa-house-chimney"></i> <span>Dashboard</span></a></li>
                        <li><a href="{{ url_for('listar_pacientes') }}"><i class="fa-solid fa-hospital-user"></i> <span>Pacientes</span></a></li>
                        <li><a href="{{ url_for('buscar_prontuario') }}"><i class="fa-solid fa-notes-medical"></i> <span>Prontu√°rios</span></a></li>
                        <li><a href="{{ url_for('listar_profissionais') }}"><i class="fa-solid fa-user-doctor"></i> <span>Profissionais</span></a></li>
                        <li><a href="{{ url_for('listar_servicos_procedimentos') }}"><i class="fa-solid fa-syringe"></i> <span>Servi√ßos/Proc.</span></a></li>
                        <li><a href="{{ url_for('listar_convenios') }}"><i class="fa-solid fa-handshake"></i> <span>Conv√™nios</span></a></li>
                        <li><a href="{{ url_for('listar_horarios') }}"><i class="fa-regular fa-clock"></i> <span>Hor√°rios</span></a></li>
                        <li class="active"><a href="{{ url_for('listar_agendamentos') }}"><i class="fa-regular fa-calendar-check"></i> <span>Agendamentos</span></a></li>
                        {% if session.user_role == 'admin' %}
                        <li><a href="{{ url_for('listar_usuarios') }}"><i class="fa-solid fa-users-gear"></i> <span>Utilizadores</span></a></li>
                        <li><a href="{{ url_for('listar_modelos_anamnese') }}"><i class="fa-regular fa-file-lines"></i> <span>Modelos Anamnese</span></a></li>
                        {% endif %}
                    </ul>
                </nav>
                <div class="sidebar-footer">
                    <button id="theme-toggle" aria-label="Alternar Tema">
                        <i class="fa-solid fa-sun"></i> <span>Alternar Tema</span>
                    </button>
                    <a href="#" id="logoutButton"><i class="fa-solid fa-arrow-right-from-bracket"></i> <span>Sair</span></a>
                </div>
            </div>
        </aside>

        <div class="main-content">
            <header class="topbar">
                <div class="topbar-left">
                    <button class="toggle-btn menu-btn-mobile"><i class="fa-solid fa-bars"></i></button>
                    <button class="toggle-btn toggle-btn-desktop"><i class="fa-solid fa-bars-staggered"></i></button>
                    <h1 class="page-title">Agendamentos</h1>
                </div>
                <div class="topbar-right">
                    <button class="btn btn-filter" id="openFilterModalBtn">
                        <i class="fas fa-filter"></i> Filtrar
                    </button>
                </div>
            </header>

            <main>
                <div class="calendar-container">
                    <div class="calendar-header">
                        <h2 id="calendar-month-year"></h2>
                        <div class="calendar-nav">
                            <button id="prev-month-btn" title="M√™s Anterior"><i class="fas fa-chevron-left"></i></button>
                            <select id="month-select" aria-label="Selecionar M√™s"></select>
                            <select id="year-select" aria-label="Selecionar Ano"></select>
                            <button id="next-month-btn" title="Pr√≥ximo M√™s"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                    <div class="calendar-grid">
                        <div class="day-header">Dom</div>
                        <div class="day-header">Seg</div>
                        <div class="day-header">Ter</div>
                        <div class="day-header">Qua</div>
                        <div class="day-header">Qui</div>
                        <div class="day-header">Sex</div>
                        <div class="day-header">S√°b</div>
                    </div>
                </div>

                <div class="agenda-container">
                    <div class="agenda-header">
                        <h3 id="agenda-date">Selecione um dia</h3>
                    </div>
                    <div class="agenda-timeline" id="agenda-timeline">
                        </div>
                </div>
            </main>
        </div>
    </div>

    <div class="modal-overlay" id="modalFiltros">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fa-solid fa-filter"></i> Filtrar Agendamentos</h3>
                <button type="button" class="modal-close-btn" data-close>&times;</button>
            </div>
            <form method="GET" action="{{ url_for('listar_agendamentos') }}" id="formFiltros">
                <div class="modal-body filter-bar-modal-body">
                    <div class="form-group">
                        <label for="filter_paciente_nome">Nome do Paciente</label>
                        <input type="text" id="filter_paciente_nome" name="paciente_nome" value="{{ filtros_atuais.paciente_nome or '' }}">
                    </div>
                    <div class="form-group">
                        <label for="filter_profissional_id">Profissional</label>
                        <select id="filter_profissional_id" name="profissional_id">
                            <option value="">Todos</option>
                            {% for profissional in profissionais_para_filtro %}
                            <option value="{{ profissional.id }}" {% if filtros_atuais.profissional_id == profissional.id %}selected{% endif %}>{{ profissional.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filter_status">Status</label>
                        <select id="filter_status" name="status">
                            <option value="">Todos</option>
                            <option value="confirmado" {% if filtros_atuais.status == 'confirmado' %}selected{% endif %}>Confirmado</option>
                            <option value="concluido" {% if filtros_atuais.status == 'concluido' %}selected{% endif %}>Conclu√≠do</option>
                            <option value="pendente" {% if filtros_atuais.status == 'pendente' %}selected{% endif %}>Pendente</option>
                            <option value="cancelado" {% if filtros_atuais.status == 'cancelado' %}selected{% endif %}>Cancelado</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="filter_data_inicio">Data In√≠cio</label>
                            <input type="date" id="filter_data_inicio" name="data_inicio" value="{{ filtros_atuais.data_inicio or '' }}">
                        </div>
                        <div class="form-group">
                            <label for="filter_data_fim">Data Fim</label>
                            <input type="date" id="filter_data_fim" name="data_fim" value="{{ filtros_atuais.data_fim or '' }}">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="clearFiltersBtn">Limpar Filtros</button>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-filter"></i> Aplicar Filtros</button>
                </div>
            </form>
        </div>
    </div>


    <div class="modal-overlay" id="modalDetalhesAgendamento">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fa-solid fa-calendar-check" style="color: var(--info);"></i> Detalhes do Agendamento</h3>
                <button type="button" class="modal-close-btn" data-close>&times;</button>
            </div>
            <div class="modal-body">
                <div class="info-card" id="infoCardAgendamento">
                    </div>
            </div>
            <div class="modal-footer" style="justify-content: space-between;">
                <button type="button" class="btn btn-danger-outline" id="btnApagarAgendamento"><i class="fas fa-trash"></i> Apagar Registro</button>
                <button type="button" class="btn btn-primary" id="btnEditarAgendamento"><i class="fas fa-edit"></i> Editar Registro</button>
            </div>
        </div>
    </div>


    <div class="modal-overlay" id="modalRegistroManual">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('registrar_atendimento_manual') }}" id="formRegistroManual">
                <input type="hidden" name="agendamento_id" id="agendamento_id_manual">
                <div class="modal-header">
                    <h3 id="modalRegistroManualTitle"><i class="fa-solid fa-plus-circle"></i> Registrar Atendimento</h3>
                    <button type="button" class="modal-close-btn" data-close>&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="paciente_id_manual">Selecionar Paciente Existente</label>
                        <select id="paciente_id_manual" name="paciente_id">
                            <option value="">-- Ou digite um novo paciente abaixo --</option>
                            {% for paciente in pacientes_para_filtro %}
                                <option value="{{ paciente.id }}" data-telefone="{{ paciente.contato_telefone or '' }}">{{ paciente.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="cliente_nome_manual">Nome do Paciente (Novo ou selecionado)</label>
                        <input type="text" id="cliente_nome_manual" name="cliente_nome_manual" required>
                    </div>
                    <div class="form-group">
                        <label for="cliente_telefone_manual">Telefone do Paciente (Opcional)</label>
                        <input type="tel" id="cliente_telefone_manual" name="cliente_telefone_manual" placeholder="(XX) XXXXX-XXXX">
                    </div>
                    <div class="form-group">
                        <label for="profissional_id_manual">Profissional</label>
                        <select id="profissional_id_manual" name="barbeiro_id_manual" required>
                        <option value="">Selecione o profissional</option>
                            {% for professional in profissionais_para_filtro %} 
                            <option value="{{ professional.id }}">{{ professional.nome }}</option> {# Corrigido aqui: professional para profissional #}
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="servico_id_manual">Servi√ßo/Procedimento</label>
                        <select id="servico_id_manual" name="servico_id_manual" required>
                            <option value="">Selecione o servi√ßo/procedimento</option>
                            {% for servico_proc in servicos_ativos %} 
                            <option value="{{ servico_proc.id }}" data-preco="{{ servico_proc.preco|float }}">{{ servico_proc.nome }} (R$ {{ "%.2f"|format(servico_proc.preco|float) }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="data_agendamento_manual">Data</label>
                            <input type="date" id="data_agendamento_manual" name="data_agendamento_manual" required>
                        </div>
                        <div class="form-group">
                            <label for="hora_agendamento_manual">Hora</label>
                            <input type="time" id="hora_agendamento_manual" name="hora_agendamento_manual" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="preco_manual">Pre√ßo (R$)</label>
                        <input type="number" id="preco_manual" name="preco_manual" step="0.01" min="0" required readonly>
                    </div>
                    <div class="form-group">
                        <label for="status_manual">Status</label>
                        <select id="status_manual" name="status_manual" required>
                            <option value="confirmado" selected>Confirmado</option>
                            <option value="concluido">Conclu√≠do</option>
                            <option value="pendente">Pendente</option>
                            <option value="cancelado">Cancelado</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-close>Cancelar</button>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <form id="formApagarAgendamento" method="POST" action="{{ url_for('apagar_agendamento') }}" style="display: none;">
        <input type="hidden" name="agendamento_id" id="agendamento_id_apagar">
    </form>


    <script type="module">
        document.addEventListener('DOMContentLoaded', () => {
            const htmlEl = document.documentElement;
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            const menuBtnMobile = document.querySelector('.menu-btn-mobile');
            const toggleBtnDesktop = document.querySelector('.toggle-btn-desktop');
            const themeToggle = document.querySelector('#theme-toggle');
            const logoutButton = document.getElementById('logoutButton');

            // --- Sidebar Logic (reused) ---
            function setupSidebar() {
                if (!sidebar || !mainContent) return;
                const updateDesktopToggleIcon = () => { if (!toggleBtnDesktop) return; const icon = toggleBtnDesktop.querySelector('i'); icon.className = sidebar.classList.contains('collapsed') ? 'fa-solid fa-bars' : 'fa-solid fa-bars-staggered'; };
                const applyInitialState = () => { if (window.innerWidth > 768) { if (localStorage.getItem('sidebarCollapsed') === 'true') { sidebar.classList.add('collapsed'); mainContent.classList.add('collapsed'); } } else { sidebar.classList.remove('open', 'collapsed'); mainContent.classList.remove('collapsed'); } updateDesktopToggleIcon(); };
                if (toggleBtnDesktop) { toggleBtnDesktop.addEventListener('click', () => { sidebar.classList.toggle('collapsed'); mainContent.classList.toggle('collapsed'); localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed')); updateDesktopToggleIcon(); }); }
                if (menuBtnMobile) { menuBtnMobile.addEventListener('click', (e) => { e.stopPropagation(); sidebar.classList.toggle('open'); }); }
                document.addEventListener('click', (e) => { if (window.innerWidth <= 768 && sidebar.classList.contains('open') && !sidebar.contains(e.target) && !menuBtnMobile.contains(e.target)) { sidebar.classList.remove('open'); } });
                applyInitialState();
                window.addEventListener('resize', applyInitialState);
            }

            // --- Theme Logic (reused) ---
            function setupTheme() {
                if (!themeToggle) return;
                const updateThemeUI = (theme) => { htmlEl.setAttribute('data-theme', theme); const icon = themeToggle.querySelector('i'); icon.className = theme === 'dark' ? 'fa-solid fa-moon' : 'fa-solid fa-sun'; };
                const currentTheme = localStorage.getItem('theme') || 'light';
                updateThemeUI(currentTheme);
                themeToggle.addEventListener('click', () => { const newTheme = htmlEl.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'; localStorage.setItem('theme', newTheme); updateThemeUI(newTheme); });
            }

            // --- Logout Logic (reused) ---
            function setupLogout() {
                if (!logoutButton) return;
                logoutButton.addEventListener('click', async (event) => { event.preventDefault(); fetch("{{ url_for('logout') }}", { method: 'POST' }).then(() => window.location.href = "{{ url_for('login_page') }}").catch(() => window.location.href = "{{ url_for('login_page') }}"); });
            }

            // --- Calendar & Agenda Logic ---
            function setupCalendar() {
                const calendarGrid = document.querySelector('.calendar-grid');
                const monthYearDisplay = document.getElementById('calendar-month-year');
                const agendaDateDisplay = document.getElementById('agenda-date');
                const agendaTimeline = document.getElementById('agenda-timeline');
                const prevMonthBtn = document.getElementById('prev-month-btn');
                const nextMonthBtn = document.getElementById('next-month-btn');
                const monthSelect = document.getElementById('month-select');
                const yearSelect = document.getElementById('year-select');
                
                const modalRegistro = document.getElementById('modalRegistroManual');
                const modalFormRegistro = document.getElementById('formRegistroManual');
                const modalTitleRegistro = document.getElementById('modalRegistroManualTitle');
                
                const modalDetalhes = document.getElementById('modalDetalhesAgendamento');
                const infoCardDetalhes = document.getElementById('infoCardAgendamento');
                const btnEditar = document.getElementById('btnEditarAgendamento');
                const btnApagar = document.getElementById('btnApagarAgendamento');
                const formApagar = document.getElementById('formApagarAgendamento');

                // Novos elementos para os filtros
                const openFilterModalBtn = document.getElementById('openFilterModalBtn');
                const modalFiltros = document.getElementById('modalFiltros');
                const formFiltros = document.getElementById('formFiltros');
                const clearFiltersBtn = document.getElementById('clearFiltersBtn');


                let currentDate = new Date();
                let selectedDate = new Date();
                currentDate.setDate(1); // Start with the first day of the month

                const agendamentosDoServidor = [
                    {% for agendamento in agendamentos %}
                        {
                            "id": "{{ agendamento.id }}",
                            "data_agendamento": "{{ agendamento.data_agendamento if agendamento.data_agendamento else '' }}",
                            "hora_agendamento": "{{ agendamento.hora_agendamento }}",
                            "paciente_id": "{{ agendamento.paciente_id }}",
                            "paciente_nome": "{{ agendamento.paciente_nome | e }}",
                            "profissional_id": "{{ agendamento.profissional_id }}",
                            "profissional_nome": "{{ agendamento.profissional_nome | e }}",
                            "servico_id": "{{ agendamento.servico_procedimento_id }}",
                            "servico_nome": "{{ agendamento.servico_procedimento_nome | e }}",
                            "preco": "{{ agendamento.servico_procedimento_preco }}",
                            "status": "{{ agendamento.status }}"
                        },
                    {% endfor %}
                ];

                const appointments = {};
                agendamentosDoServidor.forEach(ag => {
                    if (ag.data_agendamento) {
                        if (!appointments[ag.data_agendamento]) {
                            appointments[ag.data_agendamento] = [];
                        }
                        appointments[ag.data_agendamento].push(ag);
                    }
                });


                function populateSelectors() {
                    const months = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
                    monthSelect.innerHTML = months.map((month, i) => `<option value="${i}">${month}</option>`).join('');
                    const currentYear = new Date().getFullYear();
                    yearSelect.innerHTML = '';
                    for (let year = currentYear - 5; year <= currentYear + 5; year++) {
                        yearSelect.innerHTML += `<option value="${year}">${year}</option>`;
                    }
                }

                function updateSelectors(date) {
                    monthSelect.value = date.getMonth();
                    yearSelect.value = date.getFullYear();
                }

                function renderCalendar(date) {
                    const year = date.getFullYear();
                    const month = date.getMonth();

                    monthYearDisplay.textContent = new Intl.DateTimeFormat('pt-BR', { month: 'long', year: 'numeric' }).format(date);
                    updateSelectors(date);

                    let dayElements = '';
                    const firstDayOfMonth = new Date(year, month, 1).getDay();
                    for (let i = 0; i < firstDayOfMonth; i++) {
                        dayElements += '<div class="calendar-day other-month"></div>';
                    }

                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                    for (let day = 1; day <= daysInMonth; day++) {
                        const dayDate = new Date(year, month, day);
                        const dateString = dayDate.toISOString().split('T')[0];
                        let classes = 'calendar-day';
                        if (dayDate.toDateString() === new Date().toDateString()) classes += ' today';
                        if (dayDate.toDateString() === selectedDate.toDateString()) classes += ' selected';
                        
                        let eventHtml = '';
                        if(appointments[dateString]) {
                            eventHtml += '<div class="day-events">';
                            // Usar map para adicionar a classe de status
                            appointments[dateString].slice(0, 2).forEach(app => {
                                // Adiciona a classe 'status-' + status do agendamento
                                eventHtml += `<div class="day-event status-${app.status}">${app.paciente_nome}</div>`;
                            });
                            if (appointments[dateString].length > 2) {
                                eventHtml += `<div style="font-size: 0.7rem; text-align: center;">+${appointments[dateString].length - 2} mais...</div>`;
                            }
                            eventHtml += '</div>';
                        }
                        
                        dayElements += `<div class="${classes}" data-date="${dateString}"><div class="day-number">${day}</div>${eventHtml}</div>`;
                    }

                    calendarGrid.innerHTML = `
                        <div class="day-header">Dom</div><div class="day-header">Seg</div><div class="day-header">Ter</div><div class="day-header">Qua</div><div class="day-header">Qui</div><div class="day-header">Sex</div><div class="day-header">S√°b</div>
                        ${dayElements}
                    `;
                    
                    document.querySelectorAll('.calendar-day:not(.other-month)').forEach(dayEl => {
                                   dayEl.addEventListener('click', () => {
                                   selectedDate = new Date(dayEl.dataset.date + 'T00:00:00');
                                   renderCalendar(currentDate); 
                                   renderAgenda(selectedDate);
                                  });
                    });
                }

                function renderAgenda(date) {
                    agendaDateDisplay.textContent = new Intl.DateTimeFormat('pt-BR', { dateStyle: 'full' }).format(date);
                    agendaTimeline.innerHTML = '';
                    
                    const dateString = date.toISOString().split('T')[0];
                    const dailyAppointments = appointments[dateString] || [];

                    // Loop para gerar hor√°rios das 00:00 √†s 23:30
                    for(let hour = 0; hour < 24; hour++) { 
                        for(let minute = 0; minute < 60; minute += 30) {
                            const timeStr = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
                            const bookedAppointment = dailyAppointments.find(app => app.hora_agendamento === timeStr);
                            
                            const slotEl = document.createElement('div');
                            slotEl.className = 'time-slot';
                            slotEl.dataset.time = timeStr;
                            
                            const detailsText = bookedAppointment ? bookedAppointment.paciente_nome : 'Dispon√≠vel';
                            
                            // Adiciona a classe de status ao elemento 'details'
                            const statusClass = bookedAppointment ? `status-${bookedAppointment.status}` : '';
                            slotEl.innerHTML = `<div class="time">${timeStr}</div><div class="details ${statusClass}">${detailsText}</div>`;
                            
                            if (bookedAppointment) {
                                slotEl.classList.add('booked');
                                slotEl.addEventListener('click', () => openDetailsModal(bookedAppointment));
                            } else {
                                slotEl.addEventListener('click', () => openBookingModal(date, timeStr));
                            }
                            agendaTimeline.appendChild(slotEl);
                        }
                    }
                }
                
                function openBookingModal(date, time) {
                    modalFormRegistro.reset();
                    modalFormRegistro.action = "{{ url_for('registrar_atendimento_manual') }}";
                    modalTitleRegistro.innerHTML = '<i class="fa-solid fa-plus-circle"></i> Registrar Atendimento';
                    document.getElementById('agendamento_id_manual').value = '';

                    document.getElementById('data_agendamento_manual').value = date.toISOString().split('T')[0];
                    document.getElementById('hora_agendamento_manual').value = time;
                    document.getElementById('cliente_nome_manual').readOnly = false;
                    document.getElementById('cliente_telefone_manual').readOnly = false;
                    modalRegistro.classList.add('active');
                }

                function openDetailsModal(agendamento) {
                    infoCardDetalhes.innerHTML = `
                        <div class="info-item">
                            <i class="fa-solid fa-user"></i>
                            <div class="info-item-content">
                                <span class="label">Paciente</span>
                                <span class="value">${agendamento.paciente_nome}</span>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="fa-solid fa-user-doctor"></i>
                            <div class="info-item-content">
                                <span class="label">Profissional</span>
                                <span class="value">${agendamento.profissional_nome}</span>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="fa-solid fa-syringe"></i>
                            <div class="info-item-content">
                                <span class="label">Servi√ßo</span>
                                <span class="value">${agendamento.servico_nome}</span>
                            </div>
                        </div>
                           <div class="info-item">
                            <i class="fa-solid fa-hand-holding-dollar"></i>
                            <div class="info-item-content">
                                <span class="label">Pre√ßo</span>
                                <span class="value">R$ ${parseFloat(agendamento.preco).toFixed(2)}</span>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="fa-solid fa-toggle-on"></i>
                            <div class="info-item-content">
                                <span class="label">Status</span>
                                <span class="value">${agendamento.status.charAt(0).toUpperCase() + agendamento.status.slice(1)}</span>
                            </div>
                        </div>
                    `;

                    btnEditar.onclick = () => {
                        modalDetalhes.classList.remove('active');
                        openEditModal(agendamento);
                    };

                    btnApagar.onclick = () => {
                                   if (confirm('Tem certeza que deseja apagar este agendamento? Esta a√ß√£o n√£o pode ser desfeita.')) {
                                       formApagar.action = "{{ url_for('apagar_agendamento') }}"; // A√ß√£o da rota j√° configurada
                                       document.getElementById('agendamento_id_apagar').value = agendamento.id; // Define o ID no campo oculto
                                       formApagar.submit();
                                   }
                    };

                    modalDetalhes.classList.add('active');
                }

                function openEditModal(agendamento) {
                    modalFormRegistro.reset();
                    // Assumindo que voc√™ ter√° uma rota para editar
                    modalFormRegistro.action = `{{ url_for('editar_agendamento') }}`;
                    modalTitleRegistro.innerHTML = '<i class="fas fa-edit"></i> Editar Agendamento';
                    
                    // Preenche o formul√°rio com os dados existentes
                    document.getElementById('agendamento_id_manual').value = agendamento.id;
                    document.getElementById('cliente_nome_manual').value = agendamento.paciente_nome;
                    document.getElementById('paciente_id_manual').value = agendamento.paciente_id;
                    document.getElementById('profissional_id_manual').value = agendamento.profissional_id;
                    document.getElementById('servico_id_manual').value = agendamento.servico_id;
                    document.getElementById('data_agendamento_manual').value = agendamento.data_agendamento;
                    document.getElementById('hora_agendamento_manual').value = agendamento.hora_agendamento;
                    document.getElementById('preco_manual').value = parseFloat(agendamento.preco).toFixed(2);
                    document.getElementById('status_manual').value = agendamento.status;
                    
                    // Dispara o evento change para que a l√≥gica de nome/telefone do paciente seja acionada se necess√°rio
                    document.getElementById('paciente_id_manual').dispatchEvent(new Event('change'));
                    
                    modalRegistro.classList.add('active');
                }


                prevMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(currentDate); });
                nextMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(currentDate); });
                monthSelect.addEventListener('change', () => { currentDate.setMonth(monthSelect.value); renderCalendar(currentDate); });
                yearSelect.addEventListener('change', () => { currentDate.setFullYear(yearSelect.value); renderCalendar(currentDate); });

                document.querySelectorAll('.modal-overlay').forEach(modalEl => {
                    modalEl.querySelectorAll('[data-close]').forEach(btn => btn.addEventListener('click', () => modalEl.classList.remove('active')));
                    modalEl.addEventListener('click', (e) => { if (e.target === modalEl) modalEl.classList.remove('active'); });
                });
                
                const servicoSelect = document.getElementById('servico_id_manual');
                const precoInput = document.getElementById('preco_manual');
                if (servicoSelect && precoInput) {
                    servicoSelect.addEventListener('change', (e) => {
                        const selectedOption = e.target.options[e.target.selectedIndex];
                        const price = selectedOption.dataset.preco || '';
                        precoInput.value = price ? parseFloat(price).toFixed(2) : '';
                    });
                }
                
                const pacienteSelectManual = document.getElementById('paciente_id_manual');
                const nomeInputManual = document.getElementById('cliente_nome_manual');
                const telefoneInputManual = document.getElementById('cliente_telefone_manual');
                if(pacienteSelectManual && nomeInputManual && telefoneInputManual) {
                    pacienteSelectManual.addEventListener('change', function() {
                               const selectedOption = this.options[this.selectedIndex];
                               if (selectedOption.value) {
                                   nomeInputManual.value = selectedOption.text;
                                   telefoneInputManual.value = selectedOption.dataset.telefone || '';
                                   nomeInputManual.readOnly = true;
                                   // Telefone pode ser editado mesmo com paciente selecionado
                                   telefoneInputManual.readOnly = false;
                               } else {
                                   nomeInputManual.value = '';
                                   telefoneInputManual.value = '';
                                   nomeInputManual.readOnly = false;
                                   telefoneInputManual.readOnly = false;
                               }
                           });
                }
                
                populateSelectors();
                renderCalendar(currentDate);
                renderAgenda(selectedDate);

                // --- L√≥gica de Filtros (Nova) ---
                const currentFilters = {{ filtros_atuais | tojson }}; // Pega os filtros do Flask
                const filterBtn = document.getElementById('openFilterModalBtn');
                const filterModal = document.getElementById('modalFiltros');
                const filterForm = document.getElementById('formFiltros');
                const clearFiltersButton = document.getElementById('clearFiltersBtn');

                // Verifica se h√° filtros aplicados para mudar a cor do bot√£o
                function checkActiveFilters() {
                    let filtersApplied = false;
                    for (const key in currentFilters) {
                        // Ignora os filtros de data padr√£o do m√™s atual
                        const isDefaultDateFilter = (key === 'data_inicio' || key === 'data_fim') && 
                                                    (new Date(currentFilters[key]).getMonth() === new Date().getMonth() &&
                                                     new Date(currentFilters[key]).getFullYear() === new Date().getFullYear() &&
                                                     new Date(currentFilters[key]).getDate() === (key === 'data_inicio' ? 1 : new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate()));

                        if (currentFilters[key] && currentFilters[key] !== '' && !isDefaultDateFilter) {
                            filtersApplied = true;
                            break;
                        }
                    }
                    if (filtersApplied) {
                        filterBtn.classList.add('active');
                    } else {
                        filterBtn.classList.remove('active');
                    }
                }

                // Abre a modal de filtros
                openFilterModalBtn.addEventListener('click', () => {
                    filterModal.classList.add('active');
                });

                // Limpa os filtros
                clearFiltersButton.addEventListener('click', () => {
                    // Limpa todos os campos do formul√°rio de filtros
                    filterForm.querySelectorAll('input, select').forEach(element => {
                        if (element.type === 'select-one' || element.type === 'text' || element.type === 'date') {
                            element.value = '';
                        }
                    });
                    // Define o valor padr√£o das datas para o m√™s atual novamente antes de submeter
                    const today = new Date();
                    const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                    const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);

                    document.getElementById('filter_data_inicio').value = firstDayOfMonth.toISOString().split('T')[0];
                    document.getElementById('filter_data_fim').value = lastDayOfMonth.toISOString().split('T')[0];

                    filterForm.submit(); // Submete o formul√°rio para recarregar a p√°gina sem filtros
                });

                // Chama a fun√ß√£o para verificar filtros ao carregar a p√°gina
                checkActiveFilters();

            }

            // --- Initialization ---
            setupSidebar();
            setupTheme();
            setupLogout();
            setupCalendar();
        });
    </script>
</body>
</html>
