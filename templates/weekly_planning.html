<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planejamento Semanal - {{ patient.nome }} - {{ session.clinica_nome_display or 'Clínica On' }}</title>
    
    <link rel="icon" type="image/png" href="https://placehold.co/40x40/0d9488/ffffff?text=C">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        :root {
            --bg: #f1f5f9;
            --card: #ffffff;
            --text: #0f172a;
            --muted: #64748b;
            --accent: #9b53b8;
            --primary-dark: #115e59;
            --primary: #5587c2;
            --primary-light: #c8dcf3;
            --secondary: #f59e0b;
            --danger: #dc2626;
            --success: #16a34a;
            --warning: #f59e0b;
            --info: #0ea5e9;
            --border-color: #e2e8f0;

            --dark-bg: #0f172a;
            --dark-card: #1e293b;
            --dark-text: #f1f5f9;
            --dark-muted: #94a3b8;
            --dark-border-color: #334155;

            color-scheme: light;
        }
        [data-theme="dark"] {
            --bg: var(--dark-bg);
            --text: var(--dark-text);
            --card: var(--dark-card);
            --muted: var(--dark-muted);
            --border-color: var(--dark-border-color);
            color-scheme: dark;
        }
        ::-webkit-scrollbar {
            background-color: var(--bg);
            width: 0.5625rem;
            height: 0.5625rem;
            border-top-right-radius: 0.3125rem;
            border-bottom-right-radius: 0.3125rem;
            transition: background-color 0.8s ease;
        }
        ::-webkit-scrollbar-thumb {
            background-color: var(--muted);
            border-radius: .3125rem;
            transition: background-color 0.8s ease;
        }
        ::-webkit-scrollbar-thumb:hover {
            transition: background-color 0.8s ease;
            background-color: var(--primary);
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        html, body {
            height: 100%;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .layout {
            display: flex;
            min-height: 100vh;
            width: 100%;
        }
        .main-content {
            flex: 1; margin-left: 260px;
            transition: margin-left 0.3s ease;
            display: flex; flex-direction: column; width: calc(100% - 260px);
            max-width: calc(100% - 260px);
            box-sizing: border-box;
        }
        .main-content.collapsed { 
            margin-left: 88px;
            width: calc(100% - 88px);
            max-width: calc(100% - 88px);
        }
        .topbar {
            background-color: var(--card);
            color: var(--text);
            padding: 0 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border-color);
            height: 70px;
            flex-shrink: 0;
            position: sticky;
            top: 0;
            z-index: 900;
        }
        .topbar-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .topbar .page-title {
            font-weight: 600;
            font-size: 1.25rem;
            color: var(--text);
        }
        .toggle-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--muted);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: grid;
            place-items: center;
            transition: background 0.2s ease, color 0.2s ease;
        }
        .toggle-btn:hover {
            background-color: var(--bg);
            color: var(--primary);
        }
        .topbar-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }
        main { 
            flex-grow: 1; 
            padding: 1.5rem; 
            width: 100%;
            max-width: 100%;
            display: flex;
            gap: 1.5rem;
            height: calc(100vh - 70px - 3rem - 1.5rem - 1.5rem); 
        }
        .btn {
            padding: 0.6rem 1.2rem;
            font-size: 0.9rem;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        .btn-primary:hover {
            background-color: var(--accent);
        }
        .btn-secondary {
            background-color: var(--muted);
            color: white;
        }
        .btn-secondary:hover {
            background-color: var(--text);
        }

        @media(min-width: 769px) {
            .toggle-btn-desktop { display: grid; }
            .menu-btn-mobile { display: none; }
            span.btn-text-desktop { display: inline; }
        }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); box-shadow: 4px 0 15px rgba(0,0,0,0.1); }
            .sidebar.collapsed { transform: translateX(-100%); width: 280px; }
            .sidebar.collapsed nav ul li a, .sidebar.collapsed .sidebar-footer button, .sidebar.collapsed .sidebar-footer a { justify-content: flex-start; }
            .sidebar.collapsed nav ul li a span, .sidebar.collapsed .sidebar-footer span { display: inline; }
            .sidebar.collapsed .sidebar-header .logo span { display: inline; }
            .main-content, .main-content.collapsed { margin-left: 0; width: 100%; }
            main { 
                padding: 1rem; 
                flex-direction: column; 
                height: auto;
            }
            .topbar { flex-wrap: wrap; height: auto; row-gap: 1rem; padding-top: 1rem; padding-bottom: 1rem;}
            .topbar-left, .topbar-actions { width: 100%; justify-content: space-between; }
        }

        .planning-container {
            display: flex;
            flex-grow: 1;
            gap: 1.5rem;
            height: 100%; 
        }

        .column {
            background-color: var(--card);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            flex: 1;
            min-width: 300px;
            height: 100%; 
        }

        .column-header {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .column-content {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 0.5rem;
            min-height: 0; 
        }

        .planning-card {
            background: var(--card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            width: 100%;
            display: flex;
            flex-direction: column;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            margin-bottom: 0.75rem;
        }

        .planning-card:hover {
            scale: 1.01;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }

        .planning-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: white;
            position: relative;
            border-radius: 15px 15px 0 0;
        }

        .planning-card-header h5 {
            font-size: 1rem;
            font-weight: 700;
            margin: 0;
            color: white;
            flex: 1;
        }

        .planning-card-body {
            padding: 1rem 1.5rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .planning-card-body p {
            font-size: 0.85rem;
            color: var(--muted);
            margin: 0;
        }
        
        .meta-card {
            cursor: grab;
            position: relative;
        }
        .meta-card.dragging {
            opacity: 0.5;
            border-style: dashed;
        }
        .meta-card .meta-description {
            font-size: 0.85rem;
            color: var(--muted);
        }
        .meta-card .pei-tag {
            display: inline-block;
            background-color: var(--primary);
            color: white;
            font-size: 0.7rem;
            padding: 0.2em 0.5em;
            border-radius: 4px;
            margin-top: 0.5rem;
            font-weight: 500;
        }

        .appointment-slot {
            min-height: 80px;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .appointment-slot.drag-over {
            background-color: color-mix(in srgb, var(--primary) 10%, transparent);
            border-color: var(--primary);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary) 20%, transparent);
        }
        .appointment-slot .appointment-info {
            font-size: 0.85rem;
            color: var(--muted);
        }
        .appointment-slot .associated-meta {
            background-color: color-mix(in srgb, var(--success) 15%, transparent);
            color: var(--success);
            border: 1px solid var(--success);
            border-radius: 6px;
            padding: 0.4rem 0.6rem;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
            margin-top: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .appointment-slot .associated-meta .remove-meta-btn {
            background: none;
            border: none;
            color: var(--danger);
            font-size: 0.9rem;
            cursor: pointer;
            padding: 0;
            margin-left: 0.5rem;
        }
        .appointment-slot .associated-meta .remove-meta-btn:hover {
            color: var(--danger);
            transform: scale(1.1);
        }

        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.25s ease;
        }
        .modal-overlay.active { opacity: 1; display: flex; }
        .modal-content { 
            background-color: var(--card); 
            color: var(--text); 
            border-radius: 16px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); 
            width: 90%;
            max-width: 700px;
            transform: translateY(-20px); 
            transition: transform 0.25s ease; 
            max-height: 90vh;
            display: flex; 
            flex-direction: column; 
            overflow: hidden;
        }
        .modal-overlay.active .modal-content { transform: translateY(0); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 1.5rem 2rem; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .modal-header h3 { font-size: 1.4rem; color: var(--text); margin: 0; font-weight: 600; }
        .modal-header h3 i { margin-right: 0.75rem; color: var(--primary); }
        .modal-close-btn { background: none; border: none; font-size: 1.5rem; color: var(--muted); cursor: pointer; line-height: 1; transition: color 0.2s ease; }
        .modal-close-btn:hover { color: var(--danger); }
        .modal-body { 
            overflow-y: auto; 
            padding: 2rem; 
            flex-grow: 1;
            max-height: calc(90vh - 150px);
        }
        .modal-body h4 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 1rem;
        }
        .modal-body ul {
            list-style: none;
            padding: 0;
        }
        .modal-body ul li {
            background-color: var(--bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .modal-body ul li .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .modal-body ul li .status-indicator.finalizada { background-color: var(--success); }
        .modal-body ul li .status-indicator.pendente { background-color: var(--warning); }
        .modal-body ul li .status-indicator.em-progresso { background-color: var(--info); }

        .patient-select-container {
            background-color: var(--card);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .patient-select-container label {
            display: block;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.75rem;
        }
        .patient-select-container select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--bg);
            color: var(--text);
            font-size: 0.95rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .patient-select-container select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary) 20%, transparent);
            outline: none;
        }

        @media (max-width: 992px) {
            .planning-container {
                flex-direction: column;
            }
            .column {
                min-width: unset;
                width: 100%;
            }
        }

        .custom-confirm-modal .modal-content {
            max-width: 400px;
            text-align: center;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border: 1px solid var(--border-color);
        }
        .custom-confirm-modal .modal-header {
            border-bottom: none;
            padding: 0;
            margin-bottom: 1.5rem;
            justify-content: center;
            position: relative;
        }
        .custom-confirm-modal .modal-header h3 {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text);
        }
        .custom-confirm-modal .modal-body {
            padding: 0;
            margin-bottom: 1.5rem;
            font-size: 1rem;
            color: var(--muted);
            line-height: 1.5;
        }
        .custom-confirm-modal .modal-footer {
            border-top: none;
            padding: 0;
            justify-content: center;
            gap: 1rem;
        }
        .custom-confirm-modal .modal-close-btn {
            position: absolute;
            top: -1rem;
            right: -1rem;
            background: var(--bg);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: var(--muted);
        }
        .custom-confirm-modal .modal-close-btn:hover {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }

        .message-modal .modal-content {
            max-width: 450px;
            text-align: center;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .message-modal .modal-header {
            border-bottom: none;
            padding: 0;
            margin-bottom: 1.5rem;
            justify-content: center;
            position: relative;
            width: 100%;
            flex-direction: column;
        }
        .message-modal .modal-header .modal-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            display: block;
            width: auto;
        }
        .message-modal .modal-header .modal-icon.success { color: var(--success); }
        .message-modal .modal-header .modal-icon.danger { color: var(--danger); }
        .message-modal .modal-header .modal-icon.warning { color: var(--warning); }
        .message-modal .modal-header .modal-icon.info { color: var(--info); }

        .message-modal .modal-header h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text);
            margin: 0;
        }
        .message-modal .modal-body {
            padding: 0;
            font-size: 1rem;
            color: var(--muted);
            line-height: 1.5;
            margin-bottom: 1.5rem;
            width: 100%;
        }
        .message-modal .modal-footer {
            border-top: none;
            padding: 0;
            justify-content: center;
            width: 100%;
        }
        .message-modal .modal-close-btn {
            position: absolute;
            top: -1rem;
            right: -1rem;
            background: var(--bg);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: var(--muted);
        }
        .message-modal .modal-close-btn:hover {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }

        #messageModalCloseBtn {
            background-color: var(--primary);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.2s ease;
        }
        #messageModalCloseBtn:hover {
            background-color: var(--accent);
        }

        .filter-modal .modal-content {
            max-width: 500px;
            padding: 2rem;
        }
        .filter-modal .modal-body .form-group {
            margin-bottom: 1.5rem;
        }
        .filter-modal .modal-body label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text);
        }
        .filter-modal .modal-body input[type="date"],
        .filter-modal .modal-body select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--bg);
            color: var(--text);
            font-size: 0.95rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .filter-modal .modal-body input[type="date"]:focus,
        .filter-modal .modal-body select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary) 20%, transparent);
            outline: none;
        }
        .filter-modal .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }

        .meta-details-modal-modern .modal-content {
            max-width: 800px;
            border-radius: 20px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .meta-details-modal-modern .modal-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: white;
            padding: 1.5rem 2rem;
            border-bottom: none;
            position: relative;
            overflow: hidden;
        }

        .meta-details-modal-modern .modal-header::before {
            content: '';
            position: absolute;
            top: -30px;
            right: -30px;
            width: 100px;
            height: 100px;
            background: radial-gradient(circle at center, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            border-radius: 50%;
        }

        .meta-details-modal-modern .modal-header h3 {
            color: white;
            font-size: 1.6rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 1rem;
            position: relative;
            z-index: 1;
        }

        .meta-details-modal-modern .modal-header h3 i {
            font-size: 1.8rem;
            color: rgba(255,255,255,0.8);
        }

        .meta-details-modal-modern .modal-close-btn {
            color: white;
            font-size: 1.8rem;
            position: relative;
            z-index: 1;
        }

        .meta-details-modal-modern .modal-body {
            padding: 2rem;
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            overflow-y: auto;
        }

        @media (min-width: 768px) {
            .meta-details-modal-modern .modal-body {
                grid-template-columns: 1fr 1fr;
            }
        }

        .meta-details-modal-modern .info-section {
            background-color: var(--bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .meta-details-modal-modern .info-section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .meta-details-modal-modern .info-section-title i {
            color: var(--primary);
        }

        .meta-details-modal-modern .info-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .meta-details-modal-modern .info-label {
            font-size: 0.85rem;
            color: var(--muted);
            font-weight: 500;
        }

        .meta-details-modal-modern .info-value {
            font-size: 0.95rem;
            color: var(--text);
            font-weight: 600;
        }

        .meta-details-modal-modern .alvos-list-container {
            flex-grow: 1;
            overflow-y: auto;
            max-height: 250px;
            padding-right: 0.5rem;
        }

        .meta-details-modal-modern .alvos-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .meta-details-modal-modern .alvos-list li {
            background-color: var(--card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .meta-details-modal-modern .alvos-list li:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transform: translateY(-1px);
        }

        .meta-details-modal-modern .alvos-list li .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .meta-details-modal-modern .alvos-list li .status-indicator.finalizada { background-color: var(--success); }
        .meta-details-modal-modern .alvos-list li .status-indicator.pendente { background-color: var(--warning); }
        .meta-details-modal-modern .alvos-list li .status-indicator.em-progresso { background-color: var(--info); }
        
        .meta-details-modal-modern .empty-list-message {
            color: var(--muted);
            font-style: italic;
            text-align: center;
            padding: 1rem;
        }
    </style>
</head>
<body>
    <div class="layout">
        {% include 'Nav.html' %}

        <div class="main-content">
            <header class="topbar">
                <div class="topbar-left">
                    <button class="toggle-btn menu-btn-mobile"><i class="fa-solid fa-bars"></i></button>
                    <button class="toggle-btn toggle-btn-desktop"><i class="fa-solid fa-bars-staggered"></i></button>
                    <h1 class="page-title">Planejamento Semanal</h1>
                </div>
                <div class="topbar-actions">
                    <button id="filterButton" class="btn btn-primary">
                        <i class="fas fa-filter"></i> Filtros
                    </button>
                    <button id="printWeeklyPlanningBtn" class="btn btn-secondary">
                        <i class="fas fa-print"></i> Imprimir Relatório
                    </button>
                </div>
            </header>

            <main>
                <div class="patient-select-container">
                    <label for="patient-selector">Paciente:</label>
                    <select id="patient-selector">
                        <option value="">Selecione um paciente</option>
                        <option value="{{ patient.id }}" selected>{{ patient.nome }}</option>
                    </select>
                </div>

                <div class="planning-container">
                    <div class="column metas-column">
                        <h2 class="column-header">Metas Ativas</h2>
                        <div class="column-content" id="metas-list">
                            {% if metas_ativas %}
                                {% for meta in metas_ativas %}
                                    <div class="meta-card planning-card" draggable="true" 
                                        data-meta-id="{{ meta.id }}" 
                                        data-meta-name="{{ meta.descricao }}"
                                        data-pei-id="{{ meta.pei_id }}"
                                        data-pei-title="{{ meta.pei_title }}">
                                        <div class="planning-card-header">
                                            <h5>{{ meta.descricao }}</h5>
                                        </div>
                                        <div class="planning-card-body">
                                            <p class="meta-description">{{ meta.descricao }}</p>
                                            <span class="pei-tag">PEI: {{ meta.pei_title }}</span>
                                        </div>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <p class="text-center text-muted">Nenhuma meta ativa encontrada para este paciente.</p>
                            {% endif %}
                        </div>
                    </div>

                    <div class="column sessions-column">
                        <h2 class="column-header">Agendamentos da Semana</h2>
                        <div class="column-content" id="sessions-list">
                            {% if agendamentos_semana %}
                                {% for agendamento in agendamentos_semana %}
                                    <div class="appointment-slot planning-card" 
                                        data-appointment-id="{{ agendamento.id }}"
                                        data-date="{{ agendamento.data_agendamento }}"
                                        data-time="{{ agendamento.hora_agendamento }}">
                                        <div class="planning-card-header">
                                            <h5>{{ agendamento.data_formatada }} - {{ agendamento.hora_agendamento }}</h5>
                                        </div>
                                        <div class="planning-card-body">
                                            <p class="appointment-info">Profissional: {{ agendamento.profissional_nome }}</p>
                                            <p class="appointment-info">Serviço: {{ agendamento.servico_procedimento_nome }}</p>
                                            <div class="associated-metas-container">
                                                {% for associated_meta in agendamento.metas_associadas %}
                                                    <div class="associated-meta" 
                                                        data-associated-meta-id="{{ associated_meta.meta_id }}"
                                                        data-associated-pei-id="{{ associated_meta.pei_id }}">
                                                        <span>{{ associated_meta.meta_nome }}</span>
                                                        <button class="remove-meta-btn" title="Remover Meta">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <p class="text-center text-muted">Nenhum agendamento encontrado para este paciente nesta semana.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div class="modal-overlay meta-details-modal-modern" id="metaDetailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="meta-modal-title"><i class="fas fa-bullseye"></i> Detalhes da Meta</h3>
                <button type="button" class="modal-close-btn" data-close-modal>&times;</button>
            </div>
            <div class="modal-body">
                <div class="info-section">
                    <h4 class="info-section-title"><i class="fas fa-info-circle"></i> Descrição da Meta</h4>
                    <div class="info-item">
                        <span class="info-label">Descrição:</span>
                        <span class="info-value" id="meta-modal-description"></span>
                    </div>
                </div>

                <div class="info-section">
                    <h4 class="info-section-title"><i class="fas fa-list-check"></i> Alvos da Meta</h4>
                    <div class="alvos-list-container">
                        <ul class="alvos-list" id="meta-modal-alvos-list">
                        </ul>
                        <p id="no-alvos-message" class="empty-list-message" style="display: none;">Nenhum alvo definido para esta meta.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay custom-confirm-modal" id="customConfirmModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="confirm-modal-title">Confirmação</h3>
                <button type="button" class="modal-close-btn" data-close-modal="customConfirmModal">&times;</button>
            </div>
            <div class="modal-body">
                <p id="confirm-modal-message"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="confirmCancelBtn">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmConfirmBtn">Confirmar</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay message-modal" id="messageModal">
        <div class="modal-content">
            <div class="modal-header">
                <div id="message-modal-icon" class="modal-icon"></div>
                <h3 id="message-modal-title"></h3>
                <button type="button" class="modal-close-btn" data-close-modal="messageModal">&times;</button>
            </div>
            <div class="modal-body">
                <p id="message-modal-text"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="messageModalCloseBtn">OK</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay filter-modal" id="filterModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-filter"></i> Filtrar Agendamentos</h3>
                <button type="button" class="modal-close-btn" data-close-modal="filterModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="filterForm">
                    <div class="form-group">
                        <label for="startDate">Data Inicial:</label>
                        <input type="date" id="startDate" name="start_date" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="endDate">Data Final:</label>
                        <input type="date" id="endDate" name="end_date" class="form-control">
                    </div>
                    {% if is_admin %}
                    <div class="form-group" id="professionalFilterGroup">
                        <label for="professionalSelect">Profissional:</label>
                        <select id="professionalSelect" name="professional_id" class="form-control">
                            <option value="">Todos os Profissionais</option>
                            {% for professional in professionals %}
                                <option value="{{ professional.id }}">{{ professional.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="clearFiltersBtn">Limpar Filtros</button>
                <button type="button" class="btn btn-primary" id="applyFiltersBtn">Aplicar Filtros</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script type="module">
        const FAKE_FIREBASE = {
            initializeApp: () => ({}),
            getAuth: () => ({ currentUser: null, signOut: () => new Promise(res => res()) })
        };
        const { initializeApp } = FAKE_FIREBASE;
        const { getAuth, signOut: firebaseSignOut } = FAKE_FIREBASE;
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        let auth = getAuth(initializeApp(firebaseConfig));

        document.addEventListener('DOMContentLoaded', () => {
            const messageModal = document.getElementById('messageModal');
            const messageModalIcon = document.getElementById('message-modal-icon');
            const messageModalTitle = document.getElementById('message-modal-title');
            const messageModalText = document.getElementById('message-modal-text');
            const messageModalCloseBtn = document.getElementById('messageModalCloseBtn');

            function showMessageModal(message, type = 'info', title = '') {
                messageModalIcon.className = 'modal-icon';
                messageModalTitle.textContent = title;
                messageModalText.textContent = message;

                let iconClass = '';
                switch (type) {
                    case 'success':
                        iconClass = 'fas fa-check-circle';
                        messageModalIcon.classList.add('success');
                        if (!title) messageModalTitle.textContent = 'Sucesso!';
                        break;
                    case 'danger':
                        iconClass = 'fas fa-times-circle';
                        messageModalIcon.classList.add('danger');
                        if (!title) messageModalTitle.textContent = 'Erro!';
                        break;
                    case 'warning':
                        iconClass = 'fas fa-exclamation-triangle';
                        messageModalIcon.classList.add('warning');
                        if (!title) messageModalTitle.textContent = 'Atenção!';
                        break;
                    case 'info':
                    default:
                        iconClass = 'fas fa-info-circle';
                        messageModalIcon.classList.add('info');
                        if (!title) messageModalTitle.textContent = 'Informação';
                        break;
                }
                messageModalIcon.innerHTML = `<i class="${iconClass}"></i>`;
                
                messageModal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }

            function closeMessageModal() {
                messageModal.classList.remove('active');
                document.body.style.overflow = '';
            }

            messageModalCloseBtn.addEventListener('click', closeMessageModal);
            messageModal.addEventListener('click', (e) => {
                if (e.target === messageModal || e.target.closest('[data-close-modal="messageModal"]')) {
                    closeMessageModal();
                }
            });

            const htmlEl = document.documentElement;
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            const menuBtnMobile = document.querySelector('.menu-btn-mobile');
            const toggleBtnDesktop = document.querySelector('.toggle-btn-desktop');
            const themeToggle = document.getElementById('theme-toggle');
            const logoutButton = document.getElementById('logoutButton');

            let draggedMeta = null;

            const metasList = document.getElementById('metas-list');
            const sessionsList = document.getElementById('sessions-list');
            let metaCards = document.querySelectorAll('.meta-card');
            let appointmentSlots = document.querySelectorAll('.appointment-slot');
            const patientSelector = document.getElementById('patient-selector');

            let allMetas = {{ metas_ativas | tojson | safe }};
            let allAppointments = {{ agendamentos_semana | tojson | safe }};
            let currentPatientId = "{{ patient.id }}";

            const IS_ADMIN = {{ is_admin | default(false) | tojson }};
            const IS_PROFESSIONAL = {{ is_professional | default(false) | tojson }};
            const LOGGED_IN_PROFESSIONAL_ID = "{{ logged_in_professional_id | default('') }}";
            const LOGGED_IN_PROFESSIONAL_NAME = "{{ logged_in_professional_name | default('N/A') }}";
            const CLINIC_LOGO_URL = "{{ session.clinica_url_logo | default('') }}";
            const CLINIC_NAME_DISPLAY = "{{ session.clinica_nome_display | default('Clínica On') }}";


            function initializeMetaCards() {
                metaCards = document.querySelectorAll('.meta-card');
                metaCards.forEach(card => {
                    card.addEventListener('dragstart', (e) => {
                        const peiId = e.target.dataset.peiId;
                        const metaPei = allMetas.find(m => m.id === e.target.dataset.metaId && m.pei_id === peiId);
                        
                        if (!IS_ADMIN && IS_PROFESSIONAL && metaPei && metaPei.profissionais_ids && !metaPei.profissionais_ids.includes(LOGGED_IN_PROFESSIONAL_ID)) {
                            e.preventDefault();
                            showMessageModal('Você não tem permissão para associar metas de outros profissionais.', 'warning');
                            return;
                        }

                        draggedMeta = {
                            id: e.target.dataset.metaId,
                            name: e.target.dataset.metaName,
                            pei_id: e.target.dataset.peiId,
                            pei_title: e.target.dataset.peiTitle
                        };
                        e.target.classList.add('dragging');
                        e.dataTransfer.setData('text/plain', JSON.stringify(draggedMeta));
                    });

                    card.addEventListener('dragend', (e) => {
                        e.target.classList.remove('dragging');
                        draggedMeta = null;
                    });
                });
            }

            initializeMetaCards();

            function initializeAppointmentSlots() {
                appointmentSlots = document.querySelectorAll('.appointment-slot');
                appointmentSlots.forEach(slot => {
                    slot.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        slot.classList.add('drag-over');
                    });

                    slot.addEventListener('dragleave', () => {
                        slot.classList.remove('drag-over');
                    });

                    slot.addEventListener('drop', async (e) => {
                        e.preventDefault();
                        slot.classList.remove('drag-over');

                        const appointmentId = e.currentTarget.dataset.appointmentId;
                        const metaData = JSON.parse(e.dataTransfer.getData('text/plain'));

                        const appointment = allAppointments.find(a => a.id === appointmentId);
                        if (!IS_ADMIN && IS_PROFESSIONAL && appointment && appointment.profissional_id !== LOGGED_IN_PROFESSIONAL_ID) {
                            showMessageModal('Você não pode associar metas a agendamentos de outros profissionais.', 'warning');
                            return;
                        }

                        const existingMetasContainer = slot.querySelector('.associated-metas-container');
                        const existingMetas = existingMetasContainer ? Array.from(existingMetasContainer.children).map(el => el.dataset.associatedMetaId) : [];

                        if (existingMetas.includes(metaData.id)) {
                            showMessageModal('Esta meta já está associada a este agendamento.', 'warning'); 
                            return;
                        }

                        try {
                            const response = await fetch('/api/planejamento_semanal/associar_meta', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    agendamento_id: appointmentId,
                                    meta_id: metaData.id,
                                    meta_nome: metaData.name,
                                    pei_id: metaData.pei_id,
                                    action: 'associar'
                                })
                            });

                            const result = await response.json();
                            if (result.success) {
                                showMessageModal(result.message, 'success'); 
                                addMetaToSlotUI(slot, metaData);
                            } else {
                                showMessageModal(result.message, 'danger'); 
                            }
                        } catch (error) {
                            console.error('Erro ao associar meta:', error);
                            showMessageModal('Erro ao associar meta. Tente novamente.', 'danger'); 
                        }
                    });
                });
            }

            initializeAppointmentSlots();

            function addMetaToSlotUI(slotElement, metaData) {
                let associatedMetasContainer = slotElement.querySelector('.associated-metas-container');
                if (!associatedMetasContainer) {
                    const newContainer = document.createElement('div');
                    newContainer.className = 'associated-metas-container';
                    slotElement.appendChild(newContainer);
                    associatedMetasContainer = newContainer;
                }

                const newMetaDiv = document.createElement('div');
                newMetaDiv.className = 'associated-meta';
                newMetaDiv.dataset.associatedMetaId = metaData.id;
                newMetaDiv.dataset.associatedPeiId = metaData.pei_id;
                newMetaDiv.innerHTML = `
                    <span>${metaData.name}</span>
                    <button class="remove-meta-btn" title="Remover Meta">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                associatedMetasContainer.appendChild(newMetaDiv);

                newMetaDiv.querySelector('.remove-meta-btn').addEventListener('click', async (e) => {
                    e.stopPropagation();
                    
                    showCustomConfirm('Tem certeza que deseja desassociar esta meta deste agendamento?', async (confirmed) => {
                        if (!confirmed) return;

                        const slotElement = newMetaDiv.closest('.appointment-slot');
                        const appointmentId = slotElement.dataset.appointmentId;
                        const metaIdToRemove = newMetaDiv.dataset.associatedMetaId;
                        const peiIdToRemove = newMetaDiv.dataset.associatedPeiId;
                        const metaName = newMetaDiv.querySelector('span').textContent;

                        const appointment = allAppointments.find(a => a.id === appointmentId);
                        if (!IS_ADMIN && IS_PROFESSIONAL && appointment && appointment.profissional_id !== LOGGED_IN_PROFESSIONAL_ID) {
                            showMessageModal('Você não pode desassociar metas de agendamentos de outros profissionais.', 'warning');
                            return;
                        }

                        try {
                            const response = await fetch('/api/planejamento_semanal/associar_meta', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    agendamento_id: appointmentId,
                                    meta_id: metaIdToRemove,
                                    meta_nome: metaName,
                                    pei_id: peiIdToRemove,
                                    action: 'desassociar'
                                })
                            });

                            const result = await response.json();
                            if (result.success) {
                                showMessageModal(result.message, 'success'); 
                                newMetaDiv.remove(); 
                            } else {
                                showMessageModal(result.message, 'danger'); 
                            }
                        } catch (error) {
                            console.error('Erro ao desassociar meta:', error);
                            showMessageModal('Erro ao desassociar meta. Tente novamente.', 'danger'); 
                        }
                    });
                });
            }

            function initializeRemoveMetaButtons() {
                document.querySelectorAll('.associated-meta .remove-meta-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        
                        showCustomConfirm('Tem certeza que deseja desassociar esta meta deste agendamento?', async (confirmed) => {
                            if (!confirmed) return;

                            const metaDiv = e.target.closest('.associated-meta');
                            const slotElement = metaDiv.closest('.appointment-slot');
                            const appointmentId = slotElement.dataset.appointmentId;
                            const metaIdToRemove = metaDiv.dataset.associatedMetaId;
                            const peiIdToRemove = metaDiv.dataset.associatedPeiId;
                            const metaName = metaDiv.querySelector('span').textContent;

                            const appointment = allAppointments.find(a => a.id === appointmentId);
                            if (!IS_ADMIN && IS_PROFESSIONAL && appointment && appointment.profissional_id !== LOGGED_IN_PROFESSIONAL_ID) {
                                showMessageModal('Você não pode desassociar metas de agendamentos de outros profissionais.', 'warning');
                                return;
                            }

                            try {
                                const response = await fetch('/api/planejamento_semanal/associar_meta', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({
                                        agendamento_id: appointmentId,
                                        meta_id: metaIdToRemove,
                                        meta_nome: metaName,
                                        pei_id: peiIdToRemove,
                                        action: 'desassociar'
                                    })
                                });

                                const result = await response.json();
                                if (result.success) {
                                    showMessageModal(result.message, 'success'); 
                                    metaDiv.remove(); 
                                } else {
                                    showMessageModal(result.message, 'danger'); 
                                }
                            } catch (error) {
                                console.error('Erro ao desassociar meta:', error);
                                showMessageModal('Erro ao desassociar meta. Tente novamente.', 'danger'); 
                            }
                        });
                    });
                });
            }
            initializeRemoveMetaButtons();

            const metaDetailsModal = document.getElementById('metaDetailsModal');
            const metaModalTitle = document.getElementById('meta-modal-title');
            const metaModalDescription = document.getElementById('meta-modal-description');
            const metaModalAlvosList = document.getElementById('meta-modal-alvos-list');
            const noAlvosMessage = document.getElementById('no-alvos-message');
            
            function openMetaDetailsModal(meta) {
                metaModalTitle.innerHTML = `<i class="fas fa-bullseye"></i> Detalhes da Meta: ${meta.descricao}`;
                metaModalDescription.textContent = meta.descricao || 'Nenhuma descrição fornecida.';
                metaModalAlvosList.innerHTML = '';

                if (meta.alvos && meta.alvos.length > 0) {
                    noAlvosMessage.style.display = 'none';
                    meta.alvos.forEach(alvo => {
                        const li = document.createElement('li');
                        let statusClass = '';
                        if (alvo.status === 'Finalizado') statusClass = 'finalizada';
                        else if (alvo.status === 'Pendente') statusClass = 'pendente';
                        else statusClass = 'em-progresso'; 

                        li.innerHTML = `
                            <span class="status-indicator ${statusClass}"></span>
                            ${alvo.descricao}
                        `;
                        metaModalAlvosList.appendChild(li);
                    });
                } else {
                    noAlvosMessage.style.display = 'block';
                }

                metaDetailsModal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }

            metasList.addEventListener('click', (e) => {
                const metaCard = e.target.closest('.meta-card');
                if (metaCard) {
                    const metaId = metaCard.dataset.metaId;
                    const meta = allMetas.find(m => m.id === metaId);
                    if (meta) {
                        openMetaDetailsModal(meta);
                    }
                }
            });

            const closeModalBtnMetaDetails = metaDetailsModal.querySelector('.modal-close-btn');
            closeModalBtnMetaDetails.addEventListener('click', () => {
                metaDetailsModal.classList.remove('active');
                document.body.style.overflow = '';
            });
            metaDetailsModal.addEventListener('click', (e) => {
                if (e.target === metaDetailsModal) {
                    metaDetailsModal.classList.remove('active');
                    document.body.style.overflow = '';
                }
            });


            patientSelector.addEventListener('change', (e) => {
                const selectedPatientId = e.target.value;
                if (selectedPatientId && selectedPatientId !== currentPatientId) {
                    window.location.href = `/pacientes/${selectedPatientId}/planejamento_semanal`;
                }
            });

            const customConfirmModal = document.getElementById('customConfirmModal');
            const confirmModalTitle = document.getElementById('confirm-modal-title');
            const confirmModalMessage = document.getElementById('confirm-modal-message');
            const confirmCancelBtn = document.getElementById('confirmCancelBtn');
            const confirmConfirmBtn = document.getElementById('confirmConfirmBtn');

            let confirmCallback = null;

            function showCustomConfirm(message, callback) {
                confirmModalTitle.textContent = 'Confirmação Necessária';
                confirmModalMessage.textContent = message;
                confirmCallback = callback;
                customConfirmModal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }

            function closeCustomConfirm() {
                customConfirmModal.classList.remove('active');
                document.body.style.overflow = '';
                confirmCallback = null;
            }

            confirmCancelBtn.addEventListener('click', () => {
                if (confirmCallback) {
                    confirmCallback(false);
                }
                closeCustomConfirm();
            });

            confirmConfirmBtn.addEventListener('click', () => {
                if (confirmCallback) {
                    confirmCallback(true);
                }
                closeCustomConfirm();
            });

            customConfirmModal.addEventListener('click', (e) => {
                if (e.target === customConfirmModal || e.target.closest('[data-close-modal="customConfirmModal"]')) {
                    if (confirmCallback) {
                        confirmCallback(false);
                    }
                    closeCustomConfirm();
                }
            });

            const filterButton = document.getElementById('filterButton');
            const filterModal = document.getElementById('filterModal');
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            const professionalSelect = document.getElementById('professionalSelect');
            const applyFiltersBtn = document.getElementById('applyFiltersBtn');
            const clearFiltersBtn = document.getElementById('clearFiltersBtn');

            filterButton.addEventListener('click', () => {
                filterModal.classList.add('active');
                document.body.style.overflow = 'hidden';
                const urlParams = new URLSearchParams(window.location.search);
                startDateInput.value = urlParams.get('start_date') || '';
                endDateInput.value = urlParams.get('end_date') || '';
                if (professionalSelect) {
                    professionalSelect.value = urlParams.get('professional_id') || '';
                }
            });

            filterModal.addEventListener('click', (e) => {
                if (e.target === filterModal || e.target.closest('[data-close-modal="filterModal"]')) {
                    filterModal.classList.remove('active');
                    document.body.style.overflow = '';
                }
            });

            applyFiltersBtn.addEventListener('click', () => {
                const startDate = startDateInput.value;
                const endDate = endDateInput.value;
                const professionalId = professionalSelect ? professionalSelect.value : '';

                const urlParams = new URLSearchParams();
                if (startDate) {
                    urlParams.set('start_date', startDate);
                }
                if (endDate) {
                    urlParams.set('end_date', endDate);
                }
                if (!IS_ADMIN && IS_PROFESSIONAL) {
                    urlParams.set('professional_id', LOGGED_IN_PROFESSIONAL_ID);
                } else if (professionalId) {
                    urlParams.set('professional_id', professionalId);
                }

                window.location.search = urlParams.toString();
                filterModal.classList.remove('active');
                document.body.style.overflow = '';
            });

            clearFiltersBtn.addEventListener('click', () => {
                window.location.search = '';
                filterModal.classList.remove('active');
                document.body.style.overflow = '';
            });

            if (currentPatientId) {
                patientSelector.value = currentPatientId;
            }

            const printWeeklyPlanningBtn = document.getElementById('printWeeklyPlanningBtn');
            if (printWeeklyPlanningBtn) {
                printWeeklyPlanningBtn.addEventListener('click', () => {
                    generateWeeklyPlanningPdf();
                });
            }

            async function generateWeeklyPlanningPdf() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                let yPos = 20;
                const margin = 15;
                const contentLineHeight = 6;
                const contentFontSize = 10;
                const maxWidth = doc.internal.pageSize.width - margin * 2;

                const patientName = "{{ patient.nome if patient else 'Paciente' }}";
                const patientCpf = "{{ patient.cpf or 'N/A' }}";
                const patientDob = "{{ patient.data_nascimento.strftime('%d/%m/%Y') if patient.data_nascimento else 'N/A' }}";
                const clinicName = CLINIC_NAME_DISPLAY;
                const loggedInProfessionalName = LOGGED_IN_PROFESSIONAL_NAME;
                const clinicLogoUrl = CLINIC_LOGO_URL;

                const checkPageBreak = (heightNeeded) => {
                    if (yPos + heightNeeded > doc.internal.pageSize.height - margin) {
                        doc.addPage();
                        yPos = margin;
                    }
                };

                // Adicionar logo da clínica e nome
                const logoWidth = 25; // Largura ajustada
                const logoHeight = 25; // Altura ajustada
                const textX = margin + logoWidth + 5;
                const initialYPos = yPos; // Guarda a posição Y inicial para calcular a altura total do cabeçalho

                if (clinicLogoUrl) {
                    try {
                        const response = await fetch(clinicLogoUrl);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        const blob = await response.blob();
                        const reader = new FileReader();
                        reader.readAsDataURL(blob);
                        await new Promise(resolve => {
                            reader.onloadend = () => {
                                const base64Image = reader.result;
                                doc.addImage(base64Image, 'PNG', margin, yPos, logoWidth, logoHeight);
                                resolve();
                            };
                        });
                    } catch (error) {
                        console.error("Erro ao carregar a logo da clínica:", error);
                        showMessageModal(`Não foi possível carregar a logo da clínica para o PDF. Erro: ${error.message}`, 'warning');
                    }
                }
                
                // Nome da Clínica (sempre adicionado)
                doc.setFontSize(12).setFont("helvetica", "bold").text(clinicName, textX, yPos + (logoHeight / 2) - 8); 
                // Subtítulo do Relatório
                doc.setFontSize(9).setFont("helvetica", "normal").text("Relatório de Planejamento Semanal", textX, yPos + (logoHeight / 2) + 2);

                yPos = initialYPos + Math.max(logoHeight, 25) + 5; // Garante espaço suficiente após logo/nome/subtítulo

                doc.setLineWidth(0.8).setDrawColor(85, 135, 194).line(margin, yPos, maxWidth + margin, yPos);
                yPos += 12;

                doc.setFontSize(10).setFont("helvetica", "normal");
                doc.text(`Paciente: ${patientName}`, margin, yPos);
                yPos += 6;
                doc.text(`CPF: ${patientCpf}`, margin, yPos);
                doc.text(`Data de Nascimento: ${patientDob}`, maxWidth + margin, yPos, { align: 'right' });
                yPos += 6;
                doc.text(`Profissional Responsável: ${loggedInProfessionalName}`, margin, yPos);
                yPos += 10;

                checkPageBreak(15);
                doc.setFontSize(14).setFont("helvetica", "bold").setTextColor(85, 135, 194).text("Agendamentos da Semana", doc.internal.pageSize.width / 2, yPos, { align: 'center' });
                yPos += 8;
                doc.setLineWidth(0.5).setDrawColor(85, 135, 194).line(margin, yPos, maxWidth + margin, yPos);
                yPos += 10;
                doc.setTextColor(0, 0, 0);

                checkPageBreak(15);
                doc.setFontSize(12).setFont("helvetica", "bold").text("Detalhes dos Agendamentos:", margin, yPos);
                yPos += 8;

                if (allAppointments.length > 0) {
                    for (const agendamento of allAppointments) {
                        checkPageBreak(40);
                        
                        doc.setFillColor(241, 245, 249);
                        const rectHeight = 35 + (agendamento.metas_associadas.length * contentLineHeight);
                        doc.rect(margin, yPos, maxWidth, rectHeight, 'F');

                        doc.setFontSize(10).setFont("helvetica", "bold").text(`Data: ${agendamento.data_formatada} - ${agendamento.hora_agendamento}`, margin + 5, yPos + 7);
                        doc.setFontSize(contentFontSize).setFont("helvetica", "normal");
                        doc.text(`Profissional: ${agendamento.profissional_nome}`, margin + 5, yPos + 14);
                        doc.text(`Serviço: ${agendamento.servico_procedimento_nome}`, margin + 5, yPos + 21);

                        let currentMetaY = yPos + 28;

                        if (agendamento.metas_associadas && agendamento.metas_associadas.length > 0) {
                            doc.setFontSize(contentFontSize).setFont("helvetica", "bold").text('Metas Associadas:', margin + 5, currentMetaY);
                            currentMetaY += contentLineHeight;
                            for (const associatedMeta of agendamento.metas_associadas) {
                                checkPageBreak(contentLineHeight);
                                doc.setFontSize(contentFontSize).setFont("helvetica", "normal").text(`  - ${associatedMeta.meta_nome} (PEI: ${associatedMeta.pei_title || 'N/A'})`, margin + 10, currentMetaY);
                                currentMetaY += contentLineHeight;
                            }
                        } else {
                            checkPageBreak(contentLineHeight);
                            doc.setFontSize(contentFontSize).setFont("helvetica", "italic").text('Nenhuma meta associada a este agendamento.', margin + 5, currentMetaY);
                            currentMetaY += contentLineHeight;
                        }
                        yPos = currentMetaY + 10;
                    }
                } else {
                    checkPageBreak(10);
                    doc.setFontSize(contentFontSize).setFont("helvetica", "italic").text('Nenhum agendamento encontrado para este paciente nesta semana.', margin, yPos);
                    yPos += contentLineHeight;
                }

                doc.save(`planejamento-semanal-${patientName.toLowerCase().replace(/[^a-z0-9]/g, '-')}.pdf`);
                showMessageModal('PDF do Planejamento Semanal gerado com sucesso!', 'success');
            }
        });
    </script>
</body>
</html>
