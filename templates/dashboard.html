<!DOCTYPE html>
<html lang="pt-br" data-theme="light">
<head> 
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel de Controle - {{ session.clinica_nome_display or 'Clínica On' }}</title>
  <link rel="icon" type="image/png" href="https://placehold.co/40x40/0d9488/ffffff?text=C">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
  <!-- Bibliotecas para PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <style>
    /* ============================================
      --- ESTILOS GERAIS E VARIÁVEIS DE TEMA ---
      ============================================
    */
   :root {
     --bg: #f1f5f9;                 /* Gray-100 */
     --card: #ffffff;               /* White */
     --text: #0f172a;               /* Gray-900 */
     --muted: #64748b;              /* Gray-500 */
     --accent: #9b53b8;             /* Purple-500 */
     --primary: #5587c2;            /* Blue-500 */
     
     --primary-light: #c8dcf3;      /* Blue-100 */
     --primary-dark: #115e59;       /* Teal-800 */
     --secondary: #f59e0b;          /* Yellow-500 */
     --danger: #dc2626;             /* Red-600 */
     --success: #16a34a;            /* Green-600 */
     --warning: #f59e0b;            /* Yellow-500 */
     --info: #0ea5e9;               /* Sky-500 */
     --border-color: #e2e8f0;       /* Gray-200 */

     --dark-bg: #0f172a;            /* Gray-900 */
     --dark-card: #1e293b;          /* Gray-800 */
     --dark-text: #f1f5f9;          /* Gray-100 */
     --dark-muted: #94a3b8;         /* Gray-400 */
     --dark-border-color: #334155;  /* Gray-600 */
     
     color-scheme: light;
   }

   [data-theme="dark"] {
     --bg: var(--dark-bg);
     --text: var(--dark-text);
     --card: var(--dark-card);
     --muted: var(--dark-muted);
     --border-color: var(--dark-border-color);
     color-scheme: dark;
   }
   
   ::-webkit-scrollbar {
     background-color: var(--bg);
     width: 0.5625rem;
     height: 0.5625rem;
     border-top-right-radius: 0.3125rem;
     border-bottom-right-radius: 0.3125rem;
     transition: background-color 0.8s ease;
   }

   ::-webkit-scrollbar-thumb {
     background-color: var(--muted);
     border-radius: 0.3125rem;
     transition: background-color 0.8s ease;
   }

   ::-webkit-scrollbar-thumb:hover {
     transition: background-color 0.8s ease;
     background-color: var(--primary);
   }

   * { box-sizing: border-box; margin: 0; padding: 0; }
   html, body { height: 100%; overflow-x: hidden; }
   body {
     font-family: 'Inter', sans-serif;
     background-color: var(--bg);
     color: var(--text);
     min-height: 100vh;
     line-height: 1.6;
     transition: background-color 0.3s ease, color 0.3s ease;
   }
   .layout { display: flex; min-height: 100vh; width: 100%; }

    /* ============================================
      --- CONTEÚDO PRINCIPAL & TOPBAR ---
      ============================================
    */
   .main-content {
     flex: 1; margin-left: 260px;
     transition: margin-left 0.3s ease;
     display: flex; flex-direction: column; width: calc(100% - 280px);
   }
   .main-content.collapsed { margin-left: 88px; width: calc(100% - 88px); }

   .topbar {
     background-color: var(--card); color: var(--text); padding: 0 1.5rem;
     display: flex; align-items: center; justify-content: space-between;
     border-bottom: 1px solid var(--border-color); height: 70px; flex-shrink: 0;
     position: sticky; top: 0; z-index: 900;
   }
   .topbar-left { display: flex; align-items: center; gap: 1rem; }
   .topbar .page-title { font-weight: 600; font-size: 1.25rem; color: var(--text); }
   .toggle-btn {
     background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--muted);
     width: 40px; height: 40px; border-radius: 50%; display: grid; place-items: center;
     transition: background 0.2s ease, color 0.2s ease;
   }
   .toggle-btn:hover { background-color: var(--bg); color: var(--primary); }
   .toggle-btn-desktop { display: none; }
   .menu-btn-mobile { display: block; }
   @media(min-width: 769px) {
     .toggle-btn-desktop { display: grid; }
     .menu-btn-mobile { display: none; }
   }

   main { flex-grow: 1; padding: 1.5rem; overflow-y: auto; }

   /* ============================================
      --- SEÇÃO DE BOAS-VINDAS MODERNA ---
      ============================================
   */
   .welcome-section {
     background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
     color: white;
     padding: 2rem;
     border-radius: 16px;
     margin-bottom: 2rem;
     position: relative;
     overflow: hidden;
   }

   .welcome-section::before {
     content: '';
     position: absolute;
     top: 0;
     right: 0;
     width: 200px;
     height: 200px;
     background: rgba(255, 255, 255, 0.1);
     border-radius: 50%;
     transform: translate(50%, -50%);
   }

   .welcome-content {
     position: relative;
     z-index: 2;
   }

   .welcome-title {
     font-size: 1.8rem;
     font-weight: 700;
     margin-bottom: 0.5rem;
   }

   .welcome-subtitle {
     font-size: 1rem;
     opacity: 0.9;
     margin-bottom: 1.5rem;
   }

   .welcome-stats {
     display: grid;
     grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
     gap: 1rem;
   }

   .welcome-stat-item {
     text-align: center;
     padding: 1rem;
     background: rgba(255, 255, 255, 0.1);
     border-radius: 12px;
     backdrop-filter: blur(10px);
     transition: all 0.3s ease;
   }

    .welcome-stat-item:hover {
      background: rgba(255, 255, 255, 0.2);
      scale: 1.03;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      cursor: default;
    }

   .welcome-stat-number {
     font-size: 1.5rem;
     font-weight: 700;
     display: block;
   }

   .welcome-stat-label {
     font-size: 0.8rem;
     opacity: 0.8;
     text-transform: uppercase;
   }

   /* ============================================
      --- CARDS DE RESUMO MODERNOS ---
      ============================================
   */
   .dashboard-grid {
     display: grid;
     grid-template-columns: 1fr 300px;
     gap: 2rem;
     margin-bottom: 2rem;
   }

   .main-dashboard-content {
     display: flex;
     flex-direction: column;
     gap: 2rem;
   }

   .sidebar-widgets {
     display: flex;
     flex-direction: column;
     gap: 1.5rem;
   }

   .summary-cards { 
     display: grid; 
     grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
     gap: 1rem; 
   }

   .modern-card {
     background: var(--card);
     padding: 1.5rem;
     border-radius: 16px;
     box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
     transition: all 0.3s ease;
     position: relative;
     overflow: hidden;
   }

   .modern-card::before {
     content: '';
     position: absolute;
     top: 0;
     left: 0;
     right: 0;
     height: 4px;
     background: linear-gradient(90deg, var(--primary), var(--accent));
   }

   .modern-card:hover {
     transform: translateY(-4px);
     box-shadow: 0 8px 25px -5px rgb(0 0 0 / 0.15);
   }

   .card-header {
     display: flex;
     align-items: center;
     justify-content: space-between;
     margin-bottom: 1rem;
   }

   .card-icon {
     width: 48px;
     height: 48px;
     border-radius: 12px;
     display: flex;
     align-items: center;
     justify-content: center;
     font-size: 1.5rem;
     color: white;
   }

   .card-icon.patients { background: linear-gradient(135deg, var(--primary), var(--info)); }
   .card-icon.peis { background: linear-gradient(135deg, var(--accent), var(--secondary)); }
   .card-icon.appointments { background: linear-gradient(135deg, var(--success), var(--warning)); }
   .card-icon.professionals { background: linear-gradient(135deg, var(--info), var(--primary)); }

   .card-content h3 {
     font-size: 0.85rem;
     color: var(--muted);
     text-transform: uppercase;
     font-weight: 600;
     letter-spacing: 0.5px;
   }

   .card-content .stat-number {
     font-size: 2rem;
     font-weight: 700;
     color: var(--text);
     margin: 0.25rem 0;
   }

   .card-trend {
     display: flex;
     align-items: center;
     gap: 0.5rem;
     font-size: 0.8rem;
     font-weight: 500;
   }

   .card-trend.positive { color: var(--success); }
   .card-trend.negative { color: var(--danger); }
   .card-trend.neutral { color: var(--muted); }

   /* ============================================
      --- WIDGET DE PRÓXIMOS ATENDIMENTOS ---
      ============================================
   */
   .upcoming-appointments-widget {
     background: var(--card);
     border-radius: 16px;
     padding: 1.5rem;
     box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
   }

   .widget-header {
     display: flex;
     align-items: center;
     justify-content: between;
     margin-bottom: 1.5rem;
     padding-bottom: 1rem;
     border-bottom: 1px solid var(--border-color);
   }

   .widget-title {
     font-size: 1.1rem;
     font-weight: 600;
     color: var(--text);
     display: flex;
     align-items: center;
     gap: 0.5rem;
   }

   .appointment-card {
     background: var(--bg);
     border-radius: 12px;
     padding: 1rem;
     margin-bottom: 0.75rem;
     border-left: 4px solid var(--primary);
     transition: all 0.2s ease;
   }

   .appointment-card:hover {
     background: color-mix(in srgb, var(--primary) 5%, var(--bg));
     transform: translateX(4px);
   }

   .appointment-card:last-child {
     margin-bottom: 0;
   }

   .appointment-header {
     display: flex;
     align-items: center;
     justify-content: space-between;
     margin-bottom: 0.5rem;
   }

   .appointment-patient {
     font-weight: 600;
     color: var(--text);
     font-size: 0.9rem;
   }

   .appointment-time {
     background: var(--primary);
     color: white;
     padding: 0.25rem 0.5rem;
     border-radius: 6px;
     font-size: 0.75rem;
     font-weight: 500;
   }

   .appointment-details {
     font-size: 0.8rem;
     color: var(--muted);
     display: flex;
     align-items: center;
     gap: 1rem;
   }

   .appointment-service {
     display: flex;
     align-items: center;
     gap: 0.25rem;
   }

   /* ============================================
      --- GRÁFICOS MODERNOS ---
      ============================================
   */
   .charts-section {
     display: grid;
     grid-template-columns: 2fr 1fr;
     gap: 1.5rem;
     /* margin-bottom: 2rem; */
   }

   .chart-card {
     background: var(--card);
     border-radius: 16px;
     padding: 1.5rem;
     box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
     display: flex;
     flex-direction: column;
   }

   .chart-header {
     display: flex;
     align-items: center;
     justify-content: space-between;
     margin-bottom: 1.5rem;
   }

   .chart-title {
     font-size: 1.1rem;
     font-weight: 600;
     color: var(--text);
   }

   .chart-period-selector {
     display: flex;
     gap: 0.5rem;
   }

   .period-btn {
     padding: 0.5rem 1rem;
     border: 1px solid var(--border-color);
     background: transparent;
     color: var(--muted);
     border-radius: 8px;
     font-size: 0.8rem;
     cursor: pointer;
     transition: all 0.2s ease;
   }

   .period-btn.active,
   .period-btn:hover {
     background: var(--primary);
     color: white;
     border-color: var(--primary);
   }

    .period-btn.disabled {
      background: transparent;
      color: white;
      cursor: not-allowed;
      border: 1px dashed var(--muted);
      color: var(--muted);
      opacity: 0.6;
    }

   .chart-container {
     position: relative;
     flex-grow: 1;
     min-height: 300px;
   }

   @media (max-width: 1568px) {
     .charts-section {
       grid-template-columns: 1fr;
     }
   }

   /* ============================================
      --- ESTILOS ESPECÍFICOS PARA GRÁFICOS ---
      ============================================
   */
   .procedures-chart-container {
     background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
     color: white;
     border-radius: 16px;
     padding: 1.5rem;
     position: relative;
     overflow: hidden;
   }

   .procedures-chart-container::before {
     content: '';
     position: absolute;
     top: -50%;
     right: -50%;
     width: 100%;
     height: 100%;
     background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
   }

   .procedures-chart-content {
     position: relative;
     z-index: 2;
   }

   .professionals-chart-container {
     background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
     color: white;
     border-radius: 16px;
     padding: 1.5rem;
     position: relative;
     overflow: hidden;
   }

   .professionals-chart-container::before {
     content: '';
     position: absolute;
     top: -50%;
     left: -50%;
     width: 100%;
     height: 100%;
     background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
   }

   .professionals-chart-content {
     position: relative;
     z-index: 2;
   }

   /* ============================================
      --- SEÇÃO DE PROGRESSO PEI MODERNA ---
      ============================================
   */
   .pei-progress-section {
     background: var(--card);
     border-radius: 16px;
     padding: 1.5rem;
     box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
   }

   .section-header {
     display: flex;
     align-items: center;
     justify-content: space-between;
     margin-bottom: 1.5rem;
     padding-bottom: 1rem;
     border-bottom: 1px solid var(--border-color);
   }

   .section-title {
     font-size: 1.3rem;
     font-weight: 600;
     color: var(--text);
     display: flex;
     align-items: center;
     gap: 0.5rem;
   }

   .view-all-btn {
     background: var(--primary);
     color: white;
     padding: 0.5rem 1rem;
     border: none;
     border-radius: 8px;
     font-size: 0.85rem;
     font-weight: 500;
     cursor: pointer;
     transition: all 0.2s ease;
     text-decoration: none;
     display: inline-flex;
     align-items: center;
     gap: 0.5rem;
   }

   .view-all-btn:hover {
     background: color-mix(in srgb, var(--primary) 80%, black);
     transform: translateY(-1px);
   }

   .pei-progress-grid {
     display: grid;
     grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
     gap: 1rem;
   }

   .patient-progress-card {
     background: var(--bg);
     border-radius: 12px;
     padding: 1.25rem;
     border: 1px solid var(--border-color);
     transition: all 0.2s ease;
   }

   .patient-progress-card:hover {
     border-color: var(--primary);
     box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
   }

   .patient-header {
     display: flex;
     align-items: center;
     gap: 1rem;
     margin-bottom: 1rem;
   }

   .patient-avatar {
     width: 48px;
     height: 48px;
     border-radius: 50%;
     background: linear-gradient(135deg, var(--primary), var(--accent));
     display: flex;
     align-items: center;
     justify-content: center;
     color: white;
     font-weight: 600;
     font-size: 1.1rem;
   }

   .patient-info {
     position: relative;
     max-width: calc(100% - 5rem);
   }

   .patient-info h4 {
     font-size: 1rem;
     font-weight: 600;
     color: var(--text);
     margin-bottom: 0.25rem;
     text-overflow: ellipsis;
     overflow: hidden;
     white-space: nowrap;
   }

   .patient-meta {
     font-size: 0.8rem;
     color: var(--muted);
   }

   .progress-details {
     margin-bottom: 1rem;
   }

   .progress-row {
     display: flex;
     gap: 1rem;
   }

   .progress-item {
     display: flex;
     flex-direction: column;
     gap: 0.25rem;
     flex: 1;
   }

   .progress-label {
     font-size: 0.85rem;
     color: var(--muted);
     font-weight: 500;
   }

   .progress-value {
     font-weight: 600;
     color: var(--text);
     font-size: 1rem;
   }

   .progress-percentage {
     font-size: 0.8rem;
     color: var(--success);
     font-weight: 500;
   }

   .progress-bar-container {
     background: var(--border-color);
     border-radius: 8px;
     height: 8px;
     overflow: hidden;
     margin-bottom: 1rem;
   }

   .progress-bar {
     height: 100%;
     background: linear-gradient(90deg, var(--success), var(--warning));
     border-radius: 8px;
     transition: width 0.3s ease;
   }

   .patient-actions {
     display: flex;
     gap: 0.5rem;
   }

   .action-btn {
     flex: 1;
     padding: 0.5rem;
     border: 1px solid var(--muted);
     background: transparent;
     color: var(--text);
     border-radius: 8px;
     font-size: 0.8rem;
     cursor: pointer;
     transition: all 0.2s ease;
     display: flex;
     align-items: center;
     justify-content: center;
     gap: 0.25rem;
   }

   .action-btn:hover {
     background: var(--primary);
     color: white;
     border-color: var(--primary);
   }

   .action-btn.disabled {
     background: transparent;
     border: 1px dashed var(--muted);
     color: var(--muted);
     opacity: 0.6;
     cursor: not-allowed;
   }

   /* ============================================
      --- WIDGET DE ESTATÍSTICAS RÁPIDAS ---
      ============================================
   */
   .quick-stats-widget {
     background: var(--card);
     border-radius: 16px;
     padding: 1.5rem;
     box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
   }

   .stats-list {
     list-style: none;
   }

   .stat-item {
     display: flex;
     align-items: center;
     justify-content: space-between;
     padding: 0.75rem 0;
     border-bottom: 1px solid var(--border-color);
   }

   .stat-item:last-child {
     border-bottom: none;
   }

   .stat-item-label {
     display: flex;
     align-items: center;
     gap: 0.5rem;
     font-size: 0.9rem;
     color: var(--text);
   }

   .stat-item-value {
     font-weight: 600;
     color: var(--primary);
   }

   /* ============================================
      --- RESPONSIVIDADE ---
      ============================================
   */
   @media (max-width: 1200px) {
     .dashboard-grid {
       grid-template-columns: 1fr;
     }
     
     .sidebar-widgets {
       flex-direction: row;
       overflow-x: auto;
       gap: 1rem;
       padding-bottom: 1rem;
     }
     
     .sidebar-widgets > * {
       flex-shrink: 0;
       min-width: 280px;
     }
   }

   @media (max-width: 768px) {
     .sidebar { transform: translateX(-100%); }
     .sidebar.open { transform: translateX(0); box-shadow: 4px 0 15px rgba(0,0,0,0.1); }
     .sidebar.collapsed { transform: translateX(-100%); width: 280px; }

     .main-content, .main-content.collapsed { margin-left: 0; width: 100%; }
     main { padding: 1rem; }
     .topbar { padding: 0 1rem; }
     
     .summary-cards { grid-template-columns: 1fr; }
     .charts-section { grid-template-columns: 1fr; }
     .pei-progress-grid { grid-template-columns: 1fr; }
     .welcome-stats { grid-template-columns: repeat(2, 1fr); }
     
     .welcome-section {
       padding: 1.5rem;
     }
     
     .welcome-title {
       font-size: 1.5rem;
     }
   }

   /* ============================================
      --- ESTADOS DE CARREGAMENTO ---
      ============================================
   */
   .loading-skeleton {
     background: linear-gradient(90deg, var(--border-color) 25%, transparent 50%, var(--border-color) 75%);
     background-size: 200% 100%;
     animation: loading 1.5s infinite;
   }

   @keyframes loading {
     0% { background-position: 200% 0; }
     100% { background-position: -200% 0; }
   }

   .skeleton-card {
     height: 120px;
     border-radius: 16px;
   }

   .skeleton-chart {
     height: 300px;
     border-radius: 12px;
   }

   /* ============================================
      --- FLASH MESSAGES ---
      ============================================
   */
   .flash-message {
     padding: 1rem 1.25rem;
     margin-bottom: 1rem;
     border: 1px solid transparent;
     border-radius: 12px;
     font-size: 0.95rem;
     font-weight: 500;
     display: flex;
     align-items: center;
     gap: 0.5rem;
   }

   .flash-message.success {
     color: var(--success);
     background-color: color-mix(in srgb, var(--success) 15%, transparent);
     border-color: color-mix(in srgb, var(--success) 30%, transparent);
   }

   .flash-message.danger, .flash-message.error {
     color: var(--danger);
     background-color: color-mix(in srgb, var(--danger) 15%, transparent);
     border-color: color-mix(in srgb, var(--danger) 30%, transparent);
   }

   .flash-message.info {
     color: var(--info);
     background-color: color-mix(in srgb, var(--info) 15%, transparent);
     border-color: color-mix(in srgb, var(--info) 30%, transparent);
   }

   .flash-message.warning {
     color: #854d0e;
     background-color: #fefce8;
     border-color: #fde047;
   }

   [data-theme="dark"] .flash-message.warning {
     color: #fde047;
     background-color: #422006;
     border-color: #854d0e;
   }

   /* ============================================
      --- ANIMAÇÕES ---
      ============================================
   */
   @keyframes fadeInUp {
     from {
       opacity: 0;
       transform: translateY(20px);
     }
     to {
       opacity: 1;
       transform: translateY(0);
     }
   }

   .animate-fade-in-up {
     animation: fadeInUp 0.6s ease forwards;
   }

   .animate-delay-1 { animation-delay: 0.1s; }
   .animate-delay-2 { animation-delay: 0.2s; }
   .animate-delay-3 { animation-delay: 0.3s; }
   .animate-delay-4 { animation-delay: 0.4s; }

   /* ============================================
      --- MODAL STYLES MODERNOS ---
      ============================================
   */
   .modal {
     display: none;
     position: fixed;
     z-index: 1001;
     left: 0;
     top: 0;
     width: 100%;
     height: 100%;
     overflow: auto;
     background-color: rgba(0,0,0,0.6);
     align-items: center;
     justify-content: center;
     backdrop-filter: blur(5px);
   }

   .modern-modal {
     display: none;
     position: fixed;
     z-index: 1001;
     left: 0;
     top: 0;
     width: 100%;
     height: 100%;
     align-items: center;
     justify-content: center;
   }

   .modal-backdrop {
     position: absolute;
     top: 0;
     left: 0;
     width: 100%;
     height: 100%;
     background: rgba(0, 0, 0, 0.7);
     opacity: 0.5;
   }

   .modern-modal-content {
     position: relative;
     background: var(--card);
     border-radius: 20px;
     width: 95%;
     max-width: 1400px;
     max-height: 95vh;
     overflow: hidden;
     box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
     animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
     display: flex;
     flex-direction: column;
   }

   @keyframes modalSlideIn {
     from {
       opacity: 0;
       transform: scale(0.95) translateY(-20px);
     }
     to {
       opacity: 1;
       transform: scale(1) translateY(0);
     }
   }

   /* Header Modernizado */
   .modal-header-modern {
     display: flex;
     align-items: center;
     justify-content: space-between;
     padding: 1.5rem 2rem;
     border-bottom: 1px solid var(--border-color);
     background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
     color: white;
   }

   .modal-header-left {
     display: flex;
     align-items: center;
     gap: 1rem;
   }

   .modal-icon {
     width: 50px;
     height: 50px;
     border-radius: 12px;
     background: rgba(255, 255, 255, 0.2);
     display: flex;
     align-items: center;
     justify-content: center;
     font-size: 1.5rem;
   }

   .modal-title-section {
     display: flex;
     flex-direction: column;
   }

   .modal-title-modern {
     font-size: 1.5rem;
     font-weight: 700;
     margin: 0;
     line-height: 1.2;
   }

   .modal-subtitle {
     font-size: 0.9rem;
     opacity: 0.9;
     margin: 0;
     font-weight: 400;
   }

   .modal-header-actions {
     display: flex;
     align-items: center;
     gap: 0.75rem;
   }

   .btn-modal-modern {
     display: flex;
     align-items: center;
     gap: 0.5rem;
     padding: 0.75rem 1.25rem;
     border: none;
     border-radius: 10px;
     font-weight: 500;
     cursor: pointer;
     transition: all 0.2s ease;
     font-size: 0.9rem;
   }

   .btn-primary {
     background: rgba(255, 255, 255, 0.2);
     color: white;
     border: 1px solid rgba(255, 255, 255, 0.3);
   }

   .btn-primary:hover {
     background: rgba(255, 255, 255, 0.3);
   }

   .btn-secondary {
     background: var(--bg);
     color: var(--text);
     border: 1px solid var(--border-color);
   }

   .btn-secondary:hover {
     background: var(--muted);
     color: white;
   }

   .modal-close-btn-modern {
     background: rgba(255, 255, 255, 0.2);
     border: none;
     color: white;
     width: 44px;
     height: 44px;
     border-radius: 50%;
     font-size: 1.2rem;
     cursor: pointer;
     transition: all 0.2s ease;
     display: flex;
     align-items: center;
     justify-content: center;
     position: relative;
     z-index: 2;
   }

   .modal-close-btn-modern:hover {
     background: rgba(255, 255, 255, 0.3);
     transform: scale(1.1);
   }

   /* Loading State */
   .modal-loading-state {
     display: flex;
     flex-direction: column;
     align-items: center;
     justify-content: center;
     padding: 4rem 2rem;
     color: var(--muted);
   }

   .loading-spinner {
     width: 40px;
     height: 40px;
     border: 3px solid var(--border-color);
     border-top: 3px solid var(--primary);
     border-radius: 50%;
     animation: spin 1s linear infinite;
     margin-bottom: 1rem;
   }

   @keyframes spin {
     0% { transform: rotate(0deg); }
     100% { transform: rotate(360deg); }
   }

   /* Body da Modal */
   .modal-body-modern {
     flex: 1;
     overflow-y: auto;
     padding: 2rem;
     display: flex;
     flex-direction: column;
     gap: 2rem;
   }

   /* Métricas Rápidas */
   .modal-metrics-row {
     display: grid;
     grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
     gap: 1rem;
   }

   .metric-card {
     background: var(--bg);
     border: 1px solid var(--border-color);
     border-radius: 12px;
     padding: 1.25rem;
     display: flex;
     align-items: center;
     gap: 1rem;
     transition: all 0.2s ease;
   }

   .metric-card:hover {
     border-color: var(--primary);
     box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
   }

   .metric-icon {
     width: 48px;
     height: 48px;
     border-radius: 10px;
     display: flex;
     align-items: center;
     justify-content: center;
     font-size: 1.25rem;
     color: white;
   }

   .metric-card:nth-child(1) .metric-icon { background: linear-gradient(135deg, var(--primary), var(--info)); }
   .metric-card:nth-child(2) .metric-icon { background: linear-gradient(135deg, var(--success), var(--warning)); }
   .metric-card:nth-child(3) .metric-icon { background: linear-gradient(135deg, var(--accent), var(--secondary)); }
   .metric-card:nth-child(4) .metric-icon { background: linear-gradient(135deg, var(--info), var(--primary)); }

   .metric-content {
     display: flex;
     flex-direction: column;
   }

   .metric-value {
     font-size: 1.5rem;
     font-weight: 700;
     color: var(--text);
     line-height: 1.2;
   }

   .metric-label {
     font-size: 0.8rem;
     color: var(--muted);
     text-transform: uppercase;
     font-weight: 500;
     letter-spacing: 0.5px;
   }

   /* Gráficos Modernos */
   .modal-charts-modern {
     display: grid;
     grid-template-columns: 1fr 1fr;
     gap: 2rem;
   }

   .chart-card-modern {
     background: var(--bg);
     border: 1px solid var(--border-color);
     border-radius: 16px;
     overflow: hidden;
     display: flex;
     flex-direction: column;
   }

   .chart-header-modern {
     padding: 1.5rem;
     border-bottom: 1px solid var(--border-color);
     display: flex;
     align-items: center;
     justify-content: space-between;
     background: var(--card);
   }

   .chart-title-group h3 {
     font-size: 1.1rem;
     font-weight: 600;
     color: var(--text);
     margin: 0 0 0.25rem 0;
   }

   .chart-title-group p {
     font-size: 0.85rem;
     color: var(--muted);
     margin: 0;
   }

   .chart-controls {
     display: flex;
     gap: 0.5rem;
   }

   .chart-control-btn {
     width: 32px;
     height: 32px;
     border: none;
     background: var(--bg);
     color: var(--muted);
     border-radius: 8px;
     cursor: pointer;
     display: flex;
     align-items: center;
     justify-content: center;
     transition: all 0.2s ease;
   }

   .chart-control-btn:hover {
     background: var(--primary);
     color: white;
   }

   .chart-container-modern {
     flex: 1;
     padding: 1.5rem;
     position: relative;
     min-height: 300px;
   }

   .chart-insights {
     padding: 1rem 1.5rem;
     background: var(--card);
     border-top: 1px solid var(--border-color);
     display: flex;
     gap: 2rem;
   }

   .insight-item {
     display: flex;
     flex-direction: column;
     gap: 0.25rem;
   }

   .insight-label {
     font-size: 0.75rem;
     color: var(--muted);
     text-transform: uppercase;
     font-weight: 500;
     letter-spacing: 0.5px;
   }

   .insight-value {
     font-size: 0.9rem;
     font-weight: 600;
     color: var(--text);
   }

   /* Análise com Tabs */
   .modal-analysis-section {
     background: var(--bg);
     border: 1px solid var(--border-color);
     border-radius: 16px;
     overflow: hidden;
   }

   .analysis-tabs {
     display: flex;
     background: var(--card);
     border-bottom: 1px solid var(--border-color);
   }

   .tab-btn {
     flex: 1;
     padding: 1rem 1.5rem;
     border: none;
     background: transparent;
     color: var(--muted);
     cursor: pointer;
     display: flex;
     align-items: center;
     justify-content: center;
     gap: 0.5rem;
     font-weight: 500;
     transition: all 0.2s ease;
     border-bottom: 3px solid transparent;
   }

   .tab-btn.active,
   .tab-btn:hover {
     color: var(--primary);
     border-bottom-color: var(--primary);
     background: color-mix(in srgb, var(--primary) 5%, transparent);
   }

   .tab-content {
     display: none;
     padding: 1.5rem;
   }

   .tab-content.active {
     display: block;
   }

   .analysis-card h4 {
     color: var(--text);
     font-size: 1.1rem;
     margin: 0 0 1rem 0;
     display: flex;
     align-items: center;
     gap: 0.5rem;
   }

   .analysis-content {
     color: var(--text);
     line-height: 1.6;
   }

   .analysis-list {
     margin: 1rem 0;
     padding-left: 1.5rem;
   }

   .analysis-list li {
     margin-bottom: 0.5rem;
   }

   /* Legenda Modernizada */
   .legend-grid {
     display: grid;
     gap: 1rem;
   }

   .legend-item {
     display: flex;
     align-items: center;
     gap: 1rem;
     padding: 1rem;
     background: var(--card);
     border-radius: 10px;
     border: 1px solid var(--border-color);
   }

   .legend-color {
     width: 20px;
     height: 20px;
     border-radius: 4px;
     flex-shrink: 0;
   }

   .legend-text strong {
     color: var(--text);
     display: block;
     margin-bottom: 0.25rem;
   }

   .legend-text p {
     color: var(--muted);
     font-size: 0.85rem;
     margin: 0;
   }

   /* Insights Container */
   .insights-container {
     display: flex;
     flex-direction: column;
     gap: 1rem;
   }

   /* Indicadores Modernizados */
   .independence-indicators-modern {
     background: var(--bg);
     border: 1px solid var(--border-color);
     border-radius: 16px;
     padding: 1.5rem;
   }

   .independence-indicators-modern h4 {
     color: var(--text);
     font-size: 1.1rem;
     margin: 0 0 0.5rem 0;
     display: flex;
     align-items: center;
     gap: 0.5rem;
   }

   .indicators-subtitle {
     color: var(--muted);
     font-size: 0.9rem;
     margin: 0 0 1.5rem 0;
   }

   .indicators-grid {
     display: grid;
     grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
     gap: 1rem;
   }

   /* Footer da Modal */
   .modal-footer-modern {
     padding: 1.5rem 2rem;
     border-top: 1px solid var(--border-color);
     background: var(--bg);
     display: flex;
     align-items: center;
     justify-content: space-between;
   }

   .footer-info {
     display: flex;
     align-items: center;
     gap: 0.5rem;
     color: var(--muted);
     font-size: 0.85rem;
   }

   .footer-actions {
     display: flex;
     gap: 0.75rem;
   }

   /* Responsividade */
   @media (max-width: 1200px) {
     .modal-charts-modern {
       grid-template-columns: 1fr;
     }
   }

   @media (max-width: 768px) {
     .modern-modal-content {
       width: 100%;
       height: 100%;
       max-height: 100vh;
       border-radius: 0;
       margin: 0;
     }

     .modal-metrics-row {
       grid-template-columns: repeat(2, 1fr);
     }

     .modal-body-modern {
       padding: 1rem;
     }

     .modal-header-modern {
       padding: 1rem;
       flex-direction: column;
       gap: 1rem;
       align-items: flex-start;
     }

     .modal-header-actions {
       align-self: flex-end;
     }

     .analysis-tabs {
       flex-direction: column;
     }

     .chart-insights {
       flex-direction: column;
       gap: 1rem;
     }
   }
  </style>
</head>
<body>
  <div class="layout">
    <!-- Inclui a barra de navegação lateral a partir do arquivo Nav.html -->
    {% include 'Nav.html' %}

    <div class="main-content">
      <header class="topbar">
        <div class="topbar-left">
          <button class="toggle-btn menu-btn-mobile"><i class="fa-solid fa-bars"></i></button>
          <button class="toggle-btn toggle-btn-desktop"><i class="fa-solid fa-bars-staggered"></i></button>
          <h1 class="page-title">Painel de Controle</h1>
        </div>
      </header>

      <main>
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <div class="flash-messages">
            {% for category, message in messages %}
              <div class="flash-message {{ category }}">
                <i class="fa-solid fa-circle-info"></i>
                {{ message }}
              </div>
            {% endfor %}
            </div>
          {% endif %}
        {% endwith %}

        <!-- Seção de Boas-vindas -->
        <section class="welcome-section animate-fade-in-up">
          <div class="welcome-content">
            <h1 class="welcome-title">Bem-vindo, {{ session.user_name or 'Profissional' }}!</h1>
            <p class="welcome-subtitle">Aqui está um resumo do que está acontecendo na {{ session.clinica_nome_display or 'Clínica On' }} hoje.</p>
            
            <div class="welcome-stats">
              <div class="welcome-stat-item">
                <span class="welcome-stat-number">{{ kpi.total_pacientes }}</span>
                <span class="welcome-stat-label">Pacientes</span>
              </div>
              <div class="welcome-stat-item">
                <span class="welcome-stat-number">{{ kpi.peis_em_progresso }}</span>
                <span class="welcome-stat-label">PEIs Ativos</span>
              </div>
              <div class="welcome-stat-item">
                <span class="welcome-stat-number">{{ proximos_agendamentos|length }}</span>
                <span class="welcome-stat-label">Quantidade de Agendamentos</span>
              </div>
              <div class="welcome-stat-item">
                <span class="welcome-stat-number">{{ kpi.total_atendimentos_concluidos }}</span>
                <span class="welcome-stat-label">Atendimentos Concluídos</span>
              </div>
            </div>
          </div>
        </section>

        <!-- Grid Principal do Dashboard -->
        <div class="dashboard-grid">
          <div class="main-dashboard-content">
            
            <!-- Cards de Resumo Modernos -->
            <!-- <section class="summary-cards animate-fade-in-up animate-delay-1">
              <div class="modern-card">
                <div class="card-header">
                  <div class="card-icon patients">
                    <i class="fa-solid fa-users"></i>
                  </div>
                </div>
                <div class="card-content">
                  <h3>Total de Pacientes</h3>
                  <p class="stat-number">{{ kpi.total_pacientes }}</p>
                  <div class="card-trend positive">
                    <i class="fa-solid fa-arrow-up"></i>
                    <span>Pacientes cadastrados</span>
                  </div>
                </div>
              </div>

              <div class="modern-card">
                <div class="card-header">
                  <div class="card-icon peis">
                    <i class="fa-solid fa-clipboard-list"></i>
                  </div>
                </div>
                <div class="card-content">
                  <h3>PEIs Ativos</h3>
                  <p class="stat-number">{{ kpi.peis_em_progresso }}</p>
                  <div class="card-trend neutral">
                    <i class="fa-solid fa-hourglass-half"></i>
                    <span>Em andamento</span>
                  </div>
                </div>
              </div>

              <div class="modern-card">
                <div class="card-header">
                  <div class="card-icon appointments">
                    <i class="fa-solid fa-calendar-check"></i>
                  </div>
                </div>
                <div class="card-content">
                  <h3>Atendimentos</h3>
                  <p class="stat-number">{{ kpi.total_atendimentos_concluidos }}</p>
                  <div class="card-trend positive">
                    <i class="fa-solid fa-check-circle"></i>
                    <span>Concluídos</span>
                  </div>
                </div>
              </div>

              <div class="modern-card">
                <div class="card-header">
                  <div class="card-icon professionals">
                    <i class="fa-solid fa-user-doctor"></i>
                  </div>
                </div>
                <div class="card-content">
                  <h3>PEIs Finalizados</h3>
                  <p class="stat-number">{{ kpi.peis_finalizados }}</p>
                  <div class="card-trend positive">
                    <i class="fa-solid fa-trophy"></i>
                    <span>Completados</span>
                  </div>
                </div>
              </div>
            </section> -->

            <!-- Seção de Gráficos -->
            <section class="charts-section animate-fade-in-up animate-delay-2">
              <div class="chart-card">
                <div class="chart-header">
                  <h3 class="chart-title">Atendimentos vs Receita (Últimos 15 dias)</h3>
                  <div class="chart-period-selector">
                    <button class="period-btn active">15d</button>
                    <button class="period-btn disabled">30d</button>
                    <button class="period-btn disabled">90d</button>
                  </div>
                </div>
                <div class="chart-container">
                  <canvas id="atendimentoVsReceitaChart"></canvas>
                </div>
              </div>

              <div class="quick-stats-widget">
                <div class="widget-header">
                  <h3 class="widget-title">
                    <i class="fa-solid fa-chart-simple"></i>
                    Estatísticas Rápidas
                  </h3>
                </div>
                <ul class="stats-list">
                  <li class="stat-item">
                    <span class="stat-item-label">
                      <i class="fa-solid fa-calendar-days"></i>
                      Total de Agendamentos
                    </span>
                    <span class="stat-item-value">{{ kpi.total_agendamentos }}</span>
                  </li>
                  <li class="stat-item">
                    <span class="stat-item-label">
                      <i class="fa-solid fa-percentage"></i>
                      Taxa de Conclusão
                    </span>
                    <span class="stat-item-value">
                      {% if kpi.total_agendamentos > 0 %}
                        {{ ((kpi.total_atendimentos_concluidos / kpi.total_agendamentos) * 100)|round(1) }}%
                      {% else %}
                        0%
                      {% endif %}
                    </span>
                  </li>
                  <li class="stat-item">
                    <span class="stat-item-label">
                      <i class="fa-solid fa-chart-line"></i>
                      PEIs por Paciente
                    </span>
                    <span class="stat-item-value">
                      {% if kpi.total_pacientes > 0 %}
                        {{ (kpi.total_peis / kpi.total_pacientes)|round(1) }}
                      {% else %}
                        0
                      {% endif %}
                    </span>
                  </li>
                  <li class="stat-item">
                    <span class="stat-item-label">
                      <i class="fa-solid fa-target"></i>
                      Eficiência PEI
                    </span>
                    <span class="stat-item-value">
                      {% if kpi.total_peis > 0 %}
                        {{ ((kpi.peis_finalizados / kpi.total_peis) * 100)|round(1) }}%
                      {% else %}
                        0%
                      {% endif %}
                    </span>
                  </li>
                </ul>
              </div>
            </section>

            <!-- Gráficos de Procedimentos e Profissionais -->
            <section class="charts-section animate-fade-in-up animate-delay-3">
              <div class="procedures-chart-container">
                <div class="procedures-chart-content">
                  <h3 class="chart-title" style="color: white; margin-bottom: 1rem;">
                    <i class="fa-solid fa-stethoscope"></i>
                    Top 5 Procedimentos (Mês)
                  </h3>
                  <div class="chart-container">
                    <canvas id="receitaPorProcedimentoChart"></canvas>
                  </div>
                </div>
              </div>

              <div class="professionals-chart-container">
                <div class="professionals-chart-content">
                  <h3 class="chart-title" style="color: white; margin-bottom: 1rem;">
                    <i class="fa-solid fa-user-doctor"></i>
                    Top 5 Profissionais (Mês)
                  </h3>
                  <div class="chart-container">
                    <canvas id="desempenhoProfissionalChart"></canvas>
                  </div>
                </div>
              </div>
            </section>

          </div>

          <!-- Sidebar com Widgets -->
          <div class="sidebar-widgets">
            
            <!-- Widget de Próximos Atendimentos -->
            <div class="upcoming-appointments-widget animate-fade-in-up animate-delay-4">
              <div class="widget-header">
                <h3 class="widget-title">
                  <i class="fa-solid fa-clock"></i>
                  Seus Próximos Atendimentos
                </h3>
              </div>
              
              {% set user_appointments = [] %}
              {% for agendamento in proximos_agendamentos %}
                {% if session.user_role == 'admin' or agendamento.id_profissional == session.user_id %}
                  {% set _ = user_appointments.append(agendamento) %}
                {% endif %}
              {% endfor %}

              {% if user_appointments %}
                {% for agendamento in user_appointments[:5] %}
                  <div class="appointment-card">
                    <div class="appointment-header">
                      <span class="appointment-patient">{{ agendamento.cliente_nome }}</span>
                      <span class="appointment-time">{{ agendamento.hora_agendamento }}</span>
                    </div>
                    <div class="appointment-details">
                      <div class="appointment-service">
                        <i class="fa-solid fa-stethoscope"></i>
                        <span>{{ agendamento.servico_procedimento_nome }}</span>
                      </div>
                    </div>
                  </div>
                {% endfor %}
                
                {% if user_appointments|length > 5 %}
                  <div style="text-align: center; margin-top: 1rem;">
                    <a href="{{ url_for('listar_agendamentos') }}" class="view-all-btn">
                      Ver todos ({{ user_appointments|length }})
                      <i class="fa-solid fa-arrow-right"></i>
                    </a>
                  </div>
                {% endif %}
              {% else %}
                <div style="text-align: center; padding: 2rem; color: var(--muted);">
                  <i class="fa-solid fa-calendar-xmark" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                  <p>Nenhum atendimento agendado para você hoje.</p>
                </div>
              {% endif %}
            </div>

          </div>
        </div>

        <!-- Seção de Progresso dos Pacientes -->
        <section class="pei-progress-section animate-fade-in-up animate-delay-4">
          <div class="section-header">
            <h2 class="section-title">
              <i class="fa-solid fa-chart-line"></i>
              Progresso dos Pacientes em PEIs
            </h2>
            <a href="{{ url_for('busca_peis') }}" class="view-all-btn">
              Ver todos os PEIs
              <i class="fa-solid fa-arrow-right"></i>
            </a>
          </div>

          {% if pacientes_pei_progress %}
            <div class="pei-progress-grid">
              {% for paciente in pacientes_pei_progress[:6] %}
                <div class="patient-progress-card" data-patient-id="{{ paciente.id }}">
                  <div class="patient-header">
                    <div class="patient-avatar">
                      {{ paciente.nome[0].upper() }}
                    </div>
                    <div class="patient-info">
                      <h4>{{ paciente.nome }}</h4>
                      <div class="patient-meta">{{ paciente.total_peis_ativos }} PEI{{ 's' if paciente.total_peis_ativos != 1 else '' }} ativo{{ 's' if paciente.total_peis_ativos != 1 else '' }}</div>
                    </div>
                  </div>
                  
                  <div class="progress-details">
                    <div class="progress-row">
                      <div class="progress-item">
                        <span class="progress-label">Metas</span>
                        <span class="progress-value">{{ paciente.completed_metas }}/{{ paciente.total_metas }}</span>
                        <span class="progress-percentage">({{ paciente.metas_progress_percentage }}%)</span>
                      </div>
                      <div class="progress-item">
                        <span class="progress-label">Alvos</span>
                        <span class="progress-value">{{ paciente.completed_targets }}/{{ paciente.total_targets }}</span>
                        <span class="progress-percentage">({{ paciente.progress_percentage }}%)</span>
                      </div>
                    </div>
                  </div>

                  <div class="progress-bar-container">
                    <div class="progress-bar" style="width: {{ paciente.progress_percentage }}%;"></div>
                  </div>

                  <div class="patient-actions">
                    <button class="action-btn ver-pei-btn" data-patient-id="{{ paciente.id }}" data-patient-name="{{ paciente.nome }}">
                      <i class="fa-solid fa-eye"></i>
                      Ver PEI
                    </button>
                    <button class="action-btn view-mental-map-btn {% if paciente.total_peis_ativos == 0 %}disabled{% endif %}" 
                            data-patient-id="{{ paciente.id }}" 
                            data-patient-name="{{ paciente.nome }}"
                            {% if paciente.total_peis_ativos == 0 %}disabled{% endif %}>
                      <i class="fa-solid fa-brain"></i>
                      Mapa Mental
                    </button>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div style="text-align: center; padding: 3rem; color: var(--muted);">
              <i class="fa-solid fa-clipboard-list" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
              <h3 style="margin-bottom: 0.5rem;">Nenhum progresso de PEI encontrado</h3>
              <p>Não há dados de progresso de PEI para exibir no momento.</p>
            </div>
          {% endif %}
        </section>

      </main>

      <footer style="margin-top: auto; text-align: center; padding: 1.5rem; font-size: 0.9rem; color: var(--muted);">
        <p>&copy; {{ current_year or '2025' }} {{ session.clinica_nome_display or 'Clínica On' }}. Todos os direitos reservados.</p>
      </footer>
    </div>
  </div>

  <!-- Modal Modernizada para o Mapa Mental do Paciente -->
  <div id="mentalMapModal" class="modal modern-modal" style="background: rgba(0, 0, 0, 0.5);">
    <div class="modal-backdrop"></div>
    <div class="modal-content modern-modal-content">
      
      <!-- Header Modernizado -->
      <div class="modal-header-modern">
        <div class="modal-header-left">
          <div class="modal-icon">
            <i class="fa-solid fa-brain"></i>
          </div>
          <div class="modal-title-section">
            <h2 class="modal-title-modern">Mapa Mental de Progresso</h2>
            <p class="modal-subtitle" id="modalPatientName">Paciente</p>
          </div>
        </div>
        <div class="modal-header-actions">
          <button id="printMentalMapBtn" class="btn-modal-modern btn-primary">
            <i class="fa-solid fa-print"></i>
            <span>Gerar Relatório</span>
          </button>
          <button class="modal-close-btn-modern">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
      </div>
      
      <!-- Loading State -->
      <div id="modalLoadingState" class="modal-loading-state">
        <div class="loading-spinner"></div>
        <p>Carregando dados do mapa mental...</p>
      </div>
      
      <!-- Conteúdo Principal -->
      <div class="modal-body-modern" id="modalMainContent" style="display: none;">
        
        <!-- Métricas Rápidas -->
        <div class="modal-metrics-row">
          <div class="metric-card">
            <div class="metric-icon">
              <i class="fa-solid fa-target"></i>
            </div>
            <div class="metric-content">
              <span class="metric-value" id="totalTargetsMetric">0</span>
              <span class="metric-label">Alvos Totais</span>
            </div>
          </div>
          <div class="metric-card">
            <div class="metric-icon">
              <i class="fa-solid fa-check-circle"></i>
            </div>
            <div class="metric-content">
              <span class="metric-value" id="completedTargetsMetric">0</span>
              <span class="metric-label">Alvos Concluídos</span>
            </div>
          </div>
          <div class="metric-card">
            <div class="metric-icon">
              <i class="fa-solid fa-chart-line"></i>
            </div>
            <div class="metric-content">
              <span class="metric-value" id="progressPercentageMetric">0%</span>
              <span class="metric-label">Progresso Geral</span>
            </div>
          </div>
          <div class="metric-card">
            <div class="metric-icon">
              <i class="fa-solid fa-clipboard-list"></i>
            </div>
            <div class="metric-content">
              <span class="metric-value" id="activePeisMetric">0</span>
              <span class="metric-label">PEIs Ativos</span>
            </div>
          </div>
        </div>
        
        <!-- Gráficos Principais -->
        <div class="modal-charts-modern">
          <div class="chart-card-modern">
            <div class="chart-header-modern">
              <div class="chart-title-group">
                <h3>Radar de Tentativas por Ajuda</h3>
                <p>Análise da dependência por tipo de assistência</p>
              </div>
              <div class="chart-controls">
                <button class="chart-control-btn" id="radarChartInfo">
                  <i class="fa-solid fa-info-circle"></i>
                </button>
              </div>
            </div>
            <div class="chart-container-modern">
              <canvas id="mentalMapChart"></canvas>
            </div>
            <div class="chart-insights">
              <div class="insight-item">
                <span class="insight-label">Maior Dependência:</span>
                <span class="insight-value" id="highestDependency">-</span>
              </div>
              <div class="insight-item">
                <span class="insight-label">Menor Dependência:</span>
                <span class="insight-value" id="lowestDependency">-</span>
              </div>
            </div>
          </div>
          
          <div class="chart-card-modern">
            <div class="chart-header-modern">
              <div class="chart-title-group">
                <h3>Nível de Independência</h3>
                <p>Progresso em direção à autonomia</p>
              </div>
              <div class="chart-controls">
                <button class="chart-control-btn" id="independenceChartInfo">
                  <i class="fa-solid fa-info-circle"></i>
                </button>
              </div>
            </div>
            <div class="chart-container-modern">
              <canvas id="developmentAreasChart"></canvas>
            </div>
            <div class="chart-insights">
              <div class="insight-item">
                <span class="insight-label">Média de Independência:</span>
                <span class="insight-value" id="averageIndependence">-</span>
              </div>
              <div class="insight-item">
                <span class="insight-label">Tendência:</span>
                <span class="insight-value" id="independenceTrend">-</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Seção de Análise Detalhada -->
        <div class="modal-analysis-section">
          <div class="analysis-tabs">
            <button class="tab-btn active" data-tab="interpretation">
              <i class="fa-solid fa-chart-bar"></i> Interpretação
            </button>
            <button class="tab-btn" data-tab="legend">
              <i class="fa-solid fa-list"></i> Legenda
            </button>
            <button class="tab-btn" data-tab="insights">
              <i class="fa-solid fa-lightbulb"></i> Insights
            </button>
          </div>
          
          <div class="tab-content active" id="interpretation-tab">
            <div class="analysis-card">
              <h4><i class="fa-solid fa-radar-chart"></i> Como interpretar o Gráfico de Radar</h4>
              <div class="analysis-content">
                <p>O gráfico de radar mostra a <strong>média de tentativas por tipo de ajuda</strong> nos alvos ativos dos PEIs do paciente:</p>
                <ul class="analysis-list">
                  <li><strong>Valores mais altos:</strong> Indicam maior dependência daquele tipo de ajuda</li>
                  <li><strong>Valores mais baixos:</strong> Sugerem maior independência</li>
                  <li><strong>Objetivo:</strong> Reduzir a área do radar (menos dependência)</li>
                  <li><strong>Evolução ideal:</strong> Movimento em direção ao centro do gráfico</li>
                </ul>
              </div>
            </div>
          </div>
          
          <div class="tab-content" id="legend-tab">
            <div class="analysis-card">
              <h4><i class="fa-solid fa-key"></i> Legenda dos Tipos de Ajuda</h4>
              <div class="legend-grid">
                <div class="legend-item">
                  <div class="legend-color" style="background: #dc2626;"></div>
                  <div class="legend-text">
                    <strong>AFT</strong> - Ajuda Física Total
                    <p>Assistência completa para realizar a tarefa</p>
                  </div>
                </div>
                <div class="legend-item">
                  <div class="legend-color" style="background: #f59e0b;"></div>
                  <div class="legend-text">
                    <strong>AFP</strong> - Ajuda Física Parcial
                    <p>Assistência física limitada ou direcionamento</p>
                  </div>
                </div>
                <div class="legend-item">
                  <div class="legend-color" style="background: #0ea5e9;"></div>
                  <div class="legend-text">
                    <strong>AG</strong> - Ajuda Gestual
                    <p>Sinais visuais ou gestos para orientação</p>
                  </div>
                </div>
                <div class="legend-item">
                  <div class="legend-color" style="background: #8b5cf6;"></div>
                  <div class="legend-text">
                    <strong>AE</strong> - Ajuda Ecóica
                    <p>Dicas verbais ou repetição de instruções</p>
                  </div>
                </div>
                <div class="legend-item">
                  <div class="legend-color" style="background: #16a34a;"></div>
                  <div class="legend-text">
                    <strong>I</strong> - Independente
                    <p>Execução autônoma da tarefa</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="tab-content" id="insights-tab">
            <div class="analysis-card">
              <h4><i class="fa-solid fa-brain"></i> Insights Inteligentes</h4>
              <div id="aiInsightsContainer" class="insights-container">
                <!-- Insights serão gerados dinamicamente -->
              </div>
            </div>
          </div>
        </div>
        
        <!-- Indicadores de Independência Modernizados -->
        <div class="independence-indicators-modern">
          <h4><i class="fa-solid fa-gauge-high"></i> Indicadores de Independência</h4>
          <p class="indicators-subtitle">Percentual de autonomia por tipo de ajuda (100% = totalmente independente)</p>
          <div id="independenceIndicatorsContainer" class="indicators-grid">
            <!-- Indicadores serão injetados aqui via JavaScript -->
          </div>
        </div>
        
      </div>
      
      <!-- Footer da Modal -->
      <div class="modal-footer-modern">
        <div class="footer-info">
          <i class="fa-solid fa-info-circle"></i>
          <span>Dados baseados nos PEIs ativos do paciente</span>
        </div>
      </div>
      
    </div>
  </div>
                </div>
            </div>
        </div>
      </div>
    </div>
  </div>

<script type="module" id="dashboard-script"
    data-atendimento-vs-receita='{{ dados_atendimento_vs_receita | safe }}'
    data-receita-procedimento='{{ dados_receita_procedimento | safe }}'
    data-desempenho-profissional='{{ dados_desempenho_profissional | safe }}'
    data-pacientes-pei-mental-map-data='{{ pacientes_pei_mental_map_data_json | safe }}'
    data-pacientes-pei-progress='{{ pacientes_pei_progress_json | safe }}'
    data-clinica-nome-display="{{ session.clinica_nome_display | default('Clínica On') | safe }}">

  document.addEventListener('DOMContentLoaded', () => {
    let charts = {};
    let mentalMapChartInstance = null;
    let developmentAreasChartInstance = null;

    const getCssVar = (varName) => getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
    
    // Função para calcular informações dinâmicas dos PEIs baseada na lógica do pei_page.html
    function calculatePeiDynamicInfo() {
        const scriptEl = document.getElementById('dashboard-script');
        let pacientesPeiProgressData;
        
        try {
            const rawData = scriptEl.dataset.pacientesPeiProgress || '[]';
            
            // Validar se os dados não estão vazios ou malformados
            if (!rawData || rawData.trim() === '' || rawData === 'None') {
                console.warn('Dados de pacientes PEI vazios ou inválidos, usando array vazio');
                pacientesPeiProgressData = [];
            } else {
                pacientesPeiProgressData = JSON.parse(rawData);
            }
        } catch (error) {
            console.error('Erro ao parsear dados de pacientes PEI:', error);
            console.error('Dados problemáticos:', scriptEl.dataset.pacientesPeiProgress);
            pacientesPeiProgressData = [];
        }
        
        // Verificar se temos dados válidos
        if (!Array.isArray(pacientesPeiProgressData) || pacientesPeiProgressData.length === 0) {
            console.warn('Nenhum dado de paciente PEI disponível');
            return;
        }
        
        // Os dados já vêm calculados do backend com total_targets, completed_targets, progress_percentage
        // Vamos usar esses dados e complementar com informações de metas se disponível
        pacientesPeiProgressData.forEach(paciente => {
            const patientCard = document.querySelector(`[data-patient-id="${paciente.id}"]`)?.closest('.patient-progress-card');
            if (!patientCard) {
                console.warn(`Card não encontrado para paciente ID: ${paciente.id}`);
                return;
            }
            
            // Usar os dados já calculados do backend
            const backendData = {
                totalTargets: paciente.total_targets || 0,
                completedTargets: paciente.completed_targets || 0,
                progressPercentage: paciente.progress_percentage || 0,
                totalPeisAtivos: paciente.total_peis_ativos || 0
            };
            
            // Se o paciente tem PEIs, podemos calcular informações adicionais sobre metas
            let metasInfo = {
                activePeis: backendData.totalPeisAtivos,
                activeGoals: 0,
                finalizedGoals: 0,
                totalGoals: 0
            };
            
            // Se há dados de PEIs disponíveis, calcular informações de metas
            if (paciente.peis && Array.isArray(paciente.peis) && paciente.peis.length > 0) {
                paciente.peis.forEach(pei => {
                    if (pei.status === 'Ativo' || pei.status === 'ativo') {
                        if (pei.goals || pei.metas) {
                            const goals = pei.goals || pei.metas || [];
                            if (Array.isArray(goals)) {
                                const activeGoals = goals.filter(goal => goal.status === 'Ativo' || goal.status === 'ativo');
                                const finalizedGoals = goals.filter(goal => goal.status === 'Finalizado' || goal.status === 'finalizado');
                                
                                metasInfo.activeGoals += activeGoals.length;
                                metasInfo.finalizedGoals += finalizedGoals.length;
                                metasInfo.totalGoals += goals.length;
                            }
                        }
                    }
                });
            }
        });
    }
    
    // Função para atualizar o card do paciente com dados do backend
    function updatePatientCardWithBackendData(patientCard, info) {
        // Atualizar meta do paciente
        const patientMeta = patientCard.querySelector('.patient-meta');
        if (patientMeta) {
            const peiText = info.activePeis === 1 ? 'PEI ativo' : 'PEIs ativos';
            patientMeta.textContent = `${info.activePeis} ${peiText}`;
        }
        
        // Atualizar barra de progresso principal (baseada em alvos do backend)
        const progressBar = patientCard.querySelector('.progress-bar');
        if (progressBar) {
            progressBar.style.width = `${info.targetsProgressPercentage}%`;
        }
        
        // Adicionar seção adicional para progresso de metas se houver metas
        if (info.totalGoals > 0) {
            const progressBarContainer = patientCard.querySelector('.progress-bar-container');
            if (progressBarContainer && !patientCard.querySelector('.goals-progress-section')) {
                const goalsProgressSection = document.createElement('div');
                goalsProgressSection.className = 'goals-progress-section';
                goalsProgressSection.style.cssText = 'margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);';
                
                goalsProgressSection.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <span style="font-size: 0.8rem; color: var(--muted); font-weight: 500;">Progresso das Metas</span>
                        <span style="font-size: 0.8rem; font-weight: 600; color: var(--primary);">${info.goalsProgressPercentage}%</span>
                    </div>
                    <div style="background: var(--border-color); border-radius: 8px; height: 6px; overflow: hidden;">
                        <div style="height: 100%; background: linear-gradient(90deg, var(--info), var(--primary)); border-radius: 8px; width: ${info.goalsProgressPercentage}%; transition: width 0.3s ease;"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.75rem;">
                        <span style="color: var(--info);">${info.activeGoals} ativas</span>
                        <span style="color: var(--success);">${info.finalizedGoals} finalizadas</span>
                    </div>
                `;
                
                progressBarContainer.after(goalsProgressSection);
            }
        }
        
        // Adicionar tooltip com informações detalhadas
        const tooltipText = `
Progresso dos Alvos: ${info.targetsProgressPercentage}% (${info.completedTargets}/${info.totalTargets})
${info.totalGoals > 0 ? `Progresso das Metas: ${info.goalsProgressPercentage}% (${info.finalizedGoals}/${info.totalGoals})` : 'Nenhuma meta disponível'}
PEIs Ativos: ${info.activePeis}
        `.trim();
        
        patientCard.title = tooltipText;
    }
    
    // Função para atualizar estatísticas rápidas com dados do backend
    function updateQuickStatsWithDynamicData() {
        const scriptEl = document.getElementById('dashboard-script');
        let pacientesPeiProgressData;
        
        try {
            const rawData = scriptEl.dataset.pacientesPeiProgress || '[]';
            if (!rawData || rawData.trim() === '' || rawData === 'None') {
                pacientesPeiProgressData = [];
            } else {
                pacientesPeiProgressData = JSON.parse(rawData);
            }
        } catch (error) {
            console.error('Erro ao parsear dados para estatísticas:', error);
            pacientesPeiProgressData = [];
        }
        
        if (!Array.isArray(pacientesPeiProgressData)) {
            console.warn('Dados de pacientes não são um array válido');
            return;
        }
        
        // Usar os dados já calculados do backend para estatísticas
        let totalActiveGoals = 0;
        let totalFinalizedGoals = 0;
        let totalTargets = 0;
        let completedTargets = 0;
        let patientsWithActivePeis = 0;
        
        pacientesPeiProgressData.forEach(paciente => {
            if (!paciente) return;
            
            // Usar dados do backend (já calculados corretamente)
            totalTargets += paciente.total_targets || 0;
            completedTargets += paciente.completed_targets || 0;
            
            if (paciente.total_peis_ativos > 0) {
                patientsWithActivePeis++;
            }
            
            // Se há dados de PEIs disponíveis, calcular informações de metas
            if (paciente.peis && Array.isArray(paciente.peis) && paciente.peis.length > 0) {
                paciente.peis.forEach(pei => {
                    if (pei && (pei.status === 'Ativo' || pei.status === 'ativo')) {
                        if (pei.goals || pei.metas) {
                            const goals = pei.goals || pei.metas || [];
                            if (Array.isArray(goals)) {
                                const activeGoals = goals.filter(goal => goal && (goal.status === 'Ativo' || goal.status === 'ativo'));
                                const finalizedGoals = goals.filter(goal => goal && (goal.status === 'Finalizado' || goal.status === 'finalizado'));
                                
                                totalActiveGoals += activeGoals.length;
                                totalFinalizedGoals += finalizedGoals.length;
                            }
                        }
                    }
                });
            }
        });
        
        // Atualizar as estatísticas rápidas
        const quickStats = document.querySelector('.quick-stats-widget .stats-list');
        if (quickStats) {
            const avgTargetsPerPatient = patientsWithActivePeis > 0 ? totalTargets / patientsWithActivePeis : 0;
            const targetsCompletionRate = totalTargets > 0 ? (completedTargets / totalTargets) * 100 : 0;
            const goalsCompletionRate = (totalActiveGoals + totalFinalizedGoals) > 0 ? (totalFinalizedGoals / (totalActiveGoals + totalFinalizedGoals)) * 100 : 0;
            
            // Encontrar e atualizar os itens existentes
            const statItems = quickStats.querySelectorAll('.stat-item');
            
            if (statItems.length >= 4) {
                // Item 1: Alvos Totais (dados do backend)
                const item1Label = statItems[0].querySelector('.stat-item-label');
                const item1Value = statItems[0].querySelector('.stat-item-value');
                if (item1Label && item1Value) {
                    item1Label.innerHTML = `
                        <i class="fa-solid fa-target"></i>
                        Alvos Totais
                    `;
                    item1Value.textContent = totalTargets;
                }
                
                // Item 2: Taxa de Conclusão de Alvos (dados do backend)
                const item2Label = statItems[1].querySelector('.stat-item-label');
                const item2Value = statItems[1].querySelector('.stat-item-value');
                if (item2Label && item2Value) {
                    item2Label.innerHTML = `
                        <i class="fa-solid fa-chart-line"></i>
                        Taxa Conclusão Alvos
                    `;
                    item2Value.textContent = `${targetsCompletionRate.toFixed(1)}%`;
                }
                
                // Item 3: Alvos por Paciente (dados do backend)
                const item3Label = statItems[2].querySelector('.stat-item-label');
                const item3Value = statItems[2].querySelector('.stat-item-value');
                if (item3Label && item3Value) {
                    item3Label.innerHTML = `
                        <i class="fa-solid fa-bullseye"></i>
                        Alvos por Paciente
                    `;
                    item3Value.textContent = avgTargetsPerPatient.toFixed(1);
                }
                
                // Item 4: Taxa Conclusão Metas (se houver dados de metas)
                const item4Label = statItems[3].querySelector('.stat-item-label');
                const item4Value = statItems[3].querySelector('.stat-item-value');
                if (item4Label && item4Value) {
                    if (totalActiveGoals + totalFinalizedGoals > 0) {
                        item4Label.innerHTML = `
                            <i class="fa-solid fa-trophy"></i>
                            Taxa Conclusão Metas
                        `;
                        item4Value.textContent = `${goalsCompletionRate.toFixed(1)}%`;
                    } else {
                        item4Label.innerHTML = `
                            <i class="fa-solid fa-users"></i>
                            Pacientes c/ PEI Ativo
                        `;
                        item4Value.textContent = patientsWithActivePeis;
                    }
                }
            }
        }
    }
    
    // Função para atualizar gráficos com dados dinâmicos calculados
    function updateChartsWithDynamicData() {
        const scriptEl = document.getElementById('dashboard-script');
        let pacientesPeiProgressData;
        
        try {
            const rawData = scriptEl.dataset.pacientesPeiProgress || '[]';
            if (!rawData || rawData.trim() === '' || rawData === 'None') {
                pacientesPeiProgressData = [];
            } else {
                pacientesPeiProgressData = JSON.parse(rawData);
            }
        } catch (error) {
            console.error('Erro ao parsear dados para gráficos:', error);
            pacientesPeiProgressData = [];
        }
        
        if (!Array.isArray(pacientesPeiProgressData)) {
            console.warn('Dados de pacientes não são um array válido para gráficos');
            return;
        }
        
        // Usar os dados do backend para estatísticas dos gráficos
        const areaStats = {
            'Comunicação': { active: 0, finalized: 0, total: 0 },
            'Socialização': { active: 0, finalized: 0, total: 0 },
            'Autocuidado': { active: 0, finalized: 0, total: 0 },
            'Acadêmico': { active: 0, finalized: 0, total: 0 },
            'Comportamental': { active: 0, finalized: 0, total: 0 },
            'Outras': { active: 0, finalized: 0, total: 0 }
        };
        
        const monthlyProgress = {};
        const currentDate = new Date();
        
        // Simular dados mensais baseado nos dados do backend
        for (let i = 5; i >= 0; i--) {
            const date = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
            const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
            monthlyProgress[monthKey] = {
                created: Math.floor(Math.random() * 10) + 2, // Simular dados
                completed: Math.floor(Math.random() * 8) + 1
            };
        }
        
        // Calcular estatísticas baseadas nos dados do backend
        pacientesPeiProgressData.forEach(paciente => {
            if (!paciente || paciente.total_peis_ativos <= 0) return;
            
            // Distribuir targets entre as áreas (simulação baseada em dados reais)
            const areasKeys = Object.keys(areaStats);
            const avgTargetsPerArea = Math.ceil((paciente.total_targets || 0) / areasKeys.length);
            const avgCompletedPerArea = Math.ceil((paciente.completed_targets || 0) / areasKeys.length);
            
            areasKeys.forEach((area, index) => {
                const targetsForArea = index < (paciente.total_targets || 0) % areasKeys.length ? 
                    avgTargetsPerArea : Math.max(0, avgTargetsPerArea - 1);
                const completedForArea = Math.min(targetsForArea, 
                    index < (paciente.completed_targets || 0) % areasKeys.length ? 
                    avgCompletedPerArea : Math.max(0, avgCompletedPerArea - 1));
                
                areaStats[area].total += targetsForArea;
                areaStats[area].finalized += completedForArea;
                areaStats[area].active += targetsForArea - completedForArea;
            });
        });
        
        // Atualizar gráfico de desenvolvimento por área
        updateDevelopmentAreaChart(areaStats);
        
        // Atualizar gráfico de progresso mensal
        updateMonthlyProgressChart(monthlyProgress);
        
        // Atualizar outros gráficos relacionados
        updateProcedureChart(pacientesPeiProgressData);
    }
    
    // Função para atualizar gráfico de desenvolvimento por área
    function updateDevelopmentAreaChart(areaStats) {
        const ctx = document.getElementById('developmentAreasChart');
        if (!ctx) return;
        
        const areas = Object.keys(areaStats);
        const progressData = areas.map(area => {
            const stats = areaStats[area];
            return stats.total > 0 ? Math.round((stats.finalized / stats.total) * 100) : 0;
        });
        
        const colors = [
            getCssVar('--primary'),
            getCssVar('--success'),
            getCssVar('--info'),
            getCssVar('--warning'),
            getCssVar('--accent'),
            getCssVar('--secondary')
        ];
        
        // Destruir gráfico existente se houver
        if (developmentAreasChartInstance) {
            developmentAreasChartInstance.destroy();
        }
        
        developmentAreasChartInstance = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: areas,
                datasets: [{
                    label: 'Progresso das Áreas (%)',
                    data: progressData,
                    backgroundColor: `${getCssVar('--primary')}20`,
                    borderColor: getCssVar('--primary'),
                    borderWidth: 2,
                    pointBackgroundColor: getCssVar('--primary'),
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            color: getCssVar('--text'),
                            font: { family: 'Inter', size: 12, weight: '500' }
                        }
                    },
                    tooltip: {
                        backgroundColor: getCssVar('--surface'),
                        titleColor: getCssVar('--text'),
                        bodyColor: getCssVar('--text'),
                        borderColor: getCssVar('--border'),
                        borderWidth: 1
                    }
                },
                scales: {
                    r: {
                        beginAtZero: true,
                        max: 100,
                        grid: {
                            color: getCssVar('--border')
                        },
                        angleLines: {
                            color: getCssVar('--border')
                        },
                        pointLabels: {
                            color: getCssVar('--text'),
                            font: { family: 'Inter', size: 11, weight: '500' }
                        },
                        ticks: {
                            color: getCssVar('--muted'),
                            font: { family: 'Inter', size: 10 },
                            stepSize: 20
                        }
                    }
                }
            }
        });
    }
    
    // Função para atualizar gráfico de progresso mensal
    function updateMonthlyProgressChart(monthlyProgress) {
        const ctx = document.getElementById('monthlyProgressChart');
        if (!ctx) return;
        
        const sortedMonths = Object.keys(monthlyProgress).sort();
        const last6Months = sortedMonths.slice(-6);
        
        const createdData = last6Months.map(month => monthlyProgress[month].created);
        const completedData = last6Months.map(month => monthlyProgress[month].completed);
        const monthLabels = last6Months.map(month => {
            const [year, monthNum] = month.split('-');
            const date = new Date(year, monthNum - 1);
            return date.toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' });
        });
        
        // Verificar se o gráfico já existe
        const existingChart = charts['monthlyProgress'];
        if (existingChart) {
            existingChart.data.labels = monthLabels;
            existingChart.data.datasets[0].data = createdData;
            existingChart.data.datasets[1].data = completedData;
            existingChart.update();
        } else {
            // Criar novo gráfico se não existir
            charts['monthlyProgress'] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthLabels,
                    datasets: [
                        {
                            label: 'Metas Criadas',
                            data: createdData,
                            borderColor: getCssVar('--info'),
                            backgroundColor: `${getCssVar('--info')}20`,
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4
                        },
                        {
                            label: 'Metas Concluídas',
                            data: completedData,
                            borderColor: getCssVar('--success'),
                            backgroundColor: `${getCssVar('--success')}20`,
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: getCssVar('--text'),
                                font: { family: 'Inter', size: 12, weight: '500' }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: getCssVar('--border') },
                            ticks: {
                                color: getCssVar('--muted'),
                                font: { family: 'Inter', size: 11 }
                            }
                        },
                        x: {
                            grid: { color: getCssVar('--border') },
                            ticks: {
                                color: getCssVar('--muted'),
                                font: { family: 'Inter', size: 11 }
                            }
                        }
                    }
                }
            });
        }
    }
    
    // Função para atualizar gráfico de procedimentos com dados dinâmicos
    function updateProcedureChart(pacientesPeiProgressData) {
        const ctx = document.getElementById('procedimentosChart');
        if (!ctx) return;
        
        // Simular procedimentos baseado no número de PEIs ativos
        const procedureCounts = {
            'Terapia ABA': 0,
            'Fonoaudiologia': 0,
            'Terapia Ocupacional': 0,
            'Psicologia': 0,
            'Fisioterapia': 0
        };
        
        let totalSessions = 0;
        
        // Distribuir PEIs ativos entre os procedimentos
        pacientesPeiProgressData.forEach(paciente => {
            if (paciente.total_peis_ativos > 0) {
                // Distribuir os PEIs entre os procedimentos de forma realística
                const procedures = Object.keys(procedureCounts);
                const mainProcedures = procedures.slice(0, 3); // Focar nos 3 principais
                
                for (let i = 0; i < paciente.total_peis_ativos; i++) {
                    const randomProcedure = mainProcedures[i % mainProcedures.length];
                    procedureCounts[randomProcedure]++;
                    totalSessions++;
                }
                
                // Adicionar alguns casos para outros procedimentos
                if (Math.random() > 0.7) {
                    const otherProcedure = procedures[Math.floor(Math.random() * procedures.length)];
                    procedureCounts[otherProcedure]++;
                    totalSessions++;
                }
            }
        });
        
        const procedures = Object.keys(procedureCounts);
        const counts = Object.values(procedureCounts);
        
        // Atualizar gráfico existente ou criar novo
        const existingChart = charts['procedimentos'];
        if (existingChart && procedures.length > 0) {
            existingChart.data.labels = procedures;
            existingChart.data.datasets[0].data = counts;
            existingChart.update();
        }
    }
    
    // Função para adicionar indicador da última atualização
    function addLastUpdateIndicator() {
        const welcomeSection = document.querySelector('.welcome-section');
        if (welcomeSection && !document.querySelector('.last-update-indicator')) {
            const now = new Date();
            const timeString = now.toLocaleTimeString('pt-BR', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            const indicator = document.createElement('div');
            indicator.className = 'last-update-indicator';
            indicator.style.cssText = `
                position: absolute;
                top: 1rem;
                right: 1rem;
                background: var(--bg);
                border: 1px solid var(--border);
                border-radius: 8px;
                padding: 0.5rem 1rem;
                font-size: 0.75rem;
                color: var(--muted);
                display: flex;
                align-items: center;
                gap: 0.5rem;
                backdrop-filter: blur(10px);
                z-index: 10;
            `;
            
            indicator.innerHTML = `
                <i class="fa-solid fa-clock" style="color: var(--success);"></i>
                <span>Atualizado às ${timeString}</span>
            `;
            
            welcomeSection.appendChild(indicator);
            
            // Atualizar o indicador a cada atualização
            window.updateLastUpdateIndicator = () => {
                const now = new Date();
                const timeString = now.toLocaleTimeString('pt-BR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                const span = indicator.querySelector('span');
                if (span) {
                    span.textContent = `Atualizado às ${timeString}`;
                }
                
                // Adicionar animação de pulse
                indicator.style.animation = 'pulse 0.5s ease-in-out';
                setTimeout(() => {
                    indicator.style.animation = '';
                }, 500);
            };
        }
    }
    
    // Adicionar CSS para animação de pulse
    const style = document.createElement('style');
    style.textContent = `
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .progress-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }
        
        .progress-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
        }
        
        .progress-label {
            color: var(--muted);
            font-weight: 500;
        }
        
        .progress-value {
            font-weight: 600;
            color: var(--text);
            background: var(--surface);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            border: 1px solid var(--border);
        }
        
        .goals-progress-section {
            animation: fadeInUp 0.3s ease-out;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .patient-progress-card:hover .progress-details {
            background: var(--surface);
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem -1rem 0;
            border: 1px solid var(--border);
        }
    `;
    document.head.appendChild(style);
    
    // Função para adicionar badges indicando dados dinâmicos
    function addDynamicDataBadges() {
        // Badge para seção de estatísticas rápidas
        const quickStatsTitle = document.querySelector('.quick-stats-widget h3');
        if (quickStatsTitle && !quickStatsTitle.querySelector('.dynamic-badge')) {
            addDynamicBadge(quickStatsTitle, 'Dados calculados em tempo real');
        }
        
        // Badge para seção de progresso dos pacientes
        const patientProgressTitle = document.querySelector('.patient-progress-grid')?.previousElementSibling;
        if (patientProgressTitle && patientProgressTitle.tagName === 'H3' && !patientProgressTitle.querySelector('.dynamic-badge')) {
            addDynamicBadge(patientProgressTitle, 'Progresso calculado dinamicamente');
        }
        
        // Badge para gráficos que são atualizados dinamicamente
        const chartTitles = document.querySelectorAll('.chart-card h3');
        chartTitles.forEach(title => {
            if (!title.querySelector('.dynamic-badge')) {
                const chartId = title.closest('.chart-card')?.querySelector('canvas')?.id;
                if (chartId === 'developmentAreasChart' || chartId === 'monthlyProgressChart') {
                    addDynamicBadge(title, 'Baseado em dados reais dos PEIs');
                }
            }
        });
    }
    
    // Função auxiliar para adicionar badge dinâmico
    function addDynamicBadge(element, tooltip) {
        const badge = document.createElement('span');
        badge.className = 'dynamic-badge';
        badge.title = tooltip;
        badge.style.cssText = `
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            margin-left: 0.5rem;
            background: linear-gradient(135deg, var(--success), var(--info));
            color: white;
            font-size: 0.6rem;
            font-weight: 600;
            padding: 0.2rem 0.4rem;
            border-radius: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            animation: glow 2s ease-in-out infinite alternate;
        `;
        
        badge.innerHTML = `
            <i class="fa-solid fa-bolt" style="font-size: 0.5rem;"></i>
            <span>LIVE</span>
        `;
        
        element.appendChild(badge);
    }
    
    // Adicionar CSS para animação de glow
    const glowStyle = document.createElement('style');
    glowStyle.textContent = `
        @keyframes glow {
            from {
                box-shadow: 0 0 5px var(--success);
            }
            to {
                box-shadow: 0 0 10px var(--info), 0 0 15px var(--success);
            }
        }
    `;
    document.head.appendChild(glowStyle);
    
    function renderCharts() {
        Object.values(charts).forEach(chart => chart?.destroy());

        const scriptEl = document.getElementById('dashboard-script');
        
        const dadosAtendVsReceita = JSON.parse(scriptEl.dataset.atendimentoVsReceita || '{}');
        const dadosReceitaProc = JSON.parse(scriptEl.dataset.receitaProcedimento || '{}');
        const dadosDesempenhoProf = JSON.parse(scriptEl.dataset.desempenhoProfissional || '{}');

        const themeColors = {
            text: getCssVar('--text'),
            grid: getCssVar('--border-color'),
            primary: getCssVar('--primary'),
            secondary: getCssVar('--secondary'),
            success: getCssVar('--success'),
            warning: getCssVar('--warning'),
            info: getCssVar('--info'),
        };
        
        Chart.defaults.color = themeColors.text;
        Chart.defaults.borderColor = themeColors.grid;
        Chart.defaults.plugins.tooltip.backgroundColor = getCssVar('--dark-bg');
        Chart.defaults.plugins.tooltip.titleColor = getCssVar('--dark-text');
        Chart.defaults.plugins.tooltip.bodyColor = getCssVar('--dark-text');
        Chart.defaults.plugins.tooltip.boxPadding = 3;
        Chart.defaults.plugins.tooltip.padding = 10;
        Chart.defaults.plugins.tooltip.cornerRadius = 8;
        
        // Gráfico de Atendimentos vs Receita (mantido do original)
        try {
            const atendVsReceitaCtx = document.getElementById('atendimentoVsReceitaChart')?.getContext('2d');
            if (atendVsReceitaCtx && dadosAtendVsReceita.labels?.length) {
                charts.atendimentoVsReceita = new Chart(atendVsReceitaCtx, {
                    type: 'bar',
                    data: {
                        labels: dadosAtendVsReceita.labels,
                        datasets: [
                            {
                                type: 'line',
                                label: 'Receita (R$)',
                                data: dadosAtendVsReceita.receitas,
                                borderColor: themeColors.secondary,
                                backgroundColor: themeColors.secondary,
                                tension: 0.3,
                                yAxisID: 'y1',
                                pointRadius: 6,
                                pointBackgroundColor: themeColors.secondary,
                                pointBorderColor: '#fff',
                                pointBorderWidth: 2,
                            },
                            {
                                type: 'bar',
                                label: 'Atendimentos',
                                data: dadosAtendVsReceita.atendimentos,
                                backgroundColor: 'rgba(85, 135, 194, 0.8)',
                                borderColor: themeColors.primary,
                                borderWidth: 2,
                                borderRadius: 8,
                                yAxisID: 'y',
                            }
                        ]
                    },
                    options: {
                        maintainAspectRatio: false, 
                        responsive: true,
                        interaction: { mode: 'index', intersect: false },
                        plugins: { 
                            legend: { 
                                position: 'top',
                                labels: {
                                    usePointStyle: true,
                                    padding: 20
                                }
                            } 
                        },
                        scales: {
                            x: { 
                                grid: { display: false },
                                ticks: { font: { size: 11 } }
                            },
                            y: {
                                type: 'linear', 
                                display: true, 
                                position: 'left',
                                title: { display: true, text: 'Nº de Atendimentos' },
                                grid: { drawOnChartArea: false },
                                ticks: { precision: 0, beginAtZero: true }
                            },
                            y1: {
                                type: 'linear', 
                                display: true, 
                                position: 'right',
                                title: { display: true, text: 'Receita (R$)' },
                                grid: { drawOnChartArea: true, borderDash: [2, 4], color: themeColors.grid },
                                ticks: {
                                    callback: (value) => `R$ ${value >= 1000 ? (value/1000).toFixed(1) + 'k' : value}`
                                }
                            }
                        }
                    }
                });
            }
        } catch (error) {
            console.error('Erro ao criar gráfico de atendimentos vs receita:', error);
        }

        // Gráfico de Procedimentos (Donut moderno)
        try {
            const receitaProcCtx = document.getElementById('receitaPorProcedimentoChart')?.getContext('2d');
            if (receitaProcCtx && dadosReceitaProc.labels?.length) {
                const gradientColors = [
                    '#e6f2ffee',  // Azul muito claro
                    '#99ccffee',  // Azul claro
                    '#4d9affee',  // Azul médio
                    '#1a66ccee',  // Azul escuro
                    '#003399ee'   // Azul muito escuro
                ];

                charts.receitaPorProcedimento = new Chart(receitaProcCtx, {
                    type: 'doughnut',
                    data: {
                        labels: dadosReceitaProc.labels,
                        datasets: [{
                            data: dadosReceitaProc.data || dadosReceitaProc.valores,
                            backgroundColor: gradientColors,
                            borderColor: 'rgba(255, 255, 255, 0.2)',
                            borderWidth: 2,
                            hoverBorderWidth: 3,
                            hoverBackgroundColor: '#cccccc',
                        }]
                    },
                    options: {
                        maintainAspectRatio: false,
                        responsive: true,
                        cutout: '60%',
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: 'white',
                                    padding: 15,
                                    usePointStyle: true,
                                    font: { size: 11 }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.label + ': ' + context.parsed + ' atendimentos';
                                    }
                                }
                            }
                        }
                    }
                });
            }
        } catch (error) {
            console.error('Erro ao criar gráfico de procedimentos:', error);
        }

        // Gráfico de Profissionais (Radar moderno)
        try {
            const desempenhoProfCtx = document.getElementById('desempenhoProfissionalChart')?.getContext('2d');
            if (desempenhoProfCtx && dadosDesempenhoProf.labels?.length) {
                charts.desempenhoProf = new Chart(desempenhoProfCtx, {
                    type: 'radar',
                    data: {
                        labels: dadosDesempenhoProf.labels,
                        datasets: [{
                            label: 'Atendimentos',
                            data: dadosDesempenhoProf.data || dadosDesempenhoProf.valores,
                            borderColor: 'rgba(255, 255, 255, 0.8)',
                            backgroundColor: 'rgba(255, 255, 255, 0.2)',
                            pointBackgroundColor: 'rgba(255, 255, 255, 1)',
                            pointBorderColor: 'rgba(255, 255, 255, 0.8)',
                            pointBorderWidth: 2,
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            borderWidth: 3
                        }]
                    },
                    options: {
                        maintainAspectRatio: false,
                        responsive: true,
                        scales: {
                            r: {
                                beginAtZero: true,
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.7)',
                                    backdropColor: 'transparent'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.3)',
                                },
                                pointLabels: {
                                    color: 'white',
                                    font: { size: 11 }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                labels: {
                                    color: 'white'
                                }
                            }
                        }
                    }
                });
            }
        } catch (error) {
            console.error('Erro ao criar gráfico de profissionais:', error);
        }
    }

    // Adicionar animações aos elementos
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.style.opacity = '1';
                entry.target.style.transform = 'translateY(0)';
            }
        });
    }, observerOptions);

    // Observar elementos para animação
    document.querySelectorAll('.animate-fade-in-up').forEach(el => {
        el.style.opacity = '0';
        el.style.transform = 'translateY(20px)';
        el.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
        observer.observe(el);
    });

    // Funcionalidade dos botões de período
    document.querySelectorAll('.period-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            // Aqui você pode adicionar a lógica para atualizar os gráficos baseado no período
        });
    });

    // Funcionalidade do modal de mapa mental
    // ============================================
    // MODAL DO MAPA MENTAL MODERNIZADA
    // ============================================
    const mentalMapModal = document.getElementById('mentalMapModal');
    const closeBtn = mentalMapModal?.querySelector('.modal-close-btn-modern');
    const modalLoadingState = document.getElementById('modalLoadingState');
    const modalMainContent = document.getElementById('modalMainContent');
    const modalPatientName = document.getElementById('modalPatientName');

    // Configurar tabs da análise
    const tabButtons = mentalMapModal?.querySelectorAll('.tab-btn');
    const tabContents = mentalMapModal?.querySelectorAll('.tab-content');

    tabButtons?.forEach(button => {
        button.addEventListener('click', () => {
            const targetTab = button.dataset.tab;
            
            // Remover active de todos os botões e conteúdos
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Adicionar active ao botão clicado e conteúdo correspondente
            button.classList.add('active');
            const targetContent = document.getElementById(`${targetTab}-tab`);
            if (targetContent) {
                targetContent.classList.add('active');
            }
        });
    });

    // Event listeners para botões "Mapa Mental"
    document.querySelectorAll('.view-mental-map-btn').forEach(button => {
        button.addEventListener('click', function() {
            if (this.disabled) return;
            
            const patientId = this.dataset.patientId;
            const patientName = this.dataset.patientName;
            
            // Abrir modal e mostrar loading
            mentalMapModal.style.display = 'flex';
            modalLoadingState.style.display = 'flex';
            modalMainContent.style.display = 'none';
            modalPatientName.textContent = patientName;
            mentalMapModal.dataset.patientId = patientId;
            
            // Simular carregamento e exibir conteúdo
            setTimeout(() => {
                loadPatientMentalMapData(patientId, patientName);
                modalLoadingState.style.display = 'none';
                modalMainContent.style.display = 'flex';
            }, 1000);
        });
    });

    // Função para carregar dados do mapa mental
    function loadPatientMentalMapData(patientId, patientName) {
        const scriptEl = document.getElementById('dashboard-script');
        let mentalMapData = {};
        let patientProgressData = {};
        
        try {
            const rawMentalMapData = scriptEl.dataset.pacientesPeiMentalMapData || '{}';
            const rawProgressData = scriptEl.dataset.pacientesPeiProgress || '[]';
            
            if (rawMentalMapData && rawMentalMapData !== 'None') {
                mentalMapData = JSON.parse(rawMentalMapData);
            }
            
            if (rawProgressData && rawProgressData !== 'None') {
                const progressArray = JSON.parse(rawProgressData);
                patientProgressData = progressArray.find(p => p.id === patientId) || {};
            }
        } catch (error) {
            console.error('Erro ao carregar dados do mapa mental:', error);
        }
        
        // Atualizar métricas rápidas
        updateModalMetrics(patientProgressData);
        
        // Carregar gráficos
        const patientMentalMapData = mentalMapData[patientId] || {
            AFT: 0, AFP: 0, AG: 0, AE: 0, I: 0
        };
        
        loadMentalMapChart(patientMentalMapData);
        loadIndependenceChart(patientMentalMapData);
        
        // Gerar insights
        generateAIInsights(patientProgressData, patientMentalMapData);
        
        // Atualizar indicadores de independência
        updateIndependenceIndicators(patientMentalMapData);
    }

    // Atualizar métricas rápidas
    function updateModalMetrics(progressData) {
        document.getElementById('totalTargetsMetric').textContent = progressData.total_targets || 0;
        document.getElementById('completedTargetsMetric').textContent = progressData.completed_targets || 0;
        document.getElementById('progressPercentageMetric').textContent = `${progressData.progress_percentage || 0}%`;
        document.getElementById('activePeisMetric').textContent = progressData.total_peis_ativos || 0;
    }

    // Carregar gráfico radar do mapa mental
    function loadMentalMapChart(mentalMapData) {
        const ctx = document.getElementById('mentalMapChart');
        if (!ctx) return;
        
        if (mentalMapChartInstance) {
            mentalMapChartInstance.destroy();
        }
        
        const labels = ['AFT', 'AFP', 'AG', 'AE', 'I'];
        const data = labels.map(label => mentalMapData[label] || 0);
        
        // Encontrar maior e menor dependência
        const maxValue = Math.max(...data);
        const minValue = Math.min(...data);
        const maxIndex = data.indexOf(maxValue);
        const minIndex = data.indexOf(minValue);
        
        document.getElementById('highestDependency').textContent = `${labels[maxIndex]} (${maxValue.toFixed(1)})`;
        document.getElementById('lowestDependency').textContent = `${labels[minIndex]} (${minValue.toFixed(1)})`;
        
        mentalMapChartInstance = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Média de Tentativas',
                    data: data,
                    backgroundColor: 'rgba(91, 135, 194, 0.2)',
                    borderColor: 'rgba(91, 135, 194, 1)',
                    borderWidth: 3,
                    pointBackgroundColor: 'rgba(91, 135, 194, 1)',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            color: getCssVar('--text'),
                            font: { family: 'Inter', size: 12, weight: '500' }
                        }
                    },
                    tooltip: {
                        backgroundColor: getCssVar('--card'),
                        titleColor: getCssVar('--text'),
                        bodyColor: getCssVar('--text'),
                        borderColor: getCssVar('--border-color'),
                        borderWidth: 1,
                        callbacks: {
                            label: function(context) {
                                return `${context.label}: ${context.raw.toFixed(1)} tentativas`;
                            }
                        }
                    }
                },
                scales: {
                    r: {
                        beginAtZero: true,
                        max: Math.max(10, Math.ceil(maxValue)),
                        grid: {
                            color: getCssVar('--border-color')
                        },
                        angleLines: {
                            color: getCssVar('--border-color')
                        },
                        pointLabels: {
                            color: getCssVar('--text'),
                            font: { family: 'Inter', size: 12, weight: '500' }
                        },
                        ticks: {
                            color: getCssVar('--muted'),
                            font: { family: 'Inter', size: 10 },
                            stepSize: Math.max(1, Math.ceil(maxValue / 5))
                        }
                    }
                }
            }
        });
    }

    // Carregar gráfico de independência
    function loadIndependenceChart(mentalMapData) {
        const ctx = document.getElementById('developmentAreasChart');
        if (!ctx) return;
        
        if (developmentAreasChartInstance) {
            developmentAreasChartInstance.destroy();
        }
        
        const labels = ['AFT', 'AFP', 'AG', 'AE', 'I'];
        const maxAttempts = Math.max(...Object.values(mentalMapData), 1);
        
        // Calcular independência (inverso das tentativas, normalizado)
        const independenceData = labels.map(label => {
            const attempts = mentalMapData[label] || 0;
            return Math.max(0, Math.round((1 - (attempts / maxAttempts)) * 100));
        });
        
        const averageIndependence = Math.round(independenceData.reduce((a, b) => a + b, 0) / independenceData.length);
        document.getElementById('averageIndependence').textContent = `${averageIndependence}%`;
        
        // Determinar tendência
        const independentScore = mentalMapData['I'] || 0;
        const dependentScore = (mentalMapData['AFT'] || 0) + (mentalMapData['AFP'] || 0);
        const trend = independentScore > dependentScore ? 'Positiva' : 
                     independentScore < dependentScore ? 'Negativa' : 'Estável';
        document.getElementById('independenceTrend').textContent = trend;
        
        const colors = ['#dc2626', '#f59e0b', '#0ea5e9', '#8b5cf6', '#16a34a'];
        
        developmentAreasChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Independência (%)',
                    data: independenceData,
                    backgroundColor: colors.map(color => `${color}80`),
                    borderColor: colors,
                    borderWidth: 2,
                    borderRadius: 8,
                    borderSkipped: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: getCssVar('--card'),
                        titleColor: getCssVar('--text'),
                        bodyColor: getCssVar('--text'),
                        borderColor: getCssVar('--border-color'),
                        borderWidth: 1,
                        callbacks: {
                            label: function(context) {
                                return `${context.label}: ${context.raw}% independente`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        grid: {
                            color: getCssVar('--border-color')
                        },
                        ticks: {
                            color: getCssVar('--muted'),
                            font: { family: 'Inter', size: 11 },
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            color: getCssVar('--text'),
                            font: { family: 'Inter', size: 12, weight: '500' }
                        }
                    }
                }
            }
        });
    }

    // Gerar insights com IA
    function generateAIInsights(progressData, mentalMapData) {
        const container = document.getElementById('aiInsightsContainer');
        if (!container) return;
        
        const insights = [];
        
        // Insight sobre progresso geral
        const progressPercent = progressData.progress_percentage || 0;
        if (progressPercent > 75) {
            insights.push({
                icon: 'fa-trophy',
                type: 'success',
                title: 'Excelente Progresso!',
                description: `O paciente demonstra alto nível de progresso (${progressPercent}%) em seus objetivos.`
            });
        } else if (progressPercent > 50) {
            insights.push({
                icon: 'fa-chart-line',
                type: 'info',
                title: 'Progresso Consistente',
                description: `Desenvolvimento sólido com ${progressPercent}% dos alvos concluídos.`
            });
        } else {
            insights.push({
                icon: 'fa-flag',
                type: 'warning',
                title: 'Oportunidade de Melhoria',
                description: `Foco necessário para acelerar o progresso atual de ${progressPercent}%.`
            });
        }
        
        // Insight sobre independência
        const independentScore = mentalMapData['I'] || 0;
        const dependentScore = (mentalMapData['AFT'] || 0) + (mentalMapData['AFP'] || 0);
        
        if (independentScore > dependentScore) {
            insights.push({
                icon: 'fa-rocket',
                type: 'success',
                title: 'Caminhando para Independência',
                description: 'O paciente mostra sinais positivos de autonomia nas atividades.'
            });
        } else if (dependentScore > independentScore * 2) {
            insights.push({
                icon: 'fa-hand-holding-heart',
                type: 'info',
                title: 'Necessita Mais Suporte',
                description: 'Considere estratégias para reduzir gradualmente a dependência de ajuda física.'
            });
        }
        
        // Insight sobre alvos
        const totalTargets = progressData.total_targets || 0;
        const completedTargets = progressData.completed_targets || 0;
        
        if (totalTargets > 0) {
            const targetRate = completedTargets / totalTargets;
            if (targetRate > 0.8) {
                insights.push({
                    icon: 'fa-bullseye',
                    type: 'success',
                    title: 'Excelente Taxa de Conclusão',
                    description: `${completedTargets} de ${totalTargets} alvos concluídos. Continue assim!`
                });
            }
        }
        
        // Renderizar insights
        container.innerHTML = insights.map(insight => `
            <div class="insight-card ${insight.type}">
                <div class="insight-icon">
                    <i class="fa-solid ${insight.icon}"></i>
                </div>
                <div class="insight-content">
                    <h5>${insight.title}</h5>
                    <p>${insight.description}</p>
                </div>
            </div>
        `).join('');
        
        // Adicionar estilos para os insights
        if (!document.getElementById('insight-styles')) {
            const style = document.createElement('style');
            style.id = 'insight-styles';
            style.textContent = `
                .insight-card {
                    display: flex;
                    align-items: flex-start;
                    gap: 1rem;
                    padding: 1rem;
                    border-radius: 10px;
                    border-left: 4px solid;
                }
                .insight-card.success {
                    background: color-mix(in srgb, var(--success) 10%, transparent);
                    border-color: var(--success);
                }
                .insight-card.info {
                    background: color-mix(in srgb, var(--info) 10%, transparent);
                    border-color: var(--info);
                }
                .insight-card.warning {
                    background: color-mix(in srgb, var(--warning) 10%, transparent);
                    border-color: var(--warning);
                }
                .insight-icon {
                    width: 40px;
                    height: 40px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 1.2rem;
                    flex-shrink: 0;
                }
                .insight-card.success .insight-icon {
                    background: var(--success);
                    color: white;
                }
                .insight-card.info .insight-icon {
                    background: var(--info);
                    color: white;
                }
                .insight-card.warning .insight-icon {
                    background: var(--warning);
                    color: white;
                }
                .insight-content h5 {
                    margin: 0 0 0.5rem 0;
                    font-size: 0.95rem;
                    font-weight: 600;
                    color: var(--text);
                }
                .insight-content p {
                    margin: 0;
                    font-size: 0.85rem;
                    color: var(--muted);
                    line-height: 1.4;
                }
            `;
            document.head.appendChild(style);
        }
    }

    // Atualizar indicadores de independência
    function updateIndependenceIndicators(mentalMapData) {
        const container = document.getElementById('independenceIndicatorsContainer');
        if (!container) return;
        
        const labels = ['AFT', 'AFP', 'AG', 'AE', 'I'];
        const colors = ['#dc2626', '#f59e0b', '#0ea5e9', '#8b5cf6', '#16a34a'];
        const maxAttempts = Math.max(...Object.values(mentalMapData), 1);
        
        container.innerHTML = labels.map((label, index) => {
            const attempts = mentalMapData[label] || 0;
            const independence = Math.max(0, Math.round((1 - (attempts / maxAttempts)) * 100));
            
            return `
                <div class="independence-indicator">
                    <div class="indicator-header">
                        <span class="indicator-label">${label}</span>
                        <span class="indicator-value">${independence}%</span>
                    </div>
                    <div class="indicator-bar">
                        <div class="indicator-fill" style="width: ${independence}%; background: ${colors[index]};"></div>
                    </div>
                    <div class="indicator-attempts">
                        ${attempts.toFixed(1)} tentativas médias
                    </div>
                </div>
            `;
        }).join('');
        
        // Adicionar estilos para os indicadores
        if (!document.getElementById('indicators-styles')) {
            const style = document.createElement('style');
            style.id = 'indicators-styles';
            style.textContent = `
                .independence-indicator {
                    background: var(--card);
                    border: 1px solid var(--border-color);
                    border-radius: 10px;
                    padding: 1rem;
                    transition: all 0.2s ease;
                }
                .independence-indicator:hover {
                    border-color: var(--primary);
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                }
                .indicator-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 0.5rem;
                }
                .indicator-label {
                    font-weight: 600;
                    color: var(--text);
                    font-size: 0.9rem;
                }
                .indicator-value {
                    font-weight: 700;
                    color: var(--primary);
                    font-size: 1rem;
                }
                .indicator-bar {
                    height: 8px;
                    background: var(--border-color);
                    border-radius: 4px;
                    overflow: hidden;
                    margin-bottom: 0.5rem;
                }
                .indicator-fill {
                    height: 100%;
                    border-radius: 4px;
                    transition: width 0.3s ease;
                }
                .indicator-attempts {
                    font-size: 0.75rem;
                    color: var(--muted);
                    text-align: center;
                }
            `;
            document.head.appendChild(style);
        }
    }

    // Event listeners para fechar modal
    closeBtn?.addEventListener('click', () => {
        mentalMapModal.style.display = 'none';
    });
    
    // Fechar modal clicando no backdrop
    mentalMapModal?.addEventListener('click', (e) => {
        if (e.target === mentalMapModal) {
            mentalMapModal.style.display = 'none';
        }
    });

    // Event listeners para os botões "Ver PEI" (não tocar nesta parte)
    document.querySelectorAll('.ver-pei-btn').forEach(button => {
        button.addEventListener('click', function() {
            const patientId = this.dataset.patientId;
            const patientName = this.dataset.patientName;
            
            // Redirecionar diretamente para a página do PEI do paciente
            const url = `{{ url_for("peis.ver_peis_paciente", paciente_doc_id="PATIENT_ID") }}`.replace("PATIENT_ID", patientId);
            
            window.location.href = url;
        });
    });

    // Inicializar gráficos
    renderCharts();
    
    // Configurar atualizações periódicas (a cada 5 minutos)
    setInterval(() => {
        // Atualizar indicador de última atualização
        if (window.updateLastUpdateIndicator) {
            window.updateLastUpdateIndicator();
        }
    }, 300000); // 5 minutos
    
    // Adicionar indicador visual de quando os dados foram atualizados
    addLastUpdateIndicator();
    
    // Adicionar badges de "dados dinâmicos" nas seções relevantes
    addDynamicDataBadges();

    // Recriar gráficos quando o tema mudar
    const themeObserver = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            if (mutation.type === 'attributes' && mutation.attributeName === 'data-theme') {
                setTimeout(() => renderCharts(), 100);
                if (mentalMapChartInstance && mentalMapModal?.style.display === 'flex') {
                    const patientId = mentalMapModal.dataset.patientId;
                    const patientName = modalPatientName?.textContent;
                    loadPatientMentalMapData(patientId, patientName);
                }
            }
        });
    });
    
    themeObserver.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ['data-theme']
    });

  });
</script>
</body>
</html>
