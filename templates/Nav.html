<aside class="sidebar">

  <div class="sidebar-inner-content">

    <div class="sidebar-header">
      <a href="{{ url_for('index') }}" class="logo" title="ClinicSolutions">
        <img src="https://i.imgur.com/484AdCn.png" alt="ClinicSolutions Logo" class="h-7 w-auto mr-2">
        <span>ClinicSolutions</span>
      </a>
    </div>

    <nav>
      <ul>

        <li class="{% if request.endpoint == 'index' %}active{% endif %}">
          <a href="{{ url_for('index') }}" title="Dashboard">
            <div class="submenu-toggle-content">
              <i class="fa-solid fa-house-chimney"></i>
              <span>Dashboard</span>
            </div>
          </a>
        </li>
        
        <li class="has-submenu {% if request.endpoint in ['listar_pacientes', 'buscar_prontuario', 'busca_peis'] %}open{% endif %}">

          <a href="#" class="submenu-toggle" title="Gerir Pacientes">
            <div class="submenu-toggle-content">
              <i class="fa-solid fa-hospital-user"></i>
              <span>Gerir Pacientes</span>
            </div>

            <i class="fa-solid fa-chevron-down submenu-arrow"></i>
          </a>

          <ul class="submenu">
            <li class="{% if request.endpoint == 'listar_pacientes' %}active{% endif %}">
              <a href="{{ url_for('listar_pacientes') }}" title="Pacientes">
                <span>Pacientes</span>
                {% if navbar_counts.pacientes is defined %}<span class="count-badge">{{ navbar_counts.pacientes }}</span>{% endif %}
              </a>
            </li>

            <li class="{% if request.endpoint == 'buscar_prontuario' %}active{% endif %}">
              <a href="{{ url_for('buscar_prontuario') }}" title="Prontuários">
                <span>Prontuários</span>
                {% if navbar_counts.prontuarios is defined %}<span class="count-badge">{{ navbar_counts.prontuarios }}</span>{% endif %}
              </a>
            </li>

            <li class="{% if request.endpoint == 'busca_peis' %}active{% endif %}">
              <a href="{{ url_for('busca_peis') }}" title="PEI's">
                <span>PEI's</span>
                {% if navbar_counts.peis is defined %}<span class="count-badge">{{ navbar_counts.peis }}</span>{% endif %}
              </a>
            </li>
          </ul>

        </li>

        <li class="{% if request.endpoint == 'listar_agendamentos' %}active{% endif %}">
          <a href="{{ url_for('listar_agendamentos') }}" title="Agendamentos">
            <div class="submenu-toggle-content">
              <i class="fa-regular fa-calendar-check"></i>
              <span>Agendamentos</span>
            </div>
            {% if navbar_counts.agendamentos is defined %}<span class="count-badge">{{ navbar_counts.agendamentos }}</span>{% endif %}
          </a>
        </li>

        {% if session.user_role == 'admin' %}
        <li class="has-submenu {% if request.endpoint in ['listar_servicos_procedimentos', 'listar_convenios', 'protocols.list_protocols', 'listar_modelos_anamnese', 'listar_profissionais'] %}open{% endif %}">

          <a href="#" class="submenu-toggle" title="Cadastro">
            <div class="submenu-toggle-content">
              <i class="fa-solid fa-folder-open"></i>
              <span>Cadastro</span>
            </div>
            <i class="fa-solid fa-chevron-down submenu-arrow"></i>
          </a>
          <ul class="submenu">
            <li class="{% if request.endpoint == 'listar_servicos_procedimentos' %}active{% endif %}">
              <a href="{{ url_for('listar_servicos_procedimentos') }}" title="Serviços/Procedimentos">
                <span>Serviços</span>
                {% if navbar_counts.servicos is defined %}<span class="count-badge">{{ navbar_counts.servicos }}</span>{% endif %}
              </a>
            </li>
            <li class="{% if request.endpoint == 'listar_convenios' %}active{% endif %}">
              <a href="{{ url_for('listar_convenios') }}" title="Convênios">
                <span>Convênios</span>
                {% if navbar_counts.convenios is defined %}<span class="count-badge">{{ navbar_counts.convenios }}</span>{% endif %}
              </a>
            </li>
            <li class="{% if request.endpoint == 'protocols.list_protocols' %}active{% endif %}">
              <a href="{{ url_for('protocols.list_protocols') }}" title="Protocolos">
                <span>Protocolos</span>
                {% if navbar_counts.protocolos is defined %}<span class="count-badge">{{ navbar_counts.protocolos }}</span>{% endif %}
              </a>
            </li>
            <li class="{% if request.endpoint == 'listar_modelos_anamnese' %}active{% endif %}">
              <a href="{{ url_for('listar_modelos_anamnese') }}" title="Modelos Anamnese">
                <span>Modelos Anamnese</span>
                {% if navbar_counts.modelos_anamnese is defined %}<span class="count-badge">{{ navbar_counts.modelos_anamnese }}</span>{% endif %}
              </a>
            </li>
            <li class="{% if request.endpoint == 'listar_profissionais' %}active{% endif %}">
              <a href="{{ url_for('listar_profissionais') }}" title="Profissionais">
                <span>Profissionais</span>
                {% if navbar_counts.profissionais is defined %}<span class="count-badge">{{ navbar_counts.profissionais }}</span>{% endif %}
              </a>
            </li>
          </ul>
        </li>

        <li class="has-submenu {% if request.endpoint in ['listar_contas_a_pagar', 'listar_estoque', 'patrimonio.listar_patrimonio'] %}open{% endif %}">

          <a href="#" class="submenu-toggle" title="Financeiro">
            <div class="submenu-toggle-content">
              <i class="fa-solid fa-money-bill-wave"></i>
              <span>Financeiro</span>
            </div>

            <i class="fa-solid fa-chevron-down submenu-arrow"></i>
          </a>

          <ul class="submenu">
            <li class="{% if request.endpoint == 'listar_contas_a_pagar' %}active{% endif %}">
              <a href="{{ url_for('listar_contas_a_pagar') }}" title="Contas a Pagar">
                <span>Contas a Pagar</span>
                {% if navbar_counts.contas_a_pagar is defined %}<span class="count-badge">{{ navbar_counts.contas_a_pagar }}</span>{% endif %}
              </a>
            </li>

            <li class="{% if request.endpoint == 'listar_estoque' %}active{% endif %}">
              <a href="{{ url_for('listar_estoque') }}" title="Estoque">
                <span>Estoque</span>
                {% if navbar_counts.estoque is defined %}<span class="count-badge">{{ navbar_counts.estoque }}</span>{% endif %}
              </a>
            </li>

            <li class="{% if request.endpoint == 'patrimonio.listar_patrimonio' %}active{% endif %}">
              <a href="{{ url_for('patrimonio.listar_patrimonio') }}" title="Patrimônio">
                <span>Patrimônio</span>
                {% if navbar_counts.patrimonio is defined %}<span class="count-badge">{{ navbar_counts.patrimonio }}</span>{% endif %}
              </a>
            </li>
          </ul>

        </li>

        <li class="has-submenu {% if request.endpoint in ['listar_horarios', 'listar_usuarios'] %}open{% endif %}">
          <a href="#" class="submenu-toggle" title="Gerir Sistema">
            <div class="submenu-toggle-content">
              <i class="fa-solid fa-gear"></i>
              <span>Gerir Sistema</span>
            </div>
            <i class="fa-solid fa-chevron-down submenu-arrow"></i>
          </a>
          <ul class="submenu">
            <li class="{% if request.endpoint == 'listar_horarios' %}active{% endif %}">
              <a href="{{ url_for('listar_horarios') }}" title="Horários">
                <span>Horários</span>
                {% if navbar_counts.horarios is defined %}<span class="count-badge">{{ navbar_counts.horarios }}</span>{% endif %}
              </a>
            </li>
            <li class="{% if request.endpoint == 'listar_usuarios' %}active{% endif %}">
              <a href="{{ url_for('listar_usuarios') }}" title="Utilizadores">
                <span>Utilizadores</span>
                {% if navbar_counts.utilizadores is defined %}<span class="count-badge">{{ navbar_counts.utilizadores }}</span>{% endif %}
              </a>
            </li>
          </ul>
        </li>

        {% endif %}
      </ul>
    </nav>

    <div class="sidebar-footer">
      <div class="user-info-section">
        <img src="{{ session.user_photo_url | default('https://placehold.co/40x40/cccccc/ffffff?text=User') }}" alt="Foto do Usuário" class="user-photo" id="userPhoto">
        <div class="user-details">
          <span class="user-name">{{ session.user_name | default('Utilizador') }}</span>
          <span class="clinic-name">{{ session.clinica_nome_display | default('Clínica On') }}</span>
        </div>
      </div>

      <div class="footer-buttons">
        <button id="theme-toggle" aria-label="Alternar tema" title="Alternar Tema">
          <i class="fa-solid fa-sun"></i> <span>Alternar Tema</span>
        </button>

        <button id="logoutButton" title="Sair">
          <i class="fa-solid fa-arrow-right-from-bracket"></i> <span>Sair</span>
        </button>
      </div>
    </div>

  </div>
</aside>

<div id="managePhotoModal" class="nav-modal-overlay">
  <div class="nav-modal-content">
    <div class="nav-modal-header">
      <h3>Gerir Foto de Perfil</h3>
      <button type="button" class="nav-modal-close-btn" data-close-modal="managePhotoModal">&times;</button>
    </div>
    <div class="nav-modal-body flex flex-col items-center p-4">
      <input type="file" id="photoUploadInput" accept="image/*" class="mb-4 p-2 border border-gray-300 rounded-md w-full">
      <div class="nav-image-crop-container mb-4 w-full max-w-xs md:max-w-sm lg:max-w-md">
        <img id="imageToCrop" style="display: block; max-width: 100%; max-height: 100%;" src="{{ session.user_photo_url | default('https://placehold.co/300x300/cccccc/ffffff?text=Selecione+uma+imagem') }}" alt="Imagem para Corte">
      </div>
      <div class="flex space-x-2 w-full justify-center">
        <button id="uploadPhotoButton" class="btn btn-primary flex-1" disabled><i class="fas fa-upload"></i> <span>Salvar Foto</span></button>
        <button id="removePhotoButton" class="btn btn-danger-outline flex-1" disabled><i class="fas fa-trash-alt"></i> <span>Remover Foto</span></button>
      </div>
    </div>
  </div>
</div>

<style>
:root {
    --bg: #f1f5f9;
    --card: #ffffff;
    --text: #0f172a;
    --muted: #64748b;
    --primary: #5587c2;
    --accent: #9b53b8;
    --primary-light: #c8dcf3;
    --primary-dark: #406a96;
    --secondary: #f59e0b;
    --danger: #dc2626;
    --success: #16a34a;
    --warning: #f59e0b;
    --info: #0ea5e9;
    --border-color: #e2e8f0;

    --dark-bg: #1e293b;
    --dark-card: #334155;
    --dark-text: #f1f5f9;
    --dark-muted: #94a3b8;
    --dark-border-color: #475569;

    color-scheme: light;
}
[data-theme="dark"] {
    --bg: var(--dark-bg);
    --text: var(--dark-text);
    --card: var(--dark-card);
    --muted: var(--dark-muted);
    --border-color: var(--dark-border-color);
    color-scheme: dark;
}
::-webkit-scrollbar {
  background-color: var(--bg);
  width: 0.5625rem;
  height: 0.5625rem;
  border-top-right-radius: 0.3125rem;
  border-bottom-right-radius: 0.3125rem;
  transition: background-color 0.8s ease;
}

::-webkit-scrollbar-thumb {
  background-color: var(--muted);
  border-radius: 0.3125rem;
  transition: background-color 0.8s ease;
}

::-webkit-scrollbar-thumb:hover {
  transition: background-color 0.8s ease;
  background-color: var(--primary);
}

.sidebar {
  background: linear-gradient(180deg, var(--primary), var(--accent));
  color: white;
  transition: width 0.3s ease, transform 0.3s ease;
  z-index: 1000;
  position: fixed;
  width: 16.25rem;
  height: 100vh;
  top: 0;
  left: 0;
  display: flex;
  flex-direction: column;
  box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
}

.sidebar-inner-content {
  padding: 0;
  height: 100%;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
}

.sidebar-header {
  padding: 0 1rem;
  border-bottom: 1px solid rgba(255, 255, 255, 0.15);
  height: 4.375rem;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.sidebar-header .logo {
  color: white;
  font-weight: 700;
  font-size: 1.3rem;
  text-decoration: none;
  white-space: nowrap;
  overflow: hidden;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.sidebar-header .logo img {
    height: 1.75rem;
    width: auto;
    margin-right: 0.5rem;
    border-radius: 0.375rem;
}

.sidebar-header .logo i {
  font-size: 1.8rem;
}

.sidebar.collapsed {
  width: 5.5rem;
}

.sidebar.collapsed .sidebar-header .logo span {
  display: none;
}

.sidebar.collapsed .sidebar-header .logo i {
  margin-right: 0;
}

.sidebar nav {
  flex-grow: 1;
  margin-top: 1rem;
  padding: 0 0.75rem;
}

.sidebar nav ul {
  list-style: none;
  padding: 0;
}

.sidebar nav ul li {
  margin-bottom: 0.5rem;
}

.sidebar nav ul li a {
  color: #e2e8f0;
  text-decoration: none;
  padding: 0.75rem 1rem;
  border-radius: 0.5rem;
  font-size: 0.95rem;
  font-weight: 500;
  white-space: nowrap;
  overflow: hidden;
  transition: background 0.2s ease, color 0.2s ease, transform 0.1s ease;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.submenu-toggle-content {
  display: flex;
  justify-content: flex-start;
  align-items: center;
  gap: 0.75rem;
  flex-grow: 1;
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.sidebar nav ul li a i {
  width: 1.5rem;
  font-size: 1.2rem;
  flex-shrink: 0;
  text-align: center;
}

.sidebar.collapsed nav ul li a span {
  display: none;
}

.sidebar.collapsed nav ul li a {
  justify-content: center;
  padding: 0.75rem;
}

.sidebar nav ul li a:hover {
  background: rgba(255, 255, 255, 0.15);
  color: white;
  transform: translateY(-1px);
}

.sidebar nav ul li.active a {
  background: white;
  color: var(--primary);
  border-radius: 0.5rem;
  font-weight: 600;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.sidebar-footer {
  margin-top: auto;
  padding: 1rem 0.75rem;
  flex-shrink: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 1rem;
  border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.user-info-section {
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  color: white;
  margin-bottom: 0.5rem;
  width: 100%;
}

.user-photo {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid rgba(255, 255, 255, 0.5);
  margin-bottom: 0.5rem;
  cursor: pointer;
  transition: transform 0.2s ease-in-out, box-shadow 0.2s ease;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.user-photo:hover {
    transform: scale(1.08);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.user-details {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.user-name {
  font-weight: 600;
  font-size: 1rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100%;
}

.clinic-name {
  font-size: 0.8rem;
  opacity: 0.8;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100%;
}

.footer-buttons {
  display: flex;
  justify-content: space-around;
  width: 100%;
  gap: 0.5rem;
}

.sidebar-footer button,
.sidebar-footer a {
  background: none;
  border: none;
  cursor: pointer;
  color: #e2e8f0;
  padding: 0.75rem 0.5rem;
  border-radius: 0.5rem;
  flex-grow: 1;
  font-family: 'Inter', sans-serif;
  font-size: 0.9rem;
  text-decoration: none;
  transition: background 0.2s ease, color 0.2s ease, transform 0.1s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
}

.sidebar-footer button:hover,
.sidebar-footer a:hover {
  background: rgba(255, 255, 255, 0.15);
  color: white;
  transform: translateY(-1px);
}

.sidebar.collapsed .sidebar-footer {
  padding: 1rem 0.5rem;
  flex-direction: column;
  align-items: center;
}

.sidebar.collapsed .sidebar-footer .user-info-section {
    display: none;
}

.sidebar.collapsed .sidebar-footer .footer-buttons {
    flex-direction: column;
}

.sidebar.collapsed .sidebar-footer span {
  display: none;
}

.sidebar.collapsed .sidebar-footer button,
.sidebar.collapsed .sidebar-footer a {
  justify-content: center;
  padding: 0.75rem;
  width: auto;
}

.sidebar nav ul li.has-submenu .submenu {
  padding: 0rem;
  max-height: 0rem;
  list-style: none;
  overflow: hidden;
  transition: max-height 0.3s ease-out;
  background: rgba(255, 255, 255, 0.08);
  border-radius: 0rem 0rem 0.5rem 0.5rem;
  box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.05);
}

.sidebar nav ul li ul.submenu li.active a {
  border-radius: 0rem;
}

.sidebar nav ul li.has-submenu.open .submenu {
  max-height: 62.5rem;
  overflow-y: auto;
  transition: max-height 0.5s ease-in;
}

.sidebar nav ul li.has-submenu.open .submenu-toggle {
  background: rgba(255, 255, 255, 0.25);
  border-radius: 0.5rem 0.5rem 0rem 0rem;
}

.sidebar nav ul li.has-submenu.open ul.submenu li a:hover {
  border-radius: 0rem;
}

.sidebar nav ul.submenu li {
  margin-bottom: 0rem;
}

.sidebar.collapsed .has-submenu .submenu-toggle span {
  display: none;
}

.sidebar.collapsed .has-submenu .submenu-toggle .submenu-arrow {
  display: none;
}

.sidebar.collapsed .has-submenu .submenu {
  display: none;
}

.count-badge {
  background-color: var(--secondary);
  color: white;
  padding: 0.2em 0.6em;
  border-radius: 0.75em;
  font-size: 0.75em;
  font-weight: 700;
  margin-left: auto;
  min-width: 1.5em;
  text-align: center;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  line-height: 1;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

@media (max-width: 768px) {
  .sidebar {
    transform: translateX(-100%);
    box-shadow: none;
  }

  .sidebar.open {
    transform: translateX(0);
    box-shadow: 0.25rem 0 0.9375rem rgba(0, 0, 0, 0.1);
  }

  .sidebar.collapsed {
    transform: translateX(-100%);
    width: 16.25rem;
  }

  .sidebar.collapsed nav ul li a,
  .sidebar.collapsed .sidebar-footer button,
  .sidebar.collapsed .sidebar-footer a {
    justify-content: flex-start;
  }

  .sidebar.collapsed nav ul li a span {
    display: inline;
  }
  .sidebar.collapsed .sidebar-footer span {
    display: inline;
  }

  .sidebar.collapsed .sidebar-header .logo span {
    display: inline;
  }
}

.nav-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
    backdrop-filter: blur(5px);
}

.nav-modal-overlay.active {
    opacity: 1;
    pointer-events: auto;
}

.nav-modal-content {
    background-color: var(--card);
    color: var(--text);
    border-radius: 12px;
    box-shadow: 0 15px 30px rgba(0,0,0,0.25), 0 5px 15px rgba(0,0,0,0.1);
    width: 90%;
    max-width: 500px;
    transform: translateY(-20px);
    transition: transform 0.3s ease, opacity 0.3s ease;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    z-index: 2001;
    border: 1px solid var(--border-color);
}

.nav-modal-overlay.active .nav-modal-content {
    transform: translateY(0);
}

.nav-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--border-color);
    flex-shrink: 0;
    background-color: var(--bg);
}

.nav-modal-header h3 {
    font-size: 1.25rem;
    color: var(--text);
    margin: 0;
    font-weight: 600;
}

.nav-modal-close-btn {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: var(--muted);
    cursor: pointer;
    line-height: 1;
    transition: color 0.2s ease, background-color 0.2s ease, transform 0.2s ease;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
}

.nav-modal-close-btn:hover {
    color: var(--danger);
    background-color: rgba(220, 38, 38, 0.1);
    transform: rotate(90deg);
}

.nav-modal-body {
    padding: 1.5rem;
    overflow-y: auto;
    flex-grow: 1;
}

.nav-image-crop-container {
    background-color: var(--bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    overflow: hidden;
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%;
    max-width: 400px;
    height: 300px;
    position: relative;
}

.nav-image-crop-container img {
    display: block;
    max-width: 100%;
    max-height: 100%;
}

.nav-modal-body input[type="file"] {
    background-color: var(--bg);
    color: var(--text);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 0.5rem 1rem;
    cursor: pointer;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

.nav-modal-body input[type="file"]:hover {
    border-color: var(--primary);
    box-shadow: 0 0 0 2px color-mix(in srgb, var(--primary) 15%, transparent);
}

.nav-modal-body input[type="file"]::-webkit-file-upload-button {
    background-color: var(--primary);
    color: white;
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.2s ease, transform 0.1s ease;
}

.nav-modal-body input[type="file"]::-webkit-file-upload-button:hover {
    background-color: var(--primary-dark);
    transform: translateY(-1px);
}

.nav-modal-body .flex.space-x-2 {
    display: flex;
    justify-content: center;
    gap: 0.75rem;
    width: 100%;
}

.nav-modal-body .flex.space-x-2 .btn {
    flex: 1;
    padding: 0.6rem 1.2rem;
    font-size: 0.9rem;
    border-radius: 8px;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    border: 1px solid transparent;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
}
.nav-modal-body .flex.space-x-2 .btn-primary {
    background-color: var(--primary);
    color: white;
}
.nav-modal-body .flex.space-x-2 .btn-primary:hover {
    background-color: var(--primary-dark);
    transform: translateY(-1px);
}
.nav-modal-body .flex.space-x-2 .btn-danger-outline {
    background-color: transparent;
    color: var(--danger);
    border-color: var(--danger);
}
.nav-modal-body .flex.space-x-2 .btn-danger-outline:hover {
    background-color: var(--danger);
    color: white;
    transform: translateY(-1px);
}

</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">

<script type="module">
  document.addEventListener('DOMContentLoaded', () => {
    const htmlEl = document.documentElement;
    const sidebar = document.querySelector('.sidebar');
    const mainContent = document.querySelector('.main-content');
    const menuBtnMobile = document.querySelector('.menu-btn-mobile');
    const toggleBtnDesktop = document.querySelector('.toggle-btn-desktop');
    const themeToggle = document.querySelector('#theme-toggle');
    const logoutButton = document.getElementById('logoutButton');

    const USER_UID = "{{ session.user_uid | default('') }}";
    const USER_PHOTO_URL_INITIAL = "{{ session.user_photo_url | default('') }}";
    const DEFAULT_PHOTO_URL = "https://placehold.co/100x100/cccccc/ffffff?text=User";

    const userPhoto = document.getElementById('userPhoto');
    const managePhotoModal = document.getElementById('managePhotoModal');
    const imageToCrop = document.getElementById('imageToCrop');
    const photoUploadInput = document.getElementById('photoUploadInput');
    const uploadPhotoButton = document.getElementById('uploadPhotoButton');
    const removePhotoButton = document.getElementById('removePhotoButton');
    const closeModalButtons = document.querySelectorAll('[data-close-modal]');

    let cropper;

    function showCustomAlert(message, title = "Aviso", type = "info") {
        const modalHtml = `
            <div id="customAlertDialog" class="nav-modal-overlay active">
                <div class="nav-modal-content" style="max-width: 400px; padding: 1.5rem;">
                    <div class="nav-modal-header" style="background-color: var(--card); border-bottom: none; padding: 0 0 1rem 0;">
                        <h3 style="font-size: 1.25rem; font-weight: 700; color: var(--text);">${title}</h3>
                        <button type="button" class="nav-modal-close-btn" data-close-modal="customAlertDialog" style="position: absolute; top: 0.5rem; right: 0.5rem;">&times;</button>
                    </div>
                    <div class="nav-modal-body" style="padding: 0; text-align: center;">
                        <p style="font-size: 1rem; color: var(--text); margin-bottom: 1.5rem;">${message}</p>
                        <button id="customAlertOkBtn" class="btn btn-primary" style="width: auto; padding: 0.6rem 1.5rem;">OK</button>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        const alertDialog = document.getElementById('customAlertDialog');
        const okBtn = document.getElementById('customAlertOkBtn');

        okBtn.addEventListener('click', () => {
            alertDialog.classList.remove('active');
            alertDialog.remove();
            document.body.style.overflow = '';
        });

        alertDialog.addEventListener('click', (e) => {
            if (e.target === alertDialog || e.target.closest('[data-close-modal="customAlertDialog"]')) {
                alertDialog.classList.remove('active');
                alertDialog.remove();
                document.body.style.overflow = '';
            }
        });
        document.body.style.overflow = 'hidden';
    }


    function updateUploadButtonTextAndState() {
        const hasExistingPhoto = userPhoto && userPhoto.src && userPhoto.src !== DEFAULT_PHOTO_URL;

        if (hasExistingPhoto) {
            uploadPhotoButton.querySelector('span').textContent = 'Alterar Foto';
            removePhotoButton.disabled = false;
        } else {
            uploadPhotoButton.querySelector('span').textContent = 'Salvar Foto';
            removePhotoButton.disabled = true;
        }
        uploadPhotoButton.disabled = true;
    }

    if (userPhoto) {
        userPhoto.src = USER_PHOTO_URL_INITIAL || DEFAULT_PHOTO_URL;
        updateUploadButtonTextAndState();
    }

    userPhoto?.addEventListener('click', () => {
        imageToCrop.src = userPhoto.src;
        if (cropper) {
            cropper.destroy();
            cropper = null;
        }
        imageToCrop.style.display = 'block';
        cropper = new Cropper(imageToCrop, {
            aspectRatio: 1,
            viewMode: 1,
            autoCropArea: 0.8,
            background: false,
            zoomable: true,
            movable: true,
            ready: function () {
            }
        });

        managePhotoModal.classList.add('active');
        document.body.style.overflow = 'hidden';
        updateUploadButtonTextAndState();
    });

    photoUploadInput?.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                imageToCrop.src = e.target.result;
                if (cropper) {
                    cropper.destroy();
                }
                imageToCrop.style.display = 'block';
                cropper = new Cropper(imageToCrop, {
                    aspectRatio: 1,
                    viewMode: 1,
                    autoCropArea: 0.8,
                    background: false,
                    zoomable: true,
                    movable: true,
                    ready: function () {
                    }
                });
            };
            reader.readAsDataURL(file);
            uploadPhotoButton.disabled = false;
            uploadPhotoButton.querySelector('span').textContent = 'Salvar Foto';
        } else {
            uploadPhotoButton.disabled = true;
            updateUploadButtonTextAndState();
        }
    });

    uploadPhotoButton?.addEventListener('click', async () => {
        if (!cropper) {
            showCustomAlert('Por favor, selecione uma imagem e ajuste o corte.');
            return;
        }

        uploadPhotoButton.disabled = true;
        uploadPhotoButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';

        cropper.getCroppedCanvas({
            width: 200,
            height: 200,
            fillColor: '#fff'
        }).toBlob(async (blob) => {
            if (!blob) {
                showCustomAlert('Erro ao obter a imagem cortada.');
                uploadPhotoButton.disabled = false;
                uploadPhotoButton.innerHTML = '<i class="fas fa-upload"></i> <span>Salvar Foto</span>';
                return;
            }

            const formData = new FormData();
            formData.append('profile_photo', blob, 'profile.png');
            formData.append('user_uid', USER_UID);

            try {
                const response = await fetch('/api/upload_user_photo', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.photo_url) {
                        userPhoto.src = data.photo_url;
                        showCustomAlert('Foto de perfil atualizada com sucesso!', 'Sucesso');
                        managePhotoModal.classList.remove('active');
                        document.body.style.overflow = '';
                        if (cropper) {
                            cropper.destroy();
                            cropper = null;
                        }
                        updateUploadButtonTextAndState();
                    } else {
                        // Se a resposta do servidor indicar falha, exibe a mensagem de erro do servidor
                        showCustomAlert(data.message || 'Erro desconhecido ao salvar foto.', 'Erro');
                    }
                } else {
                    // Se a requisição HTTP falhar (status != 200), exibe uma mensagem genérica
                    showCustomAlert(`Ocorreu um erro ao carregar a foto. Por favor, tente novamente.`, 'Erro', 'danger');
                }
            } catch (error) {
                // Captura erros de rede ou outros erros inesperados
                console.error('Erro ao fazer upload da foto:', error);
                showCustomAlert('Não foi possível completar a ação. Tente novamente.', 'Erro', 'danger');
            } finally {
                uploadPhotoButton.disabled = false;
                uploadPhotoButton.innerHTML = '<i class="fas fa-upload"></i> <span>Salvar Foto</span>';
            }
        }, 'image/png', 0.9);
    });

    removePhotoButton?.addEventListener('click', async () => {
        removePhotoButton.disabled = true;
        removePhotoButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Removendo...';

        try {
            const response = await fetch('/api/remove_user_photo', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ user_uid: USER_UID })
            });

            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    userPhoto.src = DEFAULT_PHOTO_URL;
                    imageToCrop.src = DEFAULT_PHOTO_URL;
                    if (cropper) {
                        cropper.destroy();
                        cropper = null;
                    }
                    showCustomAlert('Foto de perfil removida com sucesso!', 'Sucesso');
                    managePhotoModal.classList.remove('active');
                    document.body.style.overflow = '';
                    updateUploadButtonTextAndState();
                } else {
                    // Se a resposta do servidor indicar falha, exibe a mensagem de erro do servidor
                    showCustomAlert(data.message || 'Erro desconhecido ao remover foto.', 'Erro');
                }
            } else {
                // Se a requisição HTTP falhar (status != 200), exibe uma mensagem genérica
                showCustomAlert(`Não foi possível remover a foto. Tente novamente.`, 'Erro', 'danger');
            }
        } catch (error) {
            // Captura erros de rede ou outros erros inesperados
            console.error('Erro ao remover foto:', error);
            showCustomAlert('Não foi possível completar a ação. Tente novamente.', 'Erro', 'danger');
        } finally {
            removePhotoButton.disabled = false;
            removePhotoButton.innerHTML = '<i class="fas fa-trash-alt"></i> <span>Remover Foto</span>';
        }
    });

    closeModalButtons.forEach(button => {
        button.addEventListener('click', () => {
            const modalId = button.dataset.closeModal;
            if (modalId) {
                document.getElementById(modalId).classList.remove('active');
                document.body.style.overflow = '';
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }
            }
        });
    });

    managePhotoModal?.addEventListener('click', (e) => {
        if (e.target === managePhotoModal) {
            managePhotoModal.classList.remove('active');
            document.body.style.overflow = '';
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
        }
    });

    document.querySelectorAll('.has-submenu').forEach(item => {
      const toggle = item.querySelector('.submenu-toggle');

      if (toggle) {
        toggle.addEventListener('click', (e) => {
          e.preventDefault();
          item.classList.toggle('open');
        });
      }

    });

    function setupSidebar() {

      if (!sidebar || !mainContent) return;
      
      const updateDesktopToggleIcon = () => {

        if (!toggleBtnDesktop) return;

        const icon = toggleBtnDesktop.querySelector('i');

        if (sidebar.classList.contains('collapsed')) {
          icon.classList.replace('fa-bars-staggered', 'fa-bars');
        } else {
          icon.classList.replace('fa-bars', 'fa-bars-staggered');
        }

      };

      const applyInitialState = () => {

        if (window.innerWidth > 768) {

          if (localStorage.getItem('sidebarCollapsed') === 'true') {

            sidebar.classList.add('collapsed');
            mainContent.classList.add('collapsed');

          } else {

            sidebar.classList.remove('collapsed');
            mainContent.classList.remove('collapsed');

          }
        } else {

            sidebar.classList.remove('open', 'collapsed');
            mainContent.classList.remove('collapsed');

        }

        updateDesktopToggleIcon();

      };
      
      toggleBtnDesktop?.addEventListener('click', () => {
        
        sidebar.classList.toggle('collapsed');
        mainContent.classList.toggle('collapsed');
        localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));

        updateDesktopToggleIcon();

      });

      menuBtnMobile?.addEventListener('click', (e) => {

        e.stopPropagation();
        sidebar.classList.toggle('open');

        const icon = menuBtnMobile.querySelector('i');
        icon.classList.toggle('fa-times', sidebar.classList.contains('open'));
        icon.classList.toggle('fa-bars', !sidebar.classList.contains('open'));

      });

      document.addEventListener('click', (e) => {
        
        if (window.innerWidth <= 768 && sidebar.classList.contains('open') && !sidebar.contains(e.target) && !menuBtnMobile.contains(e.target)) {
          
          sidebar.classList.remove('open');
          const icon = menuBtnMobile.querySelector('i');
          icon.classList.remove('fa-times');
          icon.classList.add('fa-bars');

        }
      });

      applyInitialState();
      window.addEventListener('resize', applyInitialState);
    }
    
    function setupTheme() {
      
      if (!themeToggle) return;
        
        const updateThemeIcon = (theme) => {
            
            const icon = themeToggle.querySelector('i');
            
            if (icon) {
              if (theme === 'dark') {
                  icon.classList.replace('fa-sun', 'fa-moon');
              } else {
                  icon.classList.replace('fa-moon', 'fa-sun');
              }
            }
        };

        const applyInitialTheme = () => {
            
            const storedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            htmlEl.setAttribute('data-theme', storedTheme);
            updateThemeIcon(storedTheme);
            
        };
        
        themeToggle.addEventListener('click', () => {
          
          const newTheme = htmlEl.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
          htmlEl.setAttribute('data-theme', newTheme);
          localStorage.setItem('theme', newTheme);
          updateThemeIcon(newTheme);
          
        });
        
        applyInitialTheme();
    }

    function setupLogout() {
      if (!logoutButton) return;

      logoutButton.addEventListener('click', async (event) => {
        
        event.preventDefault();
        try {
            const response = await fetch("{{ url_for('logout') }}", { method: 'POST' });
            if (response.ok) {
                window.location.href = "{{ url_for('login_page') }}";
            } else {
                const errorData = await response.json();
                showCustomAlert('Erro ao fazer logout: ' + (errorData.message || 'Erro desconhecido.'), 'Erro');
                console.error('Erro no logout do servidor:', errorData);
            }
        } catch (error) {
            console.error('Erro na requisição de logout:', error);
            showCustomAlert('Não foi possível completar a ação. Tente novamente.', 'Erro', 'danger');
            window.location.href = "{{ url_for('login_page') }}";
        }
      });
    }

    setupSidebar();
    setupTheme();
    setupLogout();
  });
</script>
